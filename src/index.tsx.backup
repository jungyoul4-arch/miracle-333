import { Hono } from 'hono'
import { cors } from 'hono/cors'

type Bindings = {
  DB: D1Database
  R2: R2Bucket
  GEMINI_API_KEY: string
  ANTHROPIC_API_KEY: string
}

const app = new Hono<{ Bindings: Bindings }>()

app.use('/api/*', cors())

// ===== Helper: Simple token auth via cookie =====
async function hashPassword(pw: string): Promise<string> {
  const data = new TextEncoder().encode(pw + 'qa-salt-2026')
  const hash = await crypto.subtle.digest('SHA-256', data)
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('')
}

function generateToken(): string {
  const arr = new Uint8Array(32)
  crypto.getRandomValues(arr)
  return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('')
}

async function getUser(db: D1Database, token: string | undefined) {
  if (!token) return null
  const session = await db.prepare('SELECT user_id FROM sessions WHERE token = ? AND expires_at > datetime(\'now\')').bind(token).first() as any
  if (!session) return null
  return await db.prepare('SELECT id, username, nickname, grade FROM users WHERE id = ?').bind(session.user_id).first()
}

function getTokenFromReq(c: any): string | undefined {
  const cookie = c.req.header('Cookie') || ''
  const match = cookie.match(/qa_token=([^;]+)/)
  if (match) return match[1]
  const auth = c.req.header('Authorization') || ''
  if (auth.startsWith('Bearer ')) return auth.slice(7)
  return undefined
}

// ===== API Routes =====

app.get('/api/init', async (c) => {
  const db = c.env.DB
  await db.prepare(`CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    nickname TEXT NOT NULL DEFAULT 'í•™ìƒ',
    grade TEXT DEFAULT '',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )`).run()
  await db.prepare(`CREATE TABLE IF NOT EXISTS sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    token TEXT UNIQUE NOT NULL,
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
  )`).run()
  await db.prepare(`CREATE TABLE IF NOT EXISTS questions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    author_name TEXT NOT NULL DEFAULT 'ìµëª…',
    author_grade TEXT DEFAULT '',
    title TEXT NOT NULL,
    content TEXT DEFAULT '',
    image_data TEXT,
    subject TEXT DEFAULT 'ê¸°íƒ€',
    difficulty TEXT DEFAULT 'ì¤‘',
    comment_count INTEGER DEFAULT 0,
    status TEXT DEFAULT 'ì±„íƒ ëŒ€ê¸° ì¤‘',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )`).run()
  await db.prepare(`CREATE TABLE IF NOT EXISTS answers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    question_id INTEGER NOT NULL,
    user_id INTEGER,
    author_name TEXT NOT NULL DEFAULT 'ìµëª…',
    author_grade TEXT DEFAULT '',
    content TEXT DEFAULT '',
    image_data TEXT,
    drawing_data TEXT,
    is_accepted INTEGER DEFAULT 0,
    acceptance_tags TEXT DEFAULT NULL,
    acceptance_review TEXT DEFAULT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (question_id) REFERENCES questions(id) ON DELETE CASCADE
  )`).run()
  await db.prepare(`CREATE TABLE IF NOT EXISTS replies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    answer_id INTEGER NOT NULL,
    user_id INTEGER,
    author_name TEXT NOT NULL DEFAULT 'ìµëª…',
    author_grade TEXT DEFAULT '',
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (answer_id) REFERENCES answers(id) ON DELETE CASCADE
  )`).run()
  
  // 1:1 íŠœí„°ë§ ì‹œê°„í‘œ & ë§¤ì¹­
  await db.prepare(`CREATE TABLE IF NOT EXISTS tutoring_slots (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    question_id INTEGER NOT NULL,
    slot_time TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (question_id) REFERENCES questions(id) ON DELETE CASCADE
  )`).run()
  await db.prepare(`CREATE TABLE IF NOT EXISTS tutoring_matches (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    question_id INTEGER NOT NULL,
    slot_id INTEGER NOT NULL,
    tutor_id INTEGER NOT NULL,
    tutor_name TEXT NOT NULL DEFAULT 'ìµëª…',
    tutor_grade TEXT DEFAULT '',
    status TEXT DEFAULT 'pending',
    held_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    confirmed_at DATETIME,
    FOREIGN KEY (question_id) REFERENCES questions(id) ON DELETE CASCADE,
    FOREIGN KEY (slot_id) REFERENCES tutoring_slots(id) ON DELETE CASCADE
  )`).run()

  // Migration: add acceptance columns if they don't exist (for existing DBs)
  try{await db.prepare('ALTER TABLE answers ADD COLUMN acceptance_tags TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE answers ADD COLUMN acceptance_review TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN reward_points INTEGER DEFAULT 0').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN thumbnail_data TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE answers ADD COLUMN thumbnail_data TEXT DEFAULT NULL').run()}catch(e){}
  // R2 image key columns
  try{await db.prepare('ALTER TABLE questions ADD COLUMN image_key TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN thumbnail_key TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE answers ADD COLUMN image_key TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE answers ADD COLUMN thumbnail_key TEXT DEFAULT NULL').run()}catch(e){}
  // R2 drawing key column
  try{await db.prepare('ALTER TABLE answers ADD COLUMN drawing_key TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE answers ADD COLUMN voice_key TEXT DEFAULT NULL').run()}catch(e){} // ìŒì„± ë…¹ìŒ R2 í‚¤
  try{await db.prepare('ALTER TABLE tutoring_matches ADD COLUMN acceptance_tags TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE tutoring_matches ADD COLUMN acceptance_review TEXT DEFAULT NULL').run()}catch(e){}

  // === AI ë¶„ì„ ì»¬ëŸ¼ ===
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_difficulty TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_tags TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_topic_main TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_topic_sub TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_description TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_grade_level TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_estimated_time INTEGER DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_analyzed INTEGER DEFAULT 0').run()}catch(e){}

  // === ì§ˆë¬¸ ì½”ì¹­ ì‹œìŠ¤í…œ ===
  try{await db.prepare('ALTER TABLE questions ADD COLUMN question_type TEXT DEFAULT NULL').run()}catch(e){} // 7ìœ í˜•: 1-1,1-2,2-1,2-2,2-3,3-1,3-2
  try{await db.prepare('ALTER TABLE questions ADD COLUMN question_type_confidence REAL DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('ALTER TABLE questions ADD COLUMN student_question_text TEXT DEFAULT NULL').run()}catch(e){} // ì´ë¯¸ì§€ì—ì„œ OCR ì¸ì‹í•œ í•™ìƒ í•„ê¸° ì§ˆë¬¸
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_question_analysis TEXT DEFAULT NULL').run()}catch(e){} // AI ì§ˆë¬¸ ë¶„ì„ (ì§ˆë¬¸ì˜ ê¹Šì´/ì˜ë„ ë¶„ì„)
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_coaching_comment TEXT DEFAULT NULL').run()}catch(e){} // AI ì§ˆë¬¸ ì½”ì¹­ ì½”ë©˜íŠ¸
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_next_questions TEXT DEFAULT NULL').run()}catch(e){} // AI ë‹¤ìŒ ë‹¨ê³„ ì§ˆë¬¸ ì¶”ì²œ (JSON)
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_growth_coaching TEXT DEFAULT NULL').run()}catch(e){} // AI ì„±ì¥ ì½”ì¹­ (JSON: wrong_attempt, discovery_hint, thinking_bridge)
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_model TEXT DEFAULT NULL').run()}catch(e){} // ì½”ì¹­ ë¶„ì„ì— ì‚¬ìš©ëœ AI ëª¨ë¸ (gemini / claude)
  try{await db.prepare('ALTER TABLE questions ADD COLUMN ai_coaching_data TEXT DEFAULT NULL').run()}catch(e){} // í†µí•© ì½”ì¹­ ë°ì´í„° (JSON: coaching_questions + growth_interactions)

  // === ì§ˆë¬¸ ì½”ì¹­ ë¡œê·¸ í…Œì´ë¸” ===
  await db.prepare(`CREATE TABLE IF NOT EXISTS coaching_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    question_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    step TEXT NOT NULL,
    choice TEXT NOT NULL,
    time_spent_ms INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (question_id) REFERENCES questions(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
  )`).run()

  // === ì·¨ì†Œ íŒ¨ë„í‹° ì‹œìŠ¤í…œ ===
  // ì·¨ì†Œ ê¸°ë¡ í…Œì´ë¸”
  await db.prepare(`CREATE TABLE IF NOT EXISTS cancel_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    match_id INTEGER NOT NULL,
    question_id INTEGER NOT NULL,
    cancelled_by INTEGER NOT NULL,
    cancel_role TEXT NOT NULL DEFAULT 'questioner',
    reason TEXT NOT NULL DEFAULT 'ê¸°íƒ€',
    reason_detail TEXT DEFAULT '',
    penalty_type TEXT DEFAULT 'none',
    penalty_points INTEGER DEFAULT 0,
    warnings_added INTEGER DEFAULT 0,
    hours_before REAL DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (cancelled_by) REFERENCES users(id)
  )`).run()

  // ê²½ê³  í…Œì´ë¸”
  await db.prepare(`CREATE TABLE IF NOT EXISTS user_warnings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    cancel_record_id INTEGER,
    warning_count INTEGER DEFAULT 1,
    reason TEXT DEFAULT '',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
  )`).run()

  // ì´ìš© ì •ì§€ í…Œì´ë¸”
  await db.prepare(`CREATE TABLE IF NOT EXISTS user_suspensions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    reason TEXT DEFAULT '',
    total_warnings INTEGER DEFAULT 0,
    suspended_until DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
  )`).run()

  // ìƒí˜¸ í•©ì˜ ì·¨ì†Œ ìš”ì²­ í…Œì´ë¸”
  await db.prepare(`CREATE TABLE IF NOT EXISTS mutual_cancel_requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    match_id INTEGER NOT NULL,
    requested_by INTEGER NOT NULL,
    reason TEXT DEFAULT '',
    status TEXT DEFAULT 'pending',
    responded_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (match_id) REFERENCES tutoring_matches(id)
  )`).run()

  // users í…Œì´ë¸”ì— í¬ì¸íŠ¸/ê²½ê³  ì»¬ëŸ¼ ì¶”ê°€
  try{await db.prepare('ALTER TABLE users ADD COLUMN points INTEGER DEFAULT 0').run()}catch(e){}
  try{await db.prepare('ALTER TABLE users ADD COLUMN total_warnings INTEGER DEFAULT 0').run()}catch(e){}
  try{await db.prepare('ALTER TABLE users ADD COLUMN total_matches INTEGER DEFAULT 0').run()}catch(e){}
  try{await db.prepare('ALTER TABLE users ADD COLUMN completed_matches INTEGER DEFAULT 0').run()}catch(e){}
  try{await db.prepare('ALTER TABLE users ADD COLUMN cancelled_matches INTEGER DEFAULT 0').run()}catch(e){}
  // ì™¸ë¶€ ì•±(ì •ìœ¨í†¡) ì—°ë™ìš© external_id ì»¬ëŸ¼
  try{await db.prepare('ALTER TABLE users ADD COLUMN external_id TEXT DEFAULT NULL').run()}catch(e){}
  try{await db.prepare('CREATE UNIQUE INDEX IF NOT EXISTS idx_users_external_id ON users(external_id)').run()}catch(e){}
  
  return c.json({ success: true, message: 'Database initialized' })
})

// ===== External App Auto-Auth API (ì •ìœ¨í†¡ ì—°ë™) =====
app.post('/api/auth/external', async (c) => {
  const db = c.env.DB
  const { user_id, nick_name } = await c.req.json()
  if (!user_id) return c.json({ error: 'user_id is required' }, 400)

  const extId = String(user_id)

  // Try to find existing user by external_id
  let user = await db.prepare('SELECT id, username, nickname, grade FROM users WHERE external_id = ?').bind(extId).first() as any

  if (!user) {
    // Auto-register: create new user with external_id
    const nickname = nick_name || ('ì‚¬ìš©ì' + extId)
    const username = 'ext_' + extId
    // Check if username already exists (legacy accounts)
    const existing = await db.prepare('SELECT id FROM users WHERE username = ?').bind(username).first()
    if (existing) {
      // Link existing legacy account to external_id
      await db.prepare('UPDATE users SET external_id = ?, nickname = ? WHERE username = ?').bind(extId, nickname, username).run()
      user = await db.prepare('SELECT id, username, nickname, grade FROM users WHERE username = ?').bind(username).first() as any
    } else {
      const dummyHash = 'external_auth_no_password'
      const result = await db.prepare('INSERT INTO users (username, password_hash, nickname, grade, external_id) VALUES (?, ?, ?, ?, ?)').bind(username, dummyHash, nickname, '', extId).run()
      user = { id: result.meta.last_row_id, username, nickname, grade: '' }
    }
  } else if (nick_name && nick_name !== user.nickname) {
    // Update nickname if changed from external app
    await db.prepare('UPDATE users SET nickname = ? WHERE id = ?').bind(nick_name, user.id).run()
    user.nickname = nick_name
  }

  // Create session
  const token = generateToken()
  await db.prepare('INSERT INTO sessions (user_id, token, expires_at) VALUES (?, ?, datetime(\'now\', \'+30 days\'))').bind(user.id, token).run()

  return c.json({ success: true, token, user: { id: user.id, username: user.username, nickname: user.nickname, grade: user.grade || '' } })
})

// ===== ì •ìœ¨í†¡ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ í—¬í¼ =====
async function sendPush(senderExternalId: string, receiverExternalId: string, message: string, imageUrl?: string) {
  if (!senderExternalId || !receiverExternalId) return
  try {
    const body: any = { sender_id: senderExternalId, receiver_id: receiverExternalId, message }
    if (imageUrl) body.image_url = imageUrl
    await fetch('https://jungyoul.com/chat_server/api_id.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: Object.keys(body).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(body[k])).join('&')
    })
  } catch (e) {
    console.error('Push notification failed:', e)
  }
}

// Get external_id from internal user id
async function getExternalId(db: D1Database, userId: number): Promise<string | null> {
  const row = await db.prepare('SELECT external_id FROM users WHERE id = ?').bind(userId).first() as any
  return row?.external_id || null
}

// ===== Auth API =====

app.post('/api/auth/register', async (c) => {
  const db = c.env.DB
  const { username, password, nickname, grade } = await c.req.json()
  if (!username || !password) return c.json({ error: 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
  if (username.length < 4) return c.json({ error: 'ì•„ì´ë””ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' }, 400)
  if (password.length < 6) return c.json({ error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' }, 400)
  if (!nickname || nickname.trim().length < 1) return c.json({ error: 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)

  const existing = await db.prepare('SELECT id FROM users WHERE username = ?').bind(username).first()
  if (existing) return c.json({ error: 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.' }, 409)

  const hash = await hashPassword(password)
  const result = await db.prepare('INSERT INTO users (username, password_hash, nickname, grade) VALUES (?, ?, ?, ?)').bind(username, hash, nickname.trim(), grade || '').run()

  const token = generateToken()
  const userId = result.meta.last_row_id
  await db.prepare('INSERT INTO sessions (user_id, token, expires_at) VALUES (?, ?, datetime(\'now\', \'+30 days\'))').bind(userId, token).run()

  return c.json({ success: true, token, user: { id: userId, username, nickname: nickname.trim(), grade: grade || '' } }, 201)
})

app.post('/api/auth/login', async (c) => {
  const db = c.env.DB
  const { username, password } = await c.req.json()
  if (!username || !password) return c.json({ error: 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)

  const hash = await hashPassword(password)
  const user = await db.prepare('SELECT id, username, nickname, grade FROM users WHERE username = ? AND password_hash = ?').bind(username, hash).first() as any
  if (!user) return c.json({ error: 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' }, 401)

  const token = generateToken()
  await db.prepare('INSERT INTO sessions (user_id, token, expires_at) VALUES (?, ?, datetime(\'now\', \'+30 days\'))').bind(user.id, token).run()

  return c.json({ success: true, token, user: { id: user.id, username: user.username, nickname: user.nickname, grade: user.grade } })
})

app.get('/api/auth/me', async (c) => {
  const db = c.env.DB
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'Not logged in' }, 401)
  return c.json({ id: user.id, username: user.username, nickname: user.nickname, grade: user.grade })
})

app.post('/api/auth/logout', async (c) => {
  const db = c.env.DB
  const token = getTokenFromReq(c)
  if (token) await db.prepare('DELETE FROM sessions WHERE token = ?').bind(token).run()
  return c.json({ success: true })
})

app.patch('/api/auth/profile', async (c) => {
  const db = c.env.DB
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'Not logged in' }, 401)
  const { nickname, grade } = await c.req.json()
  const updates: string[] = []
  const params: any[] = []
  if (nickname !== undefined) { updates.push('nickname = ?'); params.push(nickname.trim()) }
  if (grade !== undefined) { updates.push('grade = ?'); params.push(grade) }
  if (updates.length === 0) return c.json({ error: 'No updates' }, 400)
  params.push(user.id)
  await db.prepare(`UPDATE users SET ${updates.join(', ')} WHERE id = ?`).bind(...params).run()
  return c.json({ success: true })
})

// ===== R2 Image API =====

// Upload image to R2 (returns R2 key)
app.post('/api/images/upload', async (c) => {
  const db = c.env.DB
  const r2 = c.env.R2
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  const body = await c.req.json()
  const { image_data, thumbnail_data, type, ref_id } = body
  // type: 'question' | 'answer', ref_id: optional

  if (!image_data) return c.json({ error: 'ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.' }, 400)

  // base64 â†’ binary
  const base64 = image_data.replace(/^data:image\/\w+;base64,/, '')
  const binaryStr = atob(base64)
  const bytes = new Uint8Array(binaryStr.length)
  for (let i = 0; i < binaryStr.length; i++) bytes[i] = binaryStr.charCodeAt(i)

  const contentType = image_data.match(/^data:(image\/\w+);/)?.[1] || 'image/jpeg'
  const ext = contentType === 'image/png' ? 'png' : 'jpg'
  const key = `images/${type || 'question'}/${Date.now()}_${Math.random().toString(36).slice(2, 8)}.${ext}`

  await r2.put(key, bytes.buffer, {
    httpMetadata: { contentType },
    customMetadata: { userId: String(user.id), type: type || 'question' }
  })

  // Upload thumbnail too
  let thumbnailKey = null
  if (thumbnail_data) {
    const tBase64 = thumbnail_data.replace(/^data:image\/\w+;base64,/, '')
    const tBin = atob(tBase64)
    const tBytes = new Uint8Array(tBin.length)
    for (let i = 0; i < tBin.length; i++) tBytes[i] = tBin.charCodeAt(i)
    thumbnailKey = `thumbnails/${type || 'question'}/${Date.now()}_${Math.random().toString(36).slice(2, 8)}.jpg`
    await r2.put(thumbnailKey, tBytes.buffer, {
      httpMetadata: { contentType: 'image/jpeg' },
      customMetadata: { userId: String(user.id), type: 'thumbnail' }
    })
  }

  return c.json({ key, thumbnailKey })
})

// Serve image from R2
app.get('/api/images/:key{.+}', async (c) => {
  const r2 = c.env.R2
  const key = c.req.param('key')
  const object = await r2.get(key)
  if (!object) return c.notFound()

  return new Response(object.body, {
    headers: {
      'Content-Type': object.httpMetadata?.contentType || 'image/jpeg',
      'Cache-Control': 'public, max-age=86400, s-maxage=604800',
      'CDN-Cache-Control': 'max-age=604800',
    }
  })
})

// ===== Questions API =====

// Migrate existing base64 images to R2
app.post('/api/admin/migrate-images', async (c) => {
  const db = c.env.DB
  const r2 = c.env.R2
  
  // Migrate questions
  const questions = await db.prepare("SELECT id, image_data, thumbnail_data FROM questions WHERE image_data IS NOT NULL AND image_data != '' AND (image_key IS NULL OR image_key = '')").all()
  let migrated = 0
  for (const q of (questions.results || []) as any[]) {
    try {
      const base64 = q.image_data.replace(/^data:image\/\w+;base64,/, '')
      const bin = atob(base64)
      const bytes = new Uint8Array(bin.length)
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i)
      const ct = q.image_data.match(/^data:(image\/\w+);/)?.[1] || 'image/jpeg'
      const ext = ct === 'image/png' ? 'png' : 'jpg'
      const key = `images/question/${q.id}_${Date.now()}.${ext}`
      await r2.put(key, bytes.buffer, { httpMetadata: { contentType: ct } })
      
      let tKey: string | null = null
      if (q.thumbnail_data) {
        const tb = q.thumbnail_data.replace(/^data:image\/\w+;base64,/, '')
        const tBin = atob(tb)
        const tBytes = new Uint8Array(tBin.length)
        for (let i = 0; i < tBin.length; i++) tBytes[i] = tBin.charCodeAt(i)
        tKey = `thumbnails/question/${q.id}_${Date.now()}.jpg`
        await r2.put(tKey, tBytes.buffer, { httpMetadata: { contentType: 'image/jpeg' } })
      }
      
      // Update DB: set R2 keys and clear base64 data
      await db.prepare('UPDATE questions SET image_key = ?, thumbnail_key = ?, image_data = NULL, thumbnail_data = NULL WHERE id = ?').bind(key, tKey, q.id).run()
      migrated++
    } catch (e) { /* skip failed */ }
  }
  
  // Migrate answers
  const answers = await db.prepare("SELECT id, image_data FROM answers WHERE image_data IS NOT NULL AND image_data != '' AND (image_key IS NULL OR image_key = '')").all()
  let aMigrated = 0
  for (const a of (answers.results || []) as any[]) {
    try {
      const base64 = a.image_data.replace(/^data:image\/\w+;base64,/, '')
      const bin = atob(base64)
      const bytes = new Uint8Array(bin.length)
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i)
      const ct = a.image_data.match(/^data:(image\/\w+);/)?.[1] || 'image/jpeg'
      const ext = ct === 'image/png' ? 'png' : 'jpg'
      const key = `images/answer/${a.id}_${Date.now()}.${ext}`
      await r2.put(key, bytes.buffer, { httpMetadata: { contentType: ct } })
      await db.prepare('UPDATE answers SET image_key = ?, image_data = NULL WHERE id = ?').bind(key, a.id).run()
      aMigrated++
    } catch (e) { /* skip failed */ }
  }
  
  return c.json({ success: true, questions_migrated: migrated, answers_migrated: aMigrated })
})

// Admin: ëª¨ë“  ì´ë¯¸ì§€ ì‚­ì œ (R2 + DB)
app.post('/api/admin/clear-all-images', async (c) => {
  const db = c.env.DB
  const r2 = c.env.R2
  let deleted = 0

  // ì§ˆë¬¸ ì´ë¯¸ì§€ R2 ì‚­ì œ
  const questions = await db.prepare("SELECT id, image_key, thumbnail_key FROM questions WHERE image_key IS NOT NULL AND image_key != ''").all()
  for (const q of (questions.results || []) as any[]) {
    try {
      if (q.image_key) await r2.delete(q.image_key)
      if (q.thumbnail_key) await r2.delete(q.thumbnail_key)
      deleted++
    } catch (e) { /* skip */ }
  }

  // ë‹µë³€ ì´ë¯¸ì§€ R2 ì‚­ì œ
  const answers = await db.prepare("SELECT id, image_key FROM answers WHERE image_key IS NOT NULL AND image_key != ''").all()
  for (const a of (answers.results || []) as any[]) {
    try {
      if (a.image_key) await r2.delete(a.image_key)
      deleted++
    } catch (e) { /* skip */ }
  }

  // DBì—ì„œ ì´ë¯¸ì§€ ê´€ë ¨ í•„ë“œ ëª¨ë‘ ì´ˆê¸°í™”
  await db.prepare("UPDATE questions SET image_data = NULL, thumbnail_data = NULL, image_key = NULL, thumbnail_key = NULL").run()
  await db.prepare("UPDATE answers SET image_data = NULL, image_key = NULL").run()

  return c.json({ success: true, r2_deleted: deleted, message: 'ëª¨ë“  ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤' })
})

// Admin: ëª¨ë“  ì§ˆë¬¸/ë‹µë³€/ë§¤ì¹­ ë°ì´í„° ì‚­ì œ
app.post('/api/admin/clear-all-data', async (c) => {
  const db = c.env.DB
  const r2 = c.env.R2

  // R2 ì´ë¯¸ì§€ ë¨¼ì € ì‚­ì œ
  const qImgs = await db.prepare("SELECT image_key, thumbnail_key FROM questions WHERE image_key IS NOT NULL AND image_key != ''").all()
  for (const q of (qImgs.results || []) as any[]) {
    try { if (q.image_key) await r2.delete(q.image_key); if (q.thumbnail_key) await r2.delete(q.thumbnail_key) } catch(e) {}
  }
  const aImgs = await db.prepare("SELECT image_key FROM answers WHERE image_key IS NOT NULL AND image_key != ''").all()
  for (const a of (aImgs.results || []) as any[]) {
    try { if (a.image_key) await r2.delete(a.image_key) } catch(e) {}
  }

  // í…Œì´ë¸” ë°ì´í„° ì‚­ì œ (ìˆœì„œ ì¤‘ìš”: FK ì˜ì¡´ì„±)
  const tables = ['cancel_records','tutoring_slots','tutoring_matches','answer_replies','answers','questions']
  for (const t of tables) {
    try { await db.prepare(`DELETE FROM ${t}`).run() } catch(e) {}
  }

  return c.json({ success: true, message: 'ëª¨ë“  ì§ˆë¬¸/ë‹µë³€ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤' })
})

app.get('/api/questions', async (c) => {
  const db = c.env.DB
  const subject = c.req.query('subject')
  const difficulty = c.req.query('difficulty')
  const category = c.req.query('category') // 'normal' | 'killer' | 'tutoring' | undefined(all)
  const search = c.req.query('search')
  const sort = c.req.query('sort') || 'latest'
  const page = parseInt(c.req.query('page') || '0')
  const limit = parseInt(c.req.query('limit') || '0')

  let baseWhere = ' WHERE 1=1'
  const params: any[] = []

  // Category filter (excludes difficulty filter when used)
  if (category === 'normal') {
    baseWhere += " AND (difficulty IS NULL OR (difficulty != 'ìµœìƒ' AND difficulty != '1:1ì‹¬í™”ì„¤ëª…'))"
  } else if (category === 'killer') {
    baseWhere += " AND difficulty = 'ìµœìƒ'"
  } else if (category === 'tutoring') {
    baseWhere += " AND difficulty = '1:1ì‹¬í™”ì„¤ëª…'"
  } else if (difficulty && difficulty !== 'ì „ì²´') {
    baseWhere += ' AND difficulty = ?'
    params.push(difficulty)
  }

  if (subject && subject !== 'ì „ì²´') {
    baseWhere += ' AND subject = ?'
    params.push(subject)
  }
  if (search) {
    baseWhere += ' AND content LIKE ?'
    params.push(`%${search}%`)
  }

  // Get total count for pagination
  const countResult = await db.prepare('SELECT COUNT(*) as total FROM questions' + baseWhere).bind(...params).first() as any
  const total = countResult?.total || 0

  let query = 'SELECT id, user_id, title, author_name, author_grade, content, subject, difficulty, comment_count, status, reward_points, created_at, CASE WHEN (image_data IS NOT NULL AND image_data != \'\') OR (image_key IS NOT NULL AND image_key != \'\') THEN 1 ELSE 0 END as has_image, thumbnail_data, image_key, thumbnail_key, ai_difficulty, ai_tags, ai_topic_main, ai_analyzed FROM questions' + baseWhere

  // Sort options
  if (sort === 'answers_asc') query += ' ORDER BY comment_count ASC, created_at DESC'
  else if (sort === 'points') query += ' ORDER BY reward_points DESC, created_at DESC'
  else if (sort === 'unanswered') query += ' ORDER BY CASE WHEN comment_count = 0 THEN 0 ELSE 1 END, created_at DESC'
  else query += ' ORDER BY created_at DESC'

  // Pagination (only when limit > 0)
  if (limit > 0) {
    const offset = page * limit
    query += ' LIMIT ? OFFSET ?'
    params.push(limit, offset)
  }

  const result = await db.prepare(query).bind(...params).all()
  const questions = result.results || []
  
  // Get current user for match status
  const token = getTokenFromReq(c)
  const currentApiUser = token ? await getUser(db, token) as any : null
  
  // Get IDs of questions where current user answered or tutored
  let myAnsweredIds = new Set<number>()
  let myAcceptedIds = new Set<number>()
  if (currentApiUser) {
    const myAnswers = await db.prepare('SELECT DISTINCT question_id FROM answers WHERE user_id = ?').bind(currentApiUser.id).all()
    for (const a of (myAnswers.results || []) as any[]) myAnsweredIds.add(a.question_id)
    const myAccepted = await db.prepare('SELECT DISTINCT question_id FROM answers WHERE user_id = ? AND is_accepted = 1').bind(currentApiUser.id).all()
    for (const a of (myAccepted.results || []) as any[]) myAcceptedIds.add(a.question_id)
    const myTutoring = await db.prepare('SELECT DISTINCT question_id FROM tutoring_matches WHERE tutor_id = ?').bind(currentApiUser.id).all()
    for (const t of (myTutoring.results || []) as any[]) myAnsweredIds.add(t.question_id)
    const myAcceptedTutoring = await db.prepare("SELECT DISTINCT question_id FROM tutoring_matches WHERE tutor_id = ? AND status = 'accepted'").bind(currentApiUser.id).all()
    for (const t of (myAcceptedTutoring.results || []) as any[]) myAcceptedIds.add(t.question_id)
  }

  // For 1:1 tutoring questions, check pending match status
  for (const q of questions as any[]) {
    // Mark if current user answered/participated
    if (currentApiUser) {
      q.i_answered = myAnsweredIds.has(q.id) ? 1 : 0
      q.i_accepted = myAcceptedIds.has(q.id) ? 1 : 0
    }
    if (q.difficulty === '1:1ì‹¬í™”ì„¤ëª…') {
      const pm = await db.prepare("SELECT id, tutor_name FROM tutoring_matches WHERE question_id = ? AND status = 'pending' LIMIT 1").bind(q.id).first() as any
      const cm = await db.prepare("SELECT id, tutor_id FROM tutoring_matches WHERE question_id = ? AND status = 'confirmed' LIMIT 1").bind(q.id).first() as any
      q.has_pending_match = pm ? 1 : 0
      q.pending_tutor_name = pm ? pm.tutor_name : null
      q.has_confirmed_match = cm ? 1 : 0
      // Check if current user is the matched tutor
      if (currentApiUser) {
        const myMatch = await db.prepare("SELECT id, status FROM tutoring_matches WHERE question_id = ? AND tutor_id = ? LIMIT 1").bind(q.id, currentApiUser.id).first() as any
        q.my_match_status = myMatch ? myMatch.status : null  // 'pending' or 'confirmed' or null
      }
    }
  }
  return c.json({ questions, total, page, limit })
})

app.get('/api/questions/:id', async (c) => {
  const db = c.env.DB
  const id = c.req.param('id')
  let question: any
  try {
    question = await db.prepare('SELECT id, user_id, title, author_name, author_grade, content, subject, difficulty, comment_count, status, reward_points, created_at, CASE WHEN (image_data IS NOT NULL AND image_data != \'\') OR (image_key IS NOT NULL AND image_key != \'\') THEN 1 ELSE 0 END as has_image, image_key, thumbnail_key, ai_difficulty, ai_tags, ai_topic_main, ai_topic_sub, ai_description, ai_grade_level, ai_estimated_time, ai_analyzed, question_type, student_question_text, ai_question_analysis, ai_coaching_comment, ai_next_questions, ai_growth_coaching, ai_model, ai_coaching_data FROM questions WHERE id = ?').bind(id).first()
  } catch (e) {
    try { await db.prepare('ALTER TABLE questions ADD COLUMN ai_next_questions TEXT DEFAULT NULL').run() } catch(e2){}
    question = await db.prepare('SELECT id, user_id, title, author_name, author_grade, content, subject, difficulty, comment_count, status, reward_points, created_at, CASE WHEN (image_data IS NOT NULL AND image_data != \'\') OR (image_key IS NOT NULL AND image_key != \'\') THEN 1 ELSE 0 END as has_image, image_key, thumbnail_key, ai_difficulty, ai_tags, ai_topic_main, ai_topic_sub, ai_description, ai_grade_level, ai_estimated_time, ai_analyzed, question_type, student_question_text, ai_question_analysis, ai_coaching_comment, ai_next_questions, ai_growth_coaching, ai_model, ai_coaching_data FROM questions WHERE id = ?').bind(id).first()
  }
  if (!question) return c.json({ error: 'Not found' }, 404)
  return c.json(question)
})

app.get('/api/questions/:id/image', async (c) => {
  const db = c.env.DB
  const r2 = c.env.R2
  const id = c.req.param('id')
  const type = c.req.query('type') // 'thumb' for thumbnail
  
  // Check for R2 key first
  const row = await db.prepare('SELECT image_data, thumbnail_data, image_key, thumbnail_key FROM questions WHERE id = ?').bind(id).first() as any
  if (!row) return c.json({ error: 'Not found' }, 404)
  
  // R2 path: serve directly from R2
  const r2Key = type === 'thumb' ? (row.thumbnail_key || row.image_key) : row.image_key
  if (r2Key) {
    const object = await r2.get(r2Key)
    if (object) {
      return new Response(object.body, {
        headers: {
          'Content-Type': object.httpMetadata?.contentType || 'image/jpeg',
          'Cache-Control': 'public, max-age=86400, s-maxage=604800',
        }
      })
    }
  }
  
  // Fallback: base64 from DB
  const data = type === 'thumb' ? (row.thumbnail_data || row.image_data) : row.image_data
  if (!data) return c.json({ error: 'Not found' }, 404)
  c.header('Cache-Control', 'public, max-age=86400, s-maxage=604800')
  return c.json({ data })
})

app.post('/api/questions', async (c) => {
  const db = c.env.DB
  const body = await c.req.json()
  const { content, image_data, thumbnail_data, image_key, thumbnail_key, subject: userSubject, is_killer, is_tutoring } = body

  // Auth check
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  // Suspension check for 1:1 tutoring questions
  if (is_tutoring) {
    const suspended = await checkSuspension(db, user.id)
    if (suspended) return c.json({ error: '1:1 íŠœí„°ë§ ì´ìš©ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. (' + suspended + 'ê¹Œì§€)' }, 403)
  }

  if (!content || content.trim().length < 10) {
    return c.json({ error: 'ì§ˆë¬¸ ë‚´ìš©ì„ 10ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.' }, 400)
  }

  const title = content.trim().length > 30 ? content.trim().slice(0, 30) + '...' : content.trim()

  let subject = userSubject || 'ê¸°íƒ€'
  if (!userSubject) {
    const allText = content.toLowerCase()
    if (/ì˜ì–´|english|grammar|word|vocab|reading|listening|whose|which|likely/i.test(allText)) subject = 'ì˜ì–´'
    else if (/ìˆ˜í•™|math|í•¨ìˆ˜|ë°©ì •ì‹|ë¯¸ì ë¶„|í™•ë¥ |í†µê³„|ê¸°í•˜|ë²¡í„°|í–‰ë ¬|ìˆ˜ì—´|ê·¹í•œ/i.test(allText)) subject = 'ìˆ˜í•™'
    else if (/êµ­ì–´|ë¬¸í•™|ë¹„ë¬¸í•™|ë…ì„œ|í™”ë²•|ì‘ë¬¸|ë¬¸ë²•|ê³ ì „|ì‹œ|ì†Œì„¤|ìˆ˜ëŠ¥êµ­ì–´/i.test(allText)) subject = 'êµ­ì–´'
    else if (/ê³¼í•™|ë¬¼ë¦¬|í™”í•™|ìƒë¬¼|ìƒëª…|ì§€êµ¬|ì²œë¬¸|ì‹¤í—˜|ê³¼íƒ/i.test(allText)) subject = 'ê³¼í•™'
  }

  let difficulty = 'ì¤‘'
  let reward_points = 0
  if (is_killer) {
    difficulty = 'ìµœìƒ'
    reward_points = [10,20,30].includes(body.reward_points) ? body.reward_points : 0
  } else if (body.is_tutoring) {
    difficulty = '1:1ì‹¬í™”ì„¤ëª…'
    reward_points = [50,80,100].includes(body.reward_points) ? body.reward_points : 0
  } else {
    const allText = content.toLowerCase()
    if (/ìˆ˜ëŠ¥|ëª¨ì˜ê³ ì‚¬|í‚¬ëŸ¬|ìµœìƒ|ebs.*ì—°ê³„|ê³ 3.*ëª¨ì˜/i.test(allText)) difficulty = 'ìµœìƒ'
    else if (/ì‹¬í™”|ì–´ë ¤|ê³ 3|ì‘ìš©|ì„œìˆ í˜•/i.test(allText)) difficulty = 'ìƒ'
    else if (/ê¸°ì´ˆ|ê¸°ë³¸|ì‰¬ìš´|ê³ 1|ê°œë…/i.test(allText)) difficulty = 'í•˜'
  }

  const result = await db.prepare(
    'INSERT INTO questions (user_id, author_name, author_grade, title, content, image_data, thumbnail_data, image_key, thumbnail_key, subject, difficulty, reward_points) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)'
  ).bind(user.id, user.nickname, user.grade, title, content.trim(), image_key ? null : (image_data || null), image_key ? null : (thumbnail_data || null), image_key || null, thumbnail_key || null, subject, difficulty, reward_points).run()

  // Save tutoring time slots
  const qId = result.meta.last_row_id
  if (body.is_tutoring && Array.isArray(body.tutoring_slots)) {
    for (const slot of body.tutoring_slots.slice(0, 3)) {
      await db.prepare('INSERT INTO tutoring_slots (question_id, slot_time) VALUES (?, ?)').bind(qId, String(slot)).run()
    }
  }

  // Trigger AI analysis asynchronously (non-blocking) with slight delay for R2 consistency
  const geminiKey = c.env.GEMINI_API_KEY
  if (geminiKey && (image_data || image_key)) {
    c.executionCtx.waitUntil(
      new Promise(r => setTimeout(r, 1500)).then(() =>
        analyzeQuestionWithAI(db, c.env, qId, subject, content.trim(), image_key, image_data)
      )
    )
  }

  return c.json({ id: qId, subject, difficulty, message: 'Question created' }, 201)
})

// === AI Question Analysis with Gemini 3 Pro ===

const CURRICULUM_PROMPT = `ë‹¹ì‹ ì€ í•œêµ­ ê³ ë“±í•™êµ êµìœ¡ê³¼ì • ì „ë¬¸ê°€ì´ì OCR ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

[ê°€ì¥ ì¤‘ìš”í•œ ì§€ì‹œì‚¬í•­ - ì´ë¯¸ì§€ ì† í•„ê¸° ì¸ì‹]
ì´ë¯¸ì§€ì—ëŠ” ì¸ì‡„ëœ ìˆ˜í•™ ë¬¸ì œì™€ í•¨ê»˜ **í•™ìƒì´ ì†ìœ¼ë¡œ ì“´ í•„ê¸°(ì†ê¸€ì”¨, íœ ë©”ëª¨, í˜•ê´‘íœ í‘œì‹œ)**ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë°˜ë“œì‹œ ë‹¤ìŒ ìˆœì„œë¡œ ë¶„ì„í•˜ì„¸ìš”:
1ë‹¨ê³„: ì´ë¯¸ì§€ì—ì„œ ì¸ì‡„ëœ ë¬¸ì œ í…ìŠ¤íŠ¸ë¥¼ ì½ìœ¼ì„¸ìš”.
2ë‹¨ê³„: ì´ë¯¸ì§€ì—ì„œ **í•™ìƒì´ ì†ìœ¼ë¡œ ì“´ í•„ê¸°/ë©”ëª¨/ì§ˆë¬¸**ì„ ì°¾ì•„ ì½ìœ¼ì„¸ìš”. (ì˜ˆ: "ì´ê±° ì™œ ì´ë˜?", "ì—¬ê¸°ì„œ ë­˜ ì¨ì•¼í•´?", "í’€ì´ ë§ë‚˜ìš”?", ë¬¼ìŒí‘œ, ë°‘ì¤„, í™”ì‚´í‘œ ë“±)
3ë‹¨ê³„: í•„ê¸°ê°€ ì—†ìœ¼ë©´ ì¸ì‡„ëœ ë¬¸ì œ ìì²´ë¥¼ í•™ìƒì˜ ì§ˆë¬¸ìœ¼ë¡œ ê°„ì£¼í•˜ì„¸ìš”.
4ë‹¨ê³„: í•™ìƒì˜ ì§ˆë¬¸ ì˜ë„ë¥¼ íŒŒì•…í•˜ì—¬ ì•„ë˜ 7ìœ í˜• ì¤‘ í•˜ë‚˜ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”.

student_question í•„ë“œì—ëŠ” ì´ë¯¸ì§€ì—ì„œ ì¸ì‹í•œ **í•™ìƒì˜ ì‹¤ì œ í•„ê¸° ë‚´ìš©**ì„ ê·¸ëŒ€ë¡œ ì ì–´ì£¼ì„¸ìš”.
í•„ê¸°ê°€ ì—†ìœ¼ë©´ "(í•„ê¸° ì—†ìŒ - ë¬¸ì œ í’€ì´ ìš”ì²­)"ì´ë¼ê³  ì ì–´ì£¼ì„¸ìš”.

[ê³¼ëª©ë³„ êµìœ¡ê³¼ì • ì²´ê³„]

â–  ìˆ˜í•™:
- ê³µí†µìˆ˜í•™1: ë‹¤í•­ì‹(ì—°ì‚°,ë‚˜ë¨¸ì§€ì •ë¦¬,ì¸ìˆ˜ë¶„í•´), ë°©ì •ì‹ê³¼ë¶€ë“±ì‹(ë³µì†Œìˆ˜,ì´ì°¨ë°©ì •ì‹,ì´ì°¨í•¨ìˆ˜,ê³ ì°¨ë°©ì •ì‹,ë¶€ë“±ì‹), ê²½ìš°ì˜ìˆ˜(í•©ê³±ë²•ì¹™,ìˆœì—´,ì¡°í•©), í–‰ë ¬
- ê³µí†µìˆ˜í•™2: ë„í˜•ì˜ë°©ì •ì‹(í‰ë©´ì¢Œí‘œ,ì§ì„ ,ì›,ì´ë™), ì§‘í•©ê³¼ëª…ì œ(ì§‘í•©,ëª…ì œ), í•¨ìˆ˜ì™€ê·¸ë˜í”„(í•¨ìˆ˜,ìœ ë¦¬í•¨ìˆ˜,ë¬´ë¦¬í•¨ìˆ˜)
- ëŒ€ìˆ˜: ì§€ìˆ˜í•¨ìˆ˜ì™€ë¡œê·¸í•¨ìˆ˜(ì§€ìˆ˜,ë¡œê·¸,ì§€ìˆ˜í•¨ìˆ˜,ë¡œê·¸í•¨ìˆ˜), ì‚¼ê°í•¨ìˆ˜(í˜¸ë„ë²•,ì‚¼ê°í•¨ìˆ˜,ê·¸ë˜í”„,ì‚¬ì¸ì½”ì‚¬ì¸ë²•ì¹™), ìˆ˜ì—´(ë“±ì°¨ìˆ˜ì—´,ë“±ë¹„ìˆ˜ì—´,ì‹œê·¸ë§ˆ,ìˆ˜í•™ì ê·€ë‚©ë²•)
- ë¯¸ì ë¶„1: í•¨ìˆ˜ì˜ê·¹í•œê³¼ì—°ì†, ë¯¸ë¶„(ë¯¸ë¶„ê³„ìˆ˜,ë„í•¨ìˆ˜,í™œìš©), ì ë¶„(ë¶€ì •ì ë¶„,ì •ì ë¶„,í™œìš©)
- í™•ë¥ ê³¼í†µê³„: ìˆœì—´ì¡°í•©(ì¤‘ë³µìˆœì—´,ì¤‘ë³µì¡°í•©,ì´í•­ì •ë¦¬), í™•ë¥ (í™•ë¥ ì˜ëœ»,ì¡°ê±´ë¶€í™•ë¥ ), í†µê³„(í™•ë¥ ë¶„í¬,ì •ê·œë¶„í¬,í†µê³„ì ì¶”ì •)
- ë¯¸ì ë¶„2: ìˆ˜ì—´ì˜ê·¹í•œ, ê¸‰ìˆ˜, ì—¬ëŸ¬ê°€ì§€ë¯¸ë¶„ë²•, ì—¬ëŸ¬ê°€ì§€ì ë¶„ë²•
- ê¸°í•˜: ì´ì°¨ê³¡ì„ , ë²¡í„°, ê³µê°„ë„í˜•, ê³µê°„ì¢Œí‘œ
- ìˆ˜í•™I(2015): ì§€ìˆ˜ë¡œê·¸í•¨ìˆ˜, ì‚¼ê°í•¨ìˆ˜, ìˆ˜ì—´
- ìˆ˜í•™II(2015): í•¨ìˆ˜ì˜ê·¹í•œê³¼ì—°ì†, ë¯¸ë¶„, ì ë¶„

â–  êµ­ì–´:
- ë¬¸í•™: ì„œì •ê°ˆë˜(í˜„ëŒ€ì‹œ,ê³ ì „ì‹œê°€), ì„œì‚¬ê°ˆë˜(í˜„ëŒ€ì†Œì„¤,ê³ ì „ì†Œì„¤), ê·¹ê°ˆë˜(í¬ê³¡,ì‹œë‚˜ë¦¬ì˜¤), êµìˆ ê°ˆë˜(í˜„ëŒ€ìˆ˜í•„,ê³ ì „ìˆ˜í•„), ê°ˆë˜ë³µí•©
- ë…ì„œì™€ì‘ë¬¸: ë…ì„œì™€ì‘ë¬¸ì˜ë³¸ì§ˆ, ì¸ë¬¸ì˜ˆìˆ , ì‚¬íšŒë¬¸í™”, ê³¼í•™ê¸°ìˆ 
- í™”ë²•ê³¼ì–¸ì–´: í™”ë²•(ê°•ì—°,ë°œí‘œ,ì—°ì„¤,í† ì˜,í† ë¡ ), ì–¸ì–´(ìŒìš´ë¡ ,í˜•íƒœë¡ ,í†µì‚¬ë¡ ,ë¬¸ë²•ìš”ì†Œ,ì¤‘ì„¸êµ­ì–´,êµ­ì–´ê·œë²”)
- ë…ì„œ(2015): ë…ì„œì´ë¡ , ì¸ë¬¸ì˜ˆìˆ , ì‚¬íšŒë¬¸í™”, ê³¼í•™ê¸°ìˆ , ë³µí•©ì§€ë¬¸
- ë¬¸í•™(2015): ì„œì •(í˜„ëŒ€ì‹œ,ê³ ì „ì‹œê°€), ì„œì‚¬(í˜„ëŒ€ì†Œì„¤,ê³ ì „ì†Œì„¤), ê·¹(í¬ê³¡,ì‹œë‚˜ë¦¬ì˜¤), êµìˆ (ìˆ˜í•„), ê°ˆë˜ë³µí•©
- ì–¸ì–´ì™€ë§¤ì²´(2015): ìŒìš´ë¡ ,í˜•íƒœë¡ ,í†µì‚¬ë¡ ,ì˜ë¯¸ë¡ ,ì¤‘ì„¸êµ­ì–´,ë§¤ì²´

â–  ì˜ì–´:
- ìˆ˜ëŠ¥ì˜ì–´: ë“£ê¸°, ê¸°ë³¸ë…í•´(ëª©ì ,ì‹¬ê²½,ì£¼ì¥,ì¼ì¹˜ë¶ˆì¼ì¹˜,ë„í‘œ), êµ¬ë¬¸ë…í•´(ìš”ì§€,ì£¼ì œ,ì œëª©,ì–´ìƒ‰í•œë¬¸ì¥), ì–´ë²•, ì¶”ë¡ (í•¨ì¶•ì˜ë¯¸,ë¹ˆì¹¸ì¶”ë¡ ,ì–´íœ˜ì¶”ë¡ ), ê°„ì ‘ì“°ê¸°(ìˆœì„œë°°ì—´,ë¬¸ì¥ì‚½ì…,ìš”ì•½ë¬¸), ì¥ë¬¸ë…í•´
- ë‚´ì‹ ì˜ì–´: ê°ê´€ì‹(ë‚´ìš©ë¶ˆì¼ì¹˜,ë¹ˆì¹¸ì¶”ë¡ ,ìˆœì„œ,ì–´ë²•,ì–´íœ˜,ìš”ì§€,ì œëª©,ì£¼ì œ), ì„œìˆ í˜•(ì˜ì‘,ì–´ë²•ìˆ˜ì •,ì–´íœ˜ìˆ˜ì •,ìš”ì•½ë¬¸)

â–  ê³¼í•™:
- í†µí•©ê³¼í•™1: ê³¼í•™ì˜ê¸°ì´ˆ(ê¸°ë³¸ëŸ‰ì¸¡ì •,ì •ë³´ì‹ í˜¸), ë¬¼ì§ˆê³¼ê·œì¹™ì„±(ë¬¼ì§ˆíƒ„ìƒ,ì£¼ê¸°ì„±,í™”í•™ê²°í•©,ìì—°êµ¬ì„±ë¬¼ì§ˆ), ì‹œìŠ¤í…œê³¼ìƒí˜¸ì‘ìš©(ì—­í•™ì ì‹œìŠ¤í…œ,ì§€êµ¬ì‹œìŠ¤í…œ,ìƒëª…ì‹œìŠ¤í…œ)
- í†µí•©ê³¼í•™2: ë³€í™”ì™€ë‹¤ì–‘ì„±(ì§€ì§ˆì‹œëŒ€,í™”í•™ë³€í™”), í™˜ê²½ê³¼ì—ë„ˆì§€(ìƒíƒœê³„,ë°œì „ì—ë„ˆì§€), ê³¼í•™ê³¼ë¯¸ë˜ì‚¬íšŒ(ê°ì—¼ë³‘,ê³¼í•™ê¸°ìˆ ìœ¤ë¦¬)
- ë¬¼ë¦¬í•™: í˜ê³¼ì—ë„ˆì§€(í˜ìš´ë™,ì—ë„ˆì§€ì—´), ì „ê¸°ì™€ìê¸°(ì „ê¸°,ìê¸°), ë¹›ê³¼ë¬¼ì§ˆ(ë¹›ì˜ì„±ì§ˆ,ì´ì¤‘ì„±,íŠ¹ìˆ˜ìƒëŒ€ì„±ì´ë¡ )
- í™”í•™: í™”í•™ì˜ì–¸ì–´(ëª°,í™”í•™ë°˜ì‘ì‹), ë¬¼ì§ˆì˜êµ¬ì¡°ì™€ì„±ì§ˆ(í™”í•™ê²°í•©,ë¶„ìêµ¬ì¡°), í™”í•™í‰í˜•(ë™ì í‰í˜•), ì—­ë™ì ì¸í™”í•™ë°˜ì‘(ì‚°ì—¼ê¸°,ì¤‘í™”ë°˜ì‘)
- ìƒëª…ê³¼í•™: ìƒëª…ì‹œìŠ¤í…œì˜êµ¬ì„±(ìƒëª…ê³¼í•™ì´í•´,êµ¬ì„±ë‹¨ê³„,ìƒíƒœê³„), í•­ìƒì„±ê³¼ì¡°ì ˆ(ì‹ ê²½ê³„,ë°©ì–´ì‘ìš©), ìƒëª…ì˜ì—°ì†ì„±ê³¼ë‹¤ì–‘ì„±(ì„¸í¬ë¶„ì—´,ìœ ì „,ì§„í™”)
- ì§€êµ¬ê³¼í•™: ëŒ€ê¸°ì™€í•´ì–‘(í•´ì–‘ë³€í™”,ëŒ€ê¸°ë³€í™”ê¸°í›„), ì§€êµ¬ì˜ì—­ì‚¬ì™€ì•”ì„(ì§€êµ¬ì—­ì‚¬,ì•”ì„ì§€ì§ˆêµ¬ì¡°), ìš°ì£¼ì™€ë³„(íƒœì–‘ê³„,ë³„ì˜íŠ¹ì„±ì§„í™”,ìš°ì£¼êµ¬ì¡°)

[ë¶„ì„ ê·œì¹™]
1. ë°˜ë“œì‹œ ìœ„ êµìœ¡ê³¼ì • ì²´ê³„ì—ì„œ ë§¤ì¹­ë˜ëŠ” ê³¼ëª©ëª…, ëŒ€ë‹¨ì›, ì†Œë‹¨ì›ì„ ì°¾ìœ¼ì„¸ìš”.
2. íƒœê·¸ëŠ” ì¸ìŠ¤íƒ€ê·¸ë¨ í•´ì‹œíƒœê·¸ í˜•ì‹ìœ¼ë¡œ ìƒì„± (ì˜ˆ: #ê³µí†µìˆ˜í•™1, #ì´ì°¨ë°©ì •ì‹, #íŒë³„ì‹)
3. ì˜ˆìƒ í’€ì´ì‹œê°„ì€ ë¶„ ë‹¨ìœ„ ì •ìˆ˜

[â˜… ë‚œì´ë„ íŒì • ê¸°ì¤€ â€” ë¬¸ì œ ìì²´ì˜ ê°ê´€ì  ë‚œì´ë„ë¥¼ íŒë‹¨í•˜ì„¸ìš” â˜…]
ë°˜ë“œì‹œ ë¬¸ì œì˜ ì‹¤ì§ˆì  ë‚œì´ë„ë¥¼ ì •í™•íˆ í‰ê°€í•˜ì„¸ìš”. â˜…3(ë³´í†µ)ì— ì•ˆì£¼í•˜ì§€ ë§ˆì„¸ìš”!

â˜…1 (ê¸°ì´ˆê°œë…) â€” ì •ë‹µë¥  90%â†‘:
  ìˆ˜í•™: ë‹¨ìˆœ ì‚¬ì¹™ì—°ì‚°, ê¸°ì´ˆ ê³µì‹ ëŒ€ì…, êµê³¼ì„œ ì˜ˆì œ ìˆ˜ì¤€
  êµ­ì–´: ì§ì ‘ì  ë‚´ìš© í™•ì¸, ì‚¬ì‹¤ì  ì´í•´
  ì˜ì–´: ê¸°ì´ˆ ì–´íœ˜/ë¬¸ë²•, ì§§ì€ ë¬¸ì¥ í•´ì„
  ê³¼í•™: ìš©ì–´ ì •ì˜, ë‹¨ìˆœ ê°œë… í™•ì¸

â˜…2 (ê¸°ë³¸) â€” ì •ë‹µë¥  70~89%:
  ìˆ˜í•™: êµê³¼ì„œ ê¸°ë³¸ ë¬¸ì œ, ë‹¨ì¼ ê°œë… ì ìš©, ê¸°ë³¸ ê³„ì‚° ë¬¸ì œ
  êµ­ì–´: í•µì‹¬ ë‚´ìš© íŒŒì•…, ê¸°ë³¸ ì¶”ë¡ , ëª…ì‹œì  ê·¼ê±° ì°¾ê¸°
  ì˜ì–´: ê¸°ë³¸ ë…í•´, ì£¼ì œ/ìš”ì§€ íŒŒì•…, ê¸°ì´ˆ ë¬¸ë²•
  ê³¼í•™: ê¸°ë³¸ ì›ë¦¬ ì ìš©, ë‹¨ìˆœ ê³„ì‚°, ê°œë… ì—°ê²°

â˜…3 (ë³´í†µ) â€” ì •ë‹µë¥  50~69%:
  ìˆ˜í•™: 2ê°œ ì´ìƒ ê°œë… ê²°í•©, í•™êµ ë‚´ì‹  ì¤‘ê°„ ìˆ˜ì¤€, ì¡°ê±´ í•´ì„ í•„ìš”
  êµ­ì–´: ê°„ì ‘ ì¶”ë¡ , ë¹„íŒì  ì´í•´, ê´€ì  ë¹„êµ
  ì˜ì–´: ë¹ˆì¹¸ ì¶”ë¡ , ë¬¸ì¥ ì‚½ì…, ì¤‘ê¸‰ ì–´íœ˜
  ê³¼í•™: ë‹¤ë‹¨ê³„ ê³„ì‚°, ê°œë… í†µí•©, ì‹¤í—˜ ê²°ê³¼ í•´ì„

â˜…4 (ì‹¬í™”) â€” ì •ë‹µë¥  30~49%:
  ìˆ˜í•™: ìˆ˜ëŠ¥ 3~4ì ê¸‰, ë‹¤ë‹¨ê³„ í’€ì´, ì¡°ê±´ë¶„ì„+ì „ëµì„ íƒ í•„ìš”, í•¨ìˆ˜ í•©ì„±/ë¯¸ì ë¶„ ì‘ìš©
  êµ­ì–´: ë³µí•©ì§€ë¬¸, ì¶”ìƒì  ê°œë… ë¹„êµ, EBS ì—°ê³„ ê³ ë‚œë„
  ì˜ì–´: ê³ ë‚œë„ ë¹ˆì¹¸, ë³µì¡í•œ ë…¼ë¦¬ êµ¬ì¡° íŒŒì•…, í•¨ì¶• ì˜ë¯¸
  ê³¼í•™: ë³µí•© ê°œë…, ì‹¤í—˜ ì„¤ê³„ ë¶„ì„, ì •ëŸ‰ì  ì¶”ë¡ 

â˜…5 (ìµœìƒìœ„/í‚¬ëŸ¬) â€” ì •ë‹µë¥  30%â†“:
  ìˆ˜í•™: ìˆ˜ëŠ¥ í‚¬ëŸ¬ë¬¸í•­(21ë²ˆ/22ë²ˆ/30ë²ˆê¸‰), ìˆ˜í•™ì  ì§ê´€+ì°½ì˜ì  ì ‘ê·¼ í•„ìš”, í•¨ìˆ˜Â·ë¯¸ì ë¶„Â·í™•ë¥  ë³µí•©
  êµ­ì–´: ìˆ˜ëŠ¥ ìµœê³ ë‚œë„(ë¹„ë¬¸í•™ ë§ˆì§€ë§‰ ë¬¸í•­ê¸‰), ê³ ë„ì˜ ì¶”ë¡ 
  ì˜ì–´: ìˆ˜ëŠ¥ ìµœê³ ë‚œë„(ë¹ˆì¹¸/ìˆœì„œ ìµœìƒìœ„), í•™ìˆ  í…ìŠ¤íŠ¸ ì‹¬ì¸µ ë¶„ì„
  ê³¼í•™: í‚¬ëŸ¬ë¬¸í•­, ë†’ì€ ìˆ˜í•™ì  ì—­ëŸ‰ ìš”êµ¬, ë³µí•© ë¶„ì„

ì£¼ì˜ì‚¬í•­:
- ë¬¸ì œ ì´ë¯¸ì§€ë¥¼ ê¼¼ê¼¼íˆ ë¶„ì„í•˜ì—¬ ì‹¤ì œ í’€ì´ì— í•„ìš”í•œ ê°œë… ìˆ˜, ë‹¨ê³„ ìˆ˜, ì‚¬ê³  ê¹Šì´ë¥¼ íŒŒì•…í•˜ì„¸ìš”
- ìˆ˜ëŠ¥/ëª¨ì˜ê³ ì‚¬ ì¶œì²˜ ë¬¸ì œëŠ” ì‹¤ì œ ë“±ê¸‰ì»· ê¸°ë°˜ìœ¼ë¡œ íŒë‹¨í•˜ì„¸ìš” (í‚¬ëŸ¬=â˜…5, ì¤€í‚¬ëŸ¬=â˜…4)
- ê³ 1 ê³µí†µìˆ˜í•™ ë¬¸ì œë¼ë„ ë³µí•©ì ì´ë©´ â˜…4 ì´ìƒ ê°€ëŠ¥
- "ì´ê±° ëª¨ë¥´ê² ì–´ìš”"ë¼ëŠ” í•™ìƒ ë°˜ì‘ì— ì†ì§€ ë§ˆì„¸ìš” â€” ì‰¬ìš´ ë¬¸ì œë„ í•™ìƒì´ ëª¨ë¥¼ ìˆ˜ ìˆìŒ
- ì ˆëŒ€ ëª¨ë“  ë¬¸ì œë¥¼ â˜…3ìœ¼ë¡œ ì£¼ì§€ ë§ˆì„¸ìš”. ë°˜ë“œì‹œ ë³€ë³„ë ¥ ìˆê²Œ íŒë‹¨í•˜ì„¸ìš”
- í™•ì‹ ì´ ì—†ìœ¼ë©´ â˜…3ì´ ì•„ë‹ˆë¼, ë¬¸ì œì— í•„ìš”í•œ ê°œë…ì˜ ìˆ˜ì™€ í’€ì´ ë‹¨ê³„ë¥¼ ì„¸ì–´ë³´ì„¸ìš”:
  Â· ê°œë… 1ê°œ + ë‹¨ìˆœ ëŒ€ì…/ê³„ì‚° â†’ â˜…1~â˜…2
  Â· ê°œë… 2ê°œ ê²°í•© + 2~3ë‹¨ê³„ í’€ì´ â†’ â˜…3
  Â· ê°œë… 3ê°œâ†‘ ê²°í•© + 4ë‹¨ê³„â†‘ í’€ì´ + ì¡°ê±´ ë¶„ì„ â†’ â˜…4
  Â· ìˆ˜ëŠ¥ í‚¬ëŸ¬/ì¤€í‚¬ëŸ¬ê¸‰ ë³µí•©ë¬¸í•­, ì°½ì˜ì  ì ‘ê·¼ í•„ìš” â†’ â˜…5
- ì´ë¯¸ì§€ ì† ë¬¸ì œë¥¼ ì‹¤ì œë¡œ í’€ì–´ë³´ëŠ” ê²ƒì²˜ëŸ¼ ë¶„ì„í•˜ì„¸ìš”. ëª‡ ë‹¨ê³„ê°€ í•„ìš”í•œì§€ ì„¸ì„¸ìš”.

â˜…â˜…â˜… ì ˆëŒ€ ê·œì¹™: ì‘ë‹µì— $ ê¸°í˜¸ë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”! LaTeX í‘œê¸°(ì˜ˆ: $x^2$, \\(...\\))ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
ìˆ˜ì‹ì€ ë°˜ë“œì‹œ ìœ ë‹ˆì½”ë“œ/í…ìŠ¤íŠ¸ë¡œ í‘œí˜„í•˜ì„¸ìš”: xÂ², f(x), âˆ«, Î£, Ï€, âˆš, â‰¤, â‰¥, Â±, âˆ ë“±

[ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜ ì²´ê³„ - 7ìœ í˜•]
ì‚¬ì‹¤(A) â€” ì•„ëŠ” ê²ƒì„ í™•ì¸í•˜ëŠ” ì§ˆë¬¸:
- "1-1" ì§€ì‹í™•ì¸: ì •ë‹µì´ ì •í•´ì§„ ì‚¬ì‹¤ì„ ë¬»ëŠ” ì§ˆë¬¸ ("ì´ ê³µì‹ì´ ë­ì˜ˆìš”?")
- "1-2" ì ˆì°¨í™•ì¸: í’€ì´ ë°©ë²•Â·ìˆœì„œë¥¼ ë¬»ëŠ” ì§ˆë¬¸ ("ì´ê±´ ì–´ë–¤ ìˆœì„œë¡œ í’€ì–´ìš”?", "ëª¨ë¥´ê² ì–´ìš”", "í’€ì–´ì£¼ì„¸ìš”")

í•´ì„(B) â€” ì´í•´í•˜ê³  ìƒê°í•˜ëŠ” ì§ˆë¬¸:
- "2-1" ê°œë…ì´í•´: ì´ìœ ì™€ ì›ë¦¬ë¥¼ ë¬»ëŠ” ì§ˆë¬¸ ("ì™œ ì´ ì¡°ê±´ì´ í•„ìš”í•œ ê±°ì˜ˆìš”?")
- "2-2" ì „ëµì„ íƒ: ì–´ë–¤ ë°©ë²•ì„ ì“¸ì§€ ë¬»ëŠ” ì§ˆë¬¸ ("ì´ê±´ ì–´ë–¤ ë°©ë²•ìœ¼ë¡œ ì ‘ê·¼í•´ìš”?")
- "2-3" ì˜¤ë¥˜ì§„ë‹¨: í‹€ë¦° ë¶€ë¶„ì„ ì°¾ëŠ” ì§ˆë¬¸ ("ì´ë ‡ê²Œ í•˜ë©´ ì™œ ì•ˆ ë¼ìš”?", "ë‚´ í’€ì´ ë§ë‚˜ìš”?")

í‰ê°€(C) â€” íŒë‹¨í•˜ê³  ì°½ì¡°í•˜ëŠ” ì§ˆë¬¸:
- "3-1" ë¹„êµíŒë‹¨: ë‘˜ì„ ë¹„êµí•˜ì—¬ ê³ ë¥´ëŠ” ì§ˆë¬¸ ("Aë°©ë²•ì´ Bë³´ë‹¤ ë‚˜ì€ ì´ìœ ê°€ ë­ì˜ˆìš”?")
- "3-2" í™•ì¥ì°½ì¡°: ìƒˆë¡œìš´ ì•„ì´ë””ì–´ë¥¼ ë§Œë“œëŠ” ì§ˆë¬¸ ("ì´ê±¸ ë‹¤ë¥¸ ë¬¸ì œì—ë„ ì ìš©í•  ìˆ˜ ìˆì„ê¹Œìš”?")

ë¶„ë¥˜ ì£¼ì˜:
- "ì´ê±° ëª¨ë¥´ê² ì–´ìš”", "ì§ˆë¬¸ì´ìš”" â†’ 1-2 (ì ˆì°¨í™•ì¸)
- í•„ê¸° ì—†ì´ ë¬¸ì œë§Œ ì°ì€ ê²½ìš° â†’ 1-2 (í’€ì´ ìš”ì²­)
- í’€ì´ ì í˜€ìˆê³  "ë§ë‚˜ìš”?" â†’ 2-3 (ì˜¤ë¥˜ì§„ë‹¨)

[ì„±ì¥ ê²½ë¡œ â€” 1~2ë‹¨ê³„ë§Œ ì˜¬ë¦¬ì„¸ìš”, 3ë‹¨ê³„ ì´ìƒ ê±´ë„ˆë›°ê¸° ê¸ˆì§€]
1-1â†’2-1,2-2 / 1-2â†’2-1,2-3 / 2-1â†’2-3,3-1 / 2-2â†’2-3,3-1 / 2-3â†’3-1,3-2 / 3-1â†’3-2 / 3-2â†’3-2(ì‹¬í™”)

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš” (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´):
{
  "student_question": "ì´ë¯¸ì§€ì—ì„œ ì¸ì‹í•œ í•™ìƒì˜ í•„ê¸°/ì§ˆë¬¸ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì ì–´ì£¼ì„¸ìš”",
  "problem_analysis": {
    "difficulty": "â˜…4",
    "grade": "ê³ 2",
    "estimated_time": 15,
    "unit": "ëŒ€ë‹¨ì› > ì†Œë‹¨ì›",
    "tags": ["#ë¯¸ì ë¶„1", "#í•¨ìˆ˜ì˜ì—°ì†"],
    "summary": "ì´ ë¬¸ì œê°€ ë¬´ì—‡ì„ ìš”êµ¬í•˜ëŠ”ì§€ 1~2ë¬¸ì¥ ì„¤ëª…"
  },
  "question_analysis": {
    "original_question": "í•™ìƒ ì§ˆë¬¸ ì›ë¬¸ ê·¸ëŒ€ë¡œ",
    "question_type": "2-1",
    "question_type_label": "ê°œë…ì´í•´",
    "confidence": 0.85,
    "interpretation": "í•™ìƒì´ ê¶ê¸ˆí•´í•˜ëŠ” í•µì‹¬ì´ ë¬´ì—‡ì¸ì§€ 1~2ë¬¸ì¥"
  },
  "coaching_comment": "í•™ìƒì˜ í˜„ì¬ ì§ˆë¬¸ ìˆ˜ì¤€ì„ ì¸ì •í•˜ê³  ê²©ë ¤ + êµ¬ì²´ì  ì„±ì¥ ë°©í–¥ (2~3ë¬¸ì¥, ì¹œê·¼í•œ í†¤)",
  "coaching_questions": [
    {
      "type": "2-3",
      "type_label": "ì˜¤ë¥˜ì§„ë‹¨",
      "growth_path": "ê°œë…ì´í•´ â†’ ì˜¤ë¥˜ì§„ë‹¨",
      "question": "í•™ìƒ í˜¼ì£ë§ ìŠ¤íƒ€ì¼ì˜ êµ¬ì²´ì  ì½”ì¹­ì§ˆë¬¸",
      "why_important": "ì´ ì§ˆë¬¸ì´ ì™œ ì¤‘ìš”í•œì§€ 1ë¬¸ì¥"
    },
    {
      "type": "3-1",
      "type_label": "ë¹„êµíŒë‹¨",
      "growth_path": "ê°œë…ì´í•´ â†’ ë¹„êµíŒë‹¨",
      "question": "í•™ìƒ í˜¼ì£ë§ ìŠ¤íƒ€ì¼ì˜ êµ¬ì²´ì  ì½”ì¹­ì§ˆë¬¸",
      "why_important": "ì´ ì§ˆë¬¸ì´ ì™œ ì¤‘ìš”í•œì§€ 1ë¬¸ì¥"
    }
  ],
  "growth_interactions": [
    {
      "target_coaching_index": 0,
      "target_type": "2-3",
      "target_label": "ì˜¤ë¥˜ì§„ë‹¨",
      "selection_button": "ğŸ” í•™ìƒì´ ì´í•´í•  ìˆ˜ ìˆëŠ” ì‰¬ìš´ ì§ˆë¬¸ í˜•íƒœì˜ ì„ íƒ ë²„íŠ¼",
      "wrong_attempt": {
        "setup": "ì´ ë¬¸ì œì˜ í•µì‹¬ ì¡°ê±´ì„ ì˜ëª» ì ìš©í•œ êµ¬ì²´ì  ì‹œë„ (ì‹¤ì œ ìˆ«ì/ì¡°ê±´ ì‚¬ìš©, 2~3ë¬¸ì¥)",
        "question": "ì´ê±° ê´œì°®ì„ê¹Œìš”?",
        "choices": ["âœ… ê´œì°®ì€ ê²ƒ ê°™ì•„ìš”", "âŒ ë­”ê°€ ì´ìƒí•´ìš”"]
      },
      "discovery_hint": {
        "on_correct": "ì¢‹ì•„ìš”! ì–´ë””ì„œ ë¬¸ì œê°€ ìƒê¸°ëŠ”ì§€ ê³¨ë¼ë³´ì„¸ìš”.",
        "on_correct_choices": ["êµ¬ì²´ì  ì˜¤ë¥˜ ì„ íƒì§€1", "êµ¬ì²´ì  ì˜¤ë¥˜ ì„ íƒì§€2", "êµ¬ì²´ì  ì˜¤ë¥˜ ì„ íƒì§€3", "ì˜ ëª¨ë¥´ê² ì–´ìš”"],
        "on_wrong": "ì •ë§ìš”? ğŸ§ ___ì„ í™•ì¸í•´ë³´ì„¸ìš”!",
        "on_wrong_retry": "ë‹¤ì‹œ ìƒê°í•´ë³¼ê²Œìš”",
        "on_stuck": "íŒíŠ¸: êµ¬ì²´ì  ìˆ˜ì¹˜ë¥¼ ì‚¬ìš©í•œ ë‹¨ê³„ë³„ ìœ ë„ íŒíŠ¸"
      },
      "thinking_bridge": {
        "steps": ["ë¬´ì—‡ì„ ì‹œë„í–ˆê³ ", "ë¬´ì—‡ì„ ë°œê²¬í–ˆê³ ", "ì–´ë–¤ ì§ˆë¬¸ì´ ë– ì˜¬ëëŠ”ì§€"],
        "connection": "ì´ê²Œ ë°”ë¡œ ğŸ” ì˜¤ë¥˜ì§„ë‹¨ ì§ˆë¬¸ì´ì—ìš”! ì„¤ëª… í•œ ë¬¸ì¥."
      }
    }
  ],
  "selection_prompt": "ì•„ë˜ ì¤‘ ë” ê¶ê¸ˆí•œ ê±¸ ê³¨ë¼ë³´ì„¸ìš”!"
}

[í•µì‹¬ ìƒì„± ê·œì¹™]

1. coaching_questions: 2~3ê°œ ìƒì„±. ê°ê° ì„œë¡œ ë‹¤ë¥¸ ìœ í˜•ì´ì–´ì•¼ í•¨.
2. growth_interactions: coaching_questionsì™€ 1:1 ëŒ€ì‘ (ëª¨ë“  ì½”ì¹­ì§ˆë¬¸ì— ì¸í„°ë™ì…˜ ìƒì„±)
3. wrong_attempt: êµ¬ì²´ì  ìˆ«ì/ì¡°ê±´ ì‚¬ìš©. ì¶”ìƒì  ì„¤ëª… ê¸ˆì§€. 50% í™•ë¥ ë¡œ ë°œê²¬ ê°€ëŠ¥í•œ ë‚œì´ë„.
4. discovery_hint: on_correct_choicesëŠ” ì •ë‹µ1+ì˜¤ë‹µ2+ì˜ëª¨ë¥´ê² ì–´ìš” = 4ê°œ. ë‹µì„ ì§ì ‘ ì•Œë ¤ì£¼ì§€ ë§ ê²ƒ.
5. thinking_bridge: stepsëŠ” ë°˜ë“œì‹œ 3ê°œ. connectionì— ì´ëª¨ì§€+ì§ˆë¬¸ìœ í˜• ì´ë¦„ í¬í•¨.
6. ì¸í„°ë™ì…˜ ê°„ ì¤‘ë³µ ê¸ˆì§€: ì„œë¡œ ë‹¤ë¥¸ ì‚¬ê³  ì˜ì—­ì„ ë‹¤ë£° ê²ƒ.

â˜…â˜…â˜… ì§ˆë¬¸ í†¤ ê·œì¹™ â˜…â˜…â˜…
- ì½”ì¹­ì§ˆë¬¸ì€ í•™ìƒ í˜¼ì£ë§/ë…ë°± ìŠ¤íƒ€ì¼ ("~ê±°ì§€?", "~ê±´ê°€?", "~ì¼ê¹Œ?")
- ì„ ìƒë‹˜ ì§ˆë¬¸ ìŠ¤íƒ€ì¼ ì ˆëŒ€ ê¸ˆì§€
- selection_buttonì€ í•™ìƒì´ ì´í•´í•  ìˆ˜ ìˆëŠ” ì‰¬ìš´ ì§ˆë¬¸ í˜•íƒœ`

// Strip $ and LaTeX delimiters from text
function stripDollarSigns(s: string | null | undefined): string | null {
  if (!s) return null
  // Remove $$...$$ and $...$ LaTeX delimiters but keep inner content
  let r = s.replace(/\$\$(.*?)\$\$/g, '$1').replace(/\$(.*?)\$/g, '$1')
  // Remove \( \) \[ \] LaTeX delimiters
  r = r.replace(/\\\(|\\\)/g, '').replace(/\\\[|\\\]/g, '')
  // Remove any remaining standalone $ signs
  r = r.replace(/\$/g, '')
  return r
}

async function analyzeQuestionWithAI(db: any, env: any, questionId: number, subject: string, content: string, imageKey: string | null, imageData: string | null) {
  try {
    const geminiKey = env.GEMINI_API_KEY
    if (!geminiKey) {
      await db.prepare('UPDATE questions SET ai_analyzed = -1 WHERE id = ?').bind(questionId).run()
      return
    }

    // Build image parts for Gemini
    const parts: any[] = []
    
    // Try to get image from R2 first
    let imageBase64 = null
    let imageMime = 'image/png'
    if (imageKey && env.R2) {
      try {
        const obj = await env.R2.get(imageKey)
        if (obj) {
          const buf = await obj.arrayBuffer()
          const bytes = new Uint8Array(buf)
          let binary = ''
          for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i])
          imageBase64 = btoa(binary)
          imageMime = obj.httpMetadata?.contentType || 'image/jpeg'
        }
      } catch (e) {}
    }
    // Fallback to base64 image_data
    if (!imageBase64 && imageData) {
      const match = imageData.match(/^data:([^;]+);base64,(.+)$/)
      if (match) { imageMime = match[1]; imageBase64 = match[2] }
    }
    
    // If no image available, mark as failed
    if (!imageBase64) {
      await db.prepare('UPDATE questions SET ai_analyzed = -1 WHERE id = ?').bind(questionId).run()
      return
    }
    
    parts.push({ inlineData: { mimeType: imageMime, data: imageBase64 } })
    parts.push({ text: CURRICULUM_PROMPT + '\n\n[ê³¼ëª©]: ' + subject + '\n[ì§ˆë¬¸ í…ìŠ¤íŠ¸]: ' + content.slice(0, 500) })
    
    // Use AbortController for 25-second timeout (Cloudflare Workers limit ~30s)
    const controller = new AbortController()
    const timeoutId = setTimeout(() => controller.abort(), 55000)
    
    let geminiRes: Response
    try {
      geminiRes = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=' + geminiKey, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        signal: controller.signal,
        body: JSON.stringify({
          contents: [{ parts }],
          generationConfig: { temperature: 0.3, maxOutputTokens: 8192, thinkingConfig: { thinkingBudget: 1024 } }
        })
      })
    } catch (abortErr: any) {
      console.error('Gemini API timeout for question', questionId)
      await db.prepare('UPDATE questions SET ai_analyzed = -1 WHERE id = ?').bind(questionId).run()
      return
    } finally {
      clearTimeout(timeoutId)
    }

    if (!geminiRes.ok) {
      console.error('Gemini API error:', geminiRes.status, await geminiRes.text())
      await db.prepare('UPDATE questions SET ai_analyzed = -1 WHERE id = ?').bind(questionId).run()
      return
    }

    const geminiData = await geminiRes.json() as any
    // Concatenate all text parts (skip thinking parts)
    const allParts = geminiData.candidates?.[0]?.content?.parts || []
    let text = ''
    for (const p of allParts) {
      if (p.text && !p.thought) text += p.text
    }
    
    // Extract JSON: try code block first, then raw JSON
    let jsonStr = ''
    const codeBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/)
    if (codeBlockMatch) jsonStr = codeBlockMatch[1].trim()
    else { const m = text.match(/\{[\s\S]*\}/); if (m) jsonStr = m[0] }
    if (!jsonStr) {
      await db.prepare('UPDATE questions SET ai_analyzed = -1 WHERE id = ?').bind(questionId).run()
      return
    }
    
    const analysis = JSON.parse(jsonStr)
    
    // === New spec: build coaching data JSON (coaching_questions + growth_interactions) ===
    const pa = analysis.problem_analysis || {}
    const qa = analysis.question_analysis || {}
    
    // Extract fields from new structure, with backward compat
    const difficulty = pa.difficulty || analysis.ai_difficulty || null
    const tags = Array.isArray(pa.tags) ? pa.tags.join(' ') : (analysis.ai_tags || null)
    const topicMain = pa.unit?.split('>')[0]?.trim() || analysis.ai_topic_main || null
    const topicSub = pa.unit?.split('>')?.slice(1)?.join('>').trim() || analysis.ai_topic_sub || null
    const description = pa.summary || analysis.ai_description || null
    const gradeLevel = pa.grade || analysis.ai_grade_level || null
    const estimatedTime = pa.estimated_time || analysis.ai_estimated_time || null
    const questionType = qa.question_type || analysis.question_type || null
    const questionTypeConf = qa.confidence || analysis.question_type_confidence || null
    const studentQ = analysis.student_question || qa.original_question || null
    const questionAnalysis = qa.interpretation || analysis.question_analysis || null
    const coachingComment = analysis.coaching_comment || null
    
    // Build unified coaching data JSON
    let coachingDataJson: string | null = null
    if (analysis.coaching_questions || analysis.growth_interactions) {
      const coachingData: any = {
        coaching_questions: (analysis.coaching_questions || []).map((cq: any) => ({
          type: cq.type || '', type_label: stripDollarSigns(cq.type_label) || '',
          growth_path: cq.growth_path || '', question: stripDollarSigns(cq.question) || '',
          why_important: stripDollarSigns(cq.why_important) || ''
        })),
        growth_interactions: (analysis.growth_interactions || []).map((gi: any) => ({
          target_coaching_index: gi.target_coaching_index ?? 0,
          target_type: gi.target_type || '', target_label: gi.target_label || '',
          selection_button: stripDollarSigns(gi.selection_button) || '',
          wrong_attempt: {
            setup: stripDollarSigns(gi.wrong_attempt?.setup) || '',
            question: gi.wrong_attempt?.question || 'ì´ê±° ê´œì°®ì„ê¹Œìš”?',
            choices: gi.wrong_attempt?.choices || ['âœ… ê´œì°®ì€ ê²ƒ ê°™ì•„ìš”', 'âŒ ë­”ê°€ ì´ìƒí•´ìš”']
          },
          discovery_hint: {
            on_correct: stripDollarSigns(gi.discovery_hint?.on_correct) || 'ì¢‹ì•„ìš”! ì–´ë””ì„œ ë¬¸ì œê°€ ìƒê¸°ëŠ”ì§€ ê³¨ë¼ë³´ì„¸ìš”.',
            on_correct_choices: (gi.discovery_hint?.on_correct_choices || []).map((c: string) => stripDollarSigns(c) || c),
            on_wrong: stripDollarSigns(gi.discovery_hint?.on_wrong) || '',
            on_wrong_retry: gi.discovery_hint?.on_wrong_retry || 'ë‹¤ì‹œ ìƒê°í•´ë³¼ê²Œìš”',
            on_stuck: stripDollarSigns(gi.discovery_hint?.on_stuck) || ''
          },
          thinking_bridge: {
            steps: (gi.thinking_bridge?.steps || []).map((s: string) => stripDollarSigns(s) || s),
            connection: stripDollarSigns(gi.thinking_bridge?.connection) || ''
          }
        })),
        selection_prompt: analysis.selection_prompt || 'ì•„ë˜ ì¤‘ ë” ê¶ê¸ˆí•œ ê±¸ ê³¨ë¼ë³´ì„¸ìš”!'
      }
      coachingDataJson = JSON.stringify(coachingData)
    }

    // Determine difficulty level for hybrid routing
    const difficultyStr = difficulty || ''
    const difficultyNum = parseInt(String(difficultyStr).replace(/[^0-9]/g, '')) || 0
    const useGeminiOnly = difficultyNum < 4

    await db.prepare(`UPDATE questions SET 
      ai_difficulty = ?, ai_tags = ?, ai_topic_main = ?, ai_topic_sub = ?,
      ai_description = ?, ai_grade_level = ?, ai_estimated_time = ?, 
      question_type = ?, question_type_confidence = ?, student_question_text = ?,
      ai_question_analysis = ?, ai_coaching_comment = ?, ai_coaching_data = ?, ai_model = ?, ai_analyzed = 1
      WHERE id = ?`
    ).bind(
      stripDollarSigns(difficulty), stripDollarSigns(tags),
      stripDollarSigns(topicMain), stripDollarSigns(topicSub),
      stripDollarSigns(description), stripDollarSigns(gradeLevel),
      estimatedTime, questionType, questionTypeConf,
      stripDollarSigns(studentQ), stripDollarSigns(questionAnalysis),
      stripDollarSigns(coachingComment), coachingDataJson,
      'gemini', questionId
    ).run()

    // === HYBRID: â˜…4~5 â†’ Claude Sonnet enhances coaching ===
    if (!useGeminiOnly && env.ANTHROPIC_API_KEY) {
      console.log(`Hybrid mode: â˜…${difficultyNum} detected â€” sending to Claude for enhanced coaching (question ${questionId})`)
      try {
        await enhanceCoachingWithClaude(db, env, questionId, {
          subject, content,
          difficulty: String(difficulty || ''),
          questionType: questionType || '1-2',
          description: String(description || ''),
          studentQuestion: String(studentQ || '')
        }, imageBase64, imageMime)
      } catch (claudeErr) {
        console.error('Claude enhancement failed, keeping Gemini coaching for question', questionId, claudeErr)
      }
    }
    
  } catch (e) {
    console.error('AI analysis failed for question', questionId, e)
    try {
      await db.prepare('UPDATE questions SET ai_analyzed = -1 WHERE id = ?').bind(questionId).run()
    } catch (e2) {}
  }
}

// === Claude Sonnet 4.5 â€” ê³ ë‚œë„ ì½”ì¹­ ì „ìš© (â˜…4~5) ===
const CLAUDE_COACHING_PROMPT = `ë‹¹ì‹ ì€ í•œêµ­ ê³ ë“±í•™êµ ìˆ˜í•™/ê³¼í•™ êµìœ¡ ì „ë¬¸ê°€ì´ì í•™ìƒ ì§ˆë¬¸ ì½”ì¹­ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
Geminiê°€ ì´ë¯¸ ë¬¸ì œ ë¶„ì„(ë‚œì´ë„, íƒœê·¸, ìœ í˜• ë¶„ë¥˜ ë“±)ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ì—­í• ì€ **ì½”ì¹­ í’ˆì§ˆì„ í•œ ë‹¨ê³„ ë†’ì´ëŠ” ê²ƒ**ì…ë‹ˆë‹¤.

â˜…â˜…â˜… ì ˆëŒ€ ê·œì¹™: $ ê¸°í˜¸/LaTeX ê¸ˆì§€. ìœ ë‹ˆì½”ë“œ ìˆ˜ì‹ë§Œ: xÂ², f(x), âˆ«, Î£, Ï€, âˆš
â˜…â˜…â˜… ì§ˆë¬¸ í†¤: í•™ìƒ í˜¼ì£ë§ ìŠ¤íƒ€ì¼ë§Œ ("~ê±°ì§€?", "~ê±´ê°€?"). ì„ ìƒë‹˜ ì§ˆë¬¸ ê¸ˆì§€!

[ì§ˆë¬¸ ìœ í˜•] 1-1:ì§€ì‹í™•ì¸, 1-2:ì ˆì°¨í™•ì¸, 2-1:ê°œë…ì´í•´, 2-2:ì „ëµì„ íƒ, 2-3:ì˜¤ë¥˜ì§„ë‹¨, 3-1:ë¹„êµíŒë‹¨, 3-2:í™•ì¥ì°½ì¡°
[ì„±ì¥ ê²½ë¡œ] 1-1â†’2-1,2-2 / 1-2â†’2-1,2-3 / 2-1â†’2-3,3-1 / 2-2â†’2-3,3-1 / 2-3â†’3-1,3-2 / 3-1â†’3-2 / 3-2â†’3-2(ì‹¬í™”)

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "coaching_comment": "ê²©ë ¤ + êµ¬ì²´ì  ì„±ì¥ ë°©í–¥ (2~3ë¬¸ì¥, ì¹œê·¼í•œ í†¤)",
  "coaching_questions": [
    {"type": "2-3", "type_label": "ì˜¤ë¥˜ì§„ë‹¨", "growth_path": "í˜„ì¬ìœ í˜• â†’ ëª©í‘œìœ í˜•", "question": "í•™ìƒ í˜¼ì£ë§ ìŠ¤íƒ€ì¼ ì§ˆë¬¸", "why_important": "1ë¬¸ì¥ ì„¤ëª…"},
    {"type": "3-1", "type_label": "ë¹„êµíŒë‹¨", "growth_path": "í˜„ì¬ìœ í˜• â†’ ëª©í‘œìœ í˜•", "question": "í•™ìƒ í˜¼ì£ë§ ìŠ¤íƒ€ì¼ ì§ˆë¬¸", "why_important": "1ë¬¸ì¥ ì„¤ëª…"}
  ],
  "growth_interactions": [
    {
      "target_coaching_index": 0,
      "target_type": "2-3",
      "target_label": "ì˜¤ë¥˜ì§„ë‹¨",
      "selection_button": "ğŸ” í•™ìƒì´ ì´í•´í•  ìˆ˜ ìˆëŠ” ì„ íƒ ë²„íŠ¼ í…ìŠ¤íŠ¸",
      "wrong_attempt": {
        "setup": "êµ¬ì²´ì  ìˆ«ì/ì¡°ê±´ì„ ì‚¬ìš©í•œ í‹€ë¦° ì‹œë„ (2~3ë¬¸ì¥)",
        "question": "ì´ê±° ê´œì°®ì„ê¹Œìš”?",
        "choices": ["âœ… ê´œì°®ì€ ê²ƒ ê°™ì•„ìš”", "âŒ ë­”ê°€ ì´ìƒí•´ìš”"]
      },
      "discovery_hint": {
        "on_correct": "ì¢‹ì•„ìš”! ì–´ë””ì„œ ë¬¸ì œê°€ ìƒê¸°ëŠ”ì§€ ê³¨ë¼ë³´ì„¸ìš”.",
        "on_correct_choices": ["ì˜¤ë¥˜ ì„ íƒì§€1", "ì˜¤ë¥˜ ì„ íƒì§€2", "ì˜¤ë¥˜ ì„ íƒì§€3", "ì˜ ëª¨ë¥´ê² ì–´ìš”"],
        "on_wrong": "ì •ë§ìš”? ğŸ§ ___ì„ í™•ì¸í•´ë³´ì„¸ìš”!",
        "on_wrong_retry": "ë‹¤ì‹œ ìƒê°í•´ë³¼ê²Œìš”",
        "on_stuck": "íŒíŠ¸: êµ¬ì²´ì  ìœ ë„ íŒíŠ¸"
      },
      "thinking_bridge": {
        "steps": ["ë¬´ì—‡ì„ ì‹œë„í–ˆê³ ", "ë¬´ì—‡ì„ ë°œê²¬í–ˆê³ ", "ì–´ë–¤ ì§ˆë¬¸ì´ ë– ì˜¬ëëŠ”ì§€"],
        "connection": "ì´ê²Œ ë°”ë¡œ ğŸ” ì˜¤ë¥˜ì§„ë‹¨ ì§ˆë¬¸ì´ì—ìš”! ì„¤ëª…."
      }
    }
  ],
  "selection_prompt": "ì•„ë˜ ì¤‘ ë” ê¶ê¸ˆí•œ ê±¸ ê³¨ë¼ë³´ì„¸ìš”!"
}

[í•µì‹¬ ê·œì¹™]
- coaching_questions: 2~3ê°œ, ê°ê° ë‹¤ë¥¸ ìœ í˜•
- growth_interactions: coaching_questionsì™€ 1:1 ëŒ€ì‘
- wrong_attempt: êµ¬ì²´ì  ìˆ«ì ì‚¬ìš©, 50% ë°œê²¬ ë‚œì´ë„
- on_correct_choices: ì •ë‹µ1+ì˜¤ë‹µ2+ì˜ëª¨ë¥´ê² ì–´ìš” = 4ê°œ
- thinking_bridge.steps: ë°˜ë“œì‹œ 3ê°œ
- ë‹µì„ ì§ì ‘ ì•Œë ¤ì£¼ì§€ ë§ ê²ƒ
- ì¸í„°ë™ì…˜ ê°„ ì¤‘ë³µ ê¸ˆì§€`

async function enhanceCoachingWithClaude(
  db: any, env: any, questionId: number,
  geminiAnalysis: { subject: string, content: string, difficulty: string, questionType: string, description: string, studentQuestion: string },
  imageBase64: string | null, imageMime: string
) {
  try {
    const claudeKey = env.ANTHROPIC_API_KEY
    if (!claudeKey) {
      console.log('No Anthropic key â€” skipping Claude coaching for question', questionId)
      return false
    }

    // Build messages for Claude
    const contextText = `[Gemini ë¶„ì„ ê²°ê³¼]
ê³¼ëª©: ${geminiAnalysis.subject}
ë‚œì´ë„: ${geminiAnalysis.difficulty}
ì§ˆë¬¸ ìœ í˜•: ${geminiAnalysis.questionType}
ë¬¸ì œ ì„¤ëª…: ${geminiAnalysis.description}
í•™ìƒ ì§ˆë¬¸: ${geminiAnalysis.studentQuestion}
ì§ˆë¬¸ í…ìŠ¤íŠ¸: ${geminiAnalysis.content?.slice(0, 500) || ''}

ìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì´ ê³ ë‚œë„ ë¬¸ì œì— ëŒ€í•´ ë” ê¹Šì´ ìˆëŠ” ì½”ì¹­ì„ ì œê³µí•´ì£¼ì„¸ìš”.
í˜„ì¬ ì§ˆë¬¸ ìœ í˜•(${geminiAnalysis.questionType})ì— ë§ëŠ” ì—…ê·¸ë ˆì´ë“œ ê²½ë¡œë¥¼ ë”°ë¼ next_questionsë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.`

    const content: any[] = []
    if (imageBase64) {
      content.push({
        type: 'image',
        source: { type: 'base64', media_type: imageMime, data: imageBase64 }
      })
    }
    content.push({ type: 'text', text: contextText })

    const controller = new AbortController()
    const timeoutId = setTimeout(() => controller.abort(), 55000)
    
    let claudeRes: Response
    try {
      claudeRes = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': claudeKey,
          'anthropic-version': '2023-06-01'
        },
        signal: controller.signal,
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 4096,
          system: CLAUDE_COACHING_PROMPT,
          messages: [{ role: 'user', content }]
        })
      })
    } catch (abortErr: any) {
      console.error('Claude API timeout for question', questionId)
      return false
    } finally {
      clearTimeout(timeoutId)
    }

    if (!claudeRes.ok) {
      console.error('Claude API error:', claudeRes.status, await claudeRes.text())
      return false
    }

    const claudeData = await claudeRes.json() as any
    const textBlock = claudeData.content?.find((b: any) => b.type === 'text')
    if (!textBlock?.text) return false

    // Extract JSON
    let jsonStr = ''
    const codeBlockMatch = textBlock.text.match(/```(?:json)?\s*([\s\S]*?)```/)
    if (codeBlockMatch) jsonStr = codeBlockMatch[1].trim()
    else { const m = textBlock.text.match(/\{[\s\S]*\}/); if (m) jsonStr = m[0] }
    if (!jsonStr) return false

    const coaching = JSON.parse(jsonStr)

    // Build unified coaching data JSON from Claude response
    let claudeCoachingData: string | null = null
    if (coaching.coaching_questions || coaching.growth_interactions) {
      claudeCoachingData = JSON.stringify({
        coaching_questions: (coaching.coaching_questions || []).map((cq: any) => ({
          type: cq.type || '', type_label: stripDollarSigns(cq.type_label) || '',
          growth_path: cq.growth_path || '', question: stripDollarSigns(cq.question) || '',
          why_important: stripDollarSigns(cq.why_important) || ''
        })),
        growth_interactions: (coaching.growth_interactions || []).map((gi: any) => ({
          target_coaching_index: gi.target_coaching_index ?? 0,
          target_type: gi.target_type || '', target_label: gi.target_label || '',
          selection_button: stripDollarSigns(gi.selection_button) || '',
          wrong_attempt: {
            setup: stripDollarSigns(gi.wrong_attempt?.setup) || '',
            question: gi.wrong_attempt?.question || 'ì´ê±° ê´œì°®ì„ê¹Œìš”?',
            choices: gi.wrong_attempt?.choices || ['âœ… ê´œì°®ì€ ê²ƒ ê°™ì•„ìš”', 'âŒ ë­”ê°€ ì´ìƒí•´ìš”']
          },
          discovery_hint: {
            on_correct: stripDollarSigns(gi.discovery_hint?.on_correct) || '',
            on_correct_choices: (gi.discovery_hint?.on_correct_choices || []).map((c: string) => stripDollarSigns(c) || c),
            on_wrong: stripDollarSigns(gi.discovery_hint?.on_wrong) || '',
            on_wrong_retry: gi.discovery_hint?.on_wrong_retry || 'ë‹¤ì‹œ ìƒê°í•´ë³¼ê²Œìš”',
            on_stuck: stripDollarSigns(gi.discovery_hint?.on_stuck) || ''
          },
          thinking_bridge: {
            steps: (gi.thinking_bridge?.steps || []).map((s: string) => stripDollarSigns(s) || s),
            connection: stripDollarSigns(gi.thinking_bridge?.connection) || ''
          }
        })),
        selection_prompt: coaching.selection_prompt || 'ì•„ë˜ ì¤‘ ë” ê¶ê¸ˆí•œ ê±¸ ê³¨ë¼ë³´ì„¸ìš”!'
      })
    }

    // Update only coaching fields (keep Gemini's analysis/difficulty/tags intact)
    await db.prepare(`UPDATE questions SET 
      ai_coaching_comment = ?, ai_coaching_data = ?, ai_model = ?
      WHERE id = ?`
    ).bind(
      stripDollarSigns(coaching.coaching_comment) || null,
      claudeCoachingData,
      'claude',
      questionId
    ).run()

    console.log('Claude coaching enhanced for question', questionId)
    return true
  } catch (e) {
    console.error('Claude coaching failed for question', questionId, e)
    return false
  }
}

// Manual AI analysis trigger (for existing questions) â€” with debug info
app.post('/api/questions/:id/analyze', async (c) => {
  const db = c.env.DB
  const id = c.req.param('id')
  const geminiKey = c.env.GEMINI_API_KEY
  if (!geminiKey) return c.json({ error: 'Gemini API key not configured' }, 500)
  
  const q = await db.prepare('SELECT id, subject, content, image_key, image_data FROM questions WHERE id = ?').bind(id).first() as any
  if (!q) return c.json({ error: 'Question not found' }, 404)
  
  // Inline debug analysis
  try {
    const parts: any[] = []
    let imageBase64: string | null = null
    let imageMime = 'image/png'
    let debugInfo: any = { imageKey: q.image_key, hasImageData: !!q.image_data }
    
    if (q.image_key && c.env.R2) {
      try {
        const obj = await c.env.R2.get(q.image_key)
        if (obj) {
          const buf = await obj.arrayBuffer()
          // Use chunked base64 encoding to avoid stack overflow
          const bytes = new Uint8Array(buf)
          let binary = ''
          for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i])
          imageBase64 = btoa(binary)
          imageMime = obj.httpMetadata?.contentType || 'image/jpeg'
          debugInfo.r2ImageSize = buf.byteLength
          debugInfo.base64Length = imageBase64.length
        } else {
          debugInfo.r2Error = 'Object not found'
        }
      } catch (e: any) { debugInfo.r2Error = e.message }
    }
    if (!imageBase64 && q.image_data) {
      const match = q.image_data.match(/^data:([^;]+);base64,(.+)$/)
      if (match) { imageMime = match[1]; imageBase64 = match[2]; debugInfo.usedBase64Fallback = true }
    }
    
    if (imageBase64) {
      parts.push({ inlineData: { mimeType: imageMime, data: imageBase64 } })
    }
    parts.push({ text: CURRICULUM_PROMPT + '\n\n[ê³¼ëª©]: ' + q.subject + '\n[ì§ˆë¬¸ í…ìŠ¤íŠ¸]: ' + (q.content || '').slice(0, 500) })
    debugInfo.partsCount = parts.length
    debugInfo.hasImage = !!imageBase64
    
    const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=' + geminiKey
    const geminiRes = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts }],
        generationConfig: { temperature: 0.3, maxOutputTokens: 8192, thinkingConfig: { thinkingBudget: 1024 } }
      })
    })
    
    debugInfo.geminiStatus = geminiRes.status
    if (!geminiRes.ok) {
      const errText = await geminiRes.text()
      debugInfo.geminiError = errText.slice(0, 500)
      return c.json({ success: false, debug: debugInfo })
    }
    
    const geminiData = await geminiRes.json() as any
    // Concatenate all text parts (skip thinking parts)
    const allParts = geminiData.candidates?.[0]?.content?.parts || []
    let text = ''
    for (const p of allParts) {
      if (p.text && !p.thought) text += p.text
    }
    debugInfo.rawResponse = text.slice(0, 2000)
    debugInfo.partsStructure = allParts.map((p: any) => ({ hasText: !!p.text, thought: !!p.thought, textLen: p.text?.length || 0 }))
    
    // Extract JSON: try code block first, then raw JSON
    let jsonStr = ''
    const codeBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/)
    if (codeBlockMatch) jsonStr = codeBlockMatch[1].trim()
    else { const m = text.match(/\{[\s\S]*\}/); if (m) jsonStr = m[0] }
    if (!jsonStr) {
      debugInfo.parseError = 'No JSON found in response'
      return c.json({ success: false, debug: debugInfo })
    }
    debugInfo.extractedJson = jsonStr.slice(0, 500)
    
    const analysis = JSON.parse(jsonStr)
    debugInfo.parsedAnalysis = analysis
    
    // Build coaching data JSON (new spec)
    const pa2 = analysis.problem_analysis || {}
    const qa2 = analysis.question_analysis || {}
    let coachingData2: string | null = null
    if (analysis.coaching_questions || analysis.growth_interactions) {
      coachingData2 = JSON.stringify({
        coaching_questions: (analysis.coaching_questions || []).map((cq: any) => ({
          type: cq.type || '', type_label: stripDollarSigns(cq.type_label) || '',
          growth_path: cq.growth_path || '', question: stripDollarSigns(cq.question) || '',
          why_important: stripDollarSigns(cq.why_important) || ''
        })),
        growth_interactions: (analysis.growth_interactions || []).map((gi: any) => ({
          target_coaching_index: gi.target_coaching_index ?? 0,
          target_type: gi.target_type || '', target_label: gi.target_label || '',
          selection_button: stripDollarSigns(gi.selection_button) || '',
          wrong_attempt: { setup: stripDollarSigns(gi.wrong_attempt?.setup) || '', question: gi.wrong_attempt?.question || 'ì´ê±° ê´œì°®ì„ê¹Œìš”?', choices: gi.wrong_attempt?.choices || ['âœ… ê´œì°®ì€ ê²ƒ ê°™ì•„ìš”', 'âŒ ë­”ê°€ ì´ìƒí•´ìš”'] },
          discovery_hint: { on_correct: stripDollarSigns(gi.discovery_hint?.on_correct) || '', on_correct_choices: (gi.discovery_hint?.on_correct_choices || []).map((c: string) => stripDollarSigns(c) || c), on_wrong: stripDollarSigns(gi.discovery_hint?.on_wrong) || '', on_wrong_retry: gi.discovery_hint?.on_wrong_retry || 'ë‹¤ì‹œ ìƒê°í•´ë³¼ê²Œìš”', on_stuck: stripDollarSigns(gi.discovery_hint?.on_stuck) || '' },
          thinking_bridge: { steps: (gi.thinking_bridge?.steps || []).map((s: string) => stripDollarSigns(s) || s), connection: stripDollarSigns(gi.thinking_bridge?.connection) || '' }
        })),
        selection_prompt: analysis.selection_prompt || 'ì•„ë˜ ì¤‘ ë” ê¶ê¸ˆí•œ ê±¸ ê³¨ë¼ë³´ì„¸ìš”!'
      })
    }
    
    const diff2 = pa2.difficulty || analysis.ai_difficulty || ''
    const tags2 = Array.isArray(pa2.tags) ? pa2.tags.join(' ') : (analysis.ai_tags || null)
    const diffNum = parseInt(String(diff2).replace(/[^0-9]/g, '')) || 0
    const isHard = diffNum >= 4

    await db.prepare(`UPDATE questions SET 
      ai_difficulty = ?, ai_tags = ?, ai_topic_main = ?, ai_topic_sub = ?,
      ai_description = ?, ai_grade_level = ?, ai_estimated_time = ?,
      question_type = ?, question_type_confidence = ?, student_question_text = ?,
      ai_question_analysis = ?, ai_coaching_comment = ?, ai_coaching_data = ?, ai_model = ?, ai_analyzed = 1
      WHERE id = ?`
    ).bind(
      stripDollarSigns(diff2) || null,
      stripDollarSigns(tags2) || null,
      stripDollarSigns(pa2.unit?.split('>')[0]?.trim() || analysis.ai_topic_main) || null,
      stripDollarSigns(pa2.unit?.split('>')?.slice(1)?.join('>').trim() || analysis.ai_topic_sub) || null,
      stripDollarSigns(pa2.summary || analysis.ai_description) || null,
      stripDollarSigns(pa2.grade || analysis.ai_grade_level) || null,
      pa2.estimated_time || analysis.ai_estimated_time || null,
      qa2.question_type || analysis.question_type || null,
      qa2.confidence || analysis.question_type_confidence || null,
      stripDollarSigns(analysis.student_question || qa2.original_question) || null,
      stripDollarSigns(qa2.interpretation || analysis.question_analysis) || null,
      stripDollarSigns(analysis.coaching_comment) || null,
      coachingData2,
      'gemini',
      q.id
    ).run()

    // === HYBRID: â˜…4~5 â†’ Claude enhanced coaching ===
    let claudeEnhanced = false
    if (isHard && c.env.ANTHROPIC_API_KEY) {
      debugInfo.hybridMode = true
      debugInfo.difficulty = diffNum
      try {
        claudeEnhanced = await enhanceCoachingWithClaude(db, c.env, parseInt(id), {
          subject: q.subject, content: q.content || '',
          difficulty: String(diff2 || ''),
          questionType: qa2.question_type || analysis.question_type || '1-2',
          description: pa2.summary || analysis.ai_description || '',
          studentQuestion: analysis.student_question || qa2.original_question || ''
        }, imageBase64, imageMime)
        debugInfo.claudeEnhanced = claudeEnhanced
      } catch (ce) {
        debugInfo.claudeError = (ce as Error).message
      }
    }
    
    const updated = await db.prepare('SELECT ai_difficulty, ai_tags, ai_topic_main, ai_topic_sub, ai_description, ai_grade_level, ai_estimated_time, ai_analyzed, question_type, question_type_confidence, student_question_text, ai_question_analysis, ai_coaching_comment, ai_next_questions, ai_growth_coaching, ai_model, ai_coaching_data FROM questions WHERE id = ?').bind(id).first()
    return c.json({ success: true, analysis: updated, debug: debugInfo })
  } catch (e: any) {
    return c.json({ success: false, error: e.message, stack: e.stack?.slice(0, 300) })
  }
})

// Batch analyze all unanalyzed questions
app.post('/api/questions/analyze-all', async (c) => {
  const db = c.env.DB
  const geminiKey = c.env.GEMINI_API_KEY
  if (!geminiKey) return c.json({ error: 'Gemini API key not configured' }, 500)
  
  // Re-analyze: unanalyzed OR force re-analyze all
  const reanalyze = c.req.query('force') === '1'
  const sql = reanalyze
    ? "SELECT id, subject, content, image_key, image_data FROM questions ORDER BY id DESC LIMIT 5"
    : "SELECT id, subject, content, image_key, image_data FROM questions WHERE ai_analyzed = 0 OR ai_analyzed IS NULL ORDER BY id DESC LIMIT 5"
  const unanalyzed = await db.prepare(sql).all()
  const ids = ((unanalyzed.results || []) as any[]).map(q => q.id)
  
  for (const q of (unanalyzed.results || []) as any[]) {
    await analyzeQuestionWithAI(db, c.env, q.id, q.subject, q.content, q.image_key, q.image_data)
  }
  
  return c.json({ success: true, analyzed: ids.length, ids })
})

app.patch('/api/questions/:id', async (c) => {
  const db = c.env.DB
  const id = c.req.param('id')
  const body = await c.req.json()
  const { subject, difficulty, status } = body
  const updates: string[] = []
  const params: any[] = []
  if (subject) { updates.push('subject = ?'); params.push(subject) }
  if (difficulty) { updates.push('difficulty = ?'); params.push(difficulty) }
  if (status) { updates.push('status = ?'); params.push(status) }
  if (updates.length === 0) return c.json({ error: 'No updates' }, 400)
  params.push(id)
  await db.prepare(`UPDATE questions SET ${updates.join(', ')} WHERE id = ?`).bind(...params).run()
  return c.json({ success: true })
})

// DELETE fallback via POST (some mobile browsers have issues with DELETE method)
app.post('/api/questions/:id/delete', async (c) => {
  // Redirect to the delete handler logic
  const db = c.env.DB
  const id = c.req.param('id')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token)
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  const question = await db.prepare('SELECT user_id, comment_count, status, difficulty, image_key, thumbnail_key FROM questions WHERE id = ?').bind(id).first() as any
  if (!question) return c.json({ error: 'ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
  if (question.user_id != (user as any).id) return c.json({ error: 'ë³¸ì¸ì˜ ì§ˆë¬¸ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 403)
  if ((question.comment_count || 0) > 0) return c.json({ error: 'ë‹µë³€ì´ ë‹¬ë¦° ì§ˆë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 400)
  if (question.status === 'ì±„íƒ ì™„ë£Œ') return c.json({ error: 'ì±„íƒ ì™„ë£Œëœ ì§ˆë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 400)
  if (question.status === 'ë§¤ì¹­ í™•ì •') return c.json({ error: 'ë§¤ì¹­ í™•ì •ëœ ì§ˆë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 400)
  if (question.difficulty === '1:1ì‹¬í™”ì„¤ëª…') {
    const match = await db.prepare("SELECT id FROM tutoring_matches WHERE question_id = ? AND status IN ('pending','confirmed') LIMIT 1").bind(id).first()
    if (match) return c.json({ error: 'ë§¤ì¹­ ì§„í–‰ ì¤‘ì¸ ì§ˆë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 400)
  }
  try {
    if (question.image_key && c.env.R2) try { await c.env.R2.delete(question.image_key) } catch(e){}
    if (question.thumbnail_key && c.env.R2) try { await c.env.R2.delete(question.thumbnail_key) } catch(e){}
  } catch(e){}
  try { await db.prepare('DELETE FROM tutoring_slots WHERE question_id = ?').bind(id).run() } catch(e){}
  try { await db.prepare('DELETE FROM coaching_logs WHERE question_id = ?').bind(id).run() } catch(e){}
  await db.prepare('DELETE FROM questions WHERE id = ?').bind(id).run()
  return c.json({ success: true })
})

app.delete('/api/questions/:id', async (c) => {
  const db = c.env.DB
  const id = c.req.param('id')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token)
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  const question = await db.prepare('SELECT user_id, comment_count, status, difficulty FROM questions WHERE id = ?').bind(id).first() as any
  if (!question) return c.json({ error: 'ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
  if (question.user_id != user.id) return c.json({ error: 'ë³¸ì¸ì˜ ì§ˆë¬¸ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 403)
  if ((question.comment_count || 0) > 0) return c.json({ error: 'ë‹µë³€ì´ ë‹¬ë¦° ì§ˆë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 400)
  if (question.status === 'ì±„íƒ ì™„ë£Œ') return c.json({ error: 'ì±„íƒ ì™„ë£Œëœ ì§ˆë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 400)
  if (question.status === 'ë§¤ì¹­ í™•ì •') return c.json({ error: 'ë§¤ì¹­ í™•ì •ëœ ì§ˆë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒëŒ€ë°©ê³¼ì˜ ì•½ì†ì…ë‹ˆë‹¤.' }, 400)
  // Check for any pending/confirmed tutoring match
  if (question.difficulty === '1:1ì‹¬í™”ì„¤ëª…') {
    const match = await db.prepare("SELECT id FROM tutoring_matches WHERE question_id = ? AND status IN ('pending','confirmed') LIMIT 1").bind(id).first()
    if (match) return c.json({ error: 'ë§¤ì¹­ ì§„í–‰ ì¤‘ì¸ ì§ˆë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 400)
  }

  // Clean up R2 images if present
  try {
    const qData = await db.prepare('SELECT image_key, thumbnail_key FROM questions WHERE id = ?').bind(id).first() as any
    if (qData) {
      if (qData.image_key && c.env.R2) try { await c.env.R2.delete(qData.image_key) } catch(e){}
      if (qData.thumbnail_key && c.env.R2) try { await c.env.R2.delete(qData.thumbnail_key) } catch(e){}
    }
  } catch(e){}
  
  // Delete related data first (FK)
  try { await db.prepare('DELETE FROM tutoring_slots WHERE question_id = ?').bind(id).run() } catch(e){}
  try { await db.prepare('DELETE FROM coaching_logs WHERE question_id = ?').bind(id).run() } catch(e){}
  
  await db.prepare('DELETE FROM questions WHERE id = ?').bind(id).run()
  return c.json({ success: true })
})

// ===== Tutoring Matching API =====

// Get tutoring slots & match status for a question
app.get('/api/questions/:id/tutoring', async (c) => {
  const db = c.env.DB
  const qId = c.req.param('id')
  const slots = await db.prepare('SELECT id, slot_time FROM tutoring_slots WHERE question_id = ? ORDER BY id ASC').bind(qId).all()
  const matches = await db.prepare('SELECT id, slot_id, tutor_id, tutor_name, tutor_grade, status, held_at, confirmed_at, acceptance_tags, acceptance_review FROM tutoring_matches WHERE question_id = ? ORDER BY held_at ASC').bind(qId).all()
  return c.json({ slots: slots.results || [], matches: matches.results || [] })
})

// Tutor checks a time slot (answer volunteer)
app.post('/api/questions/:id/tutoring/check', async (c) => {
  const db = c.env.DB
  const qId = c.req.param('id')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  // Suspension check
  const suspended = await checkSuspension(db, user.id)
  if (suspended) return c.json({ error: '1:1 íŠœí„°ë§ ì´ìš©ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. (' + suspended + 'ê¹Œì§€)' }, 403)

  const { slot_id } = await c.req.json()
  const question = await db.prepare('SELECT user_id, difficulty FROM questions WHERE id = ?').bind(qId).first() as any
  if (!question) return c.json({ error: 'ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
  if (question.difficulty !== '1:1ì‹¬í™”ì„¤ëª…') return c.json({ error: '1:1 íŠœí„°ë§ ì§ˆë¬¸ì´ ì•„ë‹™ë‹ˆë‹¤.' }, 400)
  if (question.user_id === user.id) return c.json({ error: 'ë³¸ì¸ ì§ˆë¬¸ì—ëŠ” ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 400)

  // Check if already has a confirmed match
  const confirmed = await db.prepare('SELECT id FROM tutoring_matches WHERE question_id = ? AND status = ?').bind(qId, 'confirmed').first()
  if (confirmed) return c.json({ error: 'ì´ë¯¸ ë§¤ì¹­ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)

  // Check if this user already checked
  const existing = await db.prepare('SELECT id FROM tutoring_matches WHERE question_id = ? AND tutor_id = ?').bind(qId, user.id).first()
  if (existing) return c.json({ error: 'ì´ë¯¸ ì‹ ì²­í•˜ì…¨ìŠµë‹ˆë‹¤.' }, 400)

  // Check for pending hold (first come first serve)
  const pending = await db.prepare("SELECT id, held_at FROM tutoring_matches WHERE question_id = ? AND status = 'pending'").bind(qId).first() as any
  if (pending) {
    // Check if hold expired (15 min)
    const heldTime = new Date(pending.held_at + 'Z').getTime()
    const now = Date.now()
    if (now - heldTime < 15 * 60 * 1000) {
      return c.json({ error: 'í˜„ì¬ ë‹¤ë¥¸ ë‹µë³€ìê°€ ìš°ì„  ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' }, 400)
    }
    // Expired - remove old hold
    await db.prepare("DELETE FROM tutoring_matches WHERE id = ?").bind(pending.id).run()
  }

  // Create new pending match (hold)
  await db.prepare('INSERT INTO tutoring_matches (question_id, slot_id, tutor_id, tutor_name, tutor_grade, status) VALUES (?, ?, ?, ?, ?, ?)').bind(qId, slot_id, user.id, user.nickname, user.grade || '', 'pending').run()

  // ì •ìœ¨í†¡ í‘¸ì‹œ: ì§ˆë¬¸ìì—ê²Œ íŠœí„°ë§ ì‹ ì²­ ì•Œë¦¼
  try {
    const senderExtId = await getExternalId(db, user.id)
    const receiverExtId = await getExternalId(db, question.user_id)
    if (senderExtId && receiverExtId) {
      const msg = `ğŸ“ [Q&A íŠœí„°ë§] ${user.nickname}ë‹˜ì´ 1:1 íŠœí„°ë§ì„ ì‹ ì²­í–ˆìŠµë‹ˆë‹¤! í™•ì •í•´ì£¼ì„¸ìš”.\nhttps://qa-tutoring-app.pages.dev/question/${qId}?user_id=${receiverExtId}`
      sendPush(senderExtId, receiverExtId, msg)
    }
  } catch(e) {}

  return c.json({ success: true, message: 'ì‹ ì²­ ì™„ë£Œ! ì§ˆë¬¸ì í™•ì •ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. (15ë¶„ ìš°ì„ ê¶Œ)' })
})

// Questioner confirms a match
app.post('/api/questions/:id/tutoring/confirm', async (c) => {
  const db = c.env.DB
  const qId = c.req.param('id')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  const { match_id } = await c.req.json()
  const question = await db.prepare('SELECT user_id FROM questions WHERE id = ?').bind(qId).first() as any
  if (!question || question.user_id != user.id) return c.json({ error: 'ì§ˆë¬¸ ì‘ì„±ìë§Œ í™•ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 403)

  if (!match_id) return c.json({ error: 'ë§¤ì¹­ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
  const match = await db.prepare('SELECT id, status FROM tutoring_matches WHERE id = ? AND question_id = ?').bind(match_id, qId).first() as any
  if (!match) return c.json({ error: 'ë§¤ì¹­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
  if (match.status === 'confirmed') return c.json({ error: 'ì´ë¯¸ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)

  // Confirm
  await db.prepare("UPDATE tutoring_matches SET status = 'confirmed', confirmed_at = datetime('now') WHERE id = ?").bind(match_id).run()
  // Update question status
  await db.prepare("UPDATE questions SET status = 'ë§¤ì¹­ í™•ì •' WHERE id = ?").bind(qId).run()
  // Remove other pending matches
  await db.prepare("DELETE FROM tutoring_matches WHERE question_id = ? AND id != ? AND status = 'pending'").bind(qId, match_id).run()

  // ì •ìœ¨í†¡ í‘¸ì‹œ: íŠœí„°ì—ê²Œ í™•ì • ì•Œë¦¼
  try {
    const confirmedMatch = await db.prepare('SELECT tutor_id, tutor_name FROM tutoring_matches WHERE id = ?').bind(match_id).first() as any
    if (confirmedMatch) {
      const senderExtId = await getExternalId(db, user.id)
      const receiverExtId = await getExternalId(db, confirmedMatch.tutor_id)
      if (senderExtId && receiverExtId) {
        const msg = `âœ… [Q&A íŠœí„°ë§] ${user.nickname}ë‹˜ì´ 1:1 íŠœí„°ë§ì„ í™•ì •í–ˆìŠµë‹ˆë‹¤! ìˆ˜ì—…ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.\nhttps://qa-tutoring-app.pages.dev/question/${qId}?user_id=${receiverExtId}`
        sendPush(senderExtId, receiverExtId, msg)
      }
    }
  } catch(e) {}

  return c.json({ success: true, message: 'ë§¤ì¹­ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' })
})

// Tutor declines
app.post('/api/questions/:id/tutoring/decline', async (c) => {
  const db = c.env.DB
  const qId = c.req.param('id')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  // Just remove the user's match
  await db.prepare('DELETE FROM tutoring_matches WHERE question_id = ? AND tutor_id = ?').bind(qId, user.id).run()
  return c.json({ success: true })
})

// Update tutoring slots (only if no confirmed match exists)
app.put('/api/questions/:id/tutoring/slots', async (c) => {
  const db = c.env.DB
  const qId = c.req.param('id')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  // Check question ownership
  const question = await db.prepare('SELECT user_id, difficulty FROM questions WHERE id = ?').bind(qId).first() as any
  if (!question) return c.json({ error: 'ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
  if (question.user_id !== user.id) return c.json({ error: 'ë³¸ì¸ì˜ ì§ˆë¬¸ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 403)
  if (question.difficulty !== '1:1ì‹¬í™”ì„¤ëª…') return c.json({ error: '1:1 íŠœí„°ë§ ì§ˆë¬¸ë§Œ ì‹œê°„ ìˆ˜ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.' }, 400)

  // Check if confirmed match exists
  const confirmedMatch = await db.prepare("SELECT id FROM tutoring_matches WHERE question_id = ? AND status = 'confirmed'").bind(qId).first()
  if (confirmedMatch) return c.json({ error: 'ë§¤ì¹­ì´ í™•ì •ëœ ì§ˆë¬¸ì€ ì‹œê°„ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 400)

  const { slots } = await c.req.json() as any
  if (!slots || !Array.isArray(slots) || slots.length === 0 || slots.length > 5) {
    return c.json({ error: 'ì‹œê°„ì€ 1~5ê°œê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 400)
  }

  // Delete pending matches (they chose old slots)
  await db.prepare("DELETE FROM tutoring_matches WHERE question_id = ? AND status = 'pending'").bind(qId).run()
  // Delete old slots
  await db.prepare('DELETE FROM tutoring_slots WHERE question_id = ?').bind(qId).run()
  // Insert new slots
  for (const slot of slots) {
    if (slot && typeof slot === 'string' && slot.trim()) {
      await db.prepare('INSERT INTO tutoring_slots (question_id, slot_time) VALUES (?, ?)').bind(qId, slot.trim()).run()
    }
  }

  return c.json({ success: true, message: 'ì‹œê°„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ì‹ ì²­ì€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' })
})

// Accept tutor after completed session (1:1 íŠœí„°ë§ ì±„íƒ)
app.post('/api/questions/:id/tutoring/accept', async (c) => {
  const db = c.env.DB
  const qId = c.req.param('id')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  // Check question ownership
  const question = await db.prepare('SELECT user_id, status, reward_points FROM questions WHERE id = ?').bind(qId).first() as any
  if (!question) return c.json({ error: 'ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
  if (question.user_id !== user.id) return c.json({ error: 'ì§ˆë¬¸ ì‘ì„±ìë§Œ ì±„íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 403)

  // Check for completed match
  const match = await db.prepare(`
    SELECT m.id, m.tutor_id, m.tutor_name, m.status, s.slot_time
    FROM tutoring_matches m
    JOIN tutoring_slots s ON m.slot_id = s.id
    WHERE m.question_id = ? AND m.status IN ('confirmed', 'completed')
    ORDER BY m.id DESC LIMIT 1
  `).bind(qId).first() as any
  if (!match) return c.json({ error: 'ë§¤ì¹­ëœ ë‹µë³€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)

  // Check if session time has passed
  const slotDate = parseSlotTimeToDate(match.slot_time)
  if (slotDate && slotDate.getTime() > Date.now()) {
    return c.json({ error: 'ìˆ˜ì—… ì‹œê°„ì´ ì§€ë‚œ í›„ì— ì±„íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 400)
  }

  const body = await c.req.json().catch(() => ({})) as any
  const review = body.review || ''
  const tags = body.tags || []
  const tagsJson = Array.isArray(tags) ? JSON.stringify(tags) : '[]'

  // Update match and question status with acceptance tags/review
  await db.prepare("UPDATE tutoring_matches SET status = 'accepted', acceptance_tags = ?, acceptance_review = ? WHERE id = ?").bind(tagsJson, review || null, match.id).run()
  await db.prepare("UPDATE questions SET status = 'ì±„íƒ ì™„ë£Œ' WHERE id = ?").bind(qId).run()
  
  // Reward tutor with points
  const pts = question.reward_points || 0
  if (pts > 0) {
    await db.prepare('UPDATE users SET points = points + ? WHERE id = ?').bind(pts, match.tutor_id).run()
  }

  // ì •ìœ¨í†¡ í‘¸ì‹œ: íŠœí„°ì—ê²Œ ì±„íƒ ì•Œë¦¼
  try {
    const senderExtId = await getExternalId(db, user.id)
    const receiverExtId = await getExternalId(db, match.tutor_id)
    if (senderExtId && receiverExtId) {
      const msg = `ğŸ† [Q&A íŠœí„°ë§] ${user.nickname}ë‹˜ì´ 1:1 íŠœí„°ë§ì„ ì±„íƒí–ˆìŠµë‹ˆë‹¤! ${pts > 0 ? pts + 'P íšë“! ' : ''}ğŸ‰\nhttps://qa-tutoring-app.pages.dev/question/${qId}?user_id=${receiverExtId}`
      sendPush(senderExtId, receiverExtId, msg)
    }
  } catch(e) {}

  return c.json({ success: true, message: match.tutor_name + 'ë‹˜ì„ ì±„íƒí–ˆìŠµë‹ˆë‹¤! (' + pts + 'P ì§€ê¸‰)' })
})

// ===== Schedule API =====

app.get('/api/schedule', async (c) => {
  const db = c.env.DB
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  // Get all confirmed + completed matches where user is questioner OR tutor
  const matches = await db.prepare(`
    SELECT m.id, m.question_id, m.slot_id, m.tutor_id, m.tutor_name, m.tutor_grade,
           m.status, m.held_at, m.confirmed_at,
           s.slot_time, q.title, q.content, q.subject, q.reward_points,
           q.user_id as questioner_id, q.author_name as questioner_name, q.author_grade as questioner_grade
    FROM tutoring_matches m
    JOIN tutoring_slots s ON m.slot_id = s.id
    JOIN questions q ON m.question_id = q.id
    WHERE m.status IN ('confirmed', 'completed') AND (q.user_id = ? OR m.tutor_id = ?)
    ORDER BY s.slot_time ASC
  `).bind(user.id, user.id).all()

  return c.json({
    user_id: user.id,
    schedules: matches.results || []
  })
})

// === Helper: Parse slot_time to Date (KST â†’ UTC) ===
// Slot times are in Korean Standard Time (UTC+9)
// Server runs in UTC, so we must subtract 9 hours to get correct UTC timestamp
function parseSlotTimeToDate(slotTime: string): Date | null {
  try {
    const parts = slotTime.trim().split(' ')
    if (parts.length < 3) return null
    const dateParts = parts[1].split('/')
    const timeParts = parts[2].split(':')
    const now = new Date()
    const year = now.getFullYear()
    // Create date as KST, then convert to UTC by subtracting 9 hours
    const kstDate = new Date(year, parseInt(dateParts[0]) - 1, parseInt(dateParts[1]), parseInt(timeParts[0]), parseInt(timeParts[1] || '0'))
    const utcDate = new Date(kstDate.getTime() - 9 * 3600000)
    if (utcDate.getTime() < now.getTime() - 180 * 86400000) utcDate.setTime(utcDate.getTime() + 365 * 86400000)
    return utcDate
  } catch (e) { return null }
}

// === Helper: Check suspension ===
async function checkSuspension(db: D1Database, userId: number): Promise<string | null> {
  const suspension = await db.prepare(
    "SELECT suspended_until, reason FROM user_suspensions WHERE user_id = ? AND suspended_until > datetime('now') ORDER BY suspended_until DESC LIMIT 1"
  ).bind(userId).first() as any
  if (!suspension) return null
  return suspension.suspended_until
}

// === Helper: Apply warnings & check suspension thresholds ===
async function applyWarnings(db: D1Database, userId: number, warningCount: number, cancelRecordId: number, reason: string) {
  // Add warning record
  await db.prepare('INSERT INTO user_warnings (user_id, cancel_record_id, warning_count, reason) VALUES (?, ?, ?, ?)').bind(userId, cancelRecordId, warningCount, reason).run()
  // Update user total
  await db.prepare('UPDATE users SET total_warnings = total_warnings + ? WHERE id = ?').bind(warningCount, userId).run()
  
  // Check 24-hour rolling window: count warnings in last 24 hours
  const recent = await db.prepare(
    "SELECT SUM(warning_count) as cnt FROM user_warnings WHERE user_id = ? AND created_at > datetime('now', '-24 hours')"
  ).bind(userId).first() as any
  const recentCount = recent?.cnt || 0

  // 24ì‹œê°„ ë‚´ ê²½ê³  3íšŒ ì´ìƒ â†’ 48ì‹œê°„ ì´ìš© ì •ì§€
  if (recentCount >= 3) {
    const until = new Date(Date.now() + 48 * 3600000).toISOString().replace('T', ' ').slice(0, 19)
    // Check if already suspended
    const existing = await checkSuspension(db, userId)
    if (!existing) {
      await db.prepare('INSERT INTO user_suspensions (user_id, reason, total_warnings, suspended_until) VALUES (?, ?, ?, ?)').bind(userId, '24ì‹œê°„ ë‚´ ê²½ê³  ' + recentCount + 'íšŒ ëˆ„ì ', recentCount, until).run()
    }
  }
}

// Cancel a tutoring match (with penalty system)
app.post('/api/schedule/:matchId/cancel', async (c) => {
  const db = c.env.DB
  const matchId = c.req.param('matchId')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  // Check suspension
  const suspendedUntil = await checkSuspension(db, user.id)
  if (suspendedUntil) return c.json({ error: '1:1 íŠœí„°ë§ ì´ìš©ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. (' + suspendedUntil + 'ê¹Œì§€)' }, 403)

  const match = await db.prepare(`
    SELECT m.id, m.question_id, m.tutor_id, m.status, m.confirmed_at, s.slot_time,
           q.user_id as questioner_id, q.reward_points
    FROM tutoring_matches m
    JOIN tutoring_slots s ON m.slot_id = s.id
    JOIN questions q ON m.question_id = q.id
    WHERE m.id = ?
  `).bind(matchId).first() as any
  if (!match) return c.json({ error: 'ë§¤ì¹­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
  if (match.status !== 'confirmed') return c.json({ error: 'í™•ì •ëœ ë§¤ì¹­ë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 400)

  const isQuestioner = match.questioner_id === user.id
  const isTutor = match.tutor_id === user.id
  if (!isQuestioner && !isTutor) return c.json({ error: 'ë§¤ì¹­ ë‹¹ì‚¬ìë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 403)

  const body = await c.req.json().catch(() => ({})) as any
  const reason = body.reason || 'ê¸°íƒ€'
  const reasonDetail = body.reason_detail || ''
  const isMutual = body.mutual === true

  // If mutual cancel request
  if (isMutual) {
    // Check if there's already a pending mutual cancel from the OTHER side
    const existing = await db.prepare(
      "SELECT id, requested_by FROM mutual_cancel_requests WHERE match_id = ? AND status = 'pending'"
    ).bind(matchId).first() as any
    
    if (existing && existing.requested_by !== user.id) {
      // Other party already requested â†’ both agree â†’ cancel with no penalty
      await db.prepare("UPDATE mutual_cancel_requests SET status = 'accepted', responded_at = datetime('now') WHERE id = ?").bind(existing.id).run()
      await db.prepare("UPDATE tutoring_matches SET status = 'cancelled' WHERE id = ?").bind(matchId).run()
      await db.prepare("UPDATE questions SET status = 'ì±„íƒ ëŒ€ê¸° ì¤‘' WHERE id = ?").bind(match.question_id).run()
      // Record cancel with no penalty
      await db.prepare('INSERT INTO cancel_records (match_id, question_id, cancelled_by, cancel_role, reason, reason_detail, penalty_type, penalty_points, warnings_added, hours_before) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)').bind(matchId, match.question_id, user.id, 'mutual', reason, reasonDetail, 'none', 0, 0, 0).run()
      return c.json({ success: true, message: 'ìƒí˜¸ í•©ì˜ë¡œ ë§¤ì¹­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. íŒ¨ë„í‹°ê°€ ì—†ìŠµë‹ˆë‹¤.', penalty: 'none', mutual: true })
    } else if (existing && existing.requested_by === user.id) {
      return c.json({ error: 'ì´ë¯¸ ìƒí˜¸ í•©ì˜ ì·¨ì†Œë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤. ìƒëŒ€ë°©ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.' }, 400)
    } else {
      // Create mutual cancel request
      await db.prepare('INSERT INTO mutual_cancel_requests (match_id, requested_by, reason) VALUES (?, ?, ?)').bind(matchId, user.id, reason).run()
      return c.json({ success: true, message: 'ìƒí˜¸ í•©ì˜ ì·¨ì†Œë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤. ìƒëŒ€ë°©ì´ ìŠ¹ì¸í•˜ë©´ íŒ¨ë„í‹° ì—†ì´ ì·¨ì†Œë©ë‹ˆë‹¤.', pending_mutual: true })
    }
  }

  // === One-sided cancel: apply penalties ===
  const slotDate = parseSlotTimeToDate(match.slot_time)
  let hoursUntilSession = -1
  if (slotDate) hoursUntilSession = (slotDate.getTime() - Date.now()) / 3600000

  // Check if within 2h of confirmation (grace period)
  let isGracePeriod = false
  if (match.confirmed_at) {
    const confirmedTime = new Date(match.confirmed_at + 'Z').getTime()
    isGracePeriod = (Date.now() - confirmedTime) < 2 * 3600000
  }

  let penaltyType = 'none'
  let penaltyPoints = 0
  let warningsAdded = 0
  const rewardPts = match.reward_points || 0

  if (isGracePeriod && hoursUntilSession > 24) {
    // Grace period + far enough â†’ free cancel for both
    penaltyType = 'none'
  } else if (isQuestioner) {
    // === ì§ˆë¬¸ì: í¬ì¸íŠ¸ ì°¨ê°ë§Œ, ê²½ê³  ì—†ìŒ ===
    if (hoursUntilSession > 24) {
      penaltyType = 'none' // 24ì‹œê°„ ì „: ììœ  ì·¨ì†Œ
    } else if (hoursUntilSession > 1) {
      penaltyType = 'half'
      penaltyPoints = Math.floor(rewardPts * 0.5) // 50% ì°¨ê°
    } else {
      penaltyType = 'full'
      penaltyPoints = rewardPts // 100% ì°¨ê°
    }
  } else {
    // === ë‹µë³€ì: ê²½ê³  ëˆ„ì , í¬ì¸íŠ¸ ì°¨ê° ì—†ìŒ ===
    if (hoursUntilSession > 24) {
      penaltyType = 'warning'
      warningsAdded = 1
    } else if (hoursUntilSession > 1) {
      penaltyType = 'warning'
      warningsAdded = 1
    } else {
      penaltyType = 'warning'
      warningsAdded = 2 // 1ì‹œê°„ ì´ë‚´: ê²½ê³  2íšŒ
    }
  }

  // Apply penalty
  await db.prepare("UPDATE tutoring_matches SET status = 'cancelled' WHERE id = ?").bind(matchId).run()
  await db.prepare("UPDATE questions SET status = 'ì±„íƒ ëŒ€ê¸° ì¤‘' WHERE id = ?").bind(match.question_id).run()
  await db.prepare('UPDATE users SET cancelled_matches = cancelled_matches + 1 WHERE id = ?').bind(user.id).run()

  // Record cancel
  const cancelResult = await db.prepare(
    'INSERT INTO cancel_records (match_id, question_id, cancelled_by, cancel_role, reason, reason_detail, penalty_type, penalty_points, warnings_added, hours_before) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)'
  ).bind(matchId, match.question_id, user.id, isQuestioner ? 'questioner' : 'tutor', reason, reasonDetail, penaltyType, penaltyPoints, warningsAdded, Math.max(0, hoursUntilSession)).run()
  const cancelRecordId = cancelResult.meta?.last_row_id || 0

  // Apply warnings if any
  if (warningsAdded > 0) {
    await applyWarnings(db, user.id, warningsAdded, cancelRecordId, reason)
  }

  // Point handling
  if (isQuestioner && penaltyPoints > 0) {
    // Questioner cancels: deduct from questioner, give 50% to tutor as consolation
    const consolation = Math.floor(penaltyPoints * 0.5)
    await db.prepare('UPDATE users SET points = points + ? WHERE id = ?').bind(consolation, match.tutor_id).run()
  } else if (isTutor && penaltyPoints > 0) {
    // Tutor cancels: questioner gets full refund (points already in question)
    // No extra deduction from tutor (they have no stake), just warnings
  }

  // Build response message
  let message = 'ë§¤ì¹­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'
  if (penaltyType === 'none') message += ' (íŒ¨ë„í‹° ì—†ìŒ)'
  else if (isQuestioner) {
    // ì§ˆë¬¸ì: í¬ì¸íŠ¸ ì°¨ê°ë§Œ í‘œì‹œ
    if (penaltyPoints > 0) message += ' (í¬ì¸íŠ¸ ' + penaltyPoints + 'P ì°¨ê°)'
  } else {
    // ë‹µë³€ì: ê²½ê³ ë§Œ í‘œì‹œ
    message += ' (ê²½ê³  ' + warningsAdded + 'íšŒ ë¶€ì—¬)'
  }

  return c.json({
    success: true,
    message,
    penalty: penaltyType,
    penalty_points: penaltyPoints,
    warnings_added: warningsAdded,
    cancelled_by: isQuestioner ? 'questioner' : 'tutor'
  })
})

// Get pending mutual cancel requests for a match
app.get('/api/schedule/:matchId/cancel-status', async (c) => {
  const db = c.env.DB
  const matchId = c.req.param('matchId')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  const pending = await db.prepare(
    "SELECT id, requested_by, reason, created_at FROM mutual_cancel_requests WHERE match_id = ? AND status = 'pending' ORDER BY created_at DESC LIMIT 1"
  ).bind(matchId).first() as any

  return c.json({
    has_pending_request: !!pending,
    requested_by_me: pending ? pending.requested_by === user.id : false,
    request: pending || null
  })
})

// Get user's penalty/warning info
app.get('/api/user/penalty-info', async (c) => {
  const db = c.env.DB
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  const userInfo = await db.prepare('SELECT total_warnings, total_matches, completed_matches, cancelled_matches FROM users WHERE id = ?').bind(user.id).first() as any
  const suspension = await checkSuspension(db, user.id)
  const recentCancels = await db.prepare(
    'SELECT reason, penalty_type, penalty_points, warnings_added, created_at FROM cancel_records WHERE cancelled_by = ? ORDER BY created_at DESC LIMIT 5'
  ).bind(user.id).all()

  const totalM = (userInfo?.total_matches || 0) + (userInfo?.completed_matches || 0) + (userInfo?.cancelled_matches || 0)
  const completedM = userInfo?.completed_matches || 0
  const fulfillRate = totalM > 0 ? Math.round((completedM / totalM) * 100) : 100

  return c.json({
    total_warnings: userInfo?.total_warnings || 0,
    total_matches: totalM,
    completed_matches: completedM,
    cancelled_matches: userInfo?.cancelled_matches || 0,
    fulfill_rate: fulfillRate,
    suspended_until: suspension,
    recent_cancels: recentCancels.results || []
  })
})

// Mark a tutoring session as completed
app.post('/api/schedule/:matchId/complete', async (c) => {
  const db = c.env.DB
  const matchId = c.req.param('matchId')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  const match = await db.prepare(`
    SELECT m.id, m.question_id, m.tutor_id, m.status, q.user_id as questioner_id
    FROM tutoring_matches m
    JOIN questions q ON m.question_id = q.id
    WHERE m.id = ?
  `).bind(matchId).first() as any
  if (!match) return c.json({ error: 'ë§¤ì¹­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
  if (match.questioner_id !== user.id && match.tutor_id !== user.id) return c.json({ error: 'ë§¤ì¹­ ë‹¹ì‚¬ìë§Œ ì™„ë£Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 403)

  await db.prepare("UPDATE tutoring_matches SET status = 'completed' WHERE id = ?").bind(matchId).run()
  await db.prepare("UPDATE questions SET status = 'ìˆ˜ì—… ì™„ë£Œ' WHERE id = ?").bind(match.question_id).run()
  // Update both users' match stats
  await db.prepare('UPDATE users SET completed_matches = completed_matches + 1 WHERE id = ?').bind(match.questioner_id).run()
  await db.prepare('UPDATE users SET completed_matches = completed_matches + 1 WHERE id = ?').bind(match.tutor_id).run()
  await db.prepare('UPDATE users SET total_matches = total_matches + 1 WHERE id = ?').bind(match.questioner_id).run()
  await db.prepare('UPDATE users SET total_matches = total_matches + 1 WHERE id = ?').bind(match.tutor_id).run()

  return c.json({ success: true, message: 'ìˆ˜ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!' })
})

app.get('/api/questions/:id/answers', async (c) => {
  const db = c.env.DB
  const id = c.req.param('id')
  const ansQuery = 'SELECT id, question_id, user_id, author_name, author_grade, content, is_accepted, acceptance_tags, acceptance_review, created_at, CASE WHEN (drawing_data IS NOT NULL AND drawing_data != \'\') OR (drawing_key IS NOT NULL AND drawing_key != \'\') THEN 1 ELSE 0 END as has_drawing, CASE WHEN (image_data IS NOT NULL AND image_data != \'\') OR (image_key IS NOT NULL AND image_key != \'\') THEN 1 ELSE 0 END as has_image, image_key, drawing_key, voice_key FROM answers WHERE question_id = ? ORDER BY created_at ASC'
  let result: any
  try {
    result = await db.prepare(ansQuery).bind(id).all()
  } catch (e) {
    try { await db.prepare('ALTER TABLE answers ADD COLUMN drawing_key TEXT DEFAULT NULL').run() } catch(e2){}
    result = await db.prepare(ansQuery).bind(id).all()
  }
  return c.json(result.results || [])
})

// Serve individual answer media (drawing/image) on demand
app.get('/api/answers/:id/drawing', async (c) => {
  const db = c.env.DB
  const r2 = c.env.R2
  const id = c.req.param('id')
  const row = await db.prepare('SELECT drawing_data, drawing_key FROM answers WHERE id = ?').bind(id).first() as any
  if (!row) return c.json({ error: 'Not found' }, 404)

  // R2 path: serve directly as binary image
  if (row.drawing_key && r2) {
    try {
      const object = await r2.get(row.drawing_key)
      if (object) {
        return new Response(object.body, {
          headers: {
            'Content-Type': object.httpMetadata?.contentType || 'image/png',
            'Cache-Control': 'public, max-age=86400, s-maxage=604800',
          }
        })
      }
    } catch (e) {}
  }

  // Fallback: base64 from DB
  if (!row.drawing_data) return c.json({ error: 'Not found' }, 404)
  return c.json({ data: row.drawing_data })
})

app.get('/api/answers/:id/image', async (c) => {
  const db = c.env.DB
  const r2 = c.env.R2
  const id = c.req.param('id')
  const row = await db.prepare('SELECT image_data, image_key FROM answers WHERE id = ?').bind(id).first() as any
  if (!row) return c.json({ error: 'Not found' }, 404)
  
  // R2 path
  if (row.image_key) {
    const object = await r2.get(row.image_key)
    if (object) {
      return new Response(object.body, {
        headers: {
          'Content-Type': object.httpMetadata?.contentType || 'image/jpeg',
          'Cache-Control': 'public, max-age=86400, s-maxage=604800',
        }
      })
    }
  }
  
  // Fallback: base64
  if (!row.image_data) return c.json({ error: 'Not found' }, 404)
  c.header('Cache-Control', 'public, max-age=86400, s-maxage=604800')
  return c.json({ data: row.image_data })
})

// === Voice recording upload ===
app.post('/api/voice/upload', async (c) => {
  try {
    const r2 = c.env.R2
    if (!r2) return c.json({ error: 'Storage not available' }, 500)
    const token = getTokenFromReq(c)
    if (!token) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. (í† í° ì—†ìŒ)' }, 401)
    const user = await getUser(c.env.DB, token) as any
    if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. (ì„¸ì…˜ ë§Œë£Œ)' }, 401)

    const formData = await c.req.formData()
    const file = formData.get('voice') as any
    if (!file) return c.json({ error: 'ìŒì„± íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.' }, 400)

    const buf = await file.arrayBuffer()
    if (buf.byteLength === 0) return c.json({ error: 'ë¹ˆ ìŒì„± íŒŒì¼ì…ë‹ˆë‹¤.' }, 400)
    const ext = file.type?.includes('webm') ? 'webm' : file.type?.includes('mp4') ? 'mp4' : file.type?.includes('ogg') ? 'ogg' : 'webm'
    const key = `voice/answer/${Date.now()}_${Math.random().toString(36).slice(2,8)}.${ext}`
    await r2.put(key, buf, { httpMetadata: { contentType: file.type || 'audio/webm' } })
    return c.json({ voice_key: key })
  } catch (e: any) {
    return c.json({ error: 'ìŒì„± ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ' + (e?.message || String(e)) }, 500)
  }
})

// === Serve voice recording from R2 ===
app.get('/api/voice/:key{.+}', async (c) => {
  const r2 = c.env.R2
  const key = c.req.param('key')
  if (!r2 || !key) return c.json({ error: 'Not found' }, 404)
  const obj = await r2.get(key)
  if (!obj) return c.json({ error: 'Not found' }, 404)
  return new Response(obj.body, {
    headers: {
      'Content-Type': obj.httpMetadata?.contentType || 'audio/webm',
      'Cache-Control': 'public, max-age=86400',
      'Accept-Ranges': 'bytes',
    }
  })
})

app.post('/api/questions/:id/answers', async (c) => {
  const db = c.env.DB
  const r2 = c.env.R2
  const questionId = c.req.param('id')
  const body = await c.req.json()
  const { content, image_data, drawing_data, voice_key } = body

  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  // Insert answer first to get the ID
  const result = await db.prepare(
    'INSERT INTO answers (question_id, user_id, author_name, author_grade, content, image_data, voice_key) VALUES (?, ?, ?, ?, ?, ?, ?)'
  ).bind(questionId, user.id, user.nickname, user.grade, content || '', image_data || null, voice_key || null).run()
  const answerId = result.meta.last_row_id

  // Save drawing to R2 if present
  if (drawing_data && r2) {
    try {
      const base64Match = drawing_data.match(/^data:([^;]+);base64,(.+)$/)
      if (base64Match) {
        const ct = base64Match[1]
        const b64 = base64Match[2]
        const bytes = Uint8Array.from(atob(b64), ch => ch.charCodeAt(0))
        const ext = ct.includes('png') ? 'png' : 'jpg'
        const drawingKey = `drawings/answer/${answerId}_${Date.now()}.${ext}`
        await r2.put(drawingKey, bytes.buffer, { httpMetadata: { contentType: ct } })
        await db.prepare('UPDATE answers SET drawing_key = ? WHERE id = ?').bind(drawingKey, answerId).run()
      } else {
        // Fallback: save raw data to DB if not base64 format
        await db.prepare('UPDATE answers SET drawing_data = ? WHERE id = ?').bind(drawing_data, answerId).run()
      }
    } catch (e) {
      // Fallback: try saving to DB directly (may fail for large data)
      try {
        await db.prepare('UPDATE answers SET drawing_data = ? WHERE id = ?').bind(drawing_data, answerId).run()
      } catch (e2) {
        console.error('Failed to save drawing:', e2)
      }
    }
  }

  await db.prepare('UPDATE questions SET comment_count = (SELECT COUNT(*) FROM answers WHERE question_id = ?) WHERE id = ?').bind(questionId, questionId).run()

  // ì •ìœ¨í†¡ í‘¸ì‹œ: ì§ˆë¬¸ìì—ê²Œ ë‹µë³€ ì•Œë¦¼
  try {
    const q = await db.prepare('SELECT user_id, title, subject FROM questions WHERE id = ?').bind(questionId).first() as any
    if (q && q.user_id !== user.id) {
      const senderExtId = await getExternalId(db, user.id)
      const receiverExtId = await getExternalId(db, q.user_id)
      if (senderExtId && receiverExtId) {
        const title = (q.title || '').slice(0, 20)
        const msg = `ğŸ“ [Q&A íŠœí„°ë§] ${user.nickname}ë‹˜ì´ "${title}" ì§ˆë¬¸ì— ë‹µë³€í–ˆìŠµë‹ˆë‹¤.\nhttps://qa-tutoring-app.pages.dev?user_id=${receiverExtId}`
        sendPush(senderExtId, receiverExtId, msg)
      }
    }
  } catch(e) {}

  return c.json({ id: answerId, message: 'Answer created' }, 201)
})

// ===== Replies (ëŒ€ëŒ“ê¸€) API =====

app.get('/api/answers/:id/replies', async (c) => {
  const db = c.env.DB
  const answerId = c.req.param('id')
  const result = await db.prepare('SELECT * FROM replies WHERE answer_id = ? ORDER BY created_at ASC').bind(answerId).all()
  return c.json(result.results || [])
})

app.post('/api/answers/:id/replies', async (c) => {
  const db = c.env.DB
  const answerId = c.req.param('id')
  const { content } = await c.req.json()
  if (!content || content.trim().length < 1) return c.json({ error: 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)

  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)

  const result = await db.prepare(
    'INSERT INTO replies (answer_id, user_id, author_name, author_grade, content) VALUES (?, ?, ?, ?, ?)'
  ).bind(answerId, user.id, user.nickname, user.grade, content.trim()).run()

  // ì •ìœ¨í†¡ í‘¸ì‹œ: ë‹µë³€ìì—ê²Œ ëŒ“ê¸€ ì•Œë¦¼
  try {
    const ans = await db.prepare('SELECT user_id, question_id FROM answers WHERE id = ?').bind(answerId).first() as any
    if (ans && ans.user_id !== user.id) {
      const senderExtId = await getExternalId(db, user.id)
      const receiverExtId = await getExternalId(db, ans.user_id)
      if (senderExtId && receiverExtId) {
        const msg = `ğŸ’¬ [Q&A íŠœí„°ë§] ${user.nickname}ë‹˜ì´ ë‹µë³€ì— ëŒ“ê¸€ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤: "${content.trim().slice(0, 30)}"\nhttps://qa-tutoring-app.pages.dev/question/${ans.question_id}?user_id=${receiverExtId}`
        sendPush(senderExtId, receiverExtId, msg)
      }
    }
    // ì§ˆë¬¸ìì—ê²Œë„ ì•Œë¦¼ (ë‹µë³€ìì™€ ë‹¤ë¥¸ ê²½ìš°)
    if (ans) {
      const q = await db.prepare('SELECT user_id FROM questions WHERE id = ?').bind(ans.question_id).first() as any
      if (q && q.user_id !== user.id && q.user_id !== ans.user_id) {
        const senderExtId = await getExternalId(db, user.id)
        const receiverExtId = await getExternalId(db, q.user_id)
        if (senderExtId && receiverExtId) {
          const msg = `ğŸ’¬ [Q&A íŠœí„°ë§] ${user.nickname}ë‹˜ì´ ì§ˆë¬¸ì˜ ëŒ“ê¸€ì— ë‹µí–ˆìŠµë‹ˆë‹¤.\nhttps://qa-tutoring-app.pages.dev/question/${ans.question_id}?user_id=${receiverExtId}`
          sendPush(senderExtId, receiverExtId, msg)
        }
      }
    }
  } catch(e) {}

  return c.json({ id: result.meta.last_row_id, message: 'Reply created' }, 201)
})

app.delete('/api/replies/:id', async (c) => {
  const db = c.env.DB
  const id = c.req.param('id')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
  const reply = await db.prepare('SELECT user_id FROM replies WHERE id = ?').bind(id).first() as any
  if (!reply) return c.json({ error: 'Not found' }, 404)
  if (reply.user_id != user.id) return c.json({ error: 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
  await db.prepare('DELETE FROM replies WHERE id = ?').bind(id).run()
  return c.json({ success: true })
})

app.delete('/api/answers/:id', async (c) => {
  const db = c.env.DB
  const id = c.req.param('id')
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
  const answer = await db.prepare('SELECT user_id, question_id FROM answers WHERE id = ?').bind(id).first() as any
  if (!answer) return c.json({ error: 'Not found' }, 404)
  if (answer.user_id != user.id) return c.json({ error: 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
  await db.prepare('DELETE FROM replies WHERE answer_id = ?').bind(id).run()
  await db.prepare('DELETE FROM answers WHERE id = ?').bind(id).run()
  await db.prepare('UPDATE questions SET comment_count = (SELECT COUNT(*) FROM answers WHERE question_id = ?) WHERE id = ?').bind(answer.question_id, answer.question_id).run()
  return c.json({ success: true })
})

app.patch('/api/answers/:id/accept', async (c) => {
  const db = c.env.DB
  const token = getTokenFromReq(c)
  const user = await getUser(db, token) as any
  if (!user) return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
  const id = c.req.param('id')
  const body = await c.req.json() as any
  const { tags, review } = body || {}
  const answer = await db.prepare('SELECT question_id FROM answers WHERE id = ?').bind(id).first() as any
  if (!answer) return c.json({ error: 'Not found' }, 404)
  // Verify the requester is the question author
  const question = await db.prepare('SELECT user_id FROM questions WHERE id = ?').bind(answer.question_id).first() as any
  if (!question || question.user_id != user.id) return c.json({ error: 'ì§ˆë¬¸ ì‘ì„±ìë§Œ ì±„íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 403)
  // Reset previous acceptance
  await db.prepare('UPDATE answers SET is_accepted = 0, acceptance_tags = NULL, acceptance_review = NULL WHERE question_id = ?').bind(answer.question_id).run()
  // Accept this answer with tags and review
  const tagsJson = tags && tags.length > 0 ? JSON.stringify(tags) : null
  await db.prepare('UPDATE answers SET is_accepted = 1, acceptance_tags = ?, acceptance_review = ? WHERE id = ?').bind(tagsJson, review || null, id).run()
  await db.prepare('UPDATE questions SET status = ? WHERE id = ?').bind('ì±„íƒ ì™„ë£Œ', answer.question_id).run()

  // ì •ìœ¨í†¡ í‘¸ì‹œ: ë‹µë³€ìì—ê²Œ ì±„íƒ ì•Œë¦¼
  try {
    const ans = await db.prepare('SELECT user_id FROM answers WHERE id = ?').bind(id).first() as any
    if (ans && ans.user_id !== user.id) {
      const senderExtId = await getExternalId(db, user.id)
      const receiverExtId = await getExternalId(db, ans.user_id)
      if (senderExtId && receiverExtId) {
        const msg = `â­ [Q&A íŠœí„°ë§] ${user.nickname}ë‹˜ì´ íšŒì›ë‹˜ì˜ ë‹µë³€ì„ ì±„íƒí–ˆìŠµë‹ˆë‹¤! ğŸ‰\nhttps://qa-tutoring-app.pages.dev/question/${answer.question_id}?user_id=${receiverExtId}`
        sendPush(senderExtId, receiverExtId, msg)
      }
    }
  } catch(e) {}

  return c.json({ success: true })
})

// ===== Ranking API =====

app.get('/api/ranking', async (c) => {
  const db = c.env.DB
  const type = c.req.query('type') || 'general' // 'general' or 'tutoring'

  if (type === 'tutoring') {
    // 1:1 íŠœí„°ë§ ì±„íƒ ë­í‚¹: tutoring_matchesì—ì„œ accepted ìƒíƒœì¸ tutor ê¸°ì¤€
    const result = await db.prepare(`
      SELECT m.tutor_id as user_id, m.tutor_name as nickname, m.tutor_grade as grade,
             COUNT(*) as accept_count
      FROM tutoring_matches m
      WHERE m.status = 'accepted'
      GROUP BY m.tutor_id
      ORDER BY accept_count DESC, m.tutor_id ASC
      LIMIT 50
    `).all()
    return c.json({ type: 'tutoring', ranking: result.results || [] })
  } else {
    // ì¼ë°˜ ì±„íƒ ë­í‚¹: answersì—ì„œ is_accepted = 1ì¸ ë‹µë³€ì ê¸°ì¤€
    const result = await db.prepare(`
      SELECT a.user_id, u.nickname, u.grade,
             COUNT(*) as accept_count
      FROM answers a
      JOIN users u ON a.user_id = u.id
      WHERE a.is_accepted = 1
      GROUP BY a.user_id
      ORDER BY accept_count DESC, a.user_id ASC
      LIMIT 50
    `).all()
    return c.json({ type: 'general', ranking: result.results || [] })
  }
})

// ===== Frontend Routes =====

app.get('/', async (c) => {
  const db = c.env.DB
  const result = await db.prepare('SELECT id, user_id, title, author_name, author_grade, content, subject, difficulty, comment_count, status, reward_points, created_at, CASE WHEN (image_data IS NOT NULL AND image_data != \'\') OR (image_key IS NOT NULL AND image_key != \'\') THEN 1 ELSE 0 END as has_image, image_key, thumbnail_key, thumbnail_data FROM questions ORDER BY created_at DESC').all()
  const questions = (result.results || []) as any[]
  
  // Get current user for match status in SSR
  const token = getTokenFromReq(c)
  const ssrUser = token ? await getUser(db, token) as any : null
  
  // Add answer participation info + tutoring match info for SSR
  let ssrAnsweredIds = new Set<number>()
  let ssrAcceptedIds = new Set<number>()
  if (ssrUser) {
    const ssrAnswers = await db.prepare('SELECT DISTINCT question_id FROM answers WHERE user_id = ?').bind(ssrUser.id).all()
    for (const a of (ssrAnswers.results || []) as any[]) ssrAnsweredIds.add(a.question_id)
    const ssrAccepted = await db.prepare('SELECT DISTINCT question_id FROM answers WHERE user_id = ? AND is_accepted = 1').bind(ssrUser.id).all()
    for (const a of (ssrAccepted.results || []) as any[]) ssrAcceptedIds.add(a.question_id)
    const ssrTutoring = await db.prepare('SELECT DISTINCT question_id FROM tutoring_matches WHERE tutor_id = ?').bind(ssrUser.id).all()
    for (const t of (ssrTutoring.results || []) as any[]) ssrAnsweredIds.add(t.question_id)
    const ssrAcceptedTutoring = await db.prepare("SELECT DISTINCT question_id FROM tutoring_matches WHERE tutor_id = ? AND status = 'accepted'").bind(ssrUser.id).all()
    for (const t of (ssrAcceptedTutoring.results || []) as any[]) ssrAcceptedIds.add(t.question_id)
  }

  for (const q of questions) {
    if (ssrUser) {
      q.i_answered = ssrAnsweredIds.has(q.id) ? 1 : 0
      q.i_accepted = ssrAcceptedIds.has(q.id) ? 1 : 0
    }
    if (q.difficulty === '1:1ì‹¬í™”ì„¤ëª…') {
      const pm = await db.prepare("SELECT id, tutor_name FROM tutoring_matches WHERE question_id = ? AND status = 'pending' LIMIT 1").bind(q.id).first() as any
      const cm = await db.prepare("SELECT id, tutor_id FROM tutoring_matches WHERE question_id = ? AND status = 'confirmed' LIMIT 1").bind(q.id).first() as any
      q.has_pending_match = pm ? 1 : 0
      q.pending_tutor_name = pm ? pm.tutor_name : null
      q.has_confirmed_match = cm ? 1 : 0
      if (ssrUser) {
        const myMatch = await db.prepare("SELECT id, status FROM tutoring_matches WHERE question_id = ? AND tutor_id = ? LIMIT 1").bind(q.id, ssrUser.id).first() as any
        q.my_match_status = myMatch ? myMatch.status : null
      }
    }
  }
  return c.html(mainPageHTML(questions))
})
app.get('/question/:id', async (c) => {
  const db = c.env.DB
  const qId = c.req.param('id')
  let q: any
  try {
    q = await db.prepare('SELECT id, user_id, title, author_name, author_grade, content, subject, difficulty, comment_count, status, reward_points, created_at, CASE WHEN (image_data IS NOT NULL AND image_data != \'\') OR (image_key IS NOT NULL AND image_key != \'\') THEN 1 ELSE 0 END as has_image, image_key, thumbnail_key, ai_difficulty, ai_tags, ai_topic_main, ai_topic_sub, ai_description, ai_grade_level, ai_estimated_time, ai_analyzed, question_type, student_question_text, ai_question_analysis, ai_coaching_comment, ai_next_questions, ai_growth_coaching, ai_model, ai_coaching_data FROM questions WHERE id = ?').bind(qId).first()
  } catch (e) {
    // Fallback: ai_next_questions column may not exist yet, auto-migrate
    try { await db.prepare('ALTER TABLE questions ADD COLUMN ai_next_questions TEXT DEFAULT NULL').run() } catch(e2){}
    q = await db.prepare('SELECT id, user_id, title, author_name, author_grade, content, subject, difficulty, comment_count, status, reward_points, created_at, CASE WHEN (image_data IS NOT NULL AND image_data != \'\') OR (image_key IS NOT NULL AND image_key != \'\') THEN 1 ELSE 0 END as has_image, image_key, thumbnail_key, ai_difficulty, ai_tags, ai_topic_main, ai_topic_sub, ai_description, ai_grade_level, ai_estimated_time, ai_analyzed, question_type, student_question_text, ai_question_analysis, ai_coaching_comment, ai_next_questions, ai_growth_coaching, ai_model, ai_coaching_data FROM questions WHERE id = ?').bind(qId).first()
  }
  let answers: any
  try {
    answers = await db.prepare('SELECT id, question_id, user_id, author_name, author_grade, content, is_accepted, acceptance_tags, acceptance_review, created_at, CASE WHEN (drawing_data IS NOT NULL AND drawing_data != \'\') OR (drawing_key IS NOT NULL AND drawing_key != \'\') THEN 1 ELSE 0 END as has_drawing, CASE WHEN (image_data IS NOT NULL AND image_data != \'\') OR (image_key IS NOT NULL AND image_key != \'\') THEN 1 ELSE 0 END as has_image, image_key, drawing_key, voice_key FROM answers WHERE question_id = ? ORDER BY created_at ASC').bind(qId).all()
  } catch (e) {
    // Fallback: drawing_key column may not exist yet, auto-migrate
    try { await db.prepare('ALTER TABLE answers ADD COLUMN drawing_key TEXT DEFAULT NULL').run() } catch(e2){}
    answers = await db.prepare('SELECT id, question_id, user_id, author_name, author_grade, content, is_accepted, acceptance_tags, acceptance_review, created_at, CASE WHEN (drawing_data IS NOT NULL AND drawing_data != \'\') OR (drawing_key IS NOT NULL AND drawing_key != \'\') THEN 1 ELSE 0 END as has_drawing, CASE WHEN (image_data IS NOT NULL AND image_data != \'\') OR (image_key IS NOT NULL AND image_key != \'\') THEN 1 ELSE 0 END as has_image, image_key, drawing_key, voice_key FROM answers WHERE question_id = ? ORDER BY created_at ASC').bind(qId).all()
  }
  return c.html(questionDetailHTML(q, answers.results || []))
})
app.get('/new', (c) => c.html(newQuestionHTML()))
app.get('/favicon.ico', (c) => new Response(null, { status: 204 }))
app.get('/login', (c) => c.redirect('/'))
app.get('/register', (c) => c.redirect('/'))
app.get('/mypage', (c) => c.html(mypageHTML()))
app.get('/coaching', (c) => c.html(coachingPageHTML()))
app.get('/coaching/:userId', (c) => c.html(coachingPageHTML()))
app.get('/schedule', (c) => c.html(schedulePageHTML()))

// === Coaching API ===
app.get('/api/coaching/stats', async (c) => {
  const db = c.env.DB
  let userId: number | null = null
  let viewerName = ''

  // Check if specific user is requested via query param
  const targetUserId = c.req.query('userId')
  if (targetUserId) {
    userId = parseInt(targetUserId)
    const targetUser = await db.prepare('SELECT id, nickname FROM users WHERE id = ?').bind(userId).first() as any
    if (!targetUser) return c.json({ error: 'User not found' }, 404)
    viewerName = targetUser.nickname
  } else {
    // Fallback to authenticated user
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) return c.json({ error: 'Unauthorized' }, 401)
    const session = await db.prepare('SELECT user_id FROM sessions WHERE token = ? AND expires_at > datetime(\'now\')').bind(token).first() as any
    if (!session) return c.json({ error: 'Unauthorized' }, 401)
    userId = session.user_id
    const user = await db.prepare('SELECT nickname FROM users WHERE id = ?').bind(userId).first() as any
    viewerName = user?.nickname || ''
  }

  // Get question type counts for this user
  const questions = await db.prepare(
    'SELECT question_type, created_at FROM questions WHERE user_id = ? AND question_type IS NOT NULL ORDER BY created_at DESC'
  ).bind(userId).all() as any

  const counts: Record<string, number> = { '1-1': 0, '1-2': 0, '2-1': 0, '2-2': 0, '2-3': 0, '3-1': 0, '3-2': 0 }
  const recentQuestions: any[] = []

  for (const q of (questions.results || [])) {
    if (q.question_type && counts[q.question_type] !== undefined) {
      counts[q.question_type]++
    }
  }

  // Get recent questions with type info
  const recent = await db.prepare(
    'SELECT id, title, content, question_type, subject, student_question_text, created_at FROM questions WHERE user_id = ? AND question_type IS NOT NULL ORDER BY created_at DESC LIMIT 10'
  ).bind(userId).all() as any

  // Weekly trend: last 5 weeks
  const weeklyScores: any[] = []
  for (let w = 4; w >= 0; w--) {
    const weekQuestions = await db.prepare(
      `SELECT question_type FROM questions WHERE user_id = ? AND question_type IS NOT NULL AND created_at >= datetime('now', '-${w * 7 + 7} days') AND created_at < datetime('now', '-${w * 7} days')`
    ).bind(userId).all() as any
    const wCounts: Record<string, number> = { '1-1': 0, '1-2': 0, '2-1': 0, '2-2': 0, '2-3': 0, '3-1': 0, '3-2': 0 }
    for (const q of (weekQuestions.results || [])) {
      if (q.question_type && wCounts[q.question_type] !== undefined) wCounts[q.question_type]++
    }
    const weights: Record<string, number> = { '1-1': 1, '1-2': 2, '2-1': 5, '2-2': 4, '2-3': 6, '3-1': 8, '3-2': 10 }
    const total = Object.values(wCounts).reduce((a, b) => a + b, 0)
    let weighted = 0
    Object.entries(wCounts).forEach(([k, v]) => { weighted += (weights[k] || 0) * v })
    const score = total === 0 ? 0 : Math.min(100, Math.round((weighted / (total * 10)) * 100))
    weeklyScores.push({ week: w === 0 ? 'ì´ë²ˆì£¼' : w + 'ì£¼ì „', score, total })
  }

  // Total questions for this user (all, not just typed)
  const totalRes = await db.prepare('SELECT COUNT(*) as cnt FROM questions WHERE user_id = ?').bind(userId).first() as any
  
  return c.json({
    counts,
    recentQuestions: (recent.results || []).map((q: any) => ({
      id: q.id, text: q.student_question_text || q.title || q.content, cat: q.question_type, subject: q.subject, date: q.created_at, studentQ: q.student_question_text
    })),
    weeklyScores,
    totalQuestions: totalRes?.cnt || 0,
    userName: viewerName,
    userId: userId
  })
})

// Coaching: upgrade suggestion â€” Hybrid (Gemini for easy, Claude for hard)
app.post('/api/coaching/upgrade', async (c) => {
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  if (!token) return c.json({ error: 'Unauthorized' }, 401)
  const db = c.env.DB
  const session = await db.prepare('SELECT user_id FROM sessions WHERE token = ? AND expires_at > datetime(\'now\')').bind(token).first() as any
  if (!session) return c.json({ error: 'Unauthorized' }, 401)

  const { questionId, questionText, questionType, subject, difficulty } = await c.req.json()
  const geminiKey = c.env.GEMINI_API_KEY
  const claudeKey = c.env.ANTHROPIC_API_KEY

  if (!geminiKey && !claudeKey) return c.json({ error: 'No AI API key configured' }, 500)

  const typeNames: Record<string, string> = {
    '1-1': 'ì§€ì‹í™•ì¸', '1-2': 'ì ˆì°¨í™•ì¸', '2-1': 'ê°œë…ì´í•´', '2-2': 'ì „ëµì„ íƒ',
    '2-3': 'ì˜¤ë¥˜ì§„ë‹¨', '3-1': 'ë¹„êµíŒë‹¨', '3-2': 'í™•ì¥ì°½ì¡°'
  }
  const upgradeMap: Record<string, string[]> = {
    '1-1': ['2-1','2-2'], '1-2': ['2-1','2-3'], '2-1': ['2-3','3-1'],
    '2-2': ['2-3','3-1'], '2-3': ['3-1','3-2'], '3-1': ['3-2'], '3-2': ['3-2']
  }
  const targets = upgradeMap[questionType] || ['2-1']

  // Determine difficulty for model selection
  const diffNum = parseInt((difficulty || '').replace(/[^0-9]/g, '')) || 0
  const useClaude = diffNum >= 4 && !!claudeKey

  const prompt = `ë‹¹ì‹ ì€ ê³ ë“±í•™ìƒ ì§ˆë¬¸ ì½”ì¹­ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

â˜…â˜…â˜… ì§ˆë¬¸ í†¤ ê·œì¹™: ì¶”ì²œ ì§ˆë¬¸ì€ í•™ìƒ í˜¼ì£ë§/ê¶ê¸ˆì¦ ìŠ¤íƒ€ì¼ë¡œ ì‘ì„±! (ì„ ìƒë‹˜ ì§ˆë¬¸ ê¸ˆì§€)
ì¢‹ì€ ì˜ˆ: "ê·¼ë° ì™œ ì—¬ê¸°ì„œ ì¹˜í™˜ì„ ì“°ëŠ” ê±°ì§€?", "ë‚´ í’€ì´ ì–´ë””ê°€ í‹€ë¦° ê±°ì•¼?"
$ ê¸°í˜¸/LaTeX ì‚¬ìš© ê¸ˆì§€ â€” ìœ ë‹ˆì½”ë“œ ìˆ˜ì‹ë§Œ: xÂ², f(x), âˆ«, Î£, Ï€, âˆš

í•™ìƒì˜ ì›ë˜ ì§ˆë¬¸: "${questionText}"
í˜„ì¬ ì§ˆë¬¸ ìœ í˜•: ${questionType} (${typeNames[questionType] || 'ë¯¸ë¶„ë¥˜'})
ê³¼ëª©: ${subject || 'ìˆ˜í•™'}

ì´ ì§ˆë¬¸ì„ ë” ë†’ì€ ìˆ˜ì¤€ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì—¬ í•™ìƒì˜ ì‚¬ê³ ë ¥ì„ í–¥ìƒì‹œì¼œì£¼ì„¸ìš”.

ë‹¤ìŒ ìœ í˜•ë“¤ë¡œ ì—…ê·¸ë ˆì´ë“œëœ ì§ˆë¬¸ ì˜ˆì‹œë¥¼ ê°ê° ë§Œë“¤ì–´ì£¼ì„¸ìš”:
${targets.map(t => `- ${t} (${typeNames[t]})`).join('\n')}

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "upgrades": [
    {
      "targetType": "2-1",
      "targetTypeName": "ê°œë…ì´í•´",
      "upgradedQuestion": "í•™ìƒ í˜¼ì£ë§ ìŠ¤íƒ€ì¼ì˜ ì—…ê·¸ë ˆì´ë“œëœ ì§ˆë¬¸",
      "explanation": "ì™œ ì´ ì§ˆë¬¸ì´ ë” ì¢‹ì€ì§€ í•œ ì¤„ ì„¤ëª…",
      "tip": "ì´ëŸ° ì§ˆë¬¸ì„ í•˜ë©´ ì¢‹ì€ ì´ìœ  íŒ"
    }
  ],
  "model": "${useClaude ? 'claude' : 'gemini'}"
}`

  try {
    let resultJson: any
    
    if (useClaude) {
      // === Claude Sonnet for â˜…4~5 ===
      const claudeRes = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': claudeKey, 'anthropic-version': '2023-06-01' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 4096,
          messages: [{ role: 'user', content: prompt }]
        })
      })
      if (!claudeRes.ok) throw new Error('Claude API error: ' + claudeRes.status)
      const claudeData = await claudeRes.json() as any
      const textBlock = claudeData.content?.find((b: any) => b.type === 'text')
      if (!textBlock?.text) throw new Error('No text in Claude response')
      let jsonStr = ''
      const cbm = textBlock.text.match(/```(?:json)?\s*([\s\S]*?)```/)
      if (cbm) jsonStr = cbm[1].trim()
      else { const m = textBlock.text.match(/\{[\s\S]*\}/); if (m) jsonStr = m[0] }
      if (!jsonStr) throw new Error('No JSON in Claude response')
      resultJson = JSON.parse(jsonStr)
      resultJson.model = 'claude'
    } else if (geminiKey) {
      // === Gemini Flash for â˜…1~3 ===
      const geminiRes = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + geminiKey, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
        })
      })
      if (!geminiRes.ok) throw new Error('Gemini API error: ' + geminiRes.status)
      const geminiData = await geminiRes.json() as any
      const allParts = geminiData.candidates?.[0]?.content?.parts || []
      let text = ''
      for (const p of allParts) { if (p.text && !p.thought) text += p.text }
      let jsonStr = ''
      const codeBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/)
      if (codeBlockMatch) jsonStr = codeBlockMatch[1].trim()
      else { const m = text.match(/\{[\s\S]*\}/); if (m) jsonStr = m[0] }
      if (!jsonStr) throw new Error('No JSON in Gemini response')
      resultJson = JSON.parse(jsonStr)
      resultJson.model = 'gemini'
    } else {
      return c.json({ error: 'No suitable AI key' }, 500)
    }

    return c.json(resultJson)
  } catch (e: any) {
    // Fallback: if Claude fails, try Gemini
    if (useClaude && geminiKey) {
      try {
        const geminiRes = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + geminiKey, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
          })
        })
        if (geminiRes.ok) {
          const gd = await geminiRes.json() as any
          const ap = gd.candidates?.[0]?.content?.parts || []
          let t = ''; for (const p of ap) { if (p.text && !p.thought) t += p.text }
          const cbm2 = t.match(/```(?:json)?\s*([\s\S]*?)```/)
          let js = cbm2 ? cbm2[1].trim() : ''
          if (!js) { const m2 = t.match(/\{[\s\S]*\}/); if (m2) js = m2[0] }
          if (js) { const r = JSON.parse(js); r.model = 'gemini-fallback'; return c.json(r) }
        }
      } catch (e2) {}
    }
    return c.json({ error: e.message }, 500)
  }
})

// === Coaching Log API ===
app.post('/api/coaching/log', async (c) => {
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  if (!token) return c.json({ error: 'Unauthorized' }, 401)
  const db = c.env.DB
  const session = await db.prepare("SELECT user_id FROM sessions WHERE token = ? AND expires_at > datetime('now')").bind(token).first() as any
  if (!session) return c.json({ error: 'Unauthorized' }, 401)
  const { questionId, step, choice, timeSpentMs } = await c.req.json()
  if (!questionId || !step || !choice) return c.json({ error: 'Missing fields' }, 400)
  await db.prepare('INSERT INTO coaching_logs (question_id, user_id, step, choice, time_spent_ms) VALUES (?, ?, ?, ?, ?)').bind(questionId, session.user_id, step, choice, timeSpentMs || 0).run()
  return c.json({ success: true })
})

// === ì½”ì¹­ ë¡œê·¸ ì¡°íšŒ API (ë¦¬ë·°ìš©) ===
app.get('/api/coaching/logs/:questionId', async (c) => {
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  if (!token) return c.json({ error: 'Unauthorized' }, 401)
  const db = c.env.DB
  const session = await db.prepare("SELECT user_id FROM sessions WHERE token = ? AND expires_at > datetime('now')").bind(token).first() as any
  if (!session) return c.json({ error: 'Unauthorized' }, 401)
  const questionId = c.req.param('questionId')
  const logs = await db.prepare(
    'SELECT step, choice, time_spent_ms, created_at FROM coaching_logs WHERE question_id = ? AND user_id = ? ORDER BY created_at ASC'
  ).bind(questionId, session.user_id).all()
  return c.json({ success: true, logs: logs.results || [] })
})

// === ì½”ì¹­ ë¡œê·¸ ì´ˆê¸°í™” API (ë‹¤ì‹œí•˜ê¸°ìš©) ===
app.post('/api/coaching/logs/:questionId/reset', async (c) => {
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  if (!token) return c.json({ error: 'Unauthorized' }, 401)
  const db = c.env.DB
  const session = await db.prepare("SELECT user_id FROM sessions WHERE token = ? AND expires_at > datetime('now')").bind(token).first() as any
  if (!session) return c.json({ error: 'Unauthorized' }, 401)
  const questionId = c.req.param('questionId')
  await db.prepare('DELETE FROM coaching_logs WHERE question_id = ? AND user_id = ?').bind(questionId, session.user_id).run()
  return c.json({ success: true })
})

app.get('/ranking', (c) => c.html(rankingPageHTML()))
app.get('/category/:name', (c) => c.html(categoryPageHTML(c.req.param('name'))))

export default app

// ===== PWA Meta Tags =====

function pwaHead() {
  return `<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#141414">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Q&A">
<link rel="apple-touch-icon" href="/icon-192.svg">
<meta name="mobile-web-app-capable" content="yes">`
}

function pwaScript() {
  return `<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}
</script>`
}

// ===== Shared CSS =====

function sharedCSS() {
  return `
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
@import url('https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#141414;--bg2:#1a1a1a;--bg3:#222;--bg4:#2a2a2a;
  --text:#e5e5e5;--dim:#999;--muted:#666;
  --white:#fff;--red:#e50914;--green:#46d369;
  --border:#333;
}
html{scroll-behavior:smooth}
body{font-family:'Pretendard',-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;-webkit-font-smoothing:antialiased;overflow-x:hidden}
a{color:inherit;text-decoration:none}
button{cursor:pointer;font-family:inherit}
input,textarea,select{font-family:inherit}
`
}

// ===== Shared Auth JS =====
function sharedAuthJS() {
  return `
function getToken(){return localStorage.getItem('qa_token')}
function setToken(t){localStorage.setItem('qa_token',t)}
function clearToken(){localStorage.removeItem('qa_token');localStorage.removeItem('qa_user')}
function getUser(){try{return JSON.parse(localStorage.getItem('qa_user'))}catch(e){return null}}
function setUser(u){localStorage.setItem('qa_user',JSON.stringify(u))}
function authHeaders(){const t=getToken();return t?{'Authorization':'Bearer '+t,'Content-Type':'application/json'}:{'Content-Type':'application/json'}}
async function checkAuth(){
  // 1) URL íŒŒë¼ë¯¸í„°ì—ì„œ user_id í™•ì¸ (ì •ìœ¨í†¡ì—ì„œ í˜¸ì¶œ)
  const params=new URLSearchParams(location.search);
  const extUserId=params.get('user_id');
  const extNickName=params.get('nick_name');
  if(extUserId){
    try{
      const r=await fetch('/api/auth/external',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:extUserId,nick_name:extNickName||undefined})});
      if(r.ok){
        const d=await r.json();
        setToken(d.token);setUser(d.user);
        // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±° (ê¹”ë”í•œ URL)
        const clean=location.pathname+(params.toString()?'':'');
        params.delete('user_id');params.delete('nick_name');
        const newUrl=location.pathname+(params.toString()?'?'+params.toString():'');
        history.replaceState(null,'',newUrl);
        return d.user;
      }
    }catch(e){}
  }
  // 2) ê¸°ì¡´ í† í° í™•ì¸
  const t=getToken();if(!t)return null;
  try{const r=await fetch('/api/auth/me',{headers:{'Authorization':'Bearer '+t}});if(!r.ok){clearToken();return null}const u=await r.json();setUser(u);return u}
  catch(e){return null}
}
function requireAuth(){const t=getToken();if(!t){return false}return true}
if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{})}
`
}

// ===== Main Page (Grid Gallery) =====

function mainPageHTML(questions: any[] = []) {
  return `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Q&A</title>
${pwaHead()}
<style>
${sharedCSS()}

*{box-sizing:border-box}
.nav{position:fixed;top:0;left:0;right:0;z-index:200;height:60px;display:flex;align-items:center;padding:0 24px;background:rgba(15,15,25,.97);border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(12px)}
.nav__logo{font-size:26px;font-weight:800;color:var(--red);letter-spacing:-1px;margin-right:24px;flex-shrink:0}
.nav__right{display:flex;align-items:center;gap:8px;margin-left:auto}
.nav__search-wrap{position:relative;display:flex;align-items:center;height:32px}
.nav__search{width:0;padding:0;border:none;background:transparent;color:var(--white);font-size:13px;outline:none;transition:width .3s,padding .3s,border .3s;border-radius:3px;position:absolute;right:0}
.nav__search.open{width:180px;padding:7px 12px;border:1px solid var(--muted);background:rgba(0,0,0,.75)}
.nav__search-icon{font-size:14px;color:var(--dim);cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:4px}
.nav__search-icon:hover{color:var(--white);background:rgba(255,255,255,.08)}
.nav__btn{padding:8px 18px;font-size:14px;font-weight:600;color:var(--white);background:var(--red);border:none;border-radius:4px;transition:opacity .15s;white-space:nowrap}
.nav__btn:hover{opacity:.85}
.nav__user-btn{padding:8px 14px;font-size:13px;font-weight:600;color:var(--dim);background:none;border:1px solid var(--border);border-radius:4px;transition:all .15s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.nav__user-btn:hover{color:var(--white);border-color:var(--muted)}
.nav__aux{display:flex;align-items:center;gap:6px;margin-left:4px}
.nav__aux a{font-size:13px;color:var(--dim);text-decoration:none;display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:4px;transition:all .15s;white-space:nowrap}
.nav__aux a:hover{color:var(--white);background:rgba(255,255,255,.06)}
.nav__aux a i{font-size:10px}

/* Main content area */
.main{padding:72px 24px 40px;max-width:100%;margin:0 auto}

/* Schedule banner */
.today-sch-banner{margin-bottom:16px;background:linear-gradient(135deg,rgba(255,215,0,.08),rgba(108,92,231,.08));border:1px solid rgba(255,215,0,.2);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .2s}
.today-sch-banner:hover{border-color:rgba(255,215,0,.4);transform:translateY(-1px)}
.today-sch-banner__icon{width:38px;height:38px;border-radius:50%;background:rgba(255,215,0,.12);display:flex;align-items:center;justify-content:center;font-size:16px;color:#ffd700;flex-shrink:0;animation:ring 2s ease infinite}
.today-sch-banner__info{flex:1;min-width:0}
.today-sch-banner__title{font-size:12px;font-weight:700;color:var(--white);margin-bottom:2px}
.today-sch-banner__sub{font-size:11px;color:var(--muted)}
.today-sch-banner__time{font-size:16px;font-weight:800;color:#ffd700;flex-shrink:0}
.today-sch-banner__countdown{font-size:10px;color:var(--muted);text-align:right;margin-top:2px}

/* Category tabs */
.cat-tabs{display:flex;gap:0;margin-bottom:16px;border-bottom:2px solid rgba(255,255,255,.06)}
.cat-tab{padding:12px 24px;font-size:18px;font-weight:600;color:var(--dim);background:none;border:none;cursor:pointer;position:relative;transition:color .2s;white-space:nowrap}
.cat-tab:hover{color:var(--white)}
.cat-tab.active{color:var(--white)}
.cat-tab.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--red);border-radius:1px}
.cat-tab .cat-count{font-size:14px;font-weight:400;color:var(--muted);margin-left:4px}
.cat-tab.active .cat-count{color:rgba(255,255,255,.6)}
.cat-tab--killer{color:#ff6b35 !important}
.cat-tab--killer.active::after{background:linear-gradient(90deg,#ff4500,#ff6b35)}
.cat-tab--tutor{color:#a29bfe !important}
.cat-tab--tutor.active::after{background:linear-gradient(90deg,#6c5ce7,#a29bfe)}

/* Subject filter chips */
.subj-bar{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.subj-chip{padding:7px 18px;border-radius:20px;font-size:15px;font-weight:600;border:1px solid var(--border);background:transparent;color:var(--dim);cursor:pointer;transition:all .2s;white-space:nowrap}
.subj-chip:hover{border-color:var(--muted);color:var(--white)}
.subj-chip.active{background:var(--white);color:var(--bg);border-color:var(--white)}
.subj-right{margin-left:auto;display:flex;align-items:center;gap:6px}
.subj-right select{background:var(--bg2);color:var(--dim);border:1px solid var(--border);border-radius:4px;padding:6px 10px;font-size:14px;outline:none;cursor:pointer}

/* My filter chips */
.my-bar{display:flex;gap:6px;margin-bottom:8px}
.my-chip{padding:7px 16px;border-radius:20px;font-size:14px;font-weight:600;border:1px solid rgba(255,65,54,.2);background:transparent;color:var(--red);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px}
.my-chip:hover{border-color:var(--red)}
.my-chip.active{background:var(--red);color:#fff;border-color:var(--red)}
.my-chip--ans{border-color:rgba(108,92,231,.2);color:#a29bfe}
.my-chip--ans:hover{border-color:#6c5ce7}
.my-chip--ans.active{background:#6c5ce7;color:#fff;border-color:#6c5ce7}

/* Grid layout */
.qgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;min-height:200px}
@media(max-width:1100px){.qgrid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:700px){.qgrid{grid-template-columns:repeat(3,1fr);gap:5px}}
@media(max-width:480px){.qgrid{grid-template-columns:repeat(2,1fr);gap:4px}}

/* Card styles - grid version */
.card{display:block;border-radius:6px;overflow:hidden;position:relative;cursor:pointer;background:var(--bg2);transition:transform .2s,box-shadow .2s;text-decoration:none;aspect-ratio:4/3}
.card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.card__img-wrap{width:100%;height:100%;position:relative;overflow:hidden}
.card__img{width:100%;height:100%;object-fit:cover}
.card__ph{width:100%;height:100%;background:linear-gradient(135deg,#2a2a3a,#1a1a2e);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:14px;padding:16px;text-align:center;line-height:1.5}
.card__badge{position:absolute;font-size:11px;font-weight:700;padding:3px 8px;background:var(--red);color:var(--white);border-radius:3px;z-index:2}
.card__badge--done{top:6px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#ffd700,#ffaa00);color:#111;display:flex;align-items:center;gap:3px;font-weight:800;padding:3px 8px;box-shadow:0 0 8px rgba(255,215,0,.4)}
.card__badge--killer{top:6px;left:6px;background:linear-gradient(135deg,#ff4500,#ff6b35);color:#fff;display:flex;align-items:center;gap:2px}
.card__badge--tutor{top:6px;left:6px;background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff;display:flex;align-items:center;gap:2px;font-weight:700}
.card__ans{position:absolute;top:6px;right:6px;font-size:12px;font-weight:600;padding:3px 8px;background:rgba(0,0,0,.6);color:var(--white);border-radius:3px;display:flex;align-items:center;gap:3px;z-index:2}
.card__match-badge{position:absolute;top:6px;right:6px;margin-top:28px;font-size:11px;font-weight:700;padding:3px 8px;border-radius:3px;z-index:2;display:flex;align-items:center;gap:3px}
.card__match--pending{background:linear-gradient(135deg,#ffd700,#ffa500);color:#111}
.card__match--confirmed{background:linear-gradient(135deg,#00c853,#69f0ae);color:#111}
.card__match--my-pending{background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff}
.card__ai-tags{position:absolute;bottom:24px;left:6px;right:6px;display:flex;flex-wrap:wrap;gap:4px;z-index:2;pointer-events:none}
.card__ai-tag{font-size:11px;font-weight:700;color:#fff;background:rgba(6,182,212,.75);padding:2px 7px;border-radius:8px;backdrop-filter:blur(4px);white-space:nowrap;max-width:110px;overflow:hidden;text-overflow:ellipsis;text-shadow:0 1px 2px rgba(0,0,0,.3)}
.card__del{position:absolute;bottom:6px;right:6px;width:34px;height:34px;border-radius:50%;background:rgba(229,9,20,.9);color:#fff;border:none;font-size:13px;display:flex;align-items:center;justify-content:center;opacity:1;transition:transform .15s;cursor:pointer;z-index:5;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.card__del:active{transform:scale(.85)}
@media(hover:hover){.card__del{opacity:0}.card:hover .card__del{opacity:1}}
.card__info{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.85));padding:20px 8px 6px;pointer-events:none;display:flex;justify-content:space-between;align-items:flex-end}
.card__info-left{flex:1;min-width:0}
.card__info-right{text-align:right;flex-shrink:0;margin-left:6px}
.card__info-name{font-size:12px;font-weight:600;color:rgba(255,255,255,.8);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card__info-time{font-size:11px;color:rgba(255,255,255,.5)}
.card__info-grade{font-size:11px;font-weight:700;color:#ffd700;margin-left:4px}

/* Pagination */
.pager{display:flex;justify-content:center;align-items:center;gap:4px;margin-top:24px;padding-bottom:20px}
.pager__btn{width:38px;height:38px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--dim);font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.pager__btn:hover{border-color:var(--muted);color:var(--white)}
.pager__btn.active{background:var(--red);color:#fff;border-color:var(--red)}
.pager__btn:disabled{opacity:.3;cursor:default}
.pager__dots{color:var(--muted);font-size:15px;padding:0 4px}

.empty{text-align:center;padding:60px 0;color:var(--muted);font-size:18px}
.loading-spinner{text-align:center;padding:60px 0;color:var(--muted);font-size:13px}

.fab{position:fixed;bottom:24px;right:24px;width:50px;height:50px;border-radius:50%;background:var(--red);color:var(--white);border:none;font-size:18px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,.4);z-index:100;transition:transform .15s}
.fab:hover{transform:scale(1.1)}
@media(min-width:768px){.fab{display:none}}

/* Search results */
.search-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;min-height:200px}
@media(max-width:1100px){.search-grid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:700px){.search-grid{grid-template-columns:repeat(3,1fr);gap:5px}}
@media(max-width:480px){.search-grid{grid-template-columns:repeat(2,1fr);gap:4px}}

@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes ring{0%{transform:rotate(0)}15%{transform:rotate(15deg)}30%{transform:rotate(-15deg)}45%{transform:rotate(10deg)}60%{transform:rotate(-10deg)}75%{transform:rotate(5deg)}100%{transform:rotate(0)}}

@media(max-width:700px){
  .cat-tabs{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .cat-tabs::-webkit-scrollbar{display:none}
  .cat-tab{padding:10px 16px;font-size:15px}
  .subj-bar{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px}
  .subj-bar::-webkit-scrollbar{display:none}
  .nav__aux{display:none}
  .main{padding:68px 10px 30px}
}
</style>
</head>
<body>
<nav class="nav" id="nav">
  <div class="nav__logo">Q&A</div>
  <div class="nav__aux" id="navAux">
    <a href="/schedule" id="schLink" style="display:none"><i class="fas fa-calendar-alt" style="color:#a29bfe"></i> ìŠ¤ì¼€ì¤„</a>
    <a href="/coaching" id="coachLink" style="display:none"><i class="fas fa-chart-radar" style="color:#fbbf24"></i> ì½”ì¹­</a>
    <a href="/ranking"><i class="fas fa-trophy" style="color:#ffd700"></i> ë­í‚¹</a>
  </div>
  <div class="nav__right">
    <div class="nav__search-wrap">
      <i class="fas fa-search nav__search-icon" id="searchToggle"></i>
      <input id="searchInput" class="nav__search" type="text" placeholder="ê²€ìƒ‰...">
    </div>
    <a href="/new" class="nav__btn" onclick="event.preventDefault();if(!requireAuth())return;location.href='/new'"><i class="fas fa-plus" style="margin-right:3px"></i>ì§ˆë¬¸í•˜ê¸°</a>
    <div id="authArea"></div>
  </div>
</nav>

<div class="main">
  <div id="todayScheduleBanner" style="display:none"></div>

  <!-- Category Tabs -->
  <div class="cat-tabs" id="catTabs">
    <button class="cat-tab active" data-cat="all"><i class="fas fa-th" style="margin-right:4px"></i>ì „ì²´<span class="cat-count" id="cntAll"></span></button>
    <button class="cat-tab" data-cat="normal"><i class="fas fa-book-open" style="margin-right:4px"></i>Q&A<span class="cat-count" id="cntNormal"></span></button>
    <button class="cat-tab cat-tab--killer" data-cat="killer"><i class="fas fa-fire" style="margin-right:4px"></i>ê³ ë‚œë„ ë„ì „<span class="cat-count" id="cntKiller"></span></button>
    <button class="cat-tab cat-tab--tutor" data-cat="tutoring"><i class="fas fa-chalkboard-teacher" style="margin-right:4px"></i>1:1 íŠœí„°ë§<span class="cat-count" id="cntTutor"></span></button>
  </div>

  <!-- Subject Filters + Sort -->
  <div class="subj-bar" id="subjBar">
    <button class="subj-chip active" data-subj="ì „ì²´">ì „ì²´</button>
    <button class="subj-chip" data-subj="êµ­ì–´">êµ­ì–´</button>
    <button class="subj-chip" data-subj="ìˆ˜í•™">ìˆ˜í•™</button>
    <button class="subj-chip" data-subj="ì˜ì–´">ì˜ì–´</button>
    <button class="subj-chip" data-subj="ê³¼í•™">ê³¼í•™</button>
    <button class="subj-chip" data-subj="ê¸°íƒ€">ê¸°íƒ€</button>
    <div class="subj-right">
      <select id="sortSelect">
        <option value="latest">ìµœì‹ ìˆœ</option>
        <option value="unanswered">ë¯¸ë‹µë³€</option>
        <option value="points">í¬ì¸íŠ¸ìˆœ</option>
      </select>
    </div>
  </div>

  <!-- My Q/A filter (login only) -->
  <div class="my-bar" id="myBar" style="display:none">
    <button class="my-chip" data-my="ë‚´ ì§ˆë¬¸" id="myQChip"><i class="fas fa-user"></i> ë‚´ ì§ˆë¬¸</button>
    <button class="my-chip my-chip--ans" data-my="ë‚´ ë‹µë³€" id="myAChip"><i class="fas fa-pen"></i> ë‚´ ë‹µë³€</button>
  </div>

  <!-- Grid -->
  <div id="gallery" class="qgrid"></div>

  <!-- Pagination -->
  <div id="pager" class="pager"></div>

  <!-- Search Results -->
  <div id="searchResults" class="search-grid" style="display:none"></div>
</div>

<a href="/new" class="fab" onclick="event.preventDefault();if(!requireAuth())return;location.href='/new'"><i class="fas fa-plus"></i></a>

<script>
${sharedAuthJS()}

// === State ===
let currentUser=null;
let curCat='all'; // 'all' | 'normal' | 'killer' | 'tutoring'
let curSubj='ì „ì²´';
let curSort='latest';
let curPage=0;
let curMyFilter=null; // null | 'ë‚´ ì§ˆë¬¸' | 'ë‚´ ë‹µë³€'
const PAGE_SIZE=35;
let totalItems=0;
let gridData=[];
let allDataForCounts=[]; // for category count badges
const imageCache={};
let sto=null;
let isLoading=false;
let cachedAllData=[]; // Full dataset for instant client-side filtering

// === Card click delegation (handles card navigation + delete button) ===
(function(){
  var gallery=document.getElementById('gallery');
  if(!gallery)return;
  gallery.addEventListener('click',function(e){
    // Check if the click target is a delete button or inside one
    var delEl=e.target.closest('[data-del-id]');
    if(delEl){
      e.preventDefault();e.stopPropagation();
      var qid=Number(delEl.getAttribute('data-del-id'));
      if(qid)deleteQ(qid);
      return;
    }
    // Otherwise navigate to card link
    var card=e.target.closest('.card[data-href]');
    if(card){
      var href=card.getAttribute('data-href');
      if(href)window.location.href=href;
    }
  });
})();

// === Init ===
(async()=>{
  currentUser=await checkAuth();
  const el=document.getElementById('authArea');
  if(currentUser){
    el.innerHTML='<a href="/mypage" class="nav__user-btn"><i class="fas fa-user-circle"></i> '+currentUser.nickname+'</a>';
    document.getElementById('schLink').style.display='';
    document.getElementById('coachLink').style.display='';
    document.getElementById('myBar').style.display='flex';
  }else{el.innerHTML=''}
  // SSR initial data
  const ssrQ=${JSON.stringify(questions)};
  // Cache all data for instant client-side filtering
  cachedAllData=ssrQ;
  allDataForCounts=ssrQ;
  updateCategoryCounts();
  // Initial load from SSR (filter client-side for first render)
  renderFromCache();
  // If user logged in, re-fetch full data with auth for match statuses
  if(currentUser){
    loadTodayScheduleBanner();
    refreshAllData();
  }
  startMainPoll();
})();

function updateCategoryCounts(){
  const d=allDataForCounts;
  const allC=d.length;
  const normalC=d.filter(q=>q.difficulty!=='ìµœìƒ'&&q.difficulty!=='1:1ì‹¬í™”ì„¤ëª…').length;
  const killerC=d.filter(q=>q.difficulty==='ìµœìƒ').length;
  const tutorC=d.filter(q=>q.difficulty==='1:1ì‹¬í™”ì„¤ëª…').length;
  document.getElementById('cntAll').textContent=allC?' ('+allC+')':'';
  document.getElementById('cntNormal').textContent=normalC?' ('+normalC+')':'';
  document.getElementById('cntKiller').textContent=killerC?' ('+killerC+')':'';
  document.getElementById('cntTutor').textContent=tutorC?' ('+tutorC+')':'';
}

function renderFromCache(){
  // Instant client-side filtering from cached data (no API call)
  let filtered=cachedAllData;
  if(curCat==='normal')filtered=filtered.filter(q=>q.difficulty!=='ìµœìƒ'&&q.difficulty!=='1:1ì‹¬í™”ì„¤ëª…');
  else if(curCat==='killer')filtered=filtered.filter(q=>q.difficulty==='ìµœìƒ');
  else if(curCat==='tutoring')filtered=filtered.filter(q=>q.difficulty==='1:1ì‹¬í™”ì„¤ëª…');
  // 'all' = no category filter
  if(curSubj!=='ì „ì²´')filtered=filtered.filter(q=>q.subject===curSubj);
  if(curMyFilter==='ë‚´ ì§ˆë¬¸'&&currentUser)filtered=filtered.filter(q=>q.user_id===currentUser.id);
  if(curMyFilter==='ë‚´ ë‹µë³€')filtered=filtered.filter(q=>q.i_answered);
  // Sort
  if(curSort==='unanswered')filtered=[...filtered].sort((a,b)=>(a.comment_count||0)-(b.comment_count||0)||new Date(b.created_at)-new Date(a.created_at));
  else if(curSort==='points')filtered=[...filtered].sort((a,b)=>(b.reward_points||0)-(a.reward_points||0)||new Date(b.created_at)-new Date(a.created_at));
  else filtered=[...filtered].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  totalItems=filtered.length;
  const start=curPage*PAGE_SIZE;
  gridData=filtered.slice(start,start+PAGE_SIZE);
  renderGrid();
  renderPager();
}

// Fetch full data from API and update cache (background refresh)
async function refreshAllData(){
  try{
    const h=currentUser?authHeaders():{'Content-Type':'application/json'};
    const res=await fetch('/api/questions',{headers:h});
    const json=await res.json();
    const newData=json.questions||json||[];
    cachedAllData=newData;
    allDataForCounts=newData;
    updateCategoryCounts();
    renderFromCache();
  }catch(e){console.error('refreshAllData error',e)}
}

// fetchPage/fetchCounts removed - all filtering is now instant client-side via renderFromCache()

// === Time helper ===
function timeAgo(d){
  const ms=Date.now()-new Date(d+'Z').getTime(),m=Math.floor(ms/60000);
  if(m<1)return'ë°©ê¸ˆ ì „';if(m<60)return m+'ë¶„ ì „';
  const h=Math.floor(m/60);if(h<24)return h+'ì‹œê°„ ì „';return Math.floor(h/24)+'ì¼ ì „';
}

// === Card HTML ===
function cardHTML(q){
  const isMine=currentUser&&currentUser.id===q.user_id;
  const canDel=isMine&&(q.comment_count||0)===0&&q.status!=='ì±„íƒ ì™„ë£Œ'&&q.status!=='ë§¤ì¹­ í™•ì •'&&!q.has_pending_match&&!q.has_confirmed_match;
  const img=q.has_image
    ?(q.thumbnail_key?'<img class="card__img" src="/api/images/'+q.thumbnail_key+'" alt="">'
      :q.thumbnail_data?'<img class="card__img" src="'+q.thumbnail_data+'" alt="">'
      :imageCache[q.id]?'<img class="card__img" src="'+imageCache[q.id]+'" alt="">'
      :'<img class="card__img" data-qid="'+q.id+'" alt="" style="background:var(--bg3)">')
    :'<div class="card__ph">'+(q.content||'').slice(0,60)+'</div>';
  let badge='';
  const rp=q.reward_points||0;
  if(q.status==='ì±„íƒ ì™„ë£Œ')badge+='<div class="card__badge card__badge--done"><i class="fas fa-star"></i> ì±„íƒ</div>';
  if(q.difficulty==='ìµœìƒ'){
    badge+='<div class="card__badge card__badge--killer"><i class="fas fa-fire"></i> ê³ ë‚œë„'+(rp?' <span style="color:#ffd700;margin-left:2px">'+rp+'P</span>':'')+'</div>';
  }else if(q.difficulty==='1:1ì‹¬í™”ì„¤ëª…'){
    badge+='<div class="card__badge card__badge--tutor"><i class="fas fa-chalkboard-teacher"></i> íŠœí„°ë§'+(rp?' <span style="color:#ffd700;margin-left:2px">'+rp+'P</span>':'')+'</div>';
  }
  const ans='<div class="card__ans"><i class="fas fa-comment"></i> '+(q.comment_count||0)+'</div>';
  let matchNotif='';
  if(q.difficulty==='1:1ì‹¬í™”ì„¤ëª…'){
    if(q.has_confirmed_match)matchNotif='<div class="card__match-badge card__match--confirmed"><i class="fas fa-check-circle"></i> ë§¤ì¹­</div>';
    else if(isMine&&q.has_pending_match)matchNotif='<div class="card__match-badge card__match--pending"><i class="fas fa-bell"></i> ì‹ ì²­!</div>';
    else if(q.my_match_status==='pending')matchNotif='<div class="card__match-badge card__match--my-pending"><i class="fas fa-hand-paper"></i> ì‹ ì²­</div>';
  }
  let myBadge='';
  if(q.i_accepted)myBadge='<div style="position:absolute;bottom:6px;left:6px;background:linear-gradient(135deg,#ffd700,#ffaa00);color:#111;font-size:11px;font-weight:800;padding:3px 8px;border-radius:3px;z-index:2"><i class="fas fa-star"></i> ì±„íƒë¨</div>';
  else if(q.i_answered)myBadge='<div style="position:absolute;bottom:6px;left:6px;background:rgba(108,92,231,.85);color:#fff;font-size:11px;font-weight:700;padding:3px 8px;border-radius:3px;z-index:2"><i class="fas fa-pen"></i> ë‹µë³€í•¨</div>';
  // AI tags overlay on card
  let aiTagsOverlay='';
  if(q.ai_analyzed && q.ai_tags && !q.i_accepted && !q.i_answered){
    const tags=(q.ai_tags||'').split(/\\s+/).filter(t=>t.startsWith('#')).slice(0,3);
    if(tags.length) aiTagsOverlay='<div class="card__ai-tags">'+tags.map(t=>'<span class="card__ai-tag">'+t+'</span>').join('')+'</div>';
  }
  const delBtn=canDel?'<div class="card__del" data-del-id="'+q.id+'" title="ì‚­ì œ"><i class="fas fa-trash-alt"></i></div>':'';
  const outline=isMine?' style="outline:2px solid var(--red);outline-offset:-2px;border-radius:8px"':'';
  return'<div class="card" data-href="/question/'+q.id+'"'+outline+'>'+
    '<div class="card__img-wrap">'+img+badge+ans+matchNotif+myBadge+aiTagsOverlay+delBtn+
    '<div class="card__info"><div class="card__info-left"><div class="card__info-time">'+timeAgo(q.created_at)+'</div></div><div class="card__info-right"><div class="card__info-name">'+q.author_name+(q.author_grade?'<span class="card__info-grade">'+q.author_grade+'</span>':'')+'</div></div></div>'+
    '</div></div>';
}

// === Render Grid ===
function renderGrid(){
  const el=document.getElementById('gallery');
  if(!gridData.length){
    el.innerHTML='<div class="empty" style="grid-column:1/-1">ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  el.innerHTML=gridData.map(cardHTML).join('');
  lazyLoadCardImages();
}

// === Pagination ===
function renderPager(){
  const el=document.getElementById('pager');
  const totalPages=Math.ceil(totalItems/PAGE_SIZE);
  if(totalPages<=1){el.innerHTML='';return}
  let html='';
  html+='<button class="pager__btn" onclick="goPage('+(curPage-1)+')" '+(curPage<=0?'disabled':'')+'><i class="fas fa-chevron-left"></i></button>';
  const maxShow=7;
  let start=Math.max(0,curPage-Math.floor(maxShow/2));
  let end=Math.min(totalPages,start+maxShow);
  if(end-start<maxShow)start=Math.max(0,end-maxShow);
  if(start>0)html+='<button class="pager__btn" onclick="goPage(0)">1</button><span class="pager__dots">...</span>';
  for(let i=start;i<end;i++){
    html+='<button class="pager__btn'+(i===curPage?' active':'')+'" onclick="goPage('+i+')">'+(i+1)+'</button>';
  }
  if(end<totalPages)html+='<span class="pager__dots">...</span><button class="pager__btn" onclick="goPage('+(totalPages-1)+')">'+totalPages+'</button>';
  html+='<button class="pager__btn" onclick="goPage('+(curPage+1)+')" '+(curPage>=totalPages-1?'disabled':'')+'><i class="fas fa-chevron-right"></i></button>';
  el.innerHTML=html;
}
window.goPage=function(p){
  const totalPages=Math.ceil(totalItems/PAGE_SIZE);
  if(p<0||p>=totalPages)return;
  curPage=p;
  renderFromCache();
  document.querySelector('.main').scrollTo({top:0,behavior:'smooth'});
  window.scrollTo({top:0,behavior:'smooth'});
};

// === Lazy Load Images ===
function lazyLoadCardImages(){
  document.querySelectorAll('img[data-qid]').forEach(img=>{
    const qid=img.getAttribute('data-qid');
    if(!qid)return;
    if(imageCache[qid]){img.src=imageCache[qid];return}
    if(!img.src||img.src===location.href){
      fetch('/api/questions/'+qid+'/image').then(r=>r.json()).then(d=>{
        if(d.data){imageCache[qid]=d.data;img.src=d.data}
        else{img.alt='ì´ë¯¸ì§€ ì—†ìŒ';img.style.background='var(--bg3)'}
      }).catch(()=>{img.alt='ë¡œë“œ ì‹¤íŒ¨';img.style.background='var(--bg3)'});
    }
  });
}

// === Category Tab Events ===
document.querySelectorAll('.cat-tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.cat-tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    curCat=t.dataset.cat;
    curPage=0;
    curMyFilter=null;
    document.querySelectorAll('.my-chip').forEach(c=>c.classList.remove('active'));
    renderFromCache(); // Instant client-side filter
  });
});

// === Subject Filter Events ===
document.querySelectorAll('.subj-chip').forEach(c=>{
  c.addEventListener('click',()=>{
    document.querySelectorAll('.subj-chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');
    curSubj=c.dataset.subj;
    curPage=0;
    renderFromCache(); // Instant client-side filter
  });
});

// === Sort Events ===
document.getElementById('sortSelect').addEventListener('change',e=>{
  curSort=e.target.value;
  curPage=0;
  renderFromCache(); // Instant client-side filter
});

// === My Filter Events ===
document.querySelectorAll('.my-chip').forEach(c=>{
  c.addEventListener('click',()=>{
    const wasActive=c.classList.contains('active');
    document.querySelectorAll('.my-chip').forEach(x=>x.classList.remove('active'));
    if(wasActive){curMyFilter=null}
    else{c.classList.add('active');curMyFilter=c.dataset.my}
    curPage=0;
    renderFromCache(); // Instant client-side filter
  });
});

// === Search ===
document.getElementById('searchToggle').addEventListener('click',()=>{
  const inp=document.getElementById('searchInput');
  inp.classList.toggle('open');
  if(inp.classList.contains('open'))inp.focus();
  else{inp.value='';exitSearch()}
});
document.getElementById('searchInput').addEventListener('input',e=>{
  clearTimeout(sto);const v=e.target.value.trim();
  if(!v){exitSearch();return}
  sto=setTimeout(()=>doSearch(v),300);
});
async function doSearch(q){
  document.getElementById('gallery').style.display='none';
  document.getElementById('pager').style.display='none';
  const el=document.getElementById('searchResults');el.style.display='grid';
  try{
    const r=await fetch('/api/questions?search='+encodeURIComponent(q));
    const json=await r.json();
    const items=json.questions||json||[];
    el.innerHTML=items.length?items.map(cardHTML).join(''):'<div class="empty" style="grid-column:1/-1">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    lazyLoadCardImages();
  }catch(e){el.innerHTML='<div class="empty" style="grid-column:1/-1">ê²€ìƒ‰ ì‹¤íŒ¨</div>'}
}
function exitSearch(){
  document.getElementById('searchResults').style.display='none';
  document.getElementById('gallery').style.display='';
  document.getElementById('pager').style.display='';
}

// === Auto-refresh polling ===
let mainPollTimer=null;
async function mainPollOnce(){
  await refreshAllData();
}
function startMainPoll(){if(mainPollTimer)return;mainPollTimer=setInterval(mainPollOnce,10000)}
function stopMainPoll(){if(mainPollTimer){clearInterval(mainPollTimer);mainPollTimer=null}}
document.addEventListener('visibilitychange',()=>{if(document.hidden)stopMainPoll();else{mainPollOnce();startMainPoll()}});

// === Delete ===
var _deleteInProgress=false;
async function deleteQ(id){
  if(_deleteInProgress)return;
  if(!confirm('ì´ ì§ˆë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  _deleteInProgress=true;
  try{
    var t=getToken();
    var hdrs=t?{'Authorization':'Bearer '+t}:{};
    // Use POST /delete endpoint for mobile compatibility (DELETE method can fail on some browsers)
    var res=await fetch('/api/questions/'+id+'/delete',{method:'POST',headers:hdrs});
    var txt=await res.text();
    var d;
    try{d=JSON.parse(txt)}catch(pe){alert('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: '+txt.slice(0,100));_deleteInProgress=false;return}
    if(!res.ok){alert(d.error||'ì‚­ì œ ì‹¤íŒ¨');_deleteInProgress=false;return}
    cachedAllData=cachedAllData.filter(function(q){return q.id!==id});
    allDataForCounts=cachedAllData;
    updateCategoryCounts();
    renderFromCache();
  }catch(e){alert('ì‚­ì œ ìš”ì²­ ì‹¤íŒ¨: '+(e.message||e))}
  _deleteInProgress=false;
}
window.deleteQ=deleteQ;

// === Today's Schedule Banner ===
let scheduleBannerTimer=null;
async function loadTodayScheduleBanner(){
  try{
    const res=await fetch('/api/schedule',{headers:authHeaders()});
    const data=await res.json();
    if(!res.ok||!data.schedules)return;
    const now=new Date();
    const schedules=data.schedules.filter(s=>s.status==='confirmed').map(s=>{
      const parts=s.slot_time.trim().split(' ');
      if(parts.length<3)return null;
      const dp=parts[1].split('/'),tp=parts[2].split(':');
      const yr=now.getFullYear();
      const d=new Date(yr,parseInt(dp[0])-1,parseInt(dp[1]),parseInt(tp[0]),parseInt(tp[1]||'0'));
      if(d.getTime()<now.getTime()-180*86400000)d.setFullYear(yr+1);
      return {...s,_date:d,_diff:d.getTime()-now.getTime()};
    }).filter(s=>s&&s._diff>-3600000).sort((a,b)=>a._diff-b._diff);
    const banner=document.getElementById('todayScheduleBanner');
    if(!schedules.length){banner.style.display='none';return}
    const next=schedules[0];
    const isQ=currentUser.id===next.questioner_id;
    const partner=isQ?next.tutor_name:next.questioner_name;
    const timeStr=next._date.getHours().toString().padStart(2,'0')+':'+next._date.getMinutes().toString().padStart(2,'0');
    function updateCountdown(){
      const diff=next._date.getTime()-Date.now();
      if(diff<=0){cdEl.textContent='ì§€ê¸ˆ ì‹œì‘!';return}
      const h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),sec=Math.floor((diff%60000)/1000);
      cdEl.textContent=(h>0?h+'ì‹œê°„ ':'')+m+'ë¶„ '+sec+'ì´ˆ í›„';
    }
    banner.innerHTML='<div class="today-sch-banner" onclick="location.href=\\x27/schedule\\x27"><div class="today-sch-banner__icon"><i class="fas fa-bell"></i></div><div class="today-sch-banner__info"><div class="today-sch-banner__title">ë‹¤ê°€ì˜¤ëŠ” 1:1 íŠœí„°ë§</div><div class="today-sch-banner__sub">'+next.subject+' Â· '+partner+'ë‹˜'+(schedules.length>1?' ì™¸ '+(schedules.length-1)+'ê±´':'')+'</div></div><div><div class="today-sch-banner__time">'+timeStr+'</div><div class="today-sch-banner__countdown" id="schCountdown"></div></div></div>';
    banner.style.display='block';
    const cdEl=document.getElementById('schCountdown');
    updateCountdown();
    if(scheduleBannerTimer)clearInterval(scheduleBannerTimer);
    scheduleBannerTimer=setInterval(updateCountdown,1000);
  }catch(e){}
}
</script>
</body>
</html>`
}

// ===== Auth Page (Login / Register) =====

function authPageHTML() {
  return `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¡œê·¸ì¸</title>
${pwaHead()}
<style>
${sharedCSS()}

.auth-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.auth-box{width:100%;max-width:380px;background:var(--bg2);border-radius:8px;padding:40px 32px;border:1px solid var(--border)}
.auth-logo{text-align:center;margin-bottom:28px}
.auth-logo span{font-size:28px;font-weight:800;color:var(--red)}
.auth-tabs{display:flex;gap:0;margin-bottom:24px;border-bottom:2px solid var(--border)}
.auth-tab{flex:1;text-align:center;padding:10px;font-size:14px;font-weight:600;color:var(--muted);background:none;border:none;cursor:pointer;transition:all .2s;border-bottom:2px solid transparent;margin-bottom:-2px}
.auth-tab.active{color:var(--white);border-bottom-color:var(--red)}
.auth-form{display:none}
.auth-form.active{display:block}
.auth-field{margin-bottom:14px}
.auth-field label{font-size:12px;font-weight:600;color:var(--muted);display:block;margin-bottom:6px}
.auth-field label em{color:var(--red);font-style:normal}
.auth-input{width:100%;padding:11px 14px;font-size:14px;border:1px solid var(--border);border-radius:4px;background:#1a1a1a;color:var(--white);outline:none;transition:border-color .15s}
.auth-input:focus{border-color:var(--muted)}
.auth-input::placeholder{color:var(--muted)}
select.auth-input{appearance:auto}
.auth-btn{width:100%;padding:12px;font-size:14px;font-weight:700;border:none;border-radius:4px;background:var(--red);color:var(--white);margin-top:8px;transition:opacity .15s}
.auth-btn:hover{opacity:.85}
.auth-btn:disabled{opacity:.4}
.auth-error{font-size:12px;color:#ff4444;text-align:center;margin-top:10px;min-height:16px}
.auth-back{display:block;text-align:center;margin-top:20px;font-size:13px;color:var(--muted);transition:color .15s}
.auth-back:hover{color:var(--white)}
</style>
</head>
<body>
<div class="auth-wrap">
  <div class="auth-box">
    <div class="auth-logo"><span>Q&A</span></div>
    <div class="auth-tabs">
      <button class="auth-tab active" data-tab="login">ë¡œê·¸ì¸</button>
      <button class="auth-tab" data-tab="register">íšŒì›ê°€ì…</button>
    </div>

    <form class="auth-form active" id="loginForm" onsubmit="return false">
      <div class="auth-field">
        <label>ì•„ì´ë””</label>
        <input class="auth-input" id="loginId" type="text" placeholder="ì•„ì´ë”” ì…ë ¥" autocomplete="username">
      </div>
      <div class="auth-field">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input class="auth-input" id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password">
      </div>
      <button class="auth-btn" id="loginBtn" onclick="doLogin()">ë¡œê·¸ì¸</button>
      <div class="auth-error" id="loginError"></div>
    </form>

    <form class="auth-form" id="registerForm" onsubmit="return false">
      <div class="auth-field">
        <label>ì•„ì´ë”” <em>*</em></label>
        <input class="auth-input" id="regId" type="text" placeholder="4ì ì´ìƒ" autocomplete="username">
      </div>
      <div class="auth-field">
        <label>ë¹„ë°€ë²ˆí˜¸ <em>*</em></label>
        <input class="auth-input" id="regPw" type="password" placeholder="6ì ì´ìƒ" autocomplete="new-password">
      </div>
      <div class="auth-field">
        <label>ë‹‰ë„¤ì„ <em>*</em></label>
        <input class="auth-input" id="regNick" type="text" placeholder="ë‹¤ë¥¸ í•™ìƒë“¤ì—ê²Œ ë³´ì—¬ì§ˆ ì´ë¦„">
      </div>
      <div class="auth-field">
        <label>í•™ë…„</label>
        <select class="auth-input" id="regGrade">
          <option value="">ì„ íƒ (ë‚˜ì¤‘ì— ì„¤ì • ê°€ëŠ¥)</option>
          <option value="ì¤‘1">ì¤‘1</option><option value="ì¤‘2">ì¤‘2</option><option value="ì¤‘3">ì¤‘3</option>
          <option value="ê³ 1">ê³ 1</option><option value="ê³ 2">ê³ 2</option><option value="ê³ 3">ê³ 3</option>
        </select>
      </div>
      <button class="auth-btn" id="regBtn" onclick="doRegister()">íšŒì›ê°€ì…</button>
      <div class="auth-error" id="regError"></div>
    </form>

    <a href="/" class="auth-back"><i class="fas fa-arrow-left"></i> ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>
</div>

<script>
${sharedAuthJS()}

// If already logged in, redirect
(async()=>{const u=await checkAuth();if(u){const p=new URLSearchParams(location.search).get('redirect');location.href=p||'/'}})();

// Tab switching
const isReg=location.pathname==='/register';
if(isReg){document.querySelectorAll('.auth-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab==='register'));document.querySelectorAll('.auth-form').forEach(f=>f.classList.toggle('active',f.id==='registerForm'))}

document.querySelectorAll('.auth-tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.auth-form').forEach(f=>f.classList.toggle('active',f.id===(tab.dataset.tab==='login'?'loginForm':'registerForm')));
  });
});

async function doLogin(){
  const btn=document.getElementById('loginBtn');btn.disabled=true;
  document.getElementById('loginError').textContent='';
  try{
    const r=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:document.getElementById('loginId').value.trim(),password:document.getElementById('loginPw').value})});
    const d=await r.json();
    if(!r.ok){document.getElementById('loginError').textContent=d.error;return}
    setToken(d.token);setUser(d.user);
    const p=new URLSearchParams(location.search).get('redirect');location.href=p||'/';
  }catch(e){document.getElementById('loginError').textContent='ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
  finally{btn.disabled=false}
}

async function doRegister(){
  const btn=document.getElementById('regBtn');btn.disabled=true;
  document.getElementById('regError').textContent='';
  try{
    const r=await fetch('/api/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:document.getElementById('regId').value.trim(),password:document.getElementById('regPw').value,nickname:document.getElementById('regNick').value.trim(),grade:document.getElementById('regGrade').value})});
    const d=await r.json();
    if(!r.ok){document.getElementById('regError').textContent=d.error;return}
    setToken(d.token);setUser(d.user);
    const p=new URLSearchParams(location.search).get('redirect');location.href=p||'/';
  }catch(e){document.getElementById('regError').textContent='ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
  finally{btn.disabled=false}
}

// Enter key
document.getElementById('loginPw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('regGrade').addEventListener('keydown',e=>{if(e.key==='Enter')doRegister()});
</script>
</body>
</html>`
}

// ===== Coaching Page =====

function coachingPageHTML() {
  return `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì§ˆë¬¸ ì½”ì¹­</title>
${pwaHead()}
<style>
${sharedCSS()}
*{box-sizing:border-box}
body{background:var(--bg)}

.co-nav{position:fixed;top:0;left:0;right:0;z-index:200;height:56px;display:flex;align-items:center;padding:0 16px;background:rgba(15,15,25,.97);border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(12px)}
.co-nav__back{color:var(--dim);font-size:14px;display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:6px;transition:all .15s}
.co-nav__back:hover{color:var(--white);background:rgba(255,255,255,.06)}
.co-nav__title{font-size:17px;font-weight:700;color:var(--white);margin-left:8px;display:flex;align-items:center;gap:6px}
.co-nav__title i{color:#fbbf24}

.co-wrap{padding:68px 16px 40px;max-width:600px;margin:0 auto}

/* Tabs */
.co-tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid rgba(255,255,255,.06);position:sticky;top:56px;z-index:100;background:var(--bg);padding-top:4px}
.co-tab{flex:1;padding:12px 0;font-size:14px;font-weight:600;color:var(--dim);background:none;border:none;cursor:pointer;position:relative;transition:color .2s;display:flex;align-items:center;justify-content:center;gap:5px}
.co-tab:hover{color:var(--white)}
.co-tab.active{color:var(--white)}
.co-tab.active::after{content:'';position:absolute;bottom:-2px;left:20%;right:20%;height:2px;background:linear-gradient(90deg,#fbbf24,#f59e0b);border-radius:1px}

/* Profile Tab */
.co-header{text-align:center;margin-bottom:24px}
.co-header__name{font-size:20px;font-weight:800;color:var(--white);margin-bottom:4px}
.co-header__sub{font-size:13px;color:var(--dim)}
.co-level{display:inline-flex;align-items:center;gap:6px;padding:6px 16px;border-radius:20px;font-size:14px;font-weight:700;margin-top:10px}
.co-level--1{background:rgba(156,163,175,.15);color:#9ca3af;border:1px solid rgba(156,163,175,.2)}
.co-level--2{background:rgba(59,130,246,.1);color:#60a5fa;border:1px solid rgba(59,130,246,.2)}
.co-level--3{background:rgba(16,185,129,.1);color:#34d399;border:1px solid rgba(16,185,129,.2)}
.co-level--4{background:rgba(245,158,11,.1);color:#fbbf24;border:1px solid rgba(245,158,11,.2)}
.co-level--5{background:rgba(239,68,68,.1);color:#f87171;border:1px solid rgba(239,68,68,.2)}

/* Radar Chart */
.co-radar-wrap{position:relative;width:280px;height:280px;margin:0 auto 24px}

/* Bar Chart Section */
.co-section{margin-bottom:24px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px}
.co-section__title{font-size:14px;font-weight:700;color:var(--white);margin-bottom:12px;display:flex;align-items:center;gap:6px}
.co-section__title i{font-size:12px}

.co-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.co-bar-label{width:70px;font-size:11px;font-weight:600;color:var(--dim);text-align:right;flex-shrink:0}
.co-bar-track{flex:1;height:20px;background:rgba(255,255,255,.04);border-radius:4px;overflow:hidden;position:relative}
.co-bar-fill{height:100%;border-radius:4px;transition:width .8s ease;display:flex;align-items:center;padding-left:6px}
.co-bar-val{font-size:10px;font-weight:700;color:rgba(255,255,255,.9);position:absolute;right:6px;top:50%;transform:translateY(-50%)}

/* Insight Cards */
.co-insight{display:flex;gap:8px;padding:12px;border-radius:10px;margin-bottom:8px;align-items:flex-start}
.co-insight--warn{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.15)}
.co-insight--good{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.15)}
.co-insight--info{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.15)}
.co-insight__icon{font-size:16px;flex-shrink:0;margin-top:2px}
.co-insight__text{font-size:12px;color:var(--text);line-height:1.5}
.co-insight__text strong{color:var(--white)}

/* Weekly Trend */
.co-weekly{display:flex;gap:4px;align-items:flex-end;height:80px;padding:0 4px}
.co-week{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.co-week__bar{width:100%;border-radius:4px 4px 0 0;transition:height .6s ease;min-height:4px}
.co-week__label{font-size:10px;color:var(--muted)}
.co-week__score{font-size:10px;font-weight:700;color:var(--dim)}

/* Upgrade Tab */
.co-q-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;transition:all .2s}
.co-q-card:hover{border-color:rgba(255,255,255,.15)}
.co-q-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.co-q-type{font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px;white-space:nowrap}
.co-q-date{font-size:11px;color:var(--muted);margin-left:auto}
.co-q-text{font-size:13px;color:var(--text);line-height:1.5;margin-bottom:10px}
.co-q-subject{font-size:11px;color:var(--dim);display:flex;align-items:center;gap:4px}

.co-upgrade-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(251,191,36,.08));border:1px solid rgba(245,158,11,.2);border-radius:8px;color:#fbbf24;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;margin-top:8px;width:100%}
.co-upgrade-btn:hover{background:linear-gradient(135deg,rgba(245,158,11,.18),rgba(251,191,36,.14));border-color:rgba(245,158,11,.35)}
.co-upgrade-btn i{font-size:11px}
.co-upgrade-btn.loading{pointer-events:none;opacity:.6}

.co-upgrade-result{margin-top:10px;display:none}
.co-upgrade-card{padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid}
.co-upgrade-card__type{font-size:11px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:4px}
.co-upgrade-card__q{font-size:13px;font-weight:600;color:var(--white);line-height:1.5;margin-bottom:6px;padding:8px;background:rgba(255,255,255,.04);border-radius:6px}
.co-upgrade-card__exp{font-size:11px;color:var(--dim);line-height:1.4}
.co-upgrade-card__tip{font-size:11px;color:#fbbf24;margin-top:6px;display:flex;align-items:flex-start;gap:4px}
.co-upgrade-card__tip i{margin-top:2px;flex-shrink:0}

/* Challenge Tab */
.co-progress-ring{position:relative;width:140px;height:140px;margin:0 auto 20px}
.co-progress-ring__text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.co-progress-ring__num{font-size:28px;font-weight:800;color:var(--white);display:block}
.co-progress-ring__label{font-size:11px;color:var(--dim)}

.co-badge-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.co-badge{padding:14px;border-radius:12px;text-align:center;transition:all .3s}
.co-badge--locked{background:rgba(255,255,255,.02);border:1px solid var(--border);opacity:.5}
.co-badge--unlocked{background:linear-gradient(135deg,rgba(251,191,36,.06),rgba(245,158,11,.04));border:1px solid rgba(251,191,36,.2);box-shadow:0 0 12px rgba(251,191,36,.08)}
.co-badge__icon{font-size:28px;margin-bottom:6px}
.co-badge__name{font-size:12px;font-weight:700;color:var(--white);margin-bottom:2px}
.co-badge__desc{font-size:10px;color:var(--muted);line-height:1.3}
.co-badge__check{font-size:10px;color:#34d399;margin-top:4px;font-weight:600}

.co-next-goal{margin-top:20px;padding:14px;background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(99,102,241,.04));border:1px solid rgba(59,130,246,.15);border-radius:12px;text-align:center}
.co-next-goal__title{font-size:12px;font-weight:700;color:#60a5fa;margin-bottom:4px}
.co-next-goal__desc{font-size:12px;color:var(--dim);line-height:1.4}

/* No data */
.co-empty{text-align:center;padding:40px 20px;color:var(--muted)}
.co-empty i{font-size:40px;margin-bottom:12px;display:block;color:var(--border)}
.co-empty p{font-size:14px;margin-bottom:8px}
.co-empty a{color:#fbbf24;font-weight:600}

/* Loading */
.co-loading{text-align:center;padding:60px 0;color:var(--muted);font-size:13px}

@media(max-width:500px){
  .co-wrap{padding:62px 10px 30px}
  .co-radar-wrap{width:240px;height:240px}
  .co-badge-grid{grid-template-columns:repeat(2,1fr);gap:8px}
}
</style>
</head>
<body>
<nav class="co-nav">
  <a href="/" class="co-nav__back"><i class="fas fa-arrow-left"></i> í™ˆ</a>
  <div class="co-nav__title"><i class="fas fa-chart-line"></i> ì§ˆë¬¸ ì½”ì¹­</div>
</nav>

<div class="co-wrap">
  <div class="co-tabs">
    <button class="co-tab active" data-tab="profile" onclick="switchTab('profile')"><i class="fas fa-user-circle"></i> í”„ë¡œí•„</button>
    <button class="co-tab" data-tab="upgrade" onclick="switchTab('upgrade')"><i class="fas fa-arrow-up"></i> ì—…ê·¸ë ˆì´ë“œ</button>
    <button class="co-tab" data-tab="challenge" onclick="switchTab('challenge')"><i class="fas fa-trophy"></i> ì±Œë¦°ì§€</button>
  </div>

  <div id="profileTab"></div>
  <div id="upgradeTab" style="display:none"></div>
  <div id="challengeTab" style="display:none"></div>
  <div id="loadingArea" class="co-loading"><i class="fas fa-spinner fa-spin"></i> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<script>
${sharedAuthJS()}

const CATS = {
  '1-1':{label:'ì§€ì‹í™•ì¸',group:'A',color:'#9ca3af',icon:'ğŸ“–',short:'ì§€ì‹'},
  '1-2':{label:'ì ˆì°¨í™•ì¸',group:'A',color:'#60a5fa',icon:'ğŸ“',short:'ì ˆì°¨'},
  '2-1':{label:'ê°œë…ì´í•´',group:'B',color:'#34d399',icon:'ğŸ’¡',short:'ê°œë…'},
  '2-2':{label:'ì „ëµì„ íƒ',group:'B',color:'#a78bfa',icon:'ğŸ§­',short:'ì „ëµ'},
  '2-3':{label:'ì˜¤ë¥˜ì§„ë‹¨',group:'B',color:'#f472b6',icon:'ğŸ”',short:'ì˜¤ë¥˜'},
  '3-1':{label:'ë¹„êµíŒë‹¨',group:'C',color:'#fbbf24',icon:'âš–ï¸',short:'ë¹„êµ'},
  '3-2':{label:'í™•ì¥ì°½ì¡°',group:'C',color:'#f87171',icon:'ğŸš€',short:'í™•ì¥'}
};
const WEIGHTS={'1-1':1,'1-2':2,'2-1':5,'2-2':4,'2-3':6,'3-1':8,'3-2':10};
const LEVELS=[
  {min:0,name:'Lv.1 ì‹œì‘',label:'ì‹œì‘í•˜ëŠ” ì§ˆë¬¸ì'},
  {min:15,name:'Lv.2 ì„±ì¥',label:'ì„±ì¥í•˜ëŠ” ì§ˆë¬¸ì'},
  {min:30,name:'Lv.3 íƒêµ¬',label:'íƒêµ¬í•˜ëŠ” ì§ˆë¬¸ì'},
  {min:50,name:'Lv.4 ì‹¬í™”',label:'ì‹¬í™”í•˜ëŠ” ì§ˆë¬¸ì'},
  {min:75,name:'Lv.5 ë§ˆìŠ¤í„°',label:'ì§ˆë¬¸ ë§ˆìŠ¤í„°'}
];

let coachData = null;

function getScore(counts) {
  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  if(total===0)return 0;
  let w=0;Object.entries(counts).forEach(([k,v])=>{w+=(WEIGHTS[k]||0)*v});
  return Math.min(100,Math.round((w/(total*10))*100));
}
function getLevel(score) {
  let lv = LEVELS[0];
  for(const l of LEVELS){if(score>=l.min)lv=l}
  return lv;
}
function getLevelNum(score) {
  for(let i=LEVELS.length-1;i>=0;i--){if(score>=LEVELS[i].min)return i+1}return 1;
}

function switchTab(tab) {
  document.querySelectorAll('.co-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  document.getElementById('profileTab').style.display=tab==='profile'?'':'none';
  document.getElementById('upgradeTab').style.display=tab==='upgrade'?'':'none';
  document.getElementById('challengeTab').style.display=tab==='challenge'?'':'none';
}

// ====== Radar Chart ======
function drawRadar(canvas, counts) {
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const size = canvas.parentElement.clientWidth;
  canvas.width = size * dpr; canvas.height = size * dpr;
  canvas.style.width = size+'px'; canvas.style.height = size+'px';
  ctx.scale(dpr, dpr);
  
  const cx = size/2, cy = size/2, R = size/2 - 40;
  const keys = Object.keys(CATS);
  const n = keys.length;
  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  const maxVal = Math.max(...Object.values(counts), 1);

  // Background circles
  for(let r=1;r<=4;r++){
    ctx.beginPath();
    for(let i=0;i<=n;i++){
      const angle = (Math.PI*2/n)*i - Math.PI/2;
      const rr = R*(r/4);
      const x = cx + rr*Math.cos(angle);
      const y = cy + rr*Math.sin(angle);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.strokeStyle='rgba(255,255,255,'+(r===4?0.1:0.05)+')';
    ctx.lineWidth=1;ctx.stroke();
  }

  // Axis lines
  for(let i=0;i<n;i++){
    const angle = (Math.PI*2/n)*i - Math.PI/2;
    ctx.beginPath();ctx.moveTo(cx,cy);
    ctx.lineTo(cx+R*Math.cos(angle),cy+R*Math.sin(angle));
    ctx.strokeStyle='rgba(255,255,255,.06)';ctx.stroke();
  }

  // Data shape
  ctx.beginPath();
  for(let i=0;i<=n;i++){
    const idx = i%n;
    const angle = (Math.PI*2/n)*idx - Math.PI/2;
    const val = (counts[keys[idx]]||0)/maxVal;
    const rr = Math.max(R*0.08, R*val);
    const x = cx + rr*Math.cos(angle);
    const y = cy + rr*Math.sin(angle);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  }
  ctx.closePath();
  const grad = ctx.createRadialGradient(cx,cy,0,cx,cy,R);
  grad.addColorStop(0,'rgba(251,191,36,.25)');grad.addColorStop(1,'rgba(245,158,11,.08)');
  ctx.fillStyle=grad;ctx.fill();
  ctx.strokeStyle='rgba(251,191,36,.6)';ctx.lineWidth=2;ctx.stroke();

  // Data points
  for(let i=0;i<n;i++){
    const angle = (Math.PI*2/n)*i - Math.PI/2;
    const val = (counts[keys[i]]||0)/maxVal;
    const rr = Math.max(R*0.08, R*val);
    const x = cx + rr*Math.cos(angle);
    const y = cy + rr*Math.sin(angle);
    ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fillStyle=CATS[keys[i]].color;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=1;ctx.stroke();
  }

  // Labels
  ctx.font='600 11px Pretendard,-apple-system,sans-serif';
  ctx.textAlign='center';ctx.textBaseline='middle';
  for(let i=0;i<n;i++){
    const angle = (Math.PI*2/n)*i - Math.PI/2;
    const lr = R + 24;
    const lx = cx + lr*Math.cos(angle);
    const ly = cy + lr*Math.sin(angle);
    ctx.fillStyle=CATS[keys[i]].color;
    ctx.fillText(CATS[keys[i]].short+' '+(counts[keys[i]]||0),lx,ly);
  }
}

// ====== Render Profile Tab ======
function renderProfile(data) {
  const score = getScore(data.counts);
  const lv = getLevel(score);
  const lvNum = getLevelNum(score);
  const total = Object.values(data.counts).reduce((a,b)=>a+b,0);

  let html = '<div class="co-header">';
  const displayName = data.userName || (currentUser ? currentUser.nickname : '');
  const nameLabel = isViewingOther ? displayName + 'ë‹˜ì˜ ì§ˆë¬¸ ë¶„ì„' : 'ë‚˜ì˜ ì§ˆë¬¸ ë¶„ì„';
  html += '<div class="co-header__name">' + nameLabel + '</div>';
  html += '<div class="co-header__sub">ì´ '+data.totalQuestions+'ê°œ ì§ˆë¬¸ ì¤‘ '+total+'ê°œ ë¶„ë¥˜ë¨</div>';
  html += '<div class="co-level co-level--'+lvNum+'"><i class="fas fa-star"></i> '+lv.name+' Â· '+lv.label+' ('+score+'ì )</div>';
  html += '</div>';

  if(total === 0) {
    html += '<div class="co-empty"><i class="fas fa-chart-bar"></i><p>ì•„ì§ ë¶„ë¥˜ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</p><a href="/new">ì²« ì§ˆë¬¸ì„ í•´ë³´ì„¸ìš”! â†’</a></div>';
    document.getElementById('profileTab').innerHTML = html;
    return;
  }

  // Radar chart
  html += '<div class="co-radar-wrap"><canvas id="radarCanvas"></canvas></div>';

  // Bar chart
  html += '<div class="co-section"><div class="co-section__title"><i class="fas fa-chart-bar"></i> ìœ í˜•ë³„ ë¶„í¬</div>';
  const maxCnt = Math.max(...Object.values(data.counts),1);
  const groupLabels = {A:'ì‚¬ì‹¤(A)',B:'í•´ì„(B)',C:'í‰ê°€(C)'};
  let prevGroup = '';
  Object.entries(CATS).forEach(([k,v])=>{
    if(v.group!==prevGroup){
      html += '<div style="font-size:10px;color:var(--muted);margin:8px 0 4px;font-weight:600">'+groupLabels[v.group]+'</div>';
      prevGroup = v.group;
    }
    const cnt = data.counts[k]||0;
    const pct = Math.round((cnt/maxCnt)*100);
    html += '<div class="co-bar-row"><div class="co-bar-label">'+v.icon+' '+v.label+'</div>';
    html += '<div class="co-bar-track"><div class="co-bar-fill" style="width:'+pct+'%;background:'+v.color+'"></div>';
    html += '<div class="co-bar-val">'+cnt+'ê°œ</div></div></div>';
  });
  html += '</div>';

  // Insights
  html += '<div class="co-section"><div class="co-section__title"><i class="fas fa-lightbulb"></i> ì¸ì‚¬ì´íŠ¸</div>';
  const insights = getInsights(data.counts, total);
  insights.forEach(ins=>{
    html += '<div class="co-insight co-insight--'+ins.type+'">';
    html += '<div class="co-insight__icon">'+ins.icon+'</div>';
    html += '<div class="co-insight__text">'+ins.text+'</div></div>';
  });
  html += '</div>';

  // Weekly trend
  if(data.weeklyScores && data.weeklyScores.length > 0) {
    html += '<div class="co-section"><div class="co-section__title"><i class="fas fa-chart-line"></i> ì£¼ê°„ ì„±ì¥ ì¶”ì´</div>';
    html += '<div class="co-weekly">';
    const maxScore = Math.max(...data.weeklyScores.map(w=>w.score),1);
    data.weeklyScores.forEach(w=>{
      const h = Math.max(4, (w.score/maxScore)*60);
      const color = w.score >= 50 ? '#fbbf24' : w.score >= 30 ? '#60a5fa' : 'var(--muted)';
      html += '<div class="co-week">';
      html += '<div class="co-week__score">'+w.score+'</div>';
      html += '<div class="co-week__bar" style="height:'+h+'px;background:'+color+'"></div>';
      html += '<div class="co-week__label">'+w.week+'</div></div>';
    });
    html += '</div></div>';
  }

  document.getElementById('profileTab').innerHTML = html;

  // Draw radar after DOM update
  setTimeout(()=>{
    const canvas = document.getElementById('radarCanvas');
    if(canvas) drawRadar(canvas, data.counts);
  }, 50);
}

function getInsights(counts, total) {
  const ins = [];
  const whyRatio = ((counts['2-1']||0)+(counts['2-3']||0))/Math.max(total,1);
  const evalRatio = ((counts['3-1']||0)+(counts['3-2']||0))/Math.max(total,1);
  const factRatio = ((counts['1-1']||0)+(counts['1-2']||0))/Math.max(total,1);

  if(factRatio > 0.6) ins.push({type:'warn',icon:'âš ï¸',text:'<strong>ì‚¬ì‹¤ í™•ì¸(Aê·¸ë£¹)</strong> ì§ˆë¬¸ ë¹„ìœ¨ì´ '+(factRatio*100).toFixed(0)+'%ë¡œ ë†’ì•„ìš”. "ì™œ?", "ì–´ë–»ê²Œ í•˜ë©´ ë”?"ì™€ ê°™ì€ í•´ì„Â·í‰ê°€ ì§ˆë¬¸ì„ ì‹œë„í•´ë³´ì„¸ìš”!'});
  if(whyRatio < 0.2 && total >= 3) ins.push({type:'warn',icon:'ğŸ’¡',text:'"<strong>ì™œ?</strong>" ì§ˆë¬¸ì´ ë¶€ì¡±í•´ìš”. ê°œë… ì´í•´(2-1)ë‚˜ ì˜¤ë¥˜ ì§„ë‹¨(2-3) ì§ˆë¬¸ì„ ëŠ˜ë ¤ë³´ì„¸ìš”.'});
  if(evalRatio > 0.3) ins.push({type:'good',icon:'ğŸ¯',text:'<strong>í‰ê°€(Cê·¸ë£¹)</strong> ì§ˆë¬¸ ë¹„ìœ¨ì´ '+(evalRatio*100).toFixed(0)+'%! ë†’ì€ ìˆ˜ì¤€ì˜ ì‚¬ê³ ë ¥ì„ ë³´ì—¬ì£¼ê³  ìˆì–´ìš”!'});
  if((counts['2-3']||0) >= 2) ins.push({type:'good',icon:'ğŸ”',text:'<strong>ì˜¤ë¥˜ ì§„ë‹¨</strong> ì§ˆë¬¸ì„ '+(counts['2-3'])+'ê°œë‚˜ í–ˆì–´ìš”! ë©”íƒ€ì¸ì§€ ëŠ¥ë ¥ì´ ë°œë‹¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.'});
  if((counts['3-2']||0) >= 1) ins.push({type:'good',icon:'ğŸš€',text:'<strong>í™•ì¥Â·ì°½ì¡°</strong> ì§ˆë¬¸ì„ ì‹œë„í–ˆì–´ìš”! ìµœê³  ìˆ˜ì¤€ì˜ ì§ˆë¬¸ ëŠ¥ë ¥ì…ë‹ˆë‹¤.'});
  if(total >= 5 && evalRatio < 0.1) ins.push({type:'info',icon:'ğŸ“Š',text:'ë¹„êµÂ·íŒë‹¨(3-1), í™•ì¥Â·ì°½ì¡°(3-2) ìœ í˜•ì˜ ì§ˆë¬¸ì—ë„ ë„ì „í•´ë³´ì„¸ìš”. ìˆ˜ëŠ¥ ê³ ë‚œë„ ë¬¸ì œì— ëŒ€í•œ ê°ê°ì´ ìƒê²¨ìš”.'});
  if(ins.length === 0) ins.push({type:'info',icon:'âœ¨',text:'ì§ˆë¬¸ì„ ë” ë§ì´ í•˜ë©´ ë” ì •í™•í•œ ë¶„ì„ ê²°ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”!'});
  return ins;
}

// ====== Render Upgrade Tab ======
function renderUpgrade(data) {
  if(!data.recentQuestions || data.recentQuestions.length === 0) {
    document.getElementById('upgradeTab').innerHTML = '<div class="co-empty"><i class="fas fa-arrow-up"></i><p>ë¶„ë¥˜ëœ ì§ˆë¬¸ì´ ì—†ì–´ ì—…ê·¸ë ˆì´ë“œë¥¼ ì œì•ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p><a href="/new">ì§ˆë¬¸í•˜ëŸ¬ ê°€ê¸° â†’</a></div>';
    return;
  }
  let html = '<div class="co-section"><div class="co-section__title"><i class="fas fa-magic"></i> AI ì§ˆë¬¸ ì—…ê·¸ë ˆì´ë“œ</div>';
  html += '<div style="font-size:12px;color:var(--dim);margin-bottom:12px">ìµœê·¼ ì§ˆë¬¸ì„ ë” ë†’ì€ ìˆ˜ì¤€ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ëŠ” ë°©ë²•ì„ AIê°€ ì œì•ˆí•©ë‹ˆë‹¤.</div></div>';

  data.recentQuestions.forEach((q,i)=>{
    const cat = CATS[q.cat] || {label:'ë¯¸ë¶„ë¥˜',color:'#666',icon:'â“'};
    const dateStr = q.date ? new Date(q.date).toLocaleDateString('ko-KR',{month:'short',day:'numeric'}) : '';
    html += '<div class="co-q-card">';
    html += '<div class="co-q-head"><span class="co-q-type" style="background:'+cat.color+'22;color:'+cat.color+';border:1px solid '+cat.color+'33">'+cat.icon+' '+cat.label+'</span>';
    html += '<span class="co-q-date">'+dateStr+'</span></div>';
    html += '<div class="co-q-text">'+escHtml(q.text||'(ë‚´ìš© ì—†ìŒ)')+'</div>';
    html += '<div class="co-q-subject"><i class="fas fa-tag"></i> '+(q.subject||'ë¯¸ë¶„ë¥˜')+'</div>';
    if(q.cat && q.cat !== '3-2' && !isViewingOther) {
      html += '<button class="co-upgrade-btn" id="upgBtn'+i+'" onclick="requestUpgrade('+i+','+q.id+',\\''+escAttr(q.text||'')+'\\',\\''+q.cat+'\\',\\''+escAttr(q.subject||'ìˆ˜í•™')+'\\')"><i class="fas fa-wand-magic-sparkles"></i> ë” ì¢‹ì€ ì§ˆë¬¸ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ ì œì•ˆë°›ê¸°</button>';
      html += '<div class="co-upgrade-result" id="upgResult'+i+'"></div>';
    } else if(q.cat === '3-2') {
      html += '<div style="margin-top:8px;padding:8px 12px;border-radius:8px;background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.15);font-size:12px;color:#f87171;display:flex;align-items:center;gap:6px"><i class="fas fa-crown"></i> ì´ë¯¸ ìµœê³  ìˆ˜ì¤€ì˜ ì§ˆë¬¸ì…ë‹ˆë‹¤! ğŸ‘</div>';
    }
    html += '</div>';
  });

  document.getElementById('upgradeTab').innerHTML = html;
}

function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function escAttr(s){return String(s).replace(/\\\\/g,'\\\\\\\\').replace(/'/g,"\\\\'").replace(/"/g,'\\\\"').replace(/\\n/g,' ').slice(0,100)}

async function requestUpgrade(idx, qId, qText, qType, subject) {
  const btn = document.getElementById('upgBtn'+idx);
  const result = document.getElementById('upgResult'+idx);
  btn.classList.add('loading');
  btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> AIê°€ ë¶„ì„ ì¤‘...';
  try {
    const res = await fetch('/api/coaching/upgrade', {
      method:'POST', headers:authHeaders(),
      body:JSON.stringify({questionId:qId, questionText:qText, questionType:qType, subject:subject})
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||'failed');
    let rhtml = '';
    (data.upgrades||[]).forEach(u=>{
      const tc = CATS[u.targetType]||{color:'#666',icon:'â“'};
      rhtml += '<div class="co-upgrade-card" style="background:'+tc.color+'08;border-color:'+tc.color+'22">';
      rhtml += '<div class="co-upgrade-card__type" style="color:'+tc.color+'">'+tc.icon+' '+u.targetTypeName+' ('+u.targetType+')</div>';
      rhtml += '<div class="co-upgrade-card__q">"'+escHtml(u.upgradedQuestion)+'"</div>';
      rhtml += '<div class="co-upgrade-card__exp">'+escHtml(u.explanation)+'</div>';
      if(u.tip) rhtml += '<div class="co-upgrade-card__tip"><i class="fas fa-lightbulb"></i> '+escHtml(u.tip)+'</div>';
      rhtml += '</div>';
    });
    result.innerHTML = rhtml;
    result.style.display='block';
    btn.style.display='none';
  } catch(e) {
    btn.classList.remove('loading');
    btn.innerHTML='<i class="fas fa-exclamation-circle"></i> ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„';
  }
}

// ====== Render Challenge Tab ======
function renderChallenge(data) {
  const counts = data.counts;
  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  const score = getScore(counts);

  const badges = [
    {id:'first',name:'ì²« ì§ˆë¬¸',desc:'ì²« ë²ˆì§¸ ì§ˆë¬¸ì„ í–ˆì–´ìš”',icon:'ğŸ‰',check:data.totalQuestions>=1},
    {id:'why',name:'Why íƒí—˜ê°€',desc:'ê°œë…ì´í•´(2-1) ì§ˆë¬¸ 3ê°œ ì´ìƒ',icon:'ğŸ’¡',check:(counts['2-1']||0)>=3},
    {id:'debug',name:'ë””ë²„ê±°',desc:'ì˜¤ë¥˜ì§„ë‹¨(2-3) ì§ˆë¬¸ 2ê°œ ì´ìƒ',icon:'ğŸ”',check:(counts['2-3']||0)>=2},
    {id:'judge',name:'ì‹¬íŒê´€',desc:'ë¹„êµíŒë‹¨(3-1) ì§ˆë¬¸ 2ê°œ ì´ìƒ',icon:'âš–ï¸',check:(counts['3-1']||0)>=2},
    {id:'creator',name:'ì°½ì¡°ì',desc:'í™•ì¥ì°½ì¡°(3-2) ì§ˆë¬¸ 1ê°œ ì´ìƒ',icon:'ğŸš€',check:(counts['3-2']||0)>=1},
    {id:'balanced',name:'ë°¸ëŸ°ì„œ',desc:'5ê°€ì§€ ì´ìƒ ìœ í˜• ì§ˆë¬¸',icon:'ğŸ¯',check:Object.values(counts).filter(v=>v>0).length>=5},
    {id:'deep',name:'ê¹Šì€ ì‚¬ê³ ',desc:'í•´ì„Â·í‰ê°€ ì§ˆë¬¸ì´ 60% ì´ìƒ',icon:'ğŸ§ ',check:total>0&&((counts['2-1']||0)+(counts['2-2']||0)+(counts['2-3']||0)+(counts['3-1']||0)+(counts['3-2']||0))/total>=0.6},
    {id:'master',name:'ì§ˆë¬¸ ë§ˆìŠ¤í„°',desc:'ì½”ì¹­ ì ìˆ˜ 75ì  ì´ìƒ',icon:'ğŸ‘‘',check:score>=75}
  ];

  const unlocked = badges.filter(b=>b.check).length;
  const pct = Math.round((unlocked/badges.length)*100);

  // Progress ring SVG
  let html = '<div class="co-progress-ring">';
  html += '<svg width="140" height="140" viewBox="0 0 140 140">';
  html += '<circle cx="70" cy="70" r="60" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="8"/>';
  const circumference = 2 * Math.PI * 60;
  const offset = circumference - (pct/100)*circumference;
  html += '<circle cx="70" cy="70" r="60" fill="none" stroke="#fbbf24" stroke-width="8" stroke-linecap="round" stroke-dasharray="'+circumference+'" stroke-dashoffset="'+offset+'" transform="rotate(-90 70 70)" style="transition:stroke-dashoffset 1s ease"/>';
  html += '</svg>';
  html += '<div class="co-progress-ring__text"><span class="co-progress-ring__num">'+unlocked+'/'+badges.length+'</span><span class="co-progress-ring__label">ë±ƒì§€ ë‹¬ì„±</span></div>';
  html += '</div>';

  html += '<div class="co-badge-grid">';
  badges.forEach(b=>{
    html += '<div class="co-badge co-badge--'+(b.check?'unlocked':'locked')+'">';
    html += '<div class="co-badge__icon">'+b.icon+'</div>';
    html += '<div class="co-badge__name">'+b.name+'</div>';
    html += '<div class="co-badge__desc">'+b.desc+'</div>';
    if(b.check) html += '<div class="co-badge__check"><i class="fas fa-check-circle"></i> ë‹¬ì„±!</div>';
    html += '</div>';
  });
  html += '</div>';

  // Next goal
  const next = badges.find(b=>!b.check);
  if(next) {
    html += '<div class="co-next-goal"><div class="co-next-goal__title"><i class="fas fa-flag"></i> ë‹¤ìŒ ëª©í‘œ</div>';
    html += '<div class="co-next-goal__desc">'+next.icon+' <strong>'+next.name+'</strong> â€” '+next.desc+'</div></div>';
  }

  document.getElementById('challengeTab').innerHTML = html;
}

// ====== Init ======
let currentUser = null;
let isViewingOther = false;
(async()=>{
  currentUser = await checkAuth();
  
  // Check if viewing a specific user's profile via URL /coaching/:userId
  const pathParts = location.pathname.split('/');
  const urlUserId = pathParts.length >= 3 && pathParts[1] === 'coaching' && pathParts[2] ? pathParts[2] : null;
  
  if (urlUserId) {
    // Viewing someone else's profile - no auth required
    isViewingOther = true;
    try {
      const res = await fetch('/api/coaching/stats?userId=' + urlUserId);
      if(!res.ok) throw new Error('Failed');
      coachData = await res.json();
      document.getElementById('loadingArea').style.display='none';
      renderProfile(coachData);
      renderUpgrade(coachData);
      renderChallenge(coachData);
    } catch(e) {
      document.getElementById('loadingArea').innerHTML = '<div class="co-empty"><i class="fas fa-exclamation-triangle"></i><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }
  } else if (currentUser) {
    // Viewing own profile
    try {
      const res = await fetch('/api/coaching/stats', {headers:authHeaders()});
      if(!res.ok) throw new Error('Failed');
      coachData = await res.json();
      document.getElementById('loadingArea').style.display='none';
      renderProfile(coachData);
      renderUpgrade(coachData);
      renderChallenge(coachData);
    } catch(e) {
      document.getElementById('loadingArea').innerHTML = '<div class="co-empty"><i class="fas fa-exclamation-triangle"></i><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }
  } else {
    document.getElementById('loadingArea').innerHTML = '<div class="co-empty"><i class="fas fa-lock"></i><p>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p><p style="font-size:12px">ì •ìœ¨í†¡ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”</p></div>';
  }
})();
</script>
</body>
</html>`
}

// ===== My Page =====

function schedulePageHTML() {
  return `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ë‚´ ìŠ¤ì¼€ì¤„</title>
${pwaHead()}
<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
<style>
${sharedCSS()}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Pretendard',sans-serif;min-height:100vh}
.sch-nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(20,20,20,.95);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;height:48px}
.sch-nav a{color:var(--dim);font-size:13px;display:flex;align-items:center;gap:6px;text-decoration:none;position:relative;z-index:2;cursor:pointer;padding:8px 4px}
.sch-nav a:hover{color:var(--white)}
.sch-nav__title{position:absolute;left:0;right:0;text-align:center;font-size:15px;font-weight:700;color:var(--white);pointer-events:none;z-index:1}
.sch-nav__right{font-size:12px;color:var(--muted);margin-left:auto;position:relative;z-index:2}

.sch-wrap{padding:64px 16px 100px;max-width:600px;margin:0 auto}
.sch-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--bg2);border-radius:8px;padding:4px}
.sch-tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:600;color:var(--muted);border-radius:6px;cursor:pointer;transition:all .2s;border:none;background:none}
.sch-tab.active{background:var(--red);color:#fff}
.sch-tab .tab-count{font-size:11px;font-weight:400;margin-left:4px;opacity:.7}

.sch-section{margin-bottom:24px}
.sch-date{font-size:12px;font-weight:700;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;gap:6px;padding-left:4px}
.sch-date i{color:var(--red)}

.sch-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px;position:relative;overflow:hidden;transition:all .2s}
.sch-card:hover{border-color:rgba(108,92,231,.4)}
.sch-card--today{border-left:3px solid #ffd700}
.sch-card--past{opacity:.6}

.sch-card__top{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.sch-card__time{font-size:20px;font-weight:800;color:var(--white);min-width:55px}
.sch-card__subject{font-size:11px;font-weight:700;padding:3px 8px;border-radius:3px;background:rgba(108,92,231,.15);color:#a29bfe;border:1px solid rgba(108,92,231,.25)}
.sch-card__points{font-size:11px;font-weight:800;color:#ffd700;margin-left:auto}
.sch-card__dday{font-size:11px;font-weight:700;padding:3px 8px;border-radius:10px}
.sch-card__dday--today{background:rgba(255,215,0,.15);color:#ffd700;animation:ddayPulse 2s infinite}
.sch-card__dday--soon{background:rgba(255,69,0,.12);color:#ff4500}
.sch-card__dday--far{background:rgba(108,92,231,.12);color:#a29bfe}
.sch-card__dday--done{background:rgba(0,200,83,.12);color:#00c853}
@keyframes ddayPulse{0%,100%{opacity:1}50%{opacity:.6}}

.sch-card__title{font-size:13px;color:var(--white);margin-bottom:8px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.sch-card__partner{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);margin-bottom:10px}
.sch-card__partner i{color:#a29bfe}
.sch-card__role{font-size:10px;font-weight:700;padding:2px 6px;border-radius:3px}
.sch-card__role--q{background:rgba(255,65,54,.12);color:var(--red)}
.sch-card__role--t{background:rgba(108,92,231,.12);color:#a29bfe}

.sch-card__actions{display:flex;gap:8px;margin-top:12px}
.sch-btn{flex:1;padding:9px;border-radius:6px;font-size:12px;font-weight:700;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:all .2s}
.sch-btn--complete{background:linear-gradient(135deg,#00c853,#69f0ae);color:#111}
.sch-btn--complete:hover{opacity:.85}
.sch-btn--cancel{background:none;border:1px solid rgba(255,65,54,.3);color:var(--red)}
.sch-btn--cancel:hover{background:rgba(255,65,54,.08)}
.sch-btn--mutual{background:none;border:1px solid rgba(108,92,231,.3);color:#a29bfe;font-size:11px}
.sch-btn--mutual:hover{background:rgba(108,92,231,.08)}
.sch-btn--view{background:rgba(108,92,231,.12);color:#a29bfe;border:1px solid rgba(108,92,231,.25)}
.sch-btn--view:hover{background:rgba(108,92,231,.2)}
.sch-btn--accept-mutual{background:linear-gradient(135deg,#a29bfe,#6c5ce7);color:#fff}

/* Cancel Modal */
.cancel-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;animation:fadeIn .2s}
.cancel-modal{background:var(--bg2);border:1px solid var(--border);border-radius:14px;max-width:420px;width:100%;max-height:90vh;overflow-y:auto;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
.cancel-modal__header{padding:20px 20px 0;display:flex;align-items:center;gap:10px}
.cancel-modal__icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.cancel-modal__icon--warn{background:rgba(255,69,0,.12);color:#ff4500}
.cancel-modal__icon--ok{background:rgba(108,92,231,.12);color:#a29bfe}
.cancel-modal__title{font-size:16px;font-weight:700;color:var(--white)}
.cancel-modal__sub{font-size:12px;color:var(--muted);margin-top:2px}
.cancel-modal__body{padding:16px 20px}
.cancel-modal__penalty{background:rgba(255,69,0,.06);border:1px solid rgba(255,69,0,.15);border-radius:8px;padding:12px;margin-bottom:16px}
.cancel-modal__penalty-row{display:flex;justify-content:space-between;font-size:12px;color:var(--dim);padding:3px 0}
.cancel-modal__penalty-val{font-weight:700;color:#ff4500}
.cancel-modal__penalty-none{color:#00c853}
.cancel-modal__reasons{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
.cancel-reason{display:flex;align-items:center;gap:10px;padding:12px;border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;background:none}
.cancel-reason:hover{border-color:rgba(108,92,231,.3)}
.cancel-reason.selected{border-color:#a29bfe;background:rgba(108,92,231,.06)}
.cancel-reason input{accent-color:#a29bfe}
.cancel-reason__label{font-size:13px;color:var(--white)}
.cancel-detail{width:100%;padding:10px 12px;font-size:12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--white);resize:vertical;min-height:60px;margin-bottom:16px;outline:none}
.cancel-detail:focus{border-color:#a29bfe}
.cancel-modal__footer{padding:0 20px 20px;display:flex;gap:8px}
.cancel-modal__btn{flex:1;padding:12px;border-radius:8px;font-size:13px;font-weight:700;border:none;cursor:pointer;transition:all .15s}
.cancel-modal__btn--cancel{background:var(--bg);color:var(--dim);border:1px solid var(--border)}
.cancel-modal__btn--cancel:hover{background:var(--border)}
.cancel-modal__btn--confirm{background:linear-gradient(135deg,#ff4136,#ff6b6b);color:#fff}
.cancel-modal__btn--confirm:hover{opacity:.85}
.cancel-modal__btn--mutual{background:linear-gradient(135deg,#a29bfe,#6c5ce7);color:#fff}
.cancel-modal__btn--mutual:hover{opacity:.85}
.cancel-modal__btn:disabled{opacity:.4;cursor:not-allowed}

/* Penalty info banner */
.penalty-info{background:rgba(255,165,0,.06);border:1px solid rgba(255,165,0,.15);border-radius:8px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
.penalty-info i{color:#ffa500;font-size:14px}
.penalty-info__count{font-weight:700;color:#ff4500}
.mutual-pending{background:rgba(108,92,231,.08);border:1px solid rgba(108,92,231,.2);border-radius:8px;padding:10px 12px;margin-top:8px;font-size:12px;color:#a29bfe;display:flex;align-items:center;gap:8px}

.sch-empty{text-align:center;padding:60px 20px;color:var(--muted)}
.sch-empty i{font-size:40px;margin-bottom:12px;display:block;opacity:.3}
.sch-empty p{font-size:14px;margin-bottom:16px}
.sch-empty a{color:var(--red);font-weight:600;text-decoration:none}

.sch-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:24px}
.sch-stat{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px;text-align:center}
.sch-stat__num{font-size:22px;font-weight:800;color:var(--white)}
.sch-stat__label{font-size:11px;color:var(--muted);margin-top:2px}

.sch-alert{background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(255,165,0,.05));border:1px solid rgba(255,215,0,.25);border-radius:10px;padding:14px 16px;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.sch-alert i{font-size:18px;color:#ffd700;animation:ring 1s ease infinite}
.sch-alert__text{font-size:13px;color:var(--white);font-weight:600}
.sch-alert__sub{font-size:11px;color:var(--muted);margin-top:2px}
.sch-alert__btn{margin-left:auto;padding:6px 14px;background:rgba(255,215,0,.15);border:1px solid rgba(255,215,0,.3);color:#ffd700;font-size:11px;font-weight:700;border-radius:6px;cursor:pointer;white-space:nowrap}
</style>
</head>
<body>

<nav class="sch-nav">
  <a href="/"><i class="fas fa-arrow-left"></i> í™ˆ</a>
  <div class="sch-nav__title"><i class="fas fa-calendar-alt" style="margin-right:4px"></i> ë‚´ ìŠ¤ì¼€ì¤„</div>
  <div class="sch-nav__right" id="navUser"></div>
</nav>

<div class="sch-wrap">
  <div id="alertBanner"></div>

  <div class="sch-stats">
    <div class="sch-stat"><div class="sch-stat__num" id="statUpcoming">-</div><div class="sch-stat__label">ì˜ˆì •ëœ ìˆ˜ì—…</div></div>
    <div class="sch-stat"><div class="sch-stat__num" id="statCompleted">-</div><div class="sch-stat__label">ì™„ë£Œëœ ìˆ˜ì—…</div></div>
    <div class="sch-stat"><div class="sch-stat__num" id="statPoints">-</div><div class="sch-stat__label">ì´ í¬ì¸íŠ¸</div></div>
  </div>

  <div id="penaltyBanner"></div>

  <div class="sch-tabs">
    <button class="sch-tab active" data-tab="upcoming"><i class="fas fa-clock"></i> ì˜ˆì •<span class="tab-count" id="upcomingCount"></span></button>
    <button class="sch-tab" data-tab="completed"><i class="fas fa-check-circle"></i> ì™„ë£Œ<span class="tab-count" id="completedCount"></span></button>
  </div>

  <div id="scheduleList"></div>
</div>

<script>
${sharedAuthJS()}
let currentUser=null;
let allSchedules=[];
let currentTab='upcoming';

(async()=>{
  currentUser=await checkAuth();
  if(!currentUser){alert('ì •ìœ¨í†¡ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”.');return}
  document.getElementById('navUser').textContent=currentUser.nickname;
  loadSchedule();
})();

async function loadSchedule(){
  try{
    const res=await fetch('/api/schedule',{headers:authHeaders()});
    const data=await res.json();
    if(!res.ok){alert(data.error);return}
    allSchedules=data.schedules||[];
    renderSchedule();
    checkMutualCancelStatus();
    loadPenaltyInfo();
  }catch(e){console.error(e)}
}

function parseSlotTime(slotTime){
  // Parse "ìˆ˜ 02/11 18:00" or "ìˆ˜ 2/11 18:00" format
  if(!slotTime)return null;
  const parts=slotTime.trim().split(' ');
  if(parts.length<3)return null;
  const dateParts=parts[1].split('/');
  if(dateParts.length<2)return null;
  const month=parseInt(dateParts[0])-1;
  const day=parseInt(dateParts[1]);
  const timeParts=parts[2].split(':');
  const hour=parseInt(timeParts[0]);
  const minute=parseInt(timeParts[1]||'0');
  const now=new Date();
  const year=now.getFullYear();
  const d=new Date(year,month,day,hour,minute);
  // If date is far in the past, assume next year
  if(d.getTime()<now.getTime()-180*86400000) d.setFullYear(year+1);
  return d;
}

function getDday(slotDate){
  if(!slotDate)return{text:'',cls:''};
  const now=new Date();
  const diff=slotDate.getTime()-now.getTime();
  const days=Math.floor(diff/86400000);
  const hours=Math.floor(diff/3600000);
  const mins=Math.floor(diff/60000);
  if(diff<0)return{text:'ì§€ë‚¨',cls:'done'};
  if(days===0&&hours<1)return{text:mins+'ë¶„ í›„',cls:'today'};
  if(days===0)return{text:'ì˜¤ëŠ˜ '+hours+'ì‹œê°„ í›„',cls:'today'};
  if(days===1)return{text:'ë‚´ì¼',cls:'soon'};
  if(days<=7)return{text:'D-'+days,cls:'soon'};
  return{text:'D-'+days,cls:'far'};
}

function renderSchedule(){
  const now=new Date();
  const upcoming=[];
  const completed=[];
  let totalPoints=0;

  allSchedules.forEach(s=>{
    const slotDate=parseSlotTime(s.slot_time);
    s._date=slotDate;
    s._dday=getDday(slotDate);
    s._isQuestioner=currentUser.id===s.questioner_id;
    s._role=s._isQuestioner?'questioner':'tutor';
    if(s.status==='completed'){
      completed.push(s);
      if(s._role==='tutor')totalPoints+=s.reward_points||0;
    }else{
      upcoming.push(s);
    }
  });

  // Sort upcoming by date
  upcoming.sort((a,b)=>(a._date||0)-(b._date||0));
  completed.sort((a,b)=>(b._date||0)-(a._date||0));

  document.getElementById('statUpcoming').textContent=upcoming.length;
  document.getElementById('statCompleted').textContent=completed.length;
  document.getElementById('statPoints').textContent=totalPoints+'P';
  document.getElementById('upcomingCount').textContent=upcoming.length?'('+upcoming.length+')':'';
  document.getElementById('completedCount').textContent=completed.length?'('+completed.length+')':'';

  // Alert banner for imminent session (1 hour or 10 min)
  const imminent=upcoming.find(s=>s._date&&(s._date.getTime()-now.getTime())<3600000&&(s._date.getTime()-now.getTime())>0);
  const tenMin=upcoming.find(s=>s._date&&(s._date.getTime()-now.getTime())<600000&&(s._date.getTime()-now.getTime())>0);
  const banner=document.getElementById('alertBanner');
  if(tenMin){
    const mins=Math.max(0,Math.floor((tenMin._date.getTime()-now.getTime())/60000));
    const secs=Math.max(0,Math.floor(((tenMin._date.getTime()-now.getTime())%60000)/1000));
    banner.innerHTML='<div class="sch-alert" style="border-color:rgba(255,69,0,.4);background:linear-gradient(135deg,rgba(255,69,0,.15),rgba(255,69,0,.05))"><i class="fas fa-exclamation-triangle" style="color:#ff4500;font-size:20px"></i><div><div class="sch-alert__text" style="color:#ff4500">âš¡ '+mins+'ë¶„ '+secs+'ì´ˆ í›„ ìˆ˜ì—… ì‹œì‘!</div><div class="sch-alert__sub">'+tenMin.subject+' Â· '+(tenMin._isQuestioner?tenMin.tutor_name:tenMin.questioner_name)+'ë‹˜</div><div class="sch-alert__sub" style="margin-top:4px;color:#a29bfe"><i class="fas fa-comment-dots"></i> ì •ìœ¨í†¡ì—ì„œ ìƒëŒ€ë°©ê³¼ ë¯¸ë¦¬ ì¸ì‚¬í•´ë³´ì„¸ìš”!</div></div><button class="sch-alert__btn" style="background:rgba(255,69,0,.15);border-color:rgba(255,69,0,.3);color:#ff4500" onclick="location.href=\\x27/question/'+tenMin.question_id+'\\x27">ì…ì¥</button></div>';
  }else if(imminent){
    const mins=Math.max(0,Math.floor((imminent._date.getTime()-now.getTime())/60000));
    banner.innerHTML='<div class="sch-alert"><i class="fas fa-bell"></i><div><div class="sch-alert__text">ğŸ”” '+mins+'ë¶„ í›„ 1:1 íŠœí„°ë§ì´ ì‹œì‘ë©ë‹ˆë‹¤!</div><div class="sch-alert__sub">'+imminent.subject+' Â· '+(imminent._isQuestioner?imminent.tutor_name:imminent.questioner_name)+'ë‹˜</div><div class="sch-alert__sub" style="margin-top:4px;color:#a29bfe"><i class="fas fa-comment-dots"></i> ë§¤ì¹­ í™•ì • ì‹œ ì •ìœ¨í†¡ í†¡ë°©ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤</div></div><button class="sch-alert__btn" onclick="location.href=\\x27/question/'+imminent.question_id+'\\x27">ìƒì„¸ë³´ê¸°</button></div>';
  }else{banner.innerHTML=''}

  const list=currentTab==='upcoming'?upcoming:completed;
  renderList(list);
}

function renderList(list){
  const el=document.getElementById('scheduleList');
  if(!list.length){
    const isUp=currentTab==='upcoming';
    el.innerHTML='<div class="sch-empty"><i class="fas '+(isUp?'fa-calendar-plus':'fa-check-circle')+'"></i><p>'+(isUp?'ì˜ˆì •ëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤':'ì™„ë£Œëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤')+'</p>'+(isUp?'<a href="/new">1:1 íŠœí„°ë§ ì§ˆë¬¸í•˜ê¸° â†’</a>':'')+'</div>';
    return;
  }

  // Group by date
  let html='';
  let lastDate='';
  const now=new Date();
  const todayStr=now.getFullYear()+'-'+(now.getMonth()+1)+'-'+now.getDate();

  list.forEach(s=>{
    const d=s._date;
    const dateStr=d?d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate():'';
    const isToday=dateStr===todayStr;
    const isPast=d&&d.getTime()<now.getTime();

    if(dateStr!==lastDate){
      const dayNames=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      const label=d?(isToday?'ì˜¤ëŠ˜':(d.getMonth()+1)+'/'+ d.getDate()+' ('+dayNames[d.getDay()]+')'):'ë‚ ì§œ ë¯¸ì •';
      html+='<div class="sch-section"><div class="sch-date"><i class="fas '+(isToday?'fa-star':'fa-calendar-day')+'"></i> '+label+'</div>';
      lastDate=dateStr;
    }

    const timeStr=d?(d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0')):'--:--';
    const dday=s._dday;
    const partner=s._isQuestioner?{name:s.tutor_name,grade:s.tutor_grade,label:'ë‹µë³€ì',cls:'t'}:{name:s.questioner_name,grade:s.questioner_grade,label:'ì§ˆë¬¸ì',cls:'q'};
    const roleTag=s._isQuestioner?'<span class="sch-card__role sch-card__role--q">ì§ˆë¬¸ì</span>':'<span class="sch-card__role sch-card__role--t">ë‹µë³€ì</span>';

    html+='<div class="sch-card'+(isToday?' sch-card--today':'')+(isPast&&s.status!=='completed'?' sch-card--past':'')+'">';
    html+='<div class="sch-card__top">';
    html+='<div class="sch-card__time">'+timeStr+'</div>';
    html+='<div class="sch-card__subject"><i class="fas fa-chalkboard-teacher"></i> '+s.subject+'</div>';
    html+=roleTag;
    if(s.reward_points)html+='<div class="sch-card__points"><i class="fas fa-coins"></i> '+s.reward_points+'P</div>';
    if(dday.text)html+='<div class="sch-card__dday sch-card__dday--'+dday.cls+'">'+dday.text+'</div>';
    html+='</div>';

    html+='<div class="sch-card__title">'+(s.title||s.content||'')+'</div>';
    html+='<div class="sch-card__partner"><i class="fas fa-user-circle"></i> '+partner.label+': <strong>'+partner.name+'</strong>'+(partner.grade?' ('+partner.grade+')':'')+'</div>';

    html+='<div class="sch-card__actions">';
    html+='<button class="sch-btn sch-btn--view" onclick="location.href=\\x27/question/'+s.question_id+'\\x27"><i class="fas fa-eye"></i> ì§ˆë¬¸ë³´ê¸°</button>';
    if(s.status==='confirmed'){
      if(isPast){
        html+='<button class="sch-btn sch-btn--complete" onclick="completeSession('+s.id+')"><i class="fas fa-check"></i> ìˆ˜ì—… ì™„ë£Œ</button>';
      }
      html+='<button class="sch-btn sch-btn--cancel" onclick="showCancelModal('+s.id+')"><i class="fas fa-times"></i> ì·¨ì†Œ</button>';
    }else if(s.status==='completed'){
      html+='<div class="sch-btn" style="background:rgba(0,200,83,.1);color:#00c853;cursor:default"><i class="fas fa-check-circle"></i> ìˆ˜ì—… ì™„ë£Œ</div>';
    }
    html+='</div>';
    // Mutual cancel pending indicator
    html+='<div id="mutualStatus'+s.id+'"></div>';
    html+='</div>';
  });

  el.innerHTML=html;
}

// Cancel reasons
const CANCEL_REASONS=[
  {id:'schedule_conflict',label:'ì¼ì •ì´ ê²¹ì³ì„œ',icon:'fa-calendar-times'},
  {id:'emergency',label:'ê¸´ê¸‰í•œ ê°œì¸ ì‚¬ì •',icon:'fa-exclamation-circle'},
  {id:'health',label:'ê±´ê°• ë¬¸ì œ',icon:'fa-heartbeat'},
  {id:'no_response',label:'ìƒëŒ€ë°© ì—°ë½ ë‘ì ˆ',icon:'fa-phone-slash'},
  {id:'wrong_match',label:'ì˜ëª»ëœ ë§¤ì¹­ (ì‹¤ìˆ˜)',icon:'fa-undo'},
  {id:'other',label:'ê¸°íƒ€ ì‚¬ìœ ',icon:'fa-ellipsis-h'}
];

function showCancelModal(matchId){
  const s=allSchedules.find(x=>x.id===matchId);
  if(!s)return;
  const d=parseSlotTime(s.slot_time);
  const now=new Date();
  const hoursLeft=d?(d.getTime()-now.getTime())/3600000:-1;
  // Check grace period (within 2h of confirmation)
  let isGrace=false;
  if(s.confirmed_at){
    const ct=new Date(s.confirmed_at+'Z').getTime();
    isGrace=(Date.now()-ct)<2*3600000&&hoursLeft>24;
  }
  const isMyQ=currentUser.id===s.questioner_id;
  let penaltyText='',penaltyCls='cancel-modal__penalty-none';
  if(isGrace){penaltyText='ì—†ìŒ (í™•ì • í›„ 2ì‹œê°„ ì´ë‚´ + 24ì‹œê°„ ì „)';}
  else if(isMyQ){
    // ì§ˆë¬¸ì: í¬ì¸íŠ¸ ì°¨ê°ë§Œ
    if(hoursLeft>24){penaltyText='ì—†ìŒ (24ì‹œê°„ ì „)';}
    else if(hoursLeft>1){penaltyText='í¬ì¸íŠ¸ 50% ì°¨ê° ('+(s.reward_points?Math.floor(s.reward_points*0.5)+'P':'')+'ï¼‰';penaltyCls='cancel-modal__penalty-val';}
    else{penaltyText='í¬ì¸íŠ¸ 100% ì°¨ê° ('+(s.reward_points||0)+'P)';penaltyCls='cancel-modal__penalty-val';}
  }else{
    // ë‹µë³€ì: ê²½ê³ ë§Œ
    if(hoursLeft>24){penaltyText='ê²½ê³  1íšŒ';penaltyCls='cancel-modal__penalty-val';}
    else if(hoursLeft>1){penaltyText='ê²½ê³  1íšŒ';penaltyCls='cancel-modal__penalty-val';}
    else{penaltyText='ê²½ê³  2íšŒ';penaltyCls='cancel-modal__penalty-val';}
  }

  let timeLabel='';
  if(hoursLeft>24)timeLabel='ìˆ˜ì—… '+Math.floor(hoursLeft)+'ì‹œê°„ ì „';
  else if(hoursLeft>1)timeLabel='ìˆ˜ì—… '+Math.floor(hoursLeft)+'ì‹œê°„ ì „ (24ì‹œê°„ ì´ë‚´)';
  else if(hoursLeft>0)timeLabel='ìˆ˜ì—… '+Math.floor(hoursLeft*60)+'ë¶„ ì „ (1ì‹œê°„ ì´ë‚´!)';
  else timeLabel='ìˆ˜ì—… ì‹œê°„ ê²½ê³¼';

  const overlay=document.createElement('div');
  overlay.className='cancel-overlay';
  overlay.id='cancelOverlay';
  overlay.innerHTML=\`
  <div class="cancel-modal">
    <div class="cancel-modal__header">
      <div class="cancel-modal__icon cancel-modal__icon--warn"><i class="fas fa-exclamation-triangle"></i></div>
      <div>
        <div class="cancel-modal__title">ìˆ˜ì—… ì·¨ì†Œ</div>
        <div class="cancel-modal__sub">\${timeLabel}</div>
      </div>
    </div>
    <div class="cancel-modal__body">
      <div class="cancel-modal__penalty">
        <div class="cancel-modal__penalty-row"><span>ì¼ë°© ì·¨ì†Œ ì‹œ íŒ¨ë„í‹°</span><span class="\${penaltyCls}">\${penaltyText}</span></div>
        <div class="cancel-modal__penalty-row"><span>ìƒí˜¸ í•©ì˜ ì·¨ì†Œ</span><span class="cancel-modal__penalty-none">íŒ¨ë„í‹° ì—†ìŒ</span></div>
      </div>
      <div style="font-size:12px;font-weight:600;color:var(--dim);margin-bottom:8px">ì·¨ì†Œ ì‚¬ìœ  ì„ íƒ <span style="color:var(--red)">*</span></div>
      <div class="cancel-modal__reasons" id="cancelReasons">
        \${CANCEL_REASONS.map(r=>'<label class="cancel-reason" data-reason="'+r.id+'"><input type="radio" name="cancelReason" value="'+r.id+'"><i class="fas '+r.icon+'" style="color:var(--muted);font-size:14px"></i><span class="cancel-reason__label">'+r.label+'</span></label>').join('')}
      </div>
      <textarea class="cancel-detail" id="cancelDetail" placeholder="ìƒì„¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­)" style="display:none"></textarea>
    </div>
    <div class="cancel-modal__footer">
      <button class="cancel-modal__btn cancel-modal__btn--cancel" onclick="closeCancelModal()">ë‹«ê¸°</button>
      <button class="cancel-modal__btn cancel-modal__btn--mutual" id="mutualBtn" onclick="submitCancel(\${matchId},true)" disabled><i class="fas fa-handshake"></i> ìƒí˜¸í•©ì˜ ì·¨ì†Œ</button>
      <button class="cancel-modal__btn cancel-modal__btn--confirm" id="cancelBtn" onclick="submitCancel(\${matchId},false)" disabled><i class="fas fa-times"></i> ì¼ë°© ì·¨ì†Œ</button>
    </div>
  </div>\`;
  document.body.appendChild(overlay);
  overlay.addEventListener('click',(e)=>{if(e.target===overlay)closeCancelModal()});

  // Reason selection handlers
  document.querySelectorAll('#cancelReasons .cancel-reason').forEach(el=>{
    el.addEventListener('click',()=>{
      document.querySelectorAll('#cancelReasons .cancel-reason').forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected');
      el.querySelector('input').checked=true;
      document.getElementById('mutualBtn').disabled=false;
      document.getElementById('cancelBtn').disabled=false;
      // Show detail textarea for 'other'
      document.getElementById('cancelDetail').style.display=el.dataset.reason==='other'?'block':'none';
    });
  });
}

function closeCancelModal(){
  const o=document.getElementById('cancelOverlay');
  if(o)o.remove();
}

async function submitCancel(matchId,isMutual){
  const reasonEl=document.querySelector('#cancelReasons input[name="cancelReason"]:checked');
  if(!reasonEl){alert('ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');return}
  const reason=reasonEl.value;
  const reasonLabel=CANCEL_REASONS.find(r=>r.id===reason)?.label||reason;
  const detail=document.getElementById('cancelDetail')?.value||'';

  if(!isMutual){
    const s=allSchedules.find(x=>x.id===matchId);
    const d=s?parseSlotTime(s.slot_time):null;
    const hoursLeft=d?(d.getTime()-Date.now())/3600000:-1;
    const amQ=s&&currentUser.id===s.questioner_id;
    let warn='';
    if(amQ){
      // ì§ˆë¬¸ì: í¬ì¸íŠ¸ ì°¨ê°ë§Œ
      if(hoursLeft>1&&hoursLeft<=24)warn='\\nâš ï¸ í¬ì¸íŠ¸ 50% ì°¨ê° ('+(s.reward_points?Math.floor(s.reward_points*0.5)+'P':'')+')';
      else if(hoursLeft<=1)warn='\\nğŸ”´ í¬ì¸íŠ¸ 100% ì°¨ê° ('+(s.reward_points||0)+'P)';
    }else{
      // ë‹µë³€ì: ê²½ê³ ë§Œ
      if(hoursLeft>24)warn='\\nâš ï¸ ê²½ê³  1íšŒê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.';
      else if(hoursLeft>1)warn='\\nâš ï¸ ê²½ê³  1íšŒê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.';
      else warn='\\nğŸ”´ ê²½ê³  2íšŒê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.';
    }
    if(!confirm('ì‚¬ìœ : '+reasonLabel+warn+'\\n\\nì •ë§ ì¼ë°©ì ìœ¼ë¡œ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  }

  try{
    document.getElementById(isMutual?'mutualBtn':'cancelBtn').disabled=true;
    const res=await fetch('/api/schedule/'+matchId+'/cancel',{
      method:'POST',
      headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({reason:reasonLabel,reason_detail:detail,mutual:isMutual})
    });
    const data=await res.json();
    if(!res.ok){alert(data.error);document.getElementById(isMutual?'mutualBtn':'cancelBtn').disabled=false;return}
    closeCancelModal();
    if(data.pending_mutual){
      alert(data.message);
    }else{
      alert(data.message);
    }
    loadSchedule();
  }catch(e){alert('ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');document.getElementById(isMutual?'mutualBtn':'cancelBtn').disabled=false;}
}

// Load penalty/warning info
async function loadPenaltyInfo(){
  try{
    const res=await fetch('/api/user/penalty-info',{headers:authHeaders()});
    const data=await res.json();
    if(!res.ok)return;
    const el=document.getElementById('penaltyBanner');
    if(!el)return;
    if(data.suspended_until){
      el.innerHTML='<div class="penalty-info" style="border-color:rgba(255,0,0,.3);background:rgba(255,0,0,.06)"><i class="fas fa-ban" style="color:#ff0000;font-size:16px"></i><div><strong style="color:#ff0000">1:1 íŠœí„°ë§ ì´ìš© ì •ì§€</strong><br>ì •ì§€ í•´ì œ: '+data.suspended_until+'</div></div>';
    }else if(data.total_warnings>0){
      el.innerHTML='<div class="penalty-info"><i class="fas fa-exclamation-triangle"></i><div>ëˆ„ì  ê²½ê³ : <span class="penalty-info__count">'+data.total_warnings+'íšŒ</span> Â· ë§¤ì¹­ ì´í–‰ë¥ : '+data.fulfill_rate+'% Â· ì·¨ì†Œ: '+data.cancelled_matches+'íšŒ'+(data.total_warnings>=2?' <span style="color:#ff4500;font-size:11px">('+((3-data.total_warnings)>0?(3-data.total_warnings):'0')+'íšŒ ë” ì‹œ 3ì¼ ì •ì§€)</span>':'')+'</div></div>';
    }else{el.innerHTML=''}
  }catch(e){}
}

// Check mutual cancel requests for all upcoming schedules
async function checkMutualCancelStatus(){
  const upcoming=allSchedules.filter(s=>s.status==='confirmed');
  for(const s of upcoming){
    try{
      const res=await fetch('/api/schedule/'+s.id+'/cancel-status',{headers:authHeaders()});
      const data=await res.json();
      const el=document.getElementById('mutualStatus'+s.id);
      if(!el)continue;
      if(data.has_pending_request&&!data.requested_by_me){
        el.innerHTML='<div class="mutual-pending"><i class="fas fa-handshake"></i> ìƒëŒ€ë°©ì´ ìƒí˜¸í•©ì˜ ì·¨ì†Œë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤ <button class="sch-btn sch-btn--accept-mutual" style="margin-left:auto;padding:6px 12px;font-size:11px" onclick="acceptMutualCancel('+s.id+')">ìˆ˜ë½</button></div>';
      }else if(data.has_pending_request&&data.requested_by_me){
        el.innerHTML='<div class="mutual-pending"><i class="fas fa-clock"></i> ìƒí˜¸í•©ì˜ ì·¨ì†Œ ëŒ€ê¸° ì¤‘... ìƒëŒ€ë°©ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤</div>';
      }else{el.innerHTML=''}
    }catch(e){}
  }
}

async function acceptMutualCancel(matchId){
  if(!confirm('ìƒí˜¸í•©ì˜ë¡œ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íŒ¨ë„í‹° ì—†ìŒ)'))return;
  try{
    const res=await fetch('/api/schedule/'+matchId+'/cancel',{
      method:'POST',
      headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({reason:'ìƒí˜¸í•©ì˜ ì·¨ì†Œ',mutual:true})
    });
    const data=await res.json();
    if(!res.ok){alert(data.error);return}
    alert(data.message);
    loadSchedule();
  }catch(e){alert('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')}
}

async function completeSession(matchId){
  if(!confirm('ìˆ˜ì—…ì´ ì™„ë£Œë˜ì—ˆë‚˜ìš”?'))return;
  try{
    const res=await fetch('/api/schedule/'+matchId+'/complete',{method:'POST',headers:{...authHeaders(),'Content-Type':'application/json'},body:JSON.stringify({})});
    const data=await res.json();
    if(!res.ok){alert(data.error);return}
    alert(data.message);
    loadSchedule();
  }catch(e){alert('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')}
}

// Tab switching
document.querySelectorAll('.sch-tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.sch-tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    currentTab=t.dataset.tab;
    renderSchedule();
  });
});

// Auto-refresh every 60 seconds + countdown every 10 seconds
setInterval(()=>{loadSchedule()},60000);
setInterval(()=>{renderSchedule()},10000);
</script>
</body>
</html>`;
}

function rankingPageHTML() {
  return `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>ì±„íƒ ë­í‚¹</title>
${pwaHead()}
<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root{--bg:#111;--bg2:#1a1a1a;--bg3:#222;--white:#f5f5f5;--dim:#999;--muted:#666;--border:#2a2a2a;--red:#ff4136}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--white);min-height:100vh}
a{text-decoration:none;color:inherit}

.rk-nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(17,17,17,.95);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;height:48px}
.rk-nav__back{color:var(--dim);font-size:13px;font-weight:600;z-index:2;padding:8px 4px}
.rk-nav__back:hover{color:var(--white)}
.rk-nav__title{position:absolute;left:0;right:0;text-align:center;font-size:15px;font-weight:700;color:var(--white);pointer-events:none}

.rk-wrap{padding:64px 16px 32px;max-width:480px;margin:0 auto}

.rk-header{text-align:center;margin-bottom:24px}
.rk-header__icon{font-size:36px;margin-bottom:8px}
.rk-header__title{font-size:20px;font-weight:800;color:var(--white)}
.rk-header__desc{font-size:12px;color:var(--muted);margin-top:4px}

.rk-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--bg2);border-radius:10px;padding:4px}
.rk-tab{flex:1;text-align:center;padding:10px 8px;font-size:13px;font-weight:600;color:var(--muted);background:none;border:none;border-radius:8px;cursor:pointer;transition:all .2s}
.rk-tab.active{background:var(--bg3);color:var(--white);box-shadow:0 1px 4px rgba(0,0,0,.3)}
.rk-tab i{margin-right:4px}

/* Top 3 podium */
.rk-podium{display:flex;justify-content:center;align-items:flex-end;gap:8px;margin-bottom:24px;padding:0 8px}
.rk-podium__item{display:flex;flex-direction:column;align-items:center;border-radius:12px;padding:16px 8px 12px;position:relative;transition:all .3s}
.rk-podium__item--1{background:linear-gradient(180deg,rgba(255,215,0,.12),rgba(255,215,0,.04));border:1px solid rgba(255,215,0,.25);flex:1.15;order:2}
.rk-podium__item--2{background:linear-gradient(180deg,rgba(192,192,192,.1),rgba(192,192,192,.03));border:1px solid rgba(192,192,192,.2);flex:1;order:1}
.rk-podium__item--3{background:linear-gradient(180deg,rgba(205,127,50,.1),rgba(205,127,50,.03));border:1px solid rgba(205,127,50,.2);flex:1;order:3}
.rk-podium__medal{font-size:28px;margin-bottom:6px}
.rk-podium__name{font-size:14px;font-weight:700;color:var(--white);margin-bottom:2px;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}
.rk-podium__grade{font-size:10px;color:var(--muted);margin-bottom:6px}
.rk-podium__count{font-size:18px;font-weight:800;margin-bottom:2px}
.rk-podium__item--1 .rk-podium__count{color:#ffd700}
.rk-podium__item--2 .rk-podium__count{color:#c0c0c0}
.rk-podium__item--3 .rk-podium__count{color:#cd7f32}
.rk-podium__label{font-size:9px;color:var(--muted)}

/* List (4th+) */
.rk-list{display:flex;flex-direction:column;gap:6px}
.rk-row{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;transition:background .2s}
.rk-row:hover{background:var(--bg3)}
.rk-row__rank{width:28px;text-align:center;font-size:14px;font-weight:800;color:var(--dim);flex-shrink:0}
.rk-row__avatar{width:36px;height:36px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--dim);flex-shrink:0;border:1px solid var(--border)}
.rk-row__info{flex:1;min-width:0}
.rk-row__name{font-size:13px;font-weight:700;color:var(--white);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rk-row__grade{font-size:11px;color:var(--muted)}
.rk-row__count{font-size:16px;font-weight:800;color:#ffd700;flex-shrink:0}
.rk-row__label{font-size:9px;color:var(--muted);text-align:right}

.rk-empty{text-align:center;padding:48px 16px;color:var(--muted);font-size:13px}
.rk-empty i{font-size:32px;margin-bottom:12px;display:block;opacity:.5}
</style>
</head>
<body>

<nav class="rk-nav">
  <a href="/" class="rk-nav__back"><i class="fas fa-arrow-left"></i> í™ˆ</a>
  <div class="rk-nav__title"><i class="fas fa-trophy" style="color:#ffd700"></i> ì±„íƒ ë­í‚¹</div>
</nav>

<div class="rk-wrap">
  <div class="rk-header">
    <div class="rk-header__icon">ğŸ†</div>
    <div class="rk-header__title">ì±„íƒ ë­í‚¹</div>
    <div class="rk-header__desc">ê°€ì¥ ë§ì´ ì±„íƒë°›ì€ ë‹µë³€ìë¥¼ í™•ì¸í•˜ì„¸ìš”</div>
  </div>

  <div class="rk-tabs">
    <button class="rk-tab active" data-type="general" onclick="switchTab('general')"><i class="fas fa-star"></i>ì¼ë°˜ ì±„íƒ</button>
    <button class="rk-tab" data-type="tutoring" onclick="switchTab('tutoring')"><i class="fas fa-chalkboard-teacher"></i>1:1 ì‹¬í™”</button>
  </div>

  <div id="podium"></div>
  <div id="rankList"></div>
</div>

<script>
let curType='general';
let rankCache={};

function switchTab(type){
  curType=type;
  document.querySelectorAll('.rk-tab').forEach(t=>t.classList.toggle('active',t.dataset.type===type));
  loadRanking(type);
}

async function loadRanking(type){
  // Use cache if available
  if(rankCache[type]){renderRanking(rankCache[type]);return}
  try{
    const res=await fetch('/api/ranking?type='+type);
    const data=await res.json();
    rankCache[type]=data.ranking||[];
    renderRanking(rankCache[type]);
  }catch(e){
    document.getElementById('podium').innerHTML='';
    document.getElementById('rankList').innerHTML='<div class="rk-empty"><i class="fas fa-exclamation-circle"></i>ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
  }
}

function renderRanking(list){
  const podiumEl=document.getElementById('podium');
  const listEl=document.getElementById('rankList');
  const isT=curType==='tutoring';
  const label=isT?'ì‹¬í™” ì±„íƒ':'ì±„íƒ';

  if(!list.length){
    podiumEl.innerHTML='';
    listEl.innerHTML='<div class="rk-empty"><i class="fas fa-trophy"></i>ì•„ì§ '+label+' ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ë­ì»¤ê°€ ë˜ì–´ë³´ì„¸ìš”!</div>';
    return;
  }

  // Top 3 podium
  const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const top3=list.slice(0,3);
  let podiumHTML='<div class="rk-podium">';
  // Render in order: 2nd, 1st, 3rd for visual layout
  const order=[1,0,2];
  order.forEach(i=>{
    if(top3[i]){
      const r=top3[i];
      const initial=(r.nickname||'?')[0];
      podiumHTML+='<div class="rk-podium__item rk-podium__item--'+(i+1)+'">';
      podiumHTML+='<div class="rk-podium__medal">'+medals[i]+'</div>';
      podiumHTML+='<div class="rk-podium__name">'+esc(r.nickname||'ìµëª…')+'</div>';
      podiumHTML+='<div class="rk-podium__grade">'+(r.grade||'')+'</div>';
      podiumHTML+='<div class="rk-podium__count">'+r.accept_count+'</div>';
      podiumHTML+='<div class="rk-podium__label">'+label+'</div>';
      podiumHTML+='</div>';
    }
  });
  podiumHTML+='</div>';
  podiumEl.innerHTML=podiumHTML;

  // 4th and below
  const rest=list.slice(3);
  if(!rest.length){listEl.innerHTML='';return}
  let html='<div class="rk-list">';
  rest.forEach((r,idx)=>{
    const rank=idx+4;
    const initial=(r.nickname||'?')[0];
    html+='<div class="rk-row">';
    html+='<div class="rk-row__rank">'+rank+'</div>';
    html+='<div class="rk-row__avatar">'+esc(initial)+'</div>';
    html+='<div class="rk-row__info"><div class="rk-row__name">'+esc(r.nickname||'ìµëª…')+'</div><div class="rk-row__grade">'+(r.grade||'')+'</div></div>';
    html+='<div style="text-align:right"><div class="rk-row__count">'+r.accept_count+'</div><div class="rk-row__label">'+label+'</div></div>';
    html+='</div>';
  });
  html+='</div>';
  listEl.innerHTML=html;
}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// Initial load
loadRanking('general');
</script>
</body>
</html>`;
}

function categoryPageHTML(categoryName: string) {
  // Map category names to API parameters
  const catMap: Record<string, {title: string, icon: string, color: string, apiParam: string, paramType: string}> = {
    'ê³ ë‚œë„': {title: 'ê³ ë‚œë„ ì§ˆë¬¸ë„ì „', icon: 'fa-fire', color: '#ff4500', apiParam: 'ìµœìƒ', paramType: 'difficulty'},
    '1:1ì‹¬í™”ì„¤ëª…': {title: '1:1 íŠœí„°ë§ ìš”ì²­', icon: 'fa-chalkboard-teacher', color: '#6c5ce7', apiParam: '1:1ì‹¬í™”ì„¤ëª…', paramType: 'difficulty'},
    'ì˜ì–´': {title: 'ì˜ì–´', icon: 'fa-language', color: '#3498db', apiParam: 'ì˜ì–´', paramType: 'subject'},
    'ìˆ˜í•™': {title: 'ìˆ˜í•™', icon: 'fa-calculator', color: '#e74c3c', apiParam: 'ìˆ˜í•™', paramType: 'subject'},
    'êµ­ì–´': {title: 'êµ­ì–´', icon: 'fa-book', color: '#2ecc71', apiParam: 'êµ­ì–´', paramType: 'subject'},
    'ê³¼í•™': {title: 'ê³¼í•™', icon: 'fa-flask', color: '#f39c12', apiParam: 'ê³¼í•™', paramType: 'subject'},
    'ê¸°íƒ€': {title: 'ê¸°íƒ€', icon: 'fa-ellipsis-h', color: '#95a5a6', apiParam: 'ê¸°íƒ€', paramType: 'subject'},
  }
  const cat = catMap[categoryName] || {title: categoryName, icon: 'fa-folder', color: '#999', apiParam: categoryName, paramType: 'subject'}

  return `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>${cat.title} - Q&A</title>
${pwaHead()}
<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root{--bg:#111;--bg2:#1a1a1a;--bg3:#222;--white:#f5f5f5;--dim:#999;--muted:#666;--border:#2a2a2a;--red:#ff4136}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--white);min-height:100vh}
a{text-decoration:none;color:inherit}

.ct-nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(17,17,17,.95);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;height:48px}
.ct-nav__back{color:var(--dim);font-size:13px;font-weight:600;z-index:2;padding:8px 4px}
.ct-nav__back:hover{color:var(--white)}
.ct-nav__title{position:absolute;left:0;right:0;text-align:center;font-size:15px;font-weight:700;color:var(--white);pointer-events:none}

.ct-wrap{padding:60px 12px 32px;max-width:600px;margin:0 auto}

.ct-header{display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:0 4px}
.ct-header__icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;flex-shrink:0}
.ct-header__info h1{font-size:18px;font-weight:800;color:var(--white)}
.ct-header__count{font-size:12px;color:var(--muted);margin-top:2px}

.ct-sort{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding:0 4px;scrollbar-width:none}
.ct-sort::-webkit-scrollbar{display:none}
.ct-sort__btn{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--bg2);color:var(--dim);cursor:pointer;white-space:nowrap;transition:all .2s}
.ct-sort__btn.active{background:var(--white);color:var(--bg);border-color:var(--white)}

.ct-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 4px}
@media(max-width:380px){.ct-grid{grid-template-columns:1fr}}

.ct-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:transform .15s,border-color .15s;display:flex;flex-direction:column}
.ct-card:hover{border-color:var(--dim);transform:translateY(-2px)}
.ct-card__img{width:100%;aspect-ratio:4/3;object-fit:cover;background:var(--bg3)}
.ct-card__ph{width:100%;aspect-ratio:4/3;background:var(--bg3);display:flex;align-items:center;justify-content:center;padding:12px;font-size:11px;color:var(--muted);line-height:1.5;text-align:center;overflow:hidden}
.ct-card__body{padding:10px}
.ct-card__meta{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.ct-card__author{font-size:11px;font-weight:600;color:var(--dim)}
.ct-card__grade{font-size:9px;color:var(--muted);background:var(--bg3);padding:1px 5px;border-radius:3px}
.ct-card__time{font-size:10px;color:var(--muted);margin-left:auto}
.ct-card__text{font-size:12px;color:var(--white);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:6px}
.ct-card__footer{display:flex;align-items:center;gap:8px;font-size:10px;color:var(--muted)}
.ct-card__badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;color:#fff}
.ct-card__badge--done{background:linear-gradient(135deg,#ffd700,#ffaa00);color:#111}
.ct-card__badge--killer{background:linear-gradient(135deg,#ff4500,#ff6b35)}
.ct-card__badge--tutor{background:linear-gradient(135deg,#6c5ce7,#a29bfe)}
.ct-card__pts{color:#ffd700;font-weight:700}

.ct-loading{text-align:center;padding:24px;color:var(--muted);font-size:12px}
.ct-empty{text-align:center;padding:48px 16px;color:var(--muted);font-size:13px}
.ct-end{text-align:center;padding:16px;color:var(--muted);font-size:11px}
</style>
</head>
<body>

<nav class="ct-nav">
  <a href="/" class="ct-nav__back"><i class="fas fa-arrow-left"></i> í™ˆ</a>
  <div class="ct-nav__title"><i class="fas ${cat.icon}" style="color:${cat.color}"></i> ${cat.title}</div>
</nav>

<div class="ct-wrap">
  <div class="ct-header">
    <div class="ct-header__icon" style="background:${cat.color}"><i class="fas ${cat.icon}"></i></div>
    <div class="ct-header__info">
      <h1>${cat.title}</h1>
      <div class="ct-header__count" id="totalCount">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>

  <div class="ct-sort">
    <button class="ct-sort__btn active" data-sort="latest" onclick="changeSort('latest')">ìµœì‹ ìˆœ</button>
    <button class="ct-sort__btn" data-sort="unanswered" onclick="changeSort('unanswered')">ë¯¸ë‹µë³€ ìš°ì„ </button>
    <button class="ct-sort__btn" data-sort="answers_asc" onclick="changeSort('answers_asc')">ë‹µë³€ ì ì€ ìˆœ</button>
    <button class="ct-sort__btn" data-sort="points" onclick="changeSort('points')">í¬ì¸íŠ¸ ë†’ì€ ìˆœ</button>
  </div>

  <div class="ct-grid" id="grid"></div>
  <div id="loadMore"></div>
</div>

<script>
const CAT_PARAM_TYPE='${cat.paramType}';
const CAT_PARAM='${cat.apiParam}';
let curSort='latest',curPage=0,loading=false,noMore=false;
const PAGE_SIZE=20;
let imageCache={};

function changeSort(s){
  if(s===curSort)return;
  curSort=s;curPage=0;noMore=false;
  document.querySelectorAll('.ct-sort__btn').forEach(b=>b.classList.toggle('active',b.dataset.sort===s));
  document.getElementById('grid').innerHTML='';
  document.getElementById('loadMore').innerHTML='<div class="ct-loading"><i class="fas fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...</div>';
  loadPage();
}

async function loadPage(){
  if(loading||noMore)return;
  loading=true;
  try{
    const paramKey=CAT_PARAM_TYPE==='difficulty'?'difficulty':'subject';
    const url='/api/questions?'+paramKey+'='+encodeURIComponent(CAT_PARAM)+'&sort='+curSort+'&page='+curPage+'&limit='+PAGE_SIZE;
    const res=await fetch(url);
    const data=await res.json();
    if(!Array.isArray(data)||data.length===0){
      noMore=true;
      if(curPage===0){
        document.getElementById('grid').innerHTML='<div class="ct-empty" style="grid-column:1/-1"><i class="fas fa-inbox" style="font-size:32px;margin-bottom:12px;display:block;opacity:.5"></i>ì•„ì§ ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
      document.getElementById('loadMore').innerHTML=curPage>0?'<div class="ct-end">ëª¨ë“  ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤</div>':'';
      loading=false;return;
    }
    if(curPage===0){
      document.getElementById('totalCount').textContent=data.length>=PAGE_SIZE?PAGE_SIZE+'ê°œ ì´ìƒì˜ ì§ˆë¬¸':'ì§ˆë¬¸ '+data.length+'ê°œ';
    }
    const grid=document.getElementById('grid');
    data.forEach(q=>{
      const card=document.createElement('a');
      card.href='/question/'+q.id;
      card.className='ct-card';
      const imgPart=q.has_image
        ?(q.thumbnail_key?'<img class="ct-card__img" src="/api/images/'+q.thumbnail_key+'" alt="">'
          :q.thumbnail_data?'<img class="ct-card__img" src="'+q.thumbnail_data+'" alt="">'
          :'<img class="ct-card__img" data-qid="'+q.id+'" alt="">')
        :'<div class="ct-card__ph">'+(q.content||'').slice(0,80)+'</div>';
      let badgeHTML='';
      if(q.status==='ì±„íƒ ì™„ë£Œ')badgeHTML='<span class="ct-card__badge ct-card__badge--done"><i class="fas fa-star"></i> ì±„íƒ</span>';
      else if(q.difficulty==='ìµœìƒ')badgeHTML='<span class="ct-card__badge ct-card__badge--killer"><i class="fas fa-fire"></i> ê³ ë‚œë„</span>';
      else if(q.difficulty==='1:1ì‹¬í™”ì„¤ëª…')badgeHTML='<span class="ct-card__badge ct-card__badge--tutor"><i class="fas fa-chalkboard-teacher"></i> 1:1íŠœí„°ë§</span>';
      const pts=q.reward_points?'<span class="ct-card__pts">'+q.reward_points+'P</span>':'';
      card.innerHTML=imgPart+
        '<div class="ct-card__body">'+
          '<div class="ct-card__meta"><span class="ct-card__author">'+esc(q.author_name||'ìµëª…')+'</span>'+(q.author_grade?'<span class="ct-card__grade">'+q.author_grade+'</span>':'')+'<span class="ct-card__time">'+timeAgo(q.created_at)+'</span></div>'+
          '<div class="ct-card__text">'+esc((q.content||'').slice(0,100))+'</div>'+
          '<div class="ct-card__footer">'+badgeHTML+'<span><i class="fas fa-comment"></i> '+(q.comment_count||0)+'</span><span><i class="fas fa-tag"></i> '+q.subject+'</span>'+pts+'</div>'+
        '</div>';
      grid.appendChild(card);
    });
    // Lazy-load images
    document.querySelectorAll('.ct-card__img[data-qid]').forEach(img=>{
      const qid=img.getAttribute('data-qid');
      if(!qid||img.src)return;
      if(imageCache[qid]){img.src=imageCache[qid];return}
      fetch('/api/questions/'+qid+'/image').then(r=>r.json()).then(d=>{
        if(d.data){imageCache[qid]=d.data;img.src=d.data}
      }).catch(()=>{});
    });
    if(data.length<PAGE_SIZE){noMore=true;document.getElementById('loadMore').innerHTML='<div class="ct-end">ëª¨ë“  ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤</div>'}
    else{document.getElementById('loadMore').innerHTML='';curPage++}
  }catch(e){
    document.getElementById('loadMore').innerHTML='<div class="ct-loading" style="color:var(--red)">ë¡œë”© ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
  }
  loading=false;
}

function timeAgo(d){
  if(!d)return'';
  const diff=Date.now()-new Date(d+'Z').getTime();
  const m=Math.floor(diff/60000);
  if(m<1)return'ë°©ê¸ˆ ì „';if(m<60)return m+'ë¶„ ì „';
  const h=Math.floor(m/60);if(h<24)return h+'ì‹œê°„ ì „';
  return Math.floor(h/24)+'ì¼ ì „';
}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// Infinite scroll
let scrollTimer=null;
window.addEventListener('scroll',()=>{
  if(scrollTimer)return;
  scrollTimer=setTimeout(()=>{
    scrollTimer=null;
    if((window.innerHeight+window.scrollY)>=document.body.offsetHeight-400){loadPage()}
  },150);
});

// Initial load
loadPage();
</script>
</body>
</html>`;
}

function mypageHTML() {
  return `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë§ˆì´í˜ì´ì§€</title>
${pwaHead()}
<style>
${sharedCSS()}

.detail-nav{height:56px;display:flex;align-items:center;padding:0 4%;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;background:rgba(20,20,20,.95);backdrop-filter:blur(6px)}
.detail-nav__back{font-size:14px;font-weight:500;color:var(--dim);background:none;border:none;padding:0;display:flex;align-items:center;gap:8px;transition:color .15s}
.detail-nav__back:hover{color:var(--white)}

.mypage{max-width:480px;margin:0 auto;padding:40px 4% 80px}
.mypage__avatar{width:72px;height:72px;border-radius:50%;background:#2a2a3a;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:28px;margin:0 auto 20px}
.mypage__name{text-align:center;font-size:20px;font-weight:700;color:var(--white);margin-bottom:4px}
.mypage__sub{text-align:center;font-size:13px;color:var(--muted);margin-bottom:32px}

.mp-section{margin-bottom:20px}
.mp-label{font-size:12px;font-weight:600;color:var(--muted);margin-bottom:6px;display:block}
.mp-input{width:100%;padding:11px 14px;font-size:14px;border:1px solid var(--border);border-radius:4px;background:#1a1a1a;color:var(--white);outline:none;transition:border-color .15s}
.mp-input:focus{border-color:var(--muted)}
select.mp-input{appearance:auto}

.mp-btn{width:100%;padding:12px;font-size:14px;font-weight:700;border:none;border-radius:4px;transition:opacity .15s;margin-bottom:10px}
.mp-btn:hover{opacity:.85}
.mp-btn--save{background:var(--red);color:var(--white)}
.mp-btn--logout{background:none;border:1px solid var(--border);color:var(--muted)}
.mp-msg{text-align:center;font-size:12px;color:var(--green);min-height:18px;margin-top:8px}
</style>
</head>
<body>
<div class="detail-nav">
  <a href="/" class="detail-nav__back"><i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ</a>
</div>

<div class="mypage">
  <div class="mypage__avatar"><i class="fas fa-user"></i></div>
  <div class="mypage__name" id="mpName">-</div>
  <div class="mypage__sub" id="mpSub">-</div>
  <div id="mpMatchStats" style="text-align:center;margin-bottom:24px"></div>

  <div class="mp-section">
    <label class="mp-label">ë‹‰ë„¤ì„</label>
    <input class="mp-input" id="mpNick" type="text" maxlength="12" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
  </div>
  <div class="mp-section">
    <label class="mp-label">í•™ë…„</label>
    <select class="mp-input" id="mpGrade">
      <option value="">ì„ íƒ ì•ˆí•¨</option>
      <option value="ì¤‘1">ì¤‘1</option><option value="ì¤‘2">ì¤‘2</option><option value="ì¤‘3">ì¤‘3</option>
      <option value="ê³ 1">ê³ 1</option><option value="ê³ 2">ê³ 2</option><option value="ê³ 3">ê³ 3</option>
    </select>
  </div>

  <button class="mp-btn mp-btn--save" onclick="saveProfile()">ì €ì¥</button>
  <div class="mp-msg" id="mpMsg"></div>
</div>

<script>
${sharedAuthJS()}

(async()=>{
  const u=await checkAuth();
  if(!u){location.href='/';return}
  document.getElementById('mpName').textContent=u.nickname;
  document.getElementById('mpSub').textContent=u.grade||'í•™ë…„ ë¯¸ì„¤ì •';
  document.getElementById('mpNick').value=u.nickname;
  document.getElementById('mpGrade').value=u.grade||'';
  // Load match stats
  try{
    const pr=await fetch('/api/user/penalty-info',{headers:authHeaders()});
    const pd=await pr.json();
    if(pr.ok){
      const el=document.getElementById('mpMatchStats');
      const rate=pd.fulfill_rate||100;
      const barColor=rate>=90?'#00c853':rate>=70?'#ffa500':'#ff4136';
      el.innerHTML='<div style="display:flex;gap:16px;justify-content:center;align-items:center;font-size:12px;color:var(--muted);flex-wrap:wrap"><div>ë§¤ì¹­ ì´í–‰ë¥  <strong style="color:'+barColor+';font-size:16px">'+rate+'%</strong></div><div>ì™„ë£Œ <strong style="color:var(--white)">'+pd.completed_matches+'</strong>íšŒ</div><div>ì·¨ì†Œ <strong style="color:'+(pd.cancelled_matches>0?'#ff4136':'var(--white)')+'">'+pd.cancelled_matches+'</strong>íšŒ</div><div>ê²½ê³  <strong style="color:'+(pd.total_warnings>0?'#ff4136':'var(--white)')+'">'+pd.total_warnings+'</strong>íšŒ</div></div>'+(pd.suspended_until?'<div style="margin-top:8px;font-size:11px;color:#ff0000;font-weight:600"><i class="fas fa-ban"></i> ì´ìš© ì •ì§€ ì¤‘ ('+pd.suspended_until+'ê¹Œì§€)</div>':'');
    }
  }catch(e){}
})();

async function saveProfile(){
  const nickname=document.getElementById('mpNick').value.trim();
  const grade=document.getElementById('mpGrade').value;
  if(!nickname||nickname.length<1){alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return}
  if(nickname.length>12){alert('ë‹‰ë„¤ì„ì€ 12ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');return}
  try{
    const r=await fetch('/api/auth/profile',{method:'PATCH',headers:authHeaders(),body:JSON.stringify({nickname,grade})});
    if(r.ok){
      const u=getUser();if(u){u.nickname=nickname;u.grade=grade;setUser(u)}
      document.getElementById('mpName').textContent=nickname;
      document.getElementById('mpSub').textContent=grade||'í•™ë…„ ë¯¸ì„¤ì •';
      document.getElementById('mpMsg').textContent='ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
      setTimeout(()=>document.getElementById('mpMsg').textContent='',2000);
    }else{
      const d=await r.json().catch(()=>({}));
      alert(d.error||'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }catch(e){alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')}
}

async function doLogout(){
  try{await fetch('/api/auth/logout',{method:'POST',headers:authHeaders()})}catch(e){}
  clearToken();location.href='/';
}
</script>
</body>
</html>`
}

// ===== Question Detail Page =====

function questionDetailHTML(question: any = null, answers: any[] = []) {
  return `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì§ˆë¬¸ ìƒì„¸</title>
${pwaHead()}
<style>
${sharedCSS()}

/* ===== ORZO-STYLE SPLIT LAYOUT ===== */
.detail-nav{height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid var(--border);position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(20,20,20,.97);backdrop-filter:blur(8px)}
.detail-nav__back{font-size:14px;font-weight:500;color:var(--dim);background:none;border:none;padding:0;display:flex;align-items:center;gap:8px;transition:color .15s}
.detail-nav__back:hover{color:var(--white)}
.detail-nav__center{font-size:15px;font-weight:700;color:var(--white);position:absolute;left:50%;transform:translateX(-50%)}
.detail-nav__user{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px}
.detail-nav__left{display:flex;align-items:center;gap:12px}
.detail-nav__home{font-size:16px;color:var(--dim);transition:color .15s;display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;background:var(--bg3);border:none;cursor:pointer}
.detail-nav__home:hover{color:var(--white);background:var(--bg4)}

/* Split panel container â€” Orzo 2-column layout */
.split-container{display:flex;position:fixed;top:48px;left:0;right:0;bottom:52px;overflow:hidden}
.split-left{
  width:50%;min-width:280px;
  overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;
  padding:0;
  display:flex;flex-direction:column;
}
.split-right{
  flex:1;min-width:0;
  overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;
  padding:20px 24px 40px;
}

/* Left panel: question content */
.q-panel-inner{padding:20px 20px 40px}
.q-head{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.q-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#2a2a5a,#3a3a6a);display:flex;align-items:center;justify-content:center;color:#8888cc;font-size:15px;flex-shrink:0}
.q-meta{flex:1;min-width:0}
.q-name{font-size:14px;font-weight:700;color:var(--white);display:flex;align-items:center;gap:6px}
.q-name .grade-tag{font-size:10px;font-weight:600;color:var(--dim);background:var(--bg3);padding:2px 7px;border-radius:3px}
.q-sub{font-size:11px;color:var(--muted);margin-top:2px}
.q-status{flex-shrink:0;font-size:10px;font-weight:700;padding:4px 12px;border-radius:4px;border:1px solid var(--border);color:var(--dim);letter-spacing:.3px}
.q-status.done{border-color:var(--green);color:var(--green);background:rgba(70,211,105,.08)}
.q-status.waiting{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,.08)}

.q-content{font-size:14px;color:var(--text);line-height:1.75;white-space:pre-wrap;margin-bottom:16px;word-break:break-word}
.q-image-wrap{margin-bottom:16px;border-radius:8px;overflow:hidden;background:#1a1a1a;border:1px solid #2a2a2a;position:relative}
.q-image{width:100%;display:block;cursor:pointer;transition:opacity .15s}
.q-img-btns{position:absolute;top:8px;right:8px;z-index:5;display:flex;gap:6px}
.q-img-btn{display:flex;align-items:center;gap:5px;padding:7px 12px;font-size:11px;font-weight:600;color:#fff;background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.15);border-radius:8px;cursor:pointer;backdrop-filter:blur(8px);transition:all .2s;opacity:.85}
.q-img-btn:hover{opacity:1;background:rgba(0,0,0,.85);border-color:rgba(255,255,255,.3)}
.q-img-btn.copied{background:rgba(70,211,105,.85);border-color:rgba(70,211,105,.5);color:#fff}
.q-img-btn.downloaded{background:rgba(59,130,246,.85);border-color:rgba(59,130,246,.5);color:#fff}
.q-img-btn i{font-size:12px}
.q-image:hover{opacity:.92}
.q-footer{display:flex;gap:14px;padding-top:14px;border-top:1px solid var(--border);font-size:12px;color:var(--muted);align-items:center}
.q-footer .tag{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:var(--bg3);border-radius:3px;font-weight:500}

/* AI Analysis Meta Info Section */
.ai-meta{margin-top:16px;padding:20px;background:linear-gradient(135deg,rgba(108,92,231,.06),rgba(70,211,105,.04));border:1px solid rgba(108,92,231,.15);border-radius:12px}
.ai-meta__header{display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:22px;font-weight:700;color:#a29bfe}
.ai-meta__header i{font-size:22px}
.ai-meta__row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px;align-items:center}
.ai-meta__row:last-child{margin-bottom:0}
.ai-meta__label{font-size:18px;font-weight:600;color:var(--muted);min-width:70px;flex-shrink:0}
.ai-meta__stars{display:flex;align-items:center;gap:2px}
.ai-meta__star{font-size:24px;color:#ffd700}
.ai-meta__star.empty{color:#444}
.ai-meta__tags{display:flex;flex-wrap:wrap;gap:5px}
.ai-meta__tag{display:inline-flex;align-items:center;font-size:20px;font-weight:600;color:#a29bfe;background:rgba(108,92,231,.1);border:1px solid rgba(108,92,231,.2);padding:6px 14px;border-radius:20px;transition:all .15s;cursor:default}
.ai-meta__tag:hover{background:rgba(108,92,231,.18);border-color:rgba(108,92,231,.35)}
.ai-meta__info{font-size:20px;color:var(--dim);display:flex;align-items:center;gap:6px}
.ai-meta__info i{font-size:16px;color:var(--muted)}
.ai-meta__desc{font-size:20px;color:var(--dim);line-height:1.7;padding:12px 14px;background:rgba(0,0,0,.15);border-radius:8px;margin-top:6px}
.ai-meta__badge{display:inline-flex;align-items:center;gap:6px;font-size:18px;font-weight:600;padding:6px 14px;border-radius:14px}
.ai-meta__badge--level{background:rgba(255,215,0,.1);color:#ffd700;border:1px solid rgba(255,215,0,.2)}
.ai-meta__badge--time{background:rgba(70,211,105,.1);color:#46d369;border:1px solid rgba(70,211,105,.2)}
.ai-meta__badge--topic{background:rgba(229,9,20,.08);color:#ff6b6b;border:1px solid rgba(229,9,20,.15)}
.ai-meta__analyzing{display:flex;align-items:center;gap:10px;font-size:20px;color:var(--muted);padding:10px 0}
.ai-meta__analyzing i{animation:spin 1s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

/* AI Section 2 & 3: Question Analysis + Coaching */
.ai-section{margin-top:12px;padding:20px;border-radius:12px}
.ai-section--question{background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(99,102,241,.04));border:1px solid rgba(59,130,246,.15)}
.ai-section--coaching{background:linear-gradient(135deg,rgba(16,185,129,.06),rgba(52,211,153,.04));border:1px solid rgba(16,185,129,.15)}
.ai-section__header{display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:22px;font-weight:700}
.ai-section--question .ai-section__header{color:#60a5fa}
.ai-section--coaching .ai-section__header{color:#34d399}
.ai-section__header i{font-size:22px}
.ai-section__body{font-size:20px;color:var(--text);line-height:1.8;word-break:keep-all}
.ai-section__coaching-text{padding:14px 18px;background:rgba(16,185,129,.05);border-radius:8px;border-left:4px solid rgba(52,211,153,.4);font-style:normal;color:var(--dim)}
.q-level-bar{margin-bottom:14px}
.q-level-label{font-size:12px;color:var(--muted);font-weight:600;margin-bottom:8px}
.q-level-track{display:flex;align-items:center;gap:2px;overflow-x:auto;padding:4px 0}
.q-level-step{display:flex;flex-direction:column;align-items:center;padding:4px 6px;border-radius:8px;border:2px solid transparent;min-width:36px;transition:all .2s}
.q-level-step--active{border-width:2px;font-weight:700}
.q-level-step--past .q-level-emoji,.q-level-step--past .q-level-code{opacity:1}
.q-level-step--future .q-level-emoji{opacity:.3}
.q-level-step--future .q-level-code{opacity:.3}
.q-level-emoji{font-size:14px;line-height:1}
.q-level-code{font-size:9px;color:var(--dim);margin-top:1px}
.q-level-step--active .q-level-code{color:var(--text);font-weight:700}
.q-level-name{font-size:9px;color:var(--text);font-weight:700;white-space:nowrap;margin-top:1px}
.q-level-arrow{font-size:12px;color:var(--muted);opacity:.4;flex-shrink:0}
.q-level-arrow--past{opacity:.8}
.next-q-wrap{margin-top:14px;padding:0}
.next-q-title{font-size:15px;font-weight:700;color:#fbbf24;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.next-q-card{background:rgba(255,255,255,.04);border-radius:10px;padding:12px 14px;margin-bottom:8px}
.next-q-badge{display:inline-block;font-size:11px;font-weight:700;padding:2px 8px;border-radius:6px;margin-bottom:6px}
.next-q-text{font-size:15px;font-weight:600;color:var(--text);line-height:1.5;margin-bottom:4px}
.next-q-why{font-size:12px;color:var(--muted);line-height:1.4}

/* Growth Coaching Interactive UI */
.gc-wrap{margin-top:12px}
.gc-step{display:none;animation:gcFadeIn .3s ease}
.gc-step.active{display:block}
@keyframes gcFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.gc-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px;margin-bottom:10px}
.gc-card__title{font-size:17px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.gc-card__body{font-size:16px;color:var(--text);line-height:1.7}
.gc-card__q{font-size:17px;font-weight:700;color:#fbbf24;margin-top:8px}
.gc-btns{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.gc-btn{padding:12px 20px;font-size:15px;font-weight:700;border:none;border-radius:10px;cursor:pointer;transition:all .15s;flex:1;min-width:100px;text-align:center}
.gc-btn--yes{background:rgba(52,211,153,.15);color:#34d399;border:1px solid rgba(52,211,153,.3)}
.gc-btn--yes:hover{background:rgba(52,211,153,.25)}
.gc-btn--no{background:rgba(248,113,113,.15);color:#f87171;border:1px solid rgba(248,113,113,.3)}
.gc-btn--no:hover{background:rgba(248,113,113,.25)}
.gc-btn--choice{background:rgba(96,165,250,.1);color:#60a5fa;border:1px solid rgba(96,165,250,.2);flex:none;min-width:auto;padding:12px 16px;font-size:15px}
.gc-btn--choice:hover{background:rgba(96,165,250,.2)}
.gc-btn--next{background:rgba(251,191,36,.15);color:#fbbf24;border:1px solid rgba(251,191,36,.3)}
.gc-btn--next:hover{background:rgba(251,191,36,.25)}
.gc-hint{padding:14px 16px;background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:8px;margin-top:10px;font-size:15px;color:#fbbf24;line-height:1.6}
.gc-bridge{padding:14px;background:rgba(167,139,250,.06);border:1px solid rgba(167,139,250,.15);border-radius:10px;margin-top:10px}
.gc-bridge__step{font-size:15px;color:var(--text);line-height:1.8;padding-left:4px}
.gc-bridge__conn{font-size:16px;font-weight:700;color:#a78bfa;margin-top:8px}
.gc-progress{display:flex;gap:4px;margin-bottom:12px}
.gc-progress__dot{width:100%;height:3px;border-radius:2px;background:var(--border);transition:background .3s}
.gc-progress__dot.done{background:#34d399}
.gc-progress__dot.active{background:#fbbf24}

/* Coaching Review Timeline */
.gc-review-timeline{margin-top:10px;padding:0}
.gc-review-step{display:flex;align-items:flex-start;gap:10px;padding:8px 0;position:relative}
.gc-review-step:not(:last-child):after{content:'';position:absolute;left:13px;top:30px;bottom:0;width:2px;background:rgba(255,255,255,.1)}
.gc-review-dot{width:26px;height:26px;min-width:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;z-index:1}
.gc-review-dot--select{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#1a1a2e}
.gc-review-dot--wa{background:linear-gradient(135deg,#f472b6,#ec4899);color:#fff}
.gc-review-dot--hint{background:linear-gradient(135deg,#a78bfa,#8b5cf6);color:#fff}
.gc-review-dot--choice{background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff}
.gc-review-dot--bridge{background:linear-gradient(135deg,#34d399,#10b981);color:#fff}
.gc-review-content{flex:1;min-width:0}
.gc-review-label{font-size:12px;color:var(--muted);font-weight:600;margin-bottom:2px}
.gc-review-choice{font-size:14px;color:var(--text);line-height:1.5}
.gc-review-time{font-size:10px;color:var(--muted);margin-top:2px}

/* Drag divider for split panel */
.split-divider{width:6px;cursor:col-resize;background:var(--border);position:relative;flex-shrink:0;transition:background .15s;z-index:10}
.split-divider:hover,.split-divider.active{background:#555}
.split-divider::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:2px;height:32px;background:#666;border-radius:1px}
.split-divider:hover::after,.split-divider.active::after{background:#888}

/* Right panel: answers */
.ans-header{font-size:15px;font-weight:700;color:var(--white);padding:0 0 16px;display:flex;align-items:center;gap:8px}
.ans-header .cnt{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;background:var(--red);color:#fff;font-size:11px;font-weight:700;border-radius:11px;padding:0 7px}

/* Answer card â€” Orzo tutor answer style */
.ans-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;margin-bottom:16px;overflow:hidden;transition:border-color .15s}
.ans-card:hover{border-color:#444}
.ans-card.accepted{border-color:rgba(70,211,105,.4);background:rgba(70,211,105,.04)}

.ans-card-head{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border)}
.ans-card .ans-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#2a3a2a,#3a4a3a);display:flex;align-items:center;justify-content:center;color:#88aa88;font-size:13px;flex-shrink:0}
.ans-card .ans-meta{flex:1;min-width:0}
.ans-card .ans-name{font-size:13px;font-weight:700;color:var(--white);display:flex;align-items:center;gap:6px}
.ans-card .ans-grade{font-size:10px;color:var(--muted);font-weight:500;background:var(--bg3);padding:2px 7px;border-radius:3px}
.ans-card .ans-time{font-size:11px;color:var(--muted);margin-top:1px}
.ans-badge{flex-shrink:0;font-size:10px;font-weight:700;color:var(--green);border:1px solid var(--green);padding:3px 10px;border-radius:4px;display:flex;align-items:center;gap:4px;background:rgba(70,211,105,.08)}

.ans-card-body{padding:16px}
.ans-section{margin-bottom:14px}
.ans-section:last-child{margin-bottom:0}
.ans-section-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.ans-section-title i{font-size:10px;color:var(--dim)}
.ans-content{font-size:13px;line-height:1.75;color:var(--dim);white-space:pre-wrap;word-break:break-word}
.ans-img-wrap{border-radius:8px;overflow:hidden;background:#1a1a1a;margin-top:8px;border:1px solid #2a2a2a}
.ans-img{width:100%;display:block;cursor:pointer;transition:opacity .15s}
.ans-img:hover{opacity:.92}

/* Answer interaction bar */
.ans-actions{display:flex;align-items:center;gap:12px;padding:10px 16px;border-top:1px solid var(--border)}
.ans-act-btn{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--muted);background:none;border:none;cursor:pointer;padding:4px 8px;border-radius:4px;transition:all .15s}
.ans-act-btn:hover{background:var(--bg3);color:var(--dim)}
.ans-del-btn:hover{color:#e55;background:rgba(238,85,85,.1)}
.ans-act-btn.active-reply{color:var(--green);background:rgba(70,211,105,.1)}
.ans-accept-btn{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#46d369;background:rgba(70,211,105,.1);border:1px solid rgba(70,211,105,.3);cursor:pointer;padding:5px 12px;border-radius:6px;font-weight:600;transition:all .15s;margin-left:auto}
.ans-accept-btn:hover{background:rgba(70,211,105,.2);border-color:rgba(70,211,105,.5)}

/* Acceptance review section on accepted answer card */
.accept-review{margin:0 16px 14px;padding:14px;background:rgba(70,211,105,.04);border:1px solid rgba(70,211,105,.15);border-radius:10px}
.accept-review-title{font-size:12px;font-weight:700;color:var(--green);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.accept-review-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.accept-review-tag{display:inline-flex;align-items:center;gap:5px;font-size:12px;color:var(--dim);background:var(--bg3);padding:4px 10px;border-radius:20px}
.accept-review-text{font-size:13px;color:var(--dim);line-height:1.6;white-space:pre-wrap;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}

/* Accept modal */
.accept-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:10010;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
.accept-modal{background:var(--bg2);border:1px solid var(--border);border-radius:16px;max-width:420px;width:100%;max-height:90vh;overflow-y:auto;padding:0;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.accept-modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--border);text-align:center}
.accept-modal-header h3{font-size:17px;font-weight:700;color:var(--white);margin-bottom:4px}
.accept-modal-header p{font-size:12px;color:var(--muted)}
.accept-modal-body{padding:20px 24px}
.accept-tag-list{display:flex;flex-direction:column;gap:6px;margin-bottom:20px}
.accept-tag-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:all .15s;background:var(--bg3)}
.accept-tag-item:hover{border-color:#555;background:rgba(255,255,255,.05)}
.accept-tag-item.selected{border-color:var(--green);background:rgba(70,211,105,.08)}
.accept-tag-item .tag-emoji{font-size:22px;flex-shrink:0;width:32px;text-align:center}
.accept-tag-item .tag-text{font-size:13px;color:var(--dim);flex:1}
.accept-tag-item .tag-check{width:20px;height:20px;border-radius:50%;border:2px solid #555;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:11px;color:transparent;transition:all .15s}
.accept-tag-item.selected .tag-check{border-color:var(--green);background:var(--green);color:#fff}
.accept-review-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--dim);font-size:13px;padding:12px;resize:none;min-height:70px;font-family:inherit;transition:border-color .15s}
.accept-review-input:focus{outline:none;border-color:var(--green)}
.accept-review-input::placeholder{color:#555}
.accept-modal-footer{padding:14px 24px 20px;display:flex;gap:10px}
.accept-modal-footer button{flex:1;padding:12px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;border:none}
.accept-cancel-btn{background:var(--bg3);color:var(--dim)}
.accept-cancel-btn:hover{background:#444}
.accept-confirm-btn{background:var(--green);color:#fff}
.accept-confirm-btn:hover{background:#3bc35e}
.accept-confirm-btn:disabled{opacity:.4;cursor:not-allowed}

/* Reply (ëŒ€ëŒ“ê¸€) styles */
.reply-section{padding:0 16px 12px}
.reply-toggle{font-size:11px;color:var(--muted);background:none;border:none;cursor:pointer;padding:4px 0;display:flex;align-items:center;gap:4px;transition:color .15s}
.reply-toggle:hover{color:var(--dim)}
.reply-list{margin-top:8px}
.reply-item{display:flex;gap:8px;padding:8px 0;border-top:1px solid rgba(255,255,255,.04)}
.reply-item:first-child{border-top:none}
.reply-avatar{width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#2a2a3a,#3a3a4a);display:flex;align-items:center;justify-content:center;color:#7777aa;font-size:10px;flex-shrink:0;margin-top:2px}
.reply-body{flex:1;min-width:0}
.reply-head{display:flex;align-items:center;gap:6px;margin-bottom:2px}
.reply-name{font-size:11px;font-weight:700;color:var(--dim)}
.reply-grade{font-size:9px;color:var(--muted);background:var(--bg3);padding:1px 5px;border-radius:2px}
.reply-time{font-size:10px;color:var(--muted);margin-left:auto}
.reply-del{font-size:10px;color:#ff6b6b;background:none;border:none;cursor:pointer;padding:0 4px;opacity:.6;transition:opacity .15s}
.reply-del:hover{opacity:1}
.reply-text{font-size:12px;color:var(--dim);line-height:1.6;word-break:break-word}
.reply-input-row{display:flex;gap:6px;margin-top:8px;align-items:center}
.reply-input{flex:1;min-width:0;padding:7px 12px;font-size:12px;border:1px solid var(--border);border-radius:16px;background:#1e1e1e;color:var(--white);outline:none;transition:border-color .15s}
.reply-input:focus{border-color:var(--muted)}
.reply-input::placeholder{color:var(--muted)}
.reply-send{width:28px;height:28px;border-radius:50%;background:var(--green);border:none;color:#111;display:flex;align-items:center;justify-content:center;font-size:11px;cursor:pointer;flex-shrink:0;transition:opacity .15s}
.reply-send:hover{opacity:.85}
.reply-send:disabled{opacity:.3}
.reply-count{font-size:10px;color:var(--muted);margin-left:2px}

/* Bottom bar â€” KakaoTalk-style chat input */
.bottom-bar{position:fixed;bottom:0;left:0;right:0;min-height:52px;background:rgba(20,20,20,.97);backdrop-filter:blur(8px);border-top:1px solid var(--border);display:flex;align-items:flex-end;gap:8px;padding:8px 12px;z-index:100}
.bottom-bar .bb-draw-btn{flex-shrink:0;display:flex;align-items:center;gap:5px;padding:8px 14px;font-size:12px;font-weight:600;color:var(--dim);background:none;border:1px solid var(--border);border-radius:20px;transition:all .15s;white-space:nowrap;margin-bottom:1px}
.bottom-bar .bb-draw-btn:hover{border-color:var(--dim);color:var(--white)}
.bottom-bar .bb-draw-btn.active{background:var(--green);color:#111;border-color:var(--green)}
/* Chat input wrapper â€” contains input + image btn inside like KakaoTalk */
.bb-input-wrap{flex:1;min-width:0;display:flex;align-items:flex-end;border:1px solid var(--border);border-radius:20px;background:#1e1e1e;padding:2px 4px 2px 14px;transition:border-color .15s;gap:4px}
.bb-input-wrap:focus-within{border-color:var(--muted)}
.bb-input-wrap .bb-input{flex:1;min-width:0;padding:7px 0;font-size:13px;border:none;background:transparent;color:var(--white);outline:none}
.bb-input-wrap .bb-input::placeholder{color:var(--muted)}
/* Image button inside the input wrap */
.bb-input-wrap .bb-img-btn{flex-shrink:0;width:32px;height:32px;border-radius:50%;background:none;border:none;color:var(--muted);display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;transition:color .15s;margin-bottom:1px}
.bb-input-wrap .bb-img-btn:hover{color:var(--dim)}
.bb-input-wrap .bb-img-btn.has-img{color:var(--green)}

/* Mic button inside input wrap */
.bb-mic-btn{flex-shrink:0;width:32px;height:32px;border-radius:50%;background:none;border:none;color:var(--muted);display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;transition:all .15s;margin-bottom:1px}
.bb-mic-btn:hover{color:var(--dim)}
.bb-mic-btn.recording{color:#ff4444;animation:pulse-mic 1s ease-in-out infinite}
.bb-mic-btn.has-voice{color:#ff6b6b}
@keyframes pulse-mic{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}

/* ========== ClassIn-Style Voice Recording â€” Bottom Bar ========== */
/* Recording bar: fixed at bottom, red strip */
.voice-rec-bar{position:fixed;bottom:0;left:0;right:0;z-index:200;display:none;flex-direction:column;animation:slideUpBar .25s ease-out}
@keyframes slideUpBar{from{transform:translateY(100%)}to{transform:translateY(0)}}
/* Main red strip */
.voice-rec-strip{background:linear-gradient(90deg,#e53935,#ff5252);display:flex;align-items:center;padding:10px 16px;gap:12px;min-height:48px}
.voice-rec-strip__icon{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;flex-shrink:0;animation:pulse-mic 1.2s ease-in-out infinite}
.voice-rec-strip__timer{font-size:16px;font-weight:700;color:#fff;font-family:'SF Mono',Menlo,monospace;letter-spacing:1px;min-width:48px}
.voice-rec-strip__wave{flex:1;height:28px;min-width:0}
.voice-rec-strip__wave canvas{width:100%;height:100%;border-radius:4px}
.voice-rec-strip__btn{width:32px;height:32px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;flex-shrink:0;transition:all .12s}
.voice-rec-strip__btn:hover{transform:scale(1.1)}
.voice-rec-strip__btn--pause{background:rgba(255,255,255,.25);color:#fff}
.voice-rec-strip__btn--resume{background:rgba(255,255,255,.25);color:#fff}
.voice-rec-strip__btn--stop{background:#fff;color:#e53935;font-size:14px}
.voice-rec-strip__btn--cancel{background:rgba(255,255,255,.15);color:rgba(255,255,255,.7);font-size:11px}
/* Paused state */
.voice-rec-bar.paused .voice-rec-strip{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.voice-rec-bar.paused .voice-rec-strip__icon{animation:none}

/* Preview bar (after recording) */
.voice-preview-bar{background:rgba(20,20,30,.97);backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,.08);display:none;align-items:center;padding:10px 16px;gap:10px}
.voice-prev-play{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#6c5ce7,#a29bfe);border:none;color:#fff;font-size:13px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .12s}
.voice-prev-play:hover{transform:scale(1.05)}
.voice-prev-play.playing{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
.voice-prev-info{flex:1;min-width:0}
.voice-prev-progress{width:100%;height:3px;background:rgba(255,255,255,.1);border-radius:2px;cursor:pointer;margin-bottom:4px}
.voice-prev-progress__fill{height:100%;background:linear-gradient(90deg,#6c5ce7,#a29bfe);border-radius:2px;width:0%;transition:width .1s linear}
.voice-prev-times{display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,.35);font-family:monospace}
.voice-prev-btn{padding:7px 16px;border-radius:20px;border:none;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .12s;flex-shrink:0}
.voice-prev-btn--redo{background:rgba(255,255,255,.08);color:rgba(255,255,255,.6)}
.voice-prev-btn--redo:hover{background:rgba(255,255,255,.15);color:#fff}
.voice-prev-btn--confirm{background:linear-gradient(135deg,#00b894,#00cec9);color:#fff}
.voice-prev-btn--confirm:hover{opacity:.9}
.voice-prev-close{width:32px;height:32px;border-radius:50%;border:none;background:rgba(255,255,255,.08);color:rgba(255,255,255,.5);font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .12s;margin-left:2px}
.voice-prev-close:hover{background:rgba(255,68,68,.2);color:#ff4444;transform:scale(1.1)}
.voice-prev-btn--confirm:disabled{opacity:.4;cursor:not-allowed}

/* === Voice preview in answer input area (Step 5) === */
.voice-preview{display:flex;align-items:center;gap:10px;padding:10px 14px;background:linear-gradient(135deg,rgba(108,92,231,.08),rgba(162,155,254,.05));border:1px solid rgba(108,92,231,.2);border-radius:12px;margin:8px 16px 0}
.voice-preview__icon{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#6c5ce7,#a29bfe);display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;flex-shrink:0}
.voice-preview__info{flex:1;min-width:0}
.voice-preview__label{font-size:12px;font-weight:600;color:#a29bfe;margin-bottom:2px}
.voice-preview__duration{font-size:11px;color:rgba(255,255,255,.4);font-family:monospace}
.voice-preview__play{width:28px;height:28px;border-radius:50%;background:rgba(108,92,231,.15);border:1px solid rgba(108,92,231,.3);color:#a29bfe;font-size:11px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s}
.voice-preview__play:hover{background:rgba(108,92,231,.25)}
.voice-preview__remove{width:24px;height:24px;border-radius:50%;background:rgba(255,70,70,.15);color:#ff6b6b;border:1px solid rgba(255,70,70,.2);font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s}
.voice-preview__remove:hover{background:rgba(255,70,70,.3)}

/* === Voice player in answer cards === */
.ans-voice{margin-top:10px;padding:12px 14px;background:linear-gradient(135deg,rgba(108,92,231,.06),rgba(162,155,254,.03));border:1px solid rgba(108,92,231,.12);border-radius:12px}
.ans-voice__header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.ans-voice__icon{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#6c5ce7,#a29bfe);display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;flex-shrink:0}
.ans-voice__label{font-size:13px;font-weight:600;color:#a29bfe}
.ans-voice__duration{font-size:11px;color:rgba(255,255,255,.4);font-family:monospace;margin-left:auto}
.ans-voice-player{display:flex;align-items:center;gap:10px}
.ans-voice-play{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,#6c5ce7,#a29bfe);border:none;color:#fff;font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s}
.ans-voice-play:hover{transform:scale(1.05);box-shadow:0 2px 10px rgba(108,92,231,.3)}
.ans-voice-play.playing{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
.ans-voice-progress{flex:1;height:4px;background:rgba(255,255,255,.08);border-radius:2px;cursor:pointer;position:relative}
.ans-voice-progress__fill{height:100%;background:linear-gradient(90deg,#6c5ce7,#a29bfe);border-radius:2px;width:0%;transition:width .1s linear}
.ans-voice-times{display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,.35);font-family:monospace;margin-top:4px}
/* Inline image preview inside input area */
.bb-img-preview{position:relative;margin:4px 0 4px 0;max-width:120px}
.bb-img-preview img{width:100%;border-radius:8px;display:block}
.bb-img-preview .bb-img-remove{position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:rgba(255,70,70,.9);color:#fff;border:none;font-size:9px;display:flex;align-items:center;justify-content:center;cursor:pointer}
/* Send button */
.bottom-bar .bb-send{flex-shrink:0;width:36px;height:36px;border-radius:50%;background:var(--red);border:none;color:var(--white);display:flex;align-items:center;justify-content:center;font-size:14px;transition:opacity .15s;margin-bottom:1px}
.bottom-bar .bb-send:hover{opacity:.85}
.bottom-bar .bb-send:disabled{opacity:.3}

/* Empty state & misc */
.ans-empty{text-align:center;padding:48px 20px;color:var(--muted)}
.ans-empty i{font-size:32px;margin-bottom:12px;display:block;color:#444}
.ans-empty p{font-size:13px;line-height:1.6}

.ans-login-prompt{text-align:center;padding:32px 0}
.ans-login-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 24px;font-size:14px;font-weight:600;color:var(--white);background:var(--red);border:none;border-radius:4px;transition:opacity .15s}
.ans-login-btn:hover{opacity:.85}

/* Previews in right panel */
.preview-section{margin:16px 0;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px}
.preview-section img{max-width:100%;border-radius:6px}
.preview-section .preview-label{font-size:11px;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:4px}
.preview-remove-btn{font-size:11px;color:#ff6b6b;background:none;border:none;cursor:pointer;margin-left:auto}

/* Responsive: stack vertically on narrow screens */
@media(max-width:700px){
  .split-container{flex-direction:column}
  .split-left{width:100%!important;max-width:none;min-width:auto;border-right:none;border-bottom:1px solid var(--border);max-height:40vh}
  .split-divider{display:none}
  .split-right{flex:1;min-height:0}
}

/* ====== ORZO-STYLE FULLSCREEN DRAWING MODE ====== */
.draw-overlay{position:fixed;inset:0;z-index:10000;background:#f5f5f5;display:flex;flex-direction:column;overflow:hidden}
/* Top toolbar: Orzo-style clean light gray bar */
.draw-topbar{display:flex;align-items:center;gap:0;padding:0;background:#f0f0f0;border-bottom:1px solid #d0d0d0;flex-shrink:0;z-index:10;height:52px;min-height:52px}
.draw-topbar .dt-group{display:flex;align-items:center;gap:2px;padding:0 6px;height:100%}
.draw-topbar .dt-sep{width:1px;height:28px;background:#ccc;margin:0;flex-shrink:0}
.draw-topbar .dt-btn{width:40px;height:40px;border-radius:10px;background:none;border:none;color:#666;font-size:16px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s}
.draw-topbar .dt-btn:hover{background:#ddd;color:#333}
.draw-topbar .dt-btn:active{background:#ccc}
.draw-topbar .dt-btn.active{background:#333;color:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.draw-topbar .dt-btn.active[data-tool="eraser"]{background:#ff6b6b;color:#fff}
.draw-topbar .dt-btn:disabled{opacity:.3;cursor:default}
/* Color circles */
.draw-topbar .dt-color{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;flex-shrink:0;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.15)}
.draw-topbar .dt-color.active{border-color:#333;transform:scale(1.15);box-shadow:0 0 0 2px rgba(0,0,0,.2)}
.draw-topbar .dt-color-plus{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px dashed #aaa;background:none;display:flex;align-items:center;justify-content:center;font-size:12px;color:#999;flex-shrink:0}
/* Stroke width slider */
.draw-topbar .dt-slider{width:80px;height:4px;-webkit-appearance:none;appearance:none;background:#ccc;border-radius:2px;outline:none;cursor:pointer;flex-shrink:0}
.draw-topbar .dt-slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#555;cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.draw-topbar .dt-label{font-size:11px;color:#888;min-width:22px;text-align:center;flex-shrink:0;font-weight:600}
.draw-topbar .spacer{flex:1;min-width:4px}
/* Action buttons */
.draw-done-btn{padding:8px 20px;border-radius:10px;background:#e50914;color:#fff;border:none;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .15s;box-shadow:0 2px 6px rgba(229,9,20,.3)}
.draw-done-btn:hover{opacity:.9;transform:translateY(-1px)}
.draw-close-btn{padding:8px 14px;border-radius:10px;background:#ddd;color:#555;border:none;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .15s}
.draw-close-btn:hover{background:#ccc}

/* Canvas area â€” CRITICAL: block all iOS text selection & callout menus */
.draw-canvas-area{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;background:#e8e8e8;position:relative;
  -webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
.draw-canvas-inner{position:relative;-webkit-user-select:none;user-select:none}
.draw-canvas-inner canvas{display:block;touch-action:none;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}
#bgCanvas{position:relative;z-index:0;pointer-events:none}
#drawCanvas{position:absolute;top:0;left:0;z-index:1}
#tempCanvas{position:absolute;top:0;left:0;z-index:2;pointer-events:none}
/* Block iOS context menus on the entire overlay */
.draw-overlay{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
.draw-overlay *{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}

/* Zoom bar: minimal bottom-center pill */
.draw-zoom-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:10001;display:flex;gap:2px;background:rgba(0,0,0,.7);padding:4px 6px;border-radius:24px;backdrop-filter:blur(8px)}
.draw-zoom-bar button{width:34px;height:34px;border-radius:50%;background:transparent;border:none;color:#fff;font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .15s}
.draw-zoom-bar button:hover{background:rgba(255,255,255,.15)}
.draw-zoom-bar span{font-size:12px;color:rgba(255,255,255,.8);display:flex;align-items:center;min-width:44px;justify-content:center;font-weight:600}

/* Scissors tool active style */
.draw-topbar .dt-btn.active[data-tool="scissors"]{background:#16a34a;color:#fff}
.draw-topbar .dt-btn.active[data-tool="select"]{background:#2563eb;color:#fff}
.draw-topbar .dt-btn.active[data-tool="text"]{background:#f59e0b;color:#fff}
.select-delete-btn{position:absolute;z-index:10001;background:#e50914;color:#fff;border:none;border-radius:50%;width:28px;height:28px;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.3);transform:translate(-50%,-120%)}
.text-input-box{position:relative;z-index:10002;display:block;width:100%;min-width:80px;min-height:32px;padding:6px 10px;border:1.5px dashed rgba(180,180,180,.7);border-radius:2px;background:transparent;color:#222;font-size:18px;font-family:'Pretendard',-apple-system,sans-serif;outline:none;resize:none;overflow:hidden;line-height:1.4;white-space:pre-wrap;word-break:break-word;box-sizing:border-box}
.text-input-box::placeholder{color:rgba(150,150,150,.6)}
.text-input-box:focus{border-color:rgba(150,150,150,.9)}
.text-toolbar{position:relative;z-index:10003;display:flex;align-items:center;gap:2px;background:rgba(60,60,60,.92);padding:6px 10px;border-radius:22px;backdrop-filter:blur(8px);box-shadow:0 2px 12px rgba(0,0,0,.35);margin-top:8px;width:fit-content}
.text-toolbar button,.text-toolbar select{background:transparent;border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s}
.text-toolbar button{width:32px;height:32px;border-radius:50%;font-size:14px}
.text-toolbar button:hover{background:rgba(255,255,255,.15)}
.text-toolbar button.active{background:rgba(255,255,255,.25)}
.text-toolbar .tt-close{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.12);font-size:12px}
.text-toolbar .tt-divider{width:1px;height:20px;background:rgba(255,255,255,.15);margin:0 4px}
.text-toolbar .tt-size-select{appearance:none;background:transparent;color:#fff;font-size:14px;font-weight:600;padding:4px 8px;border:none;outline:none;cursor:pointer;min-width:36px;text-align:center}
.text-toolbar .tt-size-select option{background:#333;color:#fff}

/* Floating object context menu */
.float-ctx-menu{position:absolute;z-index:10003;display:flex;gap:2px;background:rgba(0,0,0,.8);padding:4px 6px;border-radius:16px;backdrop-filter:blur(6px)}
.float-ctx-menu button{width:32px;height:32px;border-radius:50%;background:transparent;border:none;color:#fff;font-size:13px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .15s}
.float-ctx-menu button:hover{background:rgba(255,255,255,.2)}

/* Stroke preview dot (shows current tool size) */
.dt-stroke-preview{display:flex;align-items:center;justify-content:center;width:32px;height:32px;flex-shrink:0}
.dt-stroke-preview .dot{border-radius:50%;background:#333}

.preview-wrap{position:relative;margin:12px 0}
.preview-wrap img{max-width:100%;border-radius:6px}
.preview-remove{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:50%;background:rgba(0,0,0,.7);color:var(--white);border:none;font-size:11px;display:flex;align-items:center;justify-content:center}

.img-modal{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;padding:20px;cursor:pointer}
.img-modal img{max-width:100%;max-height:90vh}

.loading{text-align:center;padding:40px 0;color:var(--muted);font-size:13px}
.empty{text-align:center;padding:40px 0;color:var(--muted);font-size:14px}

@media(max-width:768px){
  .draw-topbar{height:48px;min-height:48px}
  .draw-topbar .dt-btn{width:36px;height:36px;font-size:14px;border-radius:8px}
  .draw-topbar .dt-color{width:24px;height:24px}
  .draw-topbar .dt-slider{width:60px}
  .draw-topbar .dt-group{gap:1px;padding:0 4px}
}
</style>
</head>
<body>
<!-- Fixed top nav -->
<div class="detail-nav">
  <div class="detail-nav__left">
    <a onclick="history.back()" class="detail-nav__back" style="cursor:pointer"><i class="fas fa-arrow-left"></i></a>
    <a href="/" class="detail-nav__home" title="í™ˆìœ¼ë¡œ"><i class="fas fa-home"></i></a>
  </div>
  <span class="detail-nav__center">ì§ˆë¬¸</span>
  <div class="detail-nav__user" id="navUser"></div>
</div>

<!-- Orzo-style split layout: Left=Question, Right=Answers -->
<div class="split-container" id="splitContainer">
  <div class="split-left" id="splitLeft">
    <div class="q-panel-inner" id="questionSection"><div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
  </div>
  <div class="split-divider" id="splitDivider"></div>
  <div class="split-right" id="splitRight">
    <div class="ans-header">ë‹µë³€ <span class="cnt" id="answerCount">0</span></div>
    <div id="answersContainer"></div>

    <!-- Drawing preview (shown after drawing mode, before submit) -->
    <div id="drawingPreview" class="preview-section" style="display:none">
      <div class="preview-label"><i class="fas fa-pen-fancy"></i> í•„ê¸° ë‹µë³€ ë¯¸ë¦¬ë³´ê¸° <button class="preview-remove-btn" id="clearDrawingPreview"><i class="fas fa-times"></i> ì‚­ì œ</button></div>
      <canvas id="drawPreviewCanvas" style="max-width:100%;border-radius:6px;background:#fff"></canvas>
    </div>
    <!-- Image preview (shown after attaching image, before submit) -->
    <div id="answerImagePreview" class="preview-section" style="display:none">
      <div class="preview-label"><i class="fas fa-image"></i> ì²¨ë¶€ ì´ë¯¸ì§€ <button class="preview-remove-btn" id="clearImgPreview"><i class="fas fa-times"></i> ì‚­ì œ</button></div>
      <img id="ansImgPreview" style="max-width:100%;border-radius:6px">
    </div>
    <div id="answerFormArea"></div>
  </div>
</div>

<!-- Fixed bottom bar â€” KakaoTalk-style -->
<div class="bottom-bar" id="bottomBar">
  <button class="bb-draw-btn" id="toggleDrawing"><i class="fas fa-pen-fancy"></i> í•„ê¸°</button>
  <div class="bb-input-wrap" id="bbInputWrap">
    <input class="bb-input" id="answerContent" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
    <label class="bb-img-btn" id="bbImgBtn" title="ì´ë¯¸ì§€ ì²¨ë¶€"><i class="fas fa-image"></i><input id="answerImage" type="file" accept="image/*" style="display:none"></label>
    <button class="bb-mic-btn" id="bbMicBtn" title="ìŒì„± ë…¹ìŒ"><i class="fas fa-microphone"></i></button>
  </div>
  <button class="bb-send" id="submitAnswer" title="ë‹µë³€ ë“±ë¡"><i class="fas fa-paper-plane"></i></button>
</div>

<!-- Voice recording bottom bar (ClassIn-style) -->
<div class="voice-rec-bar" id="voiceRecBar">
  <!-- Recording strip (red bar) -->
  <div class="voice-rec-strip" id="voiceRecStrip">
    <div class="voice-rec-strip__icon"><i class="fas fa-microphone"></i></div>
    <div class="voice-rec-strip__timer" id="voiceTimer">00:00</div>
    <div class="voice-rec-strip__wave"><canvas id="voiceWaveCanvas" width="300" height="28"></canvas></div>
    <button class="voice-rec-strip__btn voice-rec-strip__btn--pause" id="voicePauseBtn" title="ì¼ì‹œì •ì§€"><i class="fas fa-pause"></i></button>
    <button class="voice-rec-strip__btn voice-rec-strip__btn--stop" id="voiceStopBtn" title="ì™„ë£Œ"><i class="fas fa-stop"></i></button>
    <button class="voice-rec-strip__btn voice-rec-strip__btn--cancel" id="voiceCancelBtn" title="ì·¨ì†Œ"><i class="fas fa-times"></i></button>
  </div>
  <!-- Preview bar (after recording) -->
  <div class="voice-preview-bar" id="voicePreviewBar">
    <button class="voice-prev-play" id="voicePreviewPlay"><i class="fas fa-play"></i></button>
    <div class="voice-prev-info">
      <div class="voice-prev-progress" id="voicePreviewProgress"><div class="voice-prev-progress__fill" id="voicePreviewFill"></div></div>
      <div class="voice-prev-times"><span id="voicePreviewCurrent">00:00</span><span id="voicePreviewTotal">00:00</span></div>
    </div>
    <button class="voice-prev-btn voice-prev-btn--redo" id="voiceRerecordBtn"><i class="fas fa-redo"></i> ì¬ë…¹ìŒ</button>
    <button class="voice-prev-btn voice-prev-btn--confirm" id="voiceConfirmBtn"><i class="fas fa-check"></i> ì²¨ë¶€</button>
    <button class="voice-prev-close" id="voicePreviewCloseBtn" title="ë…¹ìŒ ì·¨ì†Œ"><i class="fas fa-times"></i></button>
  </div>
</div>
<audio id="voiceAudio" style="display:none"></audio>

<script>
${sharedAuthJS()}

const qId=location.pathname.split('/').pop();
let drawOn=false,curTool='pen',curColor='#111111',curWidth=6,drawing=false,drawHistory=[],curStroke=null,ansImgData=null;
let questionImageData=null;

// === Voice recording state ===
let voiceBlob=null, voiceKey=null, mediaRecorder=null, audioChunks=[], voiceTimerInterval=null, voiceSeconds=0;
let audioCtx=null, analyser=null, micStream=null;
let bgCanvas,bgCtx,canvas,ctx,tempCanvas,tempCtx,bgImg=null;
let currentUser=null;
let zoomLevel=1,canvasBaseW=0,canvasBaseH=0;
let drawOverlay=null;
let lastLineWidth=0;
// DPR will be set dynamically in setupCanvas() at runtime.
// This ensures we read devicePixelRatio AFTER the page is fully rendered.
let canvasDpr=2; // default, overridden in setupCanvas
// Shape drawing state
let shapeStart=null; // {x,y} start point for shapes
let pinching=false; // global: pinch-zoom state (used by setZoom to defer re-rasterize)

// ===== FLOATING OBJECTS (Scissors capture) =====
let floatingObjects=[]; // Array of {img:HTMLImageElement, x, y, w, h, id}
let selectedFloat=null; // Currently selected floating object
let floatDragMode=null; // null | 'move' | 'resize-tl' | 'resize-tr' | 'resize-bl' | 'resize-br' | ... 
let floatDragStart=null; // {x, y, origX, origY, origW, origH}
let scissorsStart=null; // Start point of scissors selection
let floatCtxMenu=null; // Context menu DOM element
let cachedQData=${JSON.stringify(question)||'null'};
const ssrAnswers=${JSON.stringify(answers)};

// === Split panel drag resize ===
(function(){
  const divider=document.getElementById('splitDivider');
  const left=document.getElementById('splitLeft');
  const container=document.getElementById('splitContainer');
  if(!divider||!left||!container) return;
  let isDragging=false;
  function onStart(e){
    isDragging=true;
    divider.classList.add('active');
    document.body.style.cursor='col-resize';
    document.body.style.userSelect='none';
    e.preventDefault();
  }
  function onMove(e){
    if(!isDragging) return;
    const clientX=e.touches?e.touches[0].clientX:e.clientX;
    const rect=container.getBoundingClientRect();
    let pct=((clientX-rect.left)/rect.width)*100;
    if(pct<20) pct=20;
    if(pct>80) pct=80;
    left.style.width=pct+'%';
  }
  function onEnd(){
    if(!isDragging) return;
    isDragging=false;
    divider.classList.remove('active');
    document.body.style.cursor='';
    document.body.style.userSelect='';
  }
  divider.addEventListener('mousedown',onStart);
  divider.addEventListener('touchstart',onStart,{passive:false});
  document.addEventListener('mousemove',onMove);
  document.addEventListener('touchmove',onMove,{passive:false});
  document.addEventListener('mouseup',onEnd);
  document.addEventListener('touchend',onEnd);
})();

function timeAgo(d){const ms=Date.now()-new Date(d+'Z').getTime(),m=Math.floor(ms/60000);if(m<1)return'ë°©ê¸ˆ ì „';if(m<60)return m+'ë¶„ ì „';const h=Math.floor(m/60);if(h<24)return h+'ì‹œê°„ ì „';return Math.floor(h/24)+'ì¼ ì „'}

// SSR: render question and answers IMMEDIATELY from embedded data (zero fetch)
if(cachedQData) renderQ(cachedQData);
renderA(ssrAnswers, cachedQData);

// Then async: check auth and re-render with accept buttons if needed
(async()=>{
  currentUser=await checkAuth();
  const navUser=document.getElementById('navUser');
  if(currentUser){
    navUser.innerHTML='<i class="fas fa-user-circle"></i> '+currentUser.nickname;
    renderAnswerForm(true);
    // Re-render answers with accept buttons now that auth is known
    renderA(ssrAnswers, cachedQData);
    // Re-render tutoring panel now that currentUser is known (fixes owner detection)
    if(cachedQData&&cachedQData.difficulty==='1:1ì‹¬í™”ì„¤ëª…') loadTutoring(cachedQData);
  }else{
    navUser.innerHTML='';
    renderAnswerForm(false);
  }
  // Lazy load question image
  if(cachedQData&&cachedQData.has_image){
    if(cachedQData.image_key){
      // R2: direct URL
      const img=document.getElementById('qImage');
      if(img){img.src='/api/images/'+cachedQData.image_key;questionImageData='/api/images/'+cachedQData.image_key}
    } else {
    fetch('/api/questions/'+qId+'/image').then(r=>r.json()).then(d=>{
      if(d.data){
        const img=document.getElementById('qImage');
        if(img)img.src=d.data;
        questionImageData=d.data;
      } else {
        const wrap=document.querySelector('.q-image-wrap');
        if(wrap)wrap.style.display='none';
      }
    }).catch(()=>{
      const wrap=document.querySelector('.q-image-wrap');
      if(wrap)wrap.style.display='none';
    });
    } // end else (non-R2 fallback)
  }
})();

// Auto-poll answers every 20s
let ansPollTimer=null;
let lastAnsKey='';
function ansKey(list){return(list||[]).map(a=>a.id+':'+a.is_accepted).join(',')}
lastAnsKey=ansKey(ssrAnswers);
async function ansPollOnce(){
  try{
    const h=currentUser?authHeaders():{'Content-Type':'application/json'};
    const res=await fetch('/api/questions/'+qId+'/answers',{headers:h});
    const d=await res.json();
    const list=d.answers||d;
    if(!Array.isArray(list))return;
    const nk=ansKey(list);
    if(nk!==lastAnsKey){lastAnsKey=nk;renderA(list,cachedQData);}
  }catch(e){}
}
function startAnsPoll(){if(!ansPollTimer)ansPollTimer=setInterval(ansPollOnce,5000);}
function stopAnsPoll(){if(ansPollTimer){clearInterval(ansPollTimer);ansPollTimer=null;}}
document.addEventListener('visibilitychange',()=>{
  if(document.hidden)stopAnsPoll();
  else{ansPollOnce();startAnsPoll();}
});
startAnsPoll();

function renderAnswerForm(loggedIn){
  const bottomBar=document.getElementById('bottomBar');
  if(!loggedIn){
    // Hide bottom bar, show login prompt in right panel
    bottomBar.style.display='none';
    document.getElementById('answerFormArea').innerHTML='<div class="ans-login-prompt"><p style="color:var(--muted);font-size:13px;margin-bottom:12px">ë‹µë³€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p><a href="/login?redirect=/question/'+qId+'" class="ans-login-btn"><i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸í•˜ê¸°</a></div>';
    // Extend split-container to bottom
    document.querySelector('.split-container').style.bottom='0';
    return;
  }
  // Wire up bottom bar events
  initDrawingTools();
}

function removeAnsImg(){
  ansImgData=null;
  // Remove inline preview from input wrap
  const existing=document.getElementById('bbInlineImgPreview');
  if(existing)existing.remove();
  const imgBtn=document.getElementById('bbImgBtn');
  if(imgBtn)imgBtn.classList.remove('has-img');
  // Also hide old preview area
  document.getElementById('answerImagePreview').style.display='none';
}

function removeDrawingPreview(){
  drawHistory=[];drawOn=false;
  document.getElementById('drawingPreview').style.display='none';
  document.getElementById('toggleDrawing').classList.remove('active');
}

function showInlineImgPreview(){
  // Show small preview inside the input wrap (KakaoTalk style)
  const wrap=document.getElementById('bbInputWrap');
  if(!wrap)return;
  let prev=document.getElementById('bbInlineImgPreview');
  if(!prev){
    prev=document.createElement('div');
    prev.id='bbInlineImgPreview';
    prev.className='bb-img-preview';
    wrap.insertBefore(prev,wrap.firstChild);
  }
  prev.innerHTML='<img src="'+ansImgData+'"><button class="bb-img-remove" onclick="removeAnsImg()"><i class="fas fa-times"></i></button>';
  const imgBtn=document.getElementById('bbImgBtn');
  if(imgBtn)imgBtn.classList.add('has-img');
}
window.removeAnsImg=removeAnsImg;

function initDrawingTools(){
  // Toggle drawing â€” opens fullscreen mode
  document.getElementById('toggleDrawing').addEventListener('click',()=>openDrawingMode());

  // Preview removal buttons
  document.getElementById('clearDrawingPreview').addEventListener('click',removeDrawingPreview);
  document.getElementById('clearImgPreview').addEventListener('click',removeAnsImg);

  // Image attach via bottom bar (inside input wrap)
  document.getElementById('answerImage').addEventListener('change',e=>{
    const f=e.target.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=ev=>{
      const img=new Image();
      img.onload=()=>{
        let w=img.width,h=img.height;const max=1200;
        if(w>max||h>max){const s=max/Math.max(w,h);w=Math.round(w*s);h=Math.round(h*s)}
        const cv=document.createElement('canvas');cv.width=w;cv.height=h;
        cv.getContext('2d').drawImage(img,0,0,w,h);
        ansImgData=cv.toDataURL('image/jpeg',0.82);
        showInlineImgPreview();
      };
      img.src=ev.target.result;
    };
    r.readAsDataURL(f);
  });

  // Submit answer via bottom bar send button
  document.getElementById('submitAnswer').addEventListener('click',submitAnswer);
  // Enter key in input sends
  document.getElementById('answerContent').addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();submitAnswer()}
  });

  // === Voice recording setup (ClassIn bottom-bar style) ===
  document.getElementById('bbMicBtn').addEventListener('click',()=>startRecording());
  document.getElementById('voicePauseBtn').addEventListener('click',togglePauseRecording);
  document.getElementById('voiceStopBtn').addEventListener('click',stopRecording);
  document.getElementById('voiceCancelBtn').addEventListener('click',cancelRecording);
  document.getElementById('voiceRerecordBtn').addEventListener('click',rerecordVoice);
  document.getElementById('voiceConfirmBtn').addEventListener('click',confirmVoice);
  document.getElementById('voicePreviewCloseBtn').addEventListener('click',cancelFromPreview);
  document.getElementById('voicePreviewPlay').addEventListener('click',togglePreviewPlay);
  document.getElementById('voicePreviewProgress').addEventListener('click',seekPreview);
}

function openDrawingMode(){
  drawOn=true;
  document.getElementById('toggleDrawing').classList.add('active');
  if(drawOverlay){drawOverlay.remove()}
  drawOverlay=document.createElement('div');
  drawOverlay.className='draw-overlay';
  // Orzo-style toolbar: Left=undo/redo | Center=tools+colors+width | Right=cancel/done
  drawOverlay.innerHTML=\`
    <div class="draw-topbar">
      <div class="dt-group">
        <button class="dt-btn" id="undoBtn" title="ë˜ëŒë¦¬ê¸°"><i class="fas fa-undo"></i></button>
        <button class="dt-btn" id="redoBtn" title="ë‹¤ì‹œ ì‹¤í–‰"><i class="fas fa-redo"></i></button>
      </div>
      <div class="dt-sep"></div>
      <div class="dt-group">
        <button class="dt-btn active" data-tool="pen" title="íœ"><i class="fas fa-pen"></i></button>
        <button class="dt-btn" data-tool="highlighter" title="í˜•ê´‘íœ"><i class="fas fa-highlighter"></i></button>
        <button class="dt-btn" data-tool="eraser" title="ì§€ìš°ê°œ"><i class="fas fa-eraser"></i></button>
      </div>
      <div class="dt-sep"></div>
      <div class="dt-group">
        <div class="dt-color active" style="background:#111111" data-color="#111111"></div>
        <div class="dt-color" style="background:#e50914" data-color="#e50914"></div>
        <div class="dt-color" style="background:#2563eb" data-color="#2563eb"></div>
        <div class="dt-color" style="background:#16a34a" data-color="#16a34a"></div>
        <div class="dt-color" style="background:#9333ea" data-color="#9333ea"></div>
      </div>
      <div class="dt-sep"></div>
      <div class="dt-group">
        <button class="dt-btn" data-tool="text" title="í…ìŠ¤íŠ¸"><i class="fas fa-font"></i></button>
        <button class="dt-btn" data-tool="line" title="ì§ì„ "><i class="fas fa-minus"></i></button>
        <button class="dt-btn" data-tool="rect" title="ì‚¬ê°í˜•"><i class="far fa-square"></i></button>
        <button class="dt-btn" data-tool="circle" title="ì›"><i class="far fa-circle"></i></button>
        <button class="dt-btn" data-tool="select" title="ì„ íƒ/ì´ë™"><i class="fas fa-mouse-pointer"></i></button>
        <button class="dt-btn" data-tool="scissors" title="ìº¡ì²˜/ì´ë™"><i class="fas fa-cut"></i></button>
      </div>
      <div class="dt-sep"></div>
      <div class="dt-group">
        <div class="dt-stroke-preview"><div class="dot" id="strokeDot"></div></div>
        <input type="range" class="dt-slider" id="strokeSlider" min="1" max="20" value="\${curWidth}">
      </div>
      <div class="spacer"></div>
      <div class="dt-group">
        <button class="dt-btn" id="clearBtn" title="ì „ì²´ ì§€ìš°ê¸°" style="color:#ff6b6b"><i class="fas fa-trash-alt"></i></button>
      </div>
      <div class="dt-sep"></div>
      <div class="dt-group" style="gap:6px">
        <button class="draw-close-btn" id="drawCancelBtn">ì·¨ì†Œ</button>
        <button class="draw-done-btn" id="drawDoneBtn"><i class="fas fa-check" style="margin-right:4px"></i>ì™„ë£Œ</button>
      </div>
    </div>
    <div class="draw-canvas-area" id="canvasWrap">
      <div class="draw-canvas-inner" id="canvasInner">
        <canvas id="bgCanvas"></canvas>
        <canvas id="drawCanvas"></canvas>
        <canvas id="tempCanvas"></canvas>
      </div>
    </div>
    <div class="draw-zoom-bar">
      <button id="zoomOutBtn"><i class="fas fa-minus"></i></button>
      <span id="zoomLabel">100%</span>
      <button id="zoomInBtn"><i class="fas fa-plus"></i></button>
      <button id="zoomFitBtn" title="ë§ì¶”ê¸°"><i class="fas fa-expand"></i></button>
    </div>
  \`;
  document.body.appendChild(drawOverlay);
  document.body.style.overflow='hidden';

  bgCanvas=document.getElementById('bgCanvas');
  canvas=document.getElementById('drawCanvas');
  tempCanvas=document.getElementById('tempCanvas');
  bgCtx=bgCanvas.getContext('2d',{alpha:false}); // opaque bg layer
  ctx=canvas.getContext('2d',{alpha:true}); // transparent stroke layer â€” destination-out works
  tempCtx=tempCanvas.getContext('2d',{alpha:true});
  [bgCtx,ctx,tempCtx].forEach(c=>{c.imageSmoothingEnabled=true;c.imageSmoothingQuality='high'});

  if(questionImageData&&!bgImg){
    const img=new Image();
    img.onload=()=>{bgImg=img;setupCanvas()};
    img.src=questionImageData;
  }else{
    setupCanvas();
  }
  wireToolbar();
  updateStrokeDot();
}

function setupCanvas(){
  const wrap=document.getElementById('canvasWrap');
  if(!wrap)return;
  const wrapR=wrap.getBoundingClientRect();
  const wrapW=wrapR.width;
  const PAD_LEFT=100,PAD_RIGHT=200,PAD_TOP=40,PAD_BOTTOM=800;

  let imgDrawW=0,imgDrawH=0;
  if(bgImg&&bgImg.naturalWidth){
    imgDrawW=Math.min(wrapW*0.9,bgImg.naturalWidth);
    imgDrawH=imgDrawW*(bgImg.naturalHeight/bgImg.naturalWidth);
  }

  const contentW=Math.max(imgDrawW,wrapW*0.7);
  const totalW=PAD_LEFT+contentW+PAD_RIGHT;
  const totalH=PAD_TOP+Math.max(800,imgDrawH)+PAD_BOTTOM;
  canvasBaseW=totalW;canvasBaseH=totalH;

  // CRITICAL: Read DPR at RUNTIME, not at script parse time.
  // On some iOS Safari versions, devicePixelRatio may not be ready at parse time.
  // Force minimum 2 for Retina displays.
  canvasDpr=Math.max(window.devicePixelRatio||2, 2);
  console.log('[DRAW] DPR='+window.devicePixelRatio+' canvasDpr='+canvasDpr+' totalW='+totalW+' totalH='+totalH);

  // 3 canvases: bgCanvas (background) + drawCanvas (strokes) + tempCanvas (in-progress)
  [bgCanvas,canvas,tempCanvas].forEach(c=>{
    c.width=totalW*canvasDpr;
    c.height=totalH*canvasDpr;
    c.style.width=totalW+'px';
    c.style.height=totalH+'px';
  });
  const inner=document.getElementById('canvasInner');
  inner.style.width=totalW+'px';inner.style.height=totalH+'px';

  // Scale contexts by render scale so we draw in CSS-pixel coordinates
  [bgCtx,ctx,tempCtx].forEach(c=>{
    c.setTransform(canvasDpr,0,0,canvasDpr,0,0);
    c.imageSmoothingEnabled=true;
    c.imageSmoothingQuality='high';
  });

  // Draw background on bgCanvas (never erased!)
  bgCtx.fillStyle='#ffffff';
  bgCtx.fillRect(0,0,totalW,totalH);

  if(bgImg&&bgImg.naturalWidth){
    const imgX=PAD_LEFT,imgY=PAD_TOP;
    bgCtx.drawImage(bgImg,imgX,imgY,imgDrawW,imgDrawH);
    bgCtx.strokeStyle='#ddd';bgCtx.lineWidth=0.5;bgCtx.setLineDash([]);
    bgCtx.strokeRect(imgX,imgY,imgDrawW,imgDrawH);
    const lineY=imgY+imgDrawH+30;
    bgCtx.strokeStyle='#ccc';bgCtx.lineWidth=1;
    bgCtx.setLineDash([6,4]);
    bgCtx.beginPath();bgCtx.moveTo(PAD_LEFT,lineY);bgCtx.lineTo(PAD_LEFT+contentW,lineY);bgCtx.stroke();
    bgCtx.setLineDash([]);
    bgCtx.fillStyle='#aaa';bgCtx.font='13px -apple-system,BlinkMacSystemFont,Pretendard,sans-serif';
    bgCtx.textAlign='center';
    bgCtx.fillText('\\u2193 \\ud480\\uc774 \\uc791\\uc131 \\uc601\\uc5ed',PAD_LEFT+contentW/2,lineY+20);
    bgCtx.textAlign='start';
  }

  redrawStrokes();
  setZoom(1);
  setTimeout(()=>{wrap.scrollLeft=Math.max(0,PAD_LEFT-80);wrap.scrollTop=0},50);

  // === VERIFICATION: Check DPR is actually applied ===
  const actualRatio=canvas.width/parseFloat(canvas.style.width);
  if(actualRatio<1.5){
    console.error('[DRAW] WARNING: DPR not applied! canvas.width='+canvas.width+' css='+canvas.style.width+' ratio='+actualRatio);
  }

  // Debug info in console only (no on-screen overlay)
  const memMB=(canvas.width*canvas.height*4*2/1024/1024).toFixed(0);
  console.log('[DRAW] DPR:'+canvasDpr+' canvas:'+canvas.width+'x'+canvas.height+' ratio:'+actualRatio.toFixed(2)+' mem:~'+memMB+'MB');
}

function updateStrokeDot(){
  const dot=document.getElementById('strokeDot');
  if(!dot)return;
  const sz=Math.max(3,Math.min(curWidth*1.5,24));
  dot.style.width=sz+'px';dot.style.height=sz+'px';
  dot.style.background=curTool==='eraser'?'#ff6b6b':curColor;
}

// --- RENDER A FULL STROKE as one continuous Bezier path ---
// This is THE key to ClassIn-quality: one path = one anti-aliased render
function renderFullStroke(c,stroke){
  const pts=stroke.points;
  if(!pts||pts.length<1)return;
  c.save();
  c.strokeStyle=stroke.color;
  c.globalAlpha=stroke.alpha||1;
  c.globalCompositeOperation=stroke.composite||'source-over';
  c.lineCap='round';
  c.lineJoin='round';
  c.lineWidth=stroke.width;
  
  if(pts.length===1){
    c.fillStyle=stroke.color;
    c.beginPath();
    c.arc(pts[0].x,pts[0].y,stroke.width/2,0,Math.PI*2);
    c.fill();
  }else if(pts.length===2){
    c.beginPath();
    c.moveTo(pts[0].x,pts[0].y);
    c.lineTo(pts[1].x,pts[1].y);
    c.stroke();
  }else{
    // Smooth Bezier through midpoints â€” SINGLE continuous path
    c.beginPath();
    c.moveTo(pts[0].x,pts[0].y);
    c.lineTo((pts[0].x+pts[1].x)/2,(pts[0].y+pts[1].y)/2);
    for(let i=1;i<pts.length-1;i++){
      const mx=(pts[i].x+pts[i+1].x)/2;
      const my=(pts[i].y+pts[i+1].y)/2;
      c.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);
    }
    c.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);
    c.stroke();
  }
  c.restore();
}

// --- RENDER A SHAPE ---
function renderShape(c,s){
  c.save();
  c.strokeStyle=s.color;
  c.lineWidth=s.width;
  c.lineCap='round';
  c.lineJoin='round';
  c.globalAlpha=1;
  c.globalCompositeOperation='source-over';
  c.beginPath();
  if(s.tool==='line'){
    c.moveTo(s.start.x,s.start.y);c.lineTo(s.end.x,s.end.y);
  }else if(s.tool==='rect'){
    c.rect(Math.min(s.start.x,s.end.x),Math.min(s.start.y,s.end.y),Math.abs(s.end.x-s.start.x),Math.abs(s.end.y-s.start.y));
  }else if(s.tool==='circle'){
    const cx=(s.start.x+s.end.x)/2,cy=(s.start.y+s.end.y)/2;
    const rx=Math.abs(s.end.x-s.start.x)/2,ry=Math.abs(s.end.y-s.start.y)/2;
    c.ellipse(cx,cy,Math.max(rx,1),Math.max(ry,1),0,0,Math.PI*2);
  }
  c.stroke();
  c.restore();
}

function renderText(c,s){
  if(!s.text)return;
  c.save();
  c.font=(s.bold?'bold ':'')+s.fontSize+'px Pretendard,-apple-system,sans-serif';
  c.fillStyle=s.color||'#111';
  c.globalAlpha=1;
  c.globalCompositeOperation='source-over';
  c.textBaseline='top';
  const lines=s.text.split('\\n');
  const lh=s.fontSize*1.4;
  for(let i=0;i<lines.length;i++){
    c.fillText(lines[i],s.x,s.y+i*lh);
  }
  c.restore();
}

function wireToolbar(){
  const overlay=drawOverlay;if(!overlay)return;
  let redoStack=[];

  // Stroke slider
  overlay.querySelector('#strokeSlider').addEventListener('input',e=>{curWidth=+e.target.value;updateStrokeDot()});

  // Tool buttons
  overlay.querySelectorAll('.dt-btn[data-tool]').forEach(b=>b.addEventListener('click',()=>{
    overlay.querySelectorAll('.dt-btn[data-tool]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const prevTool=curTool;
    curTool=b.dataset.tool;
    updateStrokeDot();
    // When switching tools, ALWAYS reset drawing state to prevent ghost strokes
    drawing=false;curStroke=null;shapeStart=null;drawPointerId=-1;
    scissorsStart=null;floatDragMode=null;floatDragStart=null;
    // Clear select tool state
    if(prevTool==='select'&&curTool!=='select'){clearSelection();}
    // Clear text input
    if(prevTool==='text'&&curTool!=='text'){commitTextInput();}
    // When switching away from scissors, auto-commit floating objects to drawCanvas
    // This permanently bakes them into the main canvas so they never disappear
    if(prevTool==='scissors'&&curTool!=='scissors'){
      commitAllFloats();
      selectedFloat=null;
      removeFloatContextMenu();
    }
    clearTemp();
  }));

  // Color buttons
  overlay.querySelectorAll('.dt-color').forEach(d=>d.addEventListener('click',()=>{
    overlay.querySelectorAll('.dt-color').forEach(x=>x.classList.remove('active'));
    d.classList.add('active');curColor=d.dataset.color;
    if(curTool==='eraser'){curTool='pen';overlay.querySelectorAll('.dt-btn[data-tool]').forEach(x=>x.classList.remove('active'));overlay.querySelector('[data-tool=pen]').classList.add('active')}
    updateStrokeDot();
  }));

  // History
  overlay.querySelector('#clearBtn').addEventListener('click',()=>{
    if(!drawHistory.length)return;
    if(confirm('ì „ì²´ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')){drawHistory=[];redoStack=[];redrawStrokes()}
  });
  overlay.querySelector('#undoBtn').addEventListener('click',()=>{if(drawHistory.length){redoStack.push(drawHistory.pop());redrawStrokes()}});
  overlay.querySelector('#redoBtn').addEventListener('click',()=>{if(redoStack.length){drawHistory.push(redoStack.pop());redrawStrokes()}});

  // Zoom
  overlay.querySelector('#zoomInBtn').addEventListener('click',()=>setZoom(Math.min(zoomLevel+0.25,4)));
  overlay.querySelector('#zoomOutBtn').addEventListener('click',()=>setZoom(Math.max(zoomLevel-0.25,0.5)));
  overlay.querySelector('#zoomFitBtn').addEventListener('click',()=>{
    const wrap=document.getElementById('canvasWrap');
    if(!wrap||!canvasBaseW)return;
    const fitZoom=Math.min(wrap.clientWidth/canvasBaseW,wrap.clientHeight/canvasBaseH,1);
    setZoom(Math.max(0.5,fitZoom));
  });

  // Done / Cancel
  overlay.querySelector('#drawDoneBtn').addEventListener('click',()=>closeDrawingMode(true));
  overlay.querySelector('#drawCancelBtn').addEventListener('click',()=>{
    if(drawHistory.length>0&&!confirm('í•„ê¸°ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
    closeDrawingMode(false);
  });

  // ====== INCREMENTAL DRAWING ENGINE ======
  // Key insight: NEVER clear+redraw entire stroke on each frame.
  // Instead, draw only the NEW segment on tempCanvas each pointermove.
  // This eliminates frame drops and ensures zero visual gaps.
  let hasPenInput=false;
  pinching=false; // reset (global var)
  let pinchStartDist=0,pinchStartZoom=1;
  let panStartX=0,panStartY=0,panScrollX=0,panScrollY=0;
  let touchCount=0;
  let drawPointerId=-1;
  const SHAPE_TOOLS=['line','rect','circle'];
  function isShapeTool(){return SHAPE_TOOLS.includes(curTool)}
  function isSelect(){return curTool==='select'}

  // ===== SELECT TOOL: hit-test, move, delete =====
  let selectedIdx=-1; // index in drawHistory
  let selectDragStart=null; // {x,y,origStroke}
  let selectDeleteBtn=null;

  function getBounds(s){
    if(s.type==='shape'){
      if(s.tool==='line') return{x:Math.min(s.start.x,s.end.x)-s.width,y:Math.min(s.start.y,s.end.y)-s.width,w:Math.abs(s.end.x-s.start.x)+s.width*2,h:Math.abs(s.end.y-s.start.y)+s.width*2};
      if(s.tool==='rect'||s.tool==='circle') return{x:Math.min(s.start.x,s.end.x)-s.width,y:Math.min(s.start.y,s.end.y)-s.width,w:Math.abs(s.end.x-s.start.x)+s.width*2,h:Math.abs(s.end.y-s.start.y)+s.width*2};
    }else if(s.type==='text'){
      const lines=(s.text||'').split('\\n');
      const lh=s.fontSize*1.4;
      const maxW=Math.max(...lines.map(l=>l.length*s.fontSize*0.6),60);
      return{x:s.x-4,y:s.y-4,w:maxW+8,h:lines.length*lh+8};
    }else if(s.type==='float'){
      return{x:s.x,y:s.y,w:s.w,h:s.h};
    }else if(s.points&&s.points.length){
      let mx=Infinity,my=Infinity,Mx=-Infinity,My=-Infinity;
      for(const p of s.points){if(p.x<mx)mx=p.x;if(p.y<my)my=p.y;if(p.x>Mx)Mx=p.x;if(p.y>My)My=p.y;}
      const pad=s.width||6;
      return{x:mx-pad,y:my-pad,w:Mx-mx+pad*2,h:My-my+pad*2};
    }
    return null;
  }

  function hitTest(px,py){
    // Test from top (most recent) to bottom
    for(let i=drawHistory.length-1;i>=0;i--){
      const s=drawHistory[i];
      if(s.tool==='eraser'||s.composite==='destination-out')continue;
      const b=getBounds(s);
      if(b&&px>=b.x&&px<=b.x+b.w&&py>=b.y&&py<=b.y+b.h) return i;
    }
    return -1;
  }

  function drawSelectionBox(){
    if(selectedIdx<0||selectedIdx>=drawHistory.length)return;
    const s=drawHistory[selectedIdx];
    const b=getBounds(s);
    if(!b)return;
    tempCtx.save();
    tempCtx.strokeStyle='#2563eb';
    tempCtx.lineWidth=2/zoomLevel;
    tempCtx.setLineDash([6/zoomLevel,4/zoomLevel]);
    tempCtx.globalAlpha=1;
    tempCtx.globalCompositeOperation='source-over';
    tempCtx.strokeRect(b.x,b.y,b.w,b.h);
    tempCtx.setLineDash([]);
    tempCtx.restore();
  }

  function showDeleteBtn(){
    removeDeleteBtn();
    if(selectedIdx<0||selectedIdx>=drawHistory.length)return;
    const s=drawHistory[selectedIdx];
    const b=getBounds(s);
    if(!b)return;
    const btn=document.createElement('button');
    btn.className='select-delete-btn';
    btn.innerHTML='<i class="fas fa-trash"></i>';
    // Position: top-center of bounding box in screen coords
    const canvasArea=drawOverlay.querySelector('.draw-canvas-area');
    const rect=canvas.getBoundingClientRect();
    const sx=(b.x+b.w/2)*zoomLevel*(rect.width/(canvas.width/canvasDpr));
    const sy=b.y*zoomLevel*(rect.height/(canvas.height/canvasDpr));
    btn.style.left=(sx+rect.left-canvasArea.getBoundingClientRect().left+canvasArea.scrollLeft)+'px';
    btn.style.top=(sy+rect.top-canvasArea.getBoundingClientRect().top+canvasArea.scrollTop-10)+'px';
    btn.addEventListener('click',e=>{
      e.stopPropagation();
      drawHistory.splice(selectedIdx,1);
      selectedIdx=-1;
      removeDeleteBtn();
      redrawStrokes();clearTemp();
    });
    selectDeleteBtn=btn;
    canvasArea.appendChild(btn);
  }

  function removeDeleteBtn(){
    if(selectDeleteBtn&&selectDeleteBtn.parentElement)selectDeleteBtn.remove();
    selectDeleteBtn=null;
  }

  function clearSelection(){selectedIdx=-1;removeDeleteBtn();clearTemp();}

  // ===== TEXT INPUT (ClassIn-style) =====
  let activeTextInput=null;
  let textFontSize=18;
  let textBold=false;
  function removeTextInput(){
    if(activeTextInput){
      if(activeTextInput.wrap&&activeTextInput.wrap.parentElement)activeTextInput.wrap.remove();
      if(activeTextInput.toolbar&&activeTextInput.toolbar.parentElement)activeTextInput.toolbar.remove();
      activeTextInput=null;
    }
  }
  function commitTextInput(){
    if(!activeTextInput)return;
    const text=activeTextInput.ta.value.trim();
    if(text){
      const s={type:'text',text,x:activeTextInput.cx,y:activeTextInput.cy,fontSize:textFontSize,color:curColor,bold:textBold};
      drawHistory.push(s);
      redrawStrokes();
    }
    removeTextInput();
  }
  function showTextInput(cx,cy){
    // If there's already an active text input, commit it first
    if(activeTextInput) commitTextInput();

    const canvasArea=drawOverlay.querySelector('.draw-canvas-area');
    const cRect=canvas.getBoundingClientRect();
    const aRect=canvasArea.getBoundingClientRect();
    const scaleX=cRect.width/(canvas.width/canvasDpr);
    const scaleY=cRect.height/(canvas.height/canvasDpr);
    const screenX=cx*zoomLevel*scaleX+cRect.left-aRect.left+canvasArea.scrollLeft;
    const screenY=cy*zoomLevel*scaleY+cRect.top-aRect.top+canvasArea.scrollTop;

    // Text input wrapper
    const wrap=document.createElement('div');
    wrap.style.cssText='position:absolute;left:'+screenX+'px;top:'+screenY+'px;z-index:10002';

    const ta=document.createElement('textarea');
    ta.className='text-input-box';
    ta.placeholder='ì…ë ¥...';
    ta.style.fontSize=textFontSize+'px';
    ta.style.fontWeight=textBold?'bold':'normal';
    ta.style.color=curColor;
    ta.rows=1;
    ta.addEventListener('input',()=>{ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';});

    wrap.appendChild(ta);
    canvasArea.appendChild(wrap);

    // Floating toolbar (ClassIn style) - positioned below text input
    const toolbar=document.createElement('div');
    toolbar.className='text-toolbar';
    toolbar.innerHTML=
      '<button class="tt-close" title="ë‹«ê¸°"><i class="fas fa-times"></i></button>'+
      '<select class="tt-size-select" title="ê¸€ì í¬ê¸°">'+
        [12,14,16,18,20,24,28,32,40,48,60].map(s=>'<option value="'+s+'"'+(s===textFontSize?' selected':'')+'>'+s+'</option>').join('')+
      '</select>'+
      '<button title="ê¸€ì ìƒ‰ìƒ"><i class="fas fa-font" style="text-decoration:underline;text-decoration-color:'+curColor+'"></i></button>'+
      '<span class="tt-divider"></span>'+
      '<button class="tt-bold'+(textBold?' active':'')+'" title="êµµê²Œ"><b>B</b></button>'+
      '<span class="tt-divider"></span>'+
      '<button class="tt-delete" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>';
    wrap.appendChild(toolbar);

    // Wire toolbar events
    toolbar.querySelector('.tt-close').addEventListener('click',e=>{e.stopPropagation();commitTextInput();});
    toolbar.querySelector('.tt-size-select').addEventListener('change',e=>{
      e.stopPropagation();
      textFontSize=parseInt(e.target.value);
      ta.style.fontSize=textFontSize+'px';
      ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';
      ta.focus();
    });
    toolbar.querySelector('.tt-bold').addEventListener('click',e=>{
      e.stopPropagation();
      textBold=!textBold;
      e.currentTarget.classList.toggle('active',textBold);
      ta.style.fontWeight=textBold?'bold':'normal';
      ta.focus();
    });
    toolbar.querySelector('.tt-delete').addEventListener('click',e=>{e.stopPropagation();removeTextInput();});
    // Color button: use current drawing color
    toolbar.querySelectorAll('button')[2].addEventListener('click',e=>{
      e.stopPropagation();
      // Cycle through a few colors
      const colors=['#111','#e50914','#2563eb','#16a34a','#f59e0b','#8b5cf6','#fff'];
      const idx=colors.indexOf(curColor);
      const next=colors[(idx+1)%colors.length];
      curColor=next;
      ta.style.color=curColor;
      e.currentTarget.querySelector('i').style.textDecorationColor=curColor;
      ta.focus();
    });

    ta.focus();

    ta.addEventListener('keydown',e=>{
      if(e.key==='Escape'){e.preventDefault();removeTextInput();}
      e.stopPropagation();
    });

    activeTextInput={wrap,toolbar,ta,cx,cy};
  }

  function moveStroke(s,dx,dy){
    if(s.type==='shape'){
      s.start.x+=dx;s.start.y+=dy;s.end.x+=dx;s.end.y+=dy;
    }else if(s.type==='text'){
      s.x+=dx;s.y+=dy;
    }else if(s.type==='float'){
      s.x+=dx;s.y+=dy;
    }else if(s.points){
      for(const p of s.points){p.x+=dx;p.y+=dy;}
    }
  }
  function isScissors(){return curTool==='scissors'}

  // ===== FLOATING OBJECT RENDERING =====
  const HANDLE_SIZE=10;
  const HANDLE_POSITIONS=['tl','tr','bl','br','t','b','l','r'];

  function getHandleRects(fo){
    const hs=HANDLE_SIZE/zoomLevel;
    return{
      tl:{x:fo.x-hs/2,y:fo.y-hs/2,w:hs,h:hs},
      tr:{x:fo.x+fo.w-hs/2,y:fo.y-hs/2,w:hs,h:hs},
      bl:{x:fo.x-hs/2,y:fo.y+fo.h-hs/2,w:hs,h:hs},
      br:{x:fo.x+fo.w-hs/2,y:fo.y+fo.h-hs/2,w:hs,h:hs},
      t:{x:fo.x+fo.w/2-hs/2,y:fo.y-hs/2,w:hs,h:hs},
      b:{x:fo.x+fo.w/2-hs/2,y:fo.y+fo.h-hs/2,w:hs,h:hs},
      l:{x:fo.x-hs/2,y:fo.y+fo.h/2-hs/2,w:hs,h:hs},
      r:{x:fo.x+fo.w-hs/2,y:fo.y+fo.h/2-hs/2,w:hs,h:hs},
    };
  }

  function drawFloatingObjects(){
    // Draw all floating objects on tempCanvas
    // Use raw clear (not clearTemp which re-draws floats) to avoid recursion
    tempCtx.setTransform(1,0,0,1,0,0);
    tempCtx.clearRect(0,0,tempCanvas.width,tempCanvas.height);
    tempCtx.setTransform(canvasDpr,0,0,canvasDpr,0,0);
    tempCtx.imageSmoothingEnabled=true;
    tempCtx.imageSmoothingQuality='high';
    // CRITICAL: Reset composite state â€” previous eraser may have left destination-out
    tempCtx.globalAlpha=1;
    tempCtx.globalCompositeOperation='source-over';
    for(const fo of floatingObjects){
      tempCtx.save();
      tempCtx.globalAlpha=1;
      tempCtx.globalCompositeOperation='source-over';
      tempCtx.drawImage(fo.img,fo.x,fo.y,fo.w,fo.h);
      tempCtx.restore();
      if(selectedFloat&&selectedFloat.id===fo.id){
        // Draw selection border
        tempCtx.save();
        tempCtx.strokeStyle='#16a34a';
        tempCtx.lineWidth=2/zoomLevel;
        tempCtx.setLineDash([6/zoomLevel,4/zoomLevel]);
        tempCtx.strokeRect(fo.x,fo.y,fo.w,fo.h);
        tempCtx.setLineDash([]);
        // Draw handles
        const handles=getHandleRects(fo);
        for(const key of HANDLE_POSITIONS){
          const h=handles[key];
          tempCtx.fillStyle='#fff';
          tempCtx.strokeStyle='#16a34a';
          tempCtx.lineWidth=1.5/zoomLevel;
          tempCtx.beginPath();
          tempCtx.arc(h.x+h.w/2,h.y+h.h/2,h.w/2,0,Math.PI*2);
          tempCtx.fill();
          tempCtx.stroke();
        }
        tempCtx.restore();
      }
    }
  }

  function hitTestHandle(p,fo){
    const handles=getHandleRects(fo);
    const hitPad=8/zoomLevel;
    for(const key of HANDLE_POSITIONS){
      const h=handles[key];
      if(p.x>=h.x-hitPad&&p.x<=h.x+h.w+hitPad&&p.y>=h.y-hitPad&&p.y<=h.y+h.h+hitPad){
        return'resize-'+key;
      }
    }
    return null;
  }

  function hitTestFloat(p){
    // Check in reverse order (top-most first)
    for(let i=floatingObjects.length-1;i>=0;i--){
      const fo=floatingObjects[i];
      if(p.x>=fo.x&&p.x<=fo.x+fo.w&&p.y>=fo.y&&p.y<=fo.y+fo.h){
        return fo;
      }
    }
    return null;
  }

  function showFloatContextMenu(fo){
    removeFloatContextMenu();
    const inner=document.getElementById('canvasInner');
    if(!inner)return;
    const menu=document.createElement('div');
    menu.className='float-ctx-menu';
    menu.id='floatCtxMenu';
    // Position above the object (in CSS pixels relative to canvasInner)
    // canvasInner CSS size = canvasBaseW * zoomLevel
    // fo.x/y are in logical canvas coords (canvasBase space)
    const menuX=fo.x*zoomLevel;
    const menuY=Math.max(0,fo.y*zoomLevel-44);
    menu.style.left=menuX+'px';
    menu.style.top=menuY+'px';
    menu.style.zIndex='100';
    menu.innerHTML=\`
      <button id="floatDuplicate" title="ë³µì œ"><i class="fas fa-copy"></i></button>
      <button id="floatCommit" title="í™•ì • (ìº”ë²„ìŠ¤ì— ë¶™ì´ê¸°)"><i class="fas fa-check"></i></button>
      <button id="floatDelete" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
    \`;
    inner.appendChild(menu);
    floatCtxMenu=menu;

    menu.querySelector('#floatDuplicate').addEventListener('click',()=>{
      const newFo={img:fo.img,x:fo.x+20/zoomLevel,y:fo.y+20/zoomLevel,w:fo.w,h:fo.h,id:Date.now()};
      floatingObjects.push(newFo);
      selectedFloat=newFo;
      drawFloatingObjects();
      showFloatContextMenu(newFo);
    });
    menu.querySelector('#floatCommit').addEventListener('click',()=>{
      // Draw floating object onto main canvas permanently
      ctx.save();
      ctx.globalAlpha=1;
      ctx.globalCompositeOperation='source-over';
      ctx.drawImage(fo.img,fo.x,fo.y,fo.w,fo.h);
      ctx.restore();
      drawHistory.push({type:'float',img:fo.img,x:fo.x,y:fo.y,w:fo.w,h:fo.h});
      floatingObjects=floatingObjects.filter(f=>f.id!==fo.id);
      selectedFloat=null;
      removeFloatContextMenu();
      drawFloatingObjects();
    });
    menu.querySelector('#floatDelete').addEventListener('click',()=>{
      floatingObjects=floatingObjects.filter(f=>f.id!==fo.id);
      selectedFloat=null;
      removeFloatContextMenu();
      drawFloatingObjects();
    });
  }

  function removeFloatContextMenu(){
    if(floatCtxMenu){floatCtxMenu.remove();floatCtxMenu=null}
    const existing=document.getElementById('floatCtxMenu');
    if(existing)existing.remove();
  }

  // "Unstick" a committed float from drawHistory back to a floating object
  function unstickFloat(histIdx){
    const entry=drawHistory[histIdx];
    if(!entry||entry.type!=='float')return;
    // Remove from history
    drawHistory.splice(histIdx,1);
    // Re-render canvas without this float
    redrawStrokes();
    // Create a new floating object from the saved image
    const fo={img:entry.img,x:entry.x,y:entry.y,w:entry.w,h:entry.h,id:Date.now()};
    floatingObjects.push(fo);
    selectedFloat=fo;
    drawFloatingObjects();
    showFloatContextMenu(fo);
  }

  // Hit-test committed floats in drawHistory (reverse order = topmost first)
  function hitTestCommittedFloat(p){
    for(let i=drawHistory.length-1;i>=0;i--){
      const s=drawHistory[i];
      if(s.type==='float'&&p.x>=s.x&&p.x<=s.x+s.w&&p.y>=s.y&&p.y<=s.y+s.h){
        return i;
      }
    }
    return -1;
  }

  // Auto-commit ALL floating objects to drawCanvas permanently
  function commitAllFloats(){
    if(floatingObjects.length===0)return;
    ctx.save();
    ctx.globalAlpha=1;
    ctx.globalCompositeOperation='source-over';
    for(const fo of floatingObjects){
      ctx.drawImage(fo.img,fo.x,fo.y,fo.w,fo.h);
      drawHistory.push({type:'float',img:fo.img,x:fo.x,y:fo.y,w:fo.w,h:fo.h});
    }
    ctx.restore();
    floatingObjects=[];
    selectedFloat=null;
  }

  function captureRegion(x,y,w,h){
    // Capture region from drawCanvas as image
    if(w<5||h<5)return; // Too small
    // Source coordinates in physical pixels
    const sx=Math.round(x*canvasDpr), sy=Math.round(y*canvasDpr);
    const sw=Math.round(w*canvasDpr), sh=Math.round(h*canvasDpr);
    // Clamp to canvas bounds
    const cw=canvas.width, ch=canvas.height;
    const clampSx=Math.max(0,Math.min(sx,cw));
    const clampSy=Math.max(0,Math.min(sy,ch));
    const clampSw=Math.min(sw,cw-clampSx);
    const clampSh=Math.min(sh,ch-clampSy);
    if(clampSw<2||clampSh<2)return;
    // Create capture canvas at high resolution
    const capCanvas=document.createElement('canvas');
    capCanvas.width=clampSw;
    capCanvas.height=clampSh;
    const capCtx=capCanvas.getContext('2d');
    capCtx.imageSmoothingEnabled=true;
    capCtx.imageSmoothingQuality='high';
    // Merge bgCanvas + drawCanvas for capture (bg is separate layer)
    capCtx.drawImage(bgCanvas, clampSx, clampSy, clampSw, clampSh, 0, 0, clampSw, clampSh);
    capCtx.drawImage(canvas, clampSx, clampSy, clampSw, clampSh, 0, 0, clampSw, clampSh);
    const dataURL=capCanvas.toDataURL('image/png');
    const img=new Image();
    img.onload=()=>{
      // Store the natural (physical) size of the captured image for quality rendering
      const fo={img,x:x+10/zoomLevel,y:y+10/zoomLevel,w,h,id:Date.now(),
                naturalW:clampSw,naturalH:clampSh};
      floatingObjects.push(fo);
      selectedFloat=fo;
      drawFloatingObjects();
      showFloatContextMenu(fo);
    };
    img.src=dataURL;
  }

  // Coordinate mapping: screen-pixel â†’ canvas logical-pixel
  function pos(e){
    const r=canvas.getBoundingClientRect();
    return{
      x:(e.clientX-r.left)/r.width*canvasBaseW,
      y:(e.clientY-r.top)/r.height*canvasBaseH
    };
  }

  // --- Draw a single smooth segment between 3 consecutive points ---
  // Uses quadratic Bezier through midpoints for smooth connection.
  // This is the KEY function for incremental rendering.
  function drawSegment(c, p0, p1, p2, stroke){
    c.save();
    c.strokeStyle=stroke.color;
    c.globalAlpha=stroke.alpha||1;
    c.globalCompositeOperation=stroke.composite||'source-over';
    c.lineCap='round';
    c.lineJoin='round';
    c.lineWidth=stroke.width;
    c.beginPath();
    if(!p2){
      // Only 2 points: straight line
      c.moveTo(p0.x,p0.y);
      c.lineTo(p1.x,p1.y);
    }else{
      // 3 points: smooth Bezier from midpoint(p0,p1) â†’ through p1 â†’ midpoint(p1,p2)
      const mx0=(p0.x+p1.x)/2, my0=(p0.y+p1.y)/2;
      const mx1=(p1.x+p2.x)/2, my1=(p1.y+p2.y)/2;
      c.moveTo(mx0,my0);
      c.quadraticCurveTo(p1.x,p1.y,mx1,my1);
    }
    c.stroke();
    c.restore();
  }

  // --- SHAPE PREVIEW on tempCanvas ---
  function drawShapePreview(start,end,tool,color,width){
    tempCtx.setTransform(1,0,0,1,0,0);
    tempCtx.clearRect(0,0,tempCanvas.width,tempCanvas.height);
    tempCtx.setTransform(canvasDpr,0,0,canvasDpr,0,0);
    tempCtx.imageSmoothingEnabled=true;
    tempCtx.imageSmoothingQuality='high';
    tempCtx.globalAlpha=1;
    tempCtx.globalCompositeOperation='source-over';
    // Re-draw floating objects if any exist (they live on tempCanvas)
    for(const fo of floatingObjects){
      tempCtx.save();
      tempCtx.globalAlpha=1;
      tempCtx.globalCompositeOperation='source-over';
      tempCtx.drawImage(fo.img,fo.x,fo.y,fo.w,fo.h);
      tempCtx.restore();
    }
    renderShape(tempCtx,{start,end,tool,color,width});
  }

  // --- COMMIT SHAPE to main canvas + history ---
  function commitShape(start,end,tool,color,width){
    const s={type:'shape',tool,start:{...start},end:{...end},color,width};
    renderShape(ctx,s);
    drawHistory.push(s);
  }

  function clearTemp(){
    // Simply delegate to drawFloatingObjects which handles all clearing and re-drawing.
    // If no floating objects, just clear the canvas raw.
    if(floatingObjects.length>0){
      drawFloatingObjects(); // This already clears tempCanvas + redraws all floats
    }else{
      tempCtx.setTransform(1,0,0,1,0,0);
      tempCtx.clearRect(0,0,tempCanvas.width,tempCanvas.height);
      tempCtx.setTransform(canvasDpr,0,0,canvasDpr,0,0);
      tempCtx.imageSmoothingEnabled=true;
      tempCtx.imageSmoothingQuality='high';
      tempCtx.globalAlpha=1;
      tempCtx.globalCompositeOperation='source-over';
    }
  }

  // ===== PINCH-ZOOM + PAN =====
  const wrap=document.getElementById('canvasWrap');
  function tDist(a,b){return Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY)}
  function tMid(a,b){return{x:(a.clientX+b.clientX)/2,y:(a.clientY+b.clientY)/2}}

  wrap.addEventListener('touchstart',e=>{
    touchCount=e.touches.length;
    if(touchCount>=2){
      e.preventDefault();e.stopPropagation();
      pinching=true;
      if(drawing){drawing=false;curStroke=null;shapeStart=null;drawPointerId=-1;clearTemp();redrawStrokes()}
      pinchStartDist=tDist(e.touches[0],e.touches[1]);
      pinchStartZoom=zoomLevel;
      const m=tMid(e.touches[0],e.touches[1]);
      panStartX=m.x;panStartY=m.y;
      panScrollX=wrap.scrollLeft;panScrollY=wrap.scrollTop;
    }
  },{passive:false,capture:true});

  wrap.addEventListener('touchmove',e=>{
    touchCount=e.touches.length;
    if(touchCount>=2&&pinching){
      e.preventDefault();e.stopPropagation();
      const d=tDist(e.touches[0],e.touches[1]);
      setZoom(Math.max(0.5,Math.min(4,pinchStartZoom*(d/pinchStartDist))));
      const m=tMid(e.touches[0],e.touches[1]);
      wrap.scrollLeft=panScrollX-(m.x-panStartX);
      wrap.scrollTop=panScrollY-(m.y-panStartY);
    }
  },{passive:false,capture:true});

  wrap.addEventListener('touchend',e=>{
    touchCount=e.touches.length;
    if(touchCount<2&&pinching){
      pinching=false;
      // Pinch ended: now re-rasterize at final zoom level for sharp strokes
      setZoom(zoomLevel);
    }
  },{passive:false});
  wrap.addEventListener('touchcancel',()=>{
    const wasPinching=pinching;
    touchCount=0;pinching=false;
    if(wasPinching)setZoom(zoomLevel);
  },{passive:false});

  // ===== POINTER EVENTS: INCREMENTAL DRAWING =====
  // Architecture:
  //   drawCanvas(z:1) = background + ALL committed strokes (final quality)
  //   tempCanvas(z:2) = in-progress stroke (incremental segments)
  //
  // INCREMENTAL strategy:
  //   pointermove â†’ draw ONLY the new segment on tempCanvas (no clear!)
  //   pointerup   â†’ render full Bezier path on drawCanvas, clear tempCanvas
  //
  // This gives: zero lag, zero gaps, zero frame drops.
  // The final stroke on drawCanvas uses full Bezier for perfect anti-aliasing.

  const drawTarget=canvas;

  drawTarget.addEventListener('pointerdown',e=>{
    if(e.pointerType==='pen')hasPenInput=true;
    if(e.pointerType==='touch'){if(hasPenInput||pinching||touchCount>=2){e.preventDefault();return}}
    if(drawing||pinching){e.preventDefault();return}
    e.preventDefault();e.stopPropagation();
    drawTarget.setPointerCapture(e.pointerId);
    drawPointerId=e.pointerId;
    const p=pos(e);

    // ===== SCISSORS TOOL =====
    if(isScissors()){
      // First check: are we clicking on a floating object handle?
      if(selectedFloat){
        const handleHit=hitTestHandle(p,selectedFloat);
        if(handleHit){
          drawing=true;
          floatDragMode=handleHit;
          floatDragStart={x:p.x,y:p.y,origX:selectedFloat.x,origY:selectedFloat.y,origW:selectedFloat.w,origH:selectedFloat.h};
          removeFloatContextMenu();
          return;
        }
      }
      // Check: are we clicking on a floating object body?
      const hitFo=hitTestFloat(p);
      if(hitFo){
        selectedFloat=hitFo;
        drawing=true;
        floatDragMode='move';
        floatDragStart={x:p.x,y:p.y,origX:hitFo.x,origY:hitFo.y,origW:hitFo.w,origH:hitFo.h};
        removeFloatContextMenu();
        drawFloatingObjects();
        return;
      }
      // Check if clicking outside all floats â†’ deselect
      if(selectedFloat){
        selectedFloat=null;
        removeFloatContextMenu();
        drawFloatingObjects();
      }
      // Check if clicking on a COMMITTED float in drawHistory â†’ unstick it
      const committedIdx=hitTestCommittedFloat(p);
      if(committedIdx>=0){
        unstickFloat(committedIdx);
        drawing=false;drawPointerId=-1;
        return;
      }
      // Start new scissors selection
      drawing=true;
      scissorsStart=p;
      return;
    }

    // ===== TEXT TOOL =====
    if(curTool==='text'){
      showTextInput(p.x,p.y);
      return;
    }

    // ===== SELECT TOOL =====
    if(isSelect()){
      const hit=hitTest(p.x,p.y);
      if(hit>=0){
        selectedIdx=hit;
        selectDragStart={x:p.x,y:p.y,moved:false};
        drawing=true;
        // Show selection box + delete btn
        clearTemp();drawSelectionBox();showDeleteBtn();
      }else{
        clearSelection();
      }
      return;
    }

    // ===== NORMAL DRAWING =====
    drawing=true;redoStack=[];

    if(isShapeTool()){
      shapeStart=p;
    }else if(curTool==='eraser'){
      const ew=Math.max(curWidth*3,15);
      curStroke={points:[p],color:'#000',width:ew,alpha:1,composite:'destination-out',tool:'eraser'};
    }else if(curTool==='highlighter'){
      const hw=curWidth*3;
      curStroke={points:[p],color:curColor,width:hw,alpha:0.3,tool:'highlighter'};
    }else{
      curStroke={points:[p],color:curColor,width:curWidth,alpha:1,tool:'pen'};
    }

    // Immediate feedback: draw first dot
    if(curStroke){
      const isEraser=curStroke.tool==='eraser';
      const targetCtx=isEraser?ctx:tempCtx;
      if(!isEraser)clearTemp();
      targetCtx.save();
      targetCtx.fillStyle=curStroke.color;
      targetCtx.globalAlpha=curStroke.alpha||1;
      targetCtx.globalCompositeOperation=curStroke.composite||'source-over';
      targetCtx.beginPath();
      targetCtx.arc(p.x,p.y,curStroke.width/2,0,Math.PI*2);
      targetCtx.fill();
      targetCtx.restore();
    }
  },{passive:false});

  drawTarget.addEventListener('pointermove',e=>{
    if(!drawing||e.pointerId!==drawPointerId)return;
    if(e.pointerType==='touch'&&(hasPenInput||pinching||touchCount>=2))return;
    e.preventDefault();

    const p=pos(e);

    // ===== SELECT: drag to move =====
    if(isSelect()&&selectedIdx>=0&&selectDragStart){
      const dx=p.x-selectDragStart.x;
      const dy=p.y-selectDragStart.y;
      if(Math.abs(dx)>2||Math.abs(dy)>2) selectDragStart.moved=true;
      if(selectDragStart.moved){
        moveStroke(drawHistory[selectedIdx],dx,dy);
        selectDragStart.x=p.x;selectDragStart.y=p.y;
        redrawStrokes();clearTemp();drawSelectionBox();
        removeDeleteBtn(); // Hide while dragging
      }
      return;
    }

    // ===== SCISSORS: float drag/resize =====
    if(isScissors()&&floatDragMode&&selectedFloat&&floatDragStart){
      const dx=p.x-floatDragStart.x;
      const dy=p.y-floatDragStart.y;
      if(floatDragMode==='move'){
        selectedFloat.x=floatDragStart.origX+dx;
        selectedFloat.y=floatDragStart.origY+dy;
      }else{
        // Resize based on handle
        const mode=floatDragMode.replace('resize-','');
        let nx=floatDragStart.origX,ny=floatDragStart.origY,nw=floatDragStart.origW,nh=floatDragStart.origH;
        const aspect=floatDragStart.origW/floatDragStart.origH;
        const isCorner=['tl','tr','bl','br'].includes(mode);
        if(isCorner){
          // Corner handles: maintain aspect ratio
          // Use the larger delta to determine scale
          const absDx=Math.abs(dx),absDy=Math.abs(dy);
          let delta=absDx>absDy?dx:dy*aspect;
          if(mode==='br'){nw=floatDragStart.origW+delta;nh=nw/aspect}
          else if(mode==='bl'){nw=floatDragStart.origW-delta;nh=nw/aspect;nx=floatDragStart.origX+(floatDragStart.origW-nw)}
          else if(mode==='tr'){nw=floatDragStart.origW+delta;nh=nw/aspect;ny=floatDragStart.origY+(floatDragStart.origH-nh)}
          else if(mode==='tl'){nw=floatDragStart.origW-delta;nh=nw/aspect;nx=floatDragStart.origX+(floatDragStart.origW-nw);ny=floatDragStart.origY+(floatDragStart.origH-nh)}
        }else{
          // Edge handles: free resize
          if(mode==='r'){nw+=dx}
          else if(mode==='l'){nx+=dx;nw-=dx}
          else if(mode==='b'){nh+=dy}
          else if(mode==='t'){ny+=dy;nh-=dy}
        }
        // Minimum size
        if(nw<20){nw=20;if(isCorner)nh=nw/aspect}
        if(nh<20){nh=20;if(isCorner)nw=nh*aspect}
        selectedFloat.x=nx;selectedFloat.y=ny;selectedFloat.w=nw;selectedFloat.h=nh;
      }
      drawFloatingObjects();
      return;
    }

    // ===== SCISSORS: selection rectangle =====
    if(isScissors()&&scissorsStart){
      drawFloatingObjects(); // Redraw existing floats first
      // Draw selection rectangle with green dashed line
      const sx=Math.min(scissorsStart.x,p.x),sy=Math.min(scissorsStart.y,p.y);
      const sw=Math.abs(p.x-scissorsStart.x),sh=Math.abs(p.y-scissorsStart.y);
      tempCtx.strokeStyle='#16a34a';
      tempCtx.lineWidth=2/zoomLevel;
      tempCtx.setLineDash([6/zoomLevel,4/zoomLevel]);
      tempCtx.strokeRect(sx,sy,sw,sh);
      tempCtx.setLineDash([]);
      // Dim the outside area slightly
      tempCtx.fillStyle='rgba(0,0,0,0.1)';
      tempCtx.fillRect(0,0,canvasBaseW,sy); // top
      tempCtx.fillRect(0,sy,sx,sh); // left
      tempCtx.fillRect(sx+sw,sy,canvasBaseW-sx-sw,sh); // right
      tempCtx.fillRect(0,sy+sh,canvasBaseW,canvasBaseH-sy-sh); // bottom
      return;
    }

    if(isShapeTool()&&shapeStart){
      drawShapePreview(shapeStart,p,curTool,curColor,curWidth);
      return;
    }

    if(!curStroke)return;
    const isEraser=curStroke.tool==='eraser';
    const isHighlighter=curStroke.tool==='highlighter';
    // Eraser renders directly on drawCanvas; pen/highlighter on tempCanvas
    const targetCtx=isEraser?ctx:tempCtx;
    
    // Collect coalesced events for high-fidelity input
    let evts;
    try{evts=e.getCoalescedEvents();if(!evts||!evts.length)evts=[e]}catch(_){evts=[e]}

    for(const ev of evts){
      const pt=pos(ev);
      const pts=curStroke.points;
      const prev=pts[pts.length-1];
      const dist=Math.hypot(pt.x-prev.x,pt.y-prev.y);
      if(dist<0.5)continue; // Sub-pixel filter
      pts.push(pt);

      // PEN/ERASER: draw each segment immediately as points are added
      if(!isHighlighter){
        const n=pts.length;
        if(n===2){
          drawSegment(targetCtx, pts[0], pts[1], null, curStroke);
        }else if(n>=3){
          drawSegment(targetCtx, pts[n-3], pts[n-2], pts[n-1], curStroke);
        }
      }
    }

    // HIGHLIGHTER: redraw full stroke each frame to avoid alpha overlap.
    // Semi-transparent segments would accumulate and look opaque if incremental.
    if(isHighlighter){
      clearTemp();
      renderFullStroke(tempCtx, curStroke);
    }
  },{passive:false});

  function endDraw(e){
    if(e.pointerId!==drawPointerId)return;
    if(e.pointerType==='touch'&&hasPenInput)return;

    // ===== SCISSORS: end drag/resize or selection =====
    if(isScissors()){
      if(floatDragMode&&selectedFloat){
        floatDragMode=null;floatDragStart=null;
        drawFloatingObjects();
        showFloatContextMenu(selectedFloat);
        drawing=false;drawPointerId=-1;
        return;
      }
      if(scissorsStart){
        const p=pos(e);
        const sx=Math.min(scissorsStart.x,p.x),sy=Math.min(scissorsStart.y,p.y);
        const sw=Math.abs(p.x-scissorsStart.x),sh=Math.abs(p.y-scissorsStart.y);
        scissorsStart=null;
        drawing=false;drawPointerId=-1;
        if(sw>10&&sh>10){
          captureRegion(sx,sy,sw,sh);
        }else{
          drawFloatingObjects();
        }
        return;
      }
      drawing=false;drawPointerId=-1;
      return;
    }

    // ===== SELECT: end drag =====
    if(isSelect()){
      if(selectedIdx>=0&&selectDragStart&&selectDragStart.moved){
        showDeleteBtn(); // Re-show after drag
      }
      selectDragStart=null;
      drawing=false;drawPointerId=-1;
      return;
    }

    if(isShapeTool()&&shapeStart){
      const p=pos(e);
      const dx=Math.abs(p.x-shapeStart.x),dy=Math.abs(p.y-shapeStart.y);
      if(dx>3||dy>3){commitShape(shapeStart,p,curTool,curColor,curWidth)}
      clearTemp();
      shapeStart=null;
    }else if(curStroke&&curStroke.points.length>0){
      const isEraser=curStroke.tool==='eraser';
      drawHistory.push(curStroke);
      if(!isEraser){
        // COMMIT: render the full Bezier path on drawCanvas for perfect AA
        // This replaces the incremental segments with one smooth path
        renderFullStroke(ctx,curStroke);
      }
      // Eraser already drew directly on drawCanvas, no need to re-render
      clearTemp();
    }else{
      clearTemp();
    }
    drawing=false;curStroke=null;drawPointerId=-1;
  }
  drawTarget.addEventListener('pointerup',endDraw);
  drawTarget.addEventListener('pointercancel',endDraw);

  // Block ALL default touch behaviors
  drawTarget.addEventListener('touchstart',e=>{e.preventDefault()},{passive:false});
  drawTarget.addEventListener('touchmove',e=>{e.preventDefault()},{passive:false});
  drawTarget.addEventListener('touchend',e=>{e.preventDefault()},{passive:false});
  drawTarget.addEventListener('contextmenu',e=>e.preventDefault());
  drawTarget.addEventListener('selectstart',e=>e.preventDefault());
}

function closeDrawingMode(save){
  // Auto-commit any remaining floating objects
  if(save&&floatingObjects.length>0&&canvas&&ctx){
    ctx.save();
    ctx.globalAlpha=1;
    ctx.globalCompositeOperation='source-over';
    for(const fo of floatingObjects){
      ctx.drawImage(fo.img,fo.x,fo.y,fo.w,fo.h);
      drawHistory.push({type:'float',img:fo.img,x:fo.x,y:fo.y,w:fo.w,h:fo.h});
    }
    ctx.restore();
  }
  floatingObjects=[];selectedFloat=null;floatDragMode=null;scissorsStart=null;
  if(floatCtxMenu){floatCtxMenu.remove();floatCtxMenu=null}
  const existingCtxMenu=document.getElementById('floatCtxMenu');
  if(existingCtxMenu)existingCtxMenu.remove();

  if(!save){
    // Cancel: don't save, just close
  }else{
    // Show preview in the form
    if(drawHistory.length>0){
      const preview=document.getElementById('drawingPreview');
      const pc=document.getElementById('drawPreviewCanvas');
      if(preview&&pc){
        pc.width=canvas.width;pc.height=canvas.height;
        pc.style.maxWidth='100%';pc.style.maxHeight='200px';pc.style.borderRadius='6px';pc.style.background='#fff';
        const pctx=pc.getContext('2d');
        // Merge bgCanvas + drawCanvas for preview
        pctx.drawImage(bgCanvas,0,0);
        pctx.drawImage(canvas,0,0);
        preview.style.display='block';
      }
    }
  }
  // Remove overlay
  if(drawOverlay){drawOverlay.remove();drawOverlay=null}
  document.body.style.overflow='';
  bgCanvas=null;bgCtx=null;canvas=null;ctx=null;tempCanvas=null;tempCtx=null;
}

function setZoom(level){
  zoomLevel=level;
  const inner=document.getElementById('canvasInner');
  if(!inner||!canvasBaseW)return;

  // CSS display size = base * zoom
  const displayW=canvasBaseW*zoomLevel;
  const displayH=canvasBaseH*zoomLevel;
  inner.style.width=displayW+'px';
  inner.style.height=displayH+'px';
  inner.style.transform='none';

  // CRITICAL: Scale internal canvas resolution with zoom level.
  // This prevents pixelation when zoomed in â€” strokes are re-rasterized.
  // effectiveDpr = baseDpr * zoom, capped at maxDpr for memory safety.
  const baseDpr=Math.max(window.devicePixelRatio||2,2);
  const maxDpr=4;
  const effectiveDpr=Math.min(baseDpr*zoomLevel, maxDpr);

  // Only resize if DPR changed >10% AND not currently pinching.
  // During pinch, we only change CSS size (fast). On pinch-end, we re-rasterize.
  const dprChanged=Math.abs(effectiveDpr-canvasDpr)/canvasDpr>0.1;
  
  if(dprChanged && !pinching && canvas && tempCanvas){
    canvasDpr=effectiveDpr;
    
    // Resize pixel buffers
    const newW=Math.round(canvasBaseW*canvasDpr);
    const newH=Math.round(canvasBaseH*canvasDpr);
    
    // Check memory limit: 3 canvases * 4 bytes/pixel < 400MB
    const memMB=newW*newH*4*3/1024/1024;
    if(memMB>400){
      canvasDpr=baseDpr;
      const safeW=Math.round(canvasBaseW*canvasDpr);
      const safeH=Math.round(canvasBaseH*canvasDpr);
      [bgCanvas,canvas,tempCanvas].forEach(c=>{c.width=safeW;c.height=safeH});
    }else{
      [bgCanvas,canvas,tempCanvas].forEach(c=>{c.width=newW;c.height=newH});
    }

    // Re-apply transforms and smoothing
    [bgCtx,ctx,tempCtx].forEach(c=>{
      if(!c)return;
      c.setTransform(canvasDpr,0,0,canvasDpr,0,0);
      c.imageSmoothingEnabled=true;
      c.imageSmoothingQuality='high';
    });

    // Re-render everything at new resolution
    redrawStrokes();
  }

  // Update CSS sizes
  [bgCanvas,canvas,tempCanvas].forEach(c=>{
    if(c){c.style.width=displayW+'px';c.style.height=displayH+'px'}
  });
  const label=document.getElementById('zoomLabel');
  if(label)label.textContent=Math.round(zoomLevel*100)+'%';
}

function drawBackground(){
  // Re-draw background on bgCanvas (separate layer, never erased)
  if(!bgCtx||!canvasBaseW)return;
  bgCtx.fillStyle='#ffffff';
  bgCtx.fillRect(0,0,canvasBaseW,canvasBaseH);
  if(bgImg&&bgImg.naturalWidth){
    const wrapEl=document.getElementById('canvasWrap');
    const wrapW=wrapEl?wrapEl.getBoundingClientRect().width/zoomLevel:canvasBaseW;
    let imgDrawW=Math.min(wrapW*0.9,bgImg.naturalWidth);
    let imgDrawH=imgDrawW*(bgImg.naturalHeight/bgImg.naturalWidth);
    const PAD_LEFT=100,PAD_TOP=40;
    const contentW=Math.max(imgDrawW,wrapW*0.7);
    const imgX=PAD_LEFT,imgY=PAD_TOP;
    bgCtx.drawImage(bgImg,imgX,imgY,imgDrawW,imgDrawH);
    bgCtx.strokeStyle='#ddd';bgCtx.lineWidth=0.5;bgCtx.setLineDash([]);
    bgCtx.strokeRect(imgX,imgY,imgDrawW,imgDrawH);
    const lineY=imgY+imgDrawH+30;
    bgCtx.strokeStyle='#ccc';bgCtx.lineWidth=1;
    bgCtx.setLineDash([6,4]);
    bgCtx.beginPath();bgCtx.moveTo(PAD_LEFT,lineY);bgCtx.lineTo(PAD_LEFT+contentW,lineY);bgCtx.stroke();
    bgCtx.setLineDash([]);
    bgCtx.fillStyle='#aaa';bgCtx.font='13px -apple-system,BlinkMacSystemFont,Pretendard,sans-serif';
    bgCtx.textAlign='center';
    bgCtx.fillText('\\u2193 \\ud480\\uc774 \\uc791\\uc131 \\uc601\\uc5ed',PAD_LEFT+contentW/2,lineY+20);
    bgCtx.textAlign='start';
  }
}

function redrawStrokes(){
  if(!canvas||!ctx)return;
  // Clear stroke layer (transparent)
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.setTransform(canvasDpr,0,0,canvasDpr,0,0);
  ctx.imageSmoothingEnabled=true;
  ctx.imageSmoothingQuality='high';

  // Redraw background on bgCanvas
  drawBackground();

  // Replay all strokes on drawCanvas (transparent layer above bg)
  for(const s of drawHistory){
    if(s.type==='shape'){
      renderShape(ctx,s);
    }else if(s.type==='text'){
      renderText(ctx,s);
    }else if(s.type==='float'){
      ctx.save();ctx.globalAlpha=1;ctx.globalCompositeOperation='source-over';
      ctx.drawImage(s.img,s.x,s.y,s.w,s.h);
      ctx.restore();
    }else{
      renderFullStroke(ctx,s);
    }
  }
  // Re-render floating objects on tempCanvas if any exist
  if(floatingObjects.length>0){
    drawFloatingObjects();
  }
}

function renderQ(q){
  if(!q)return;
  questionImageData=null;
  const isDone=q.status==='ì±„íƒ ì™„ë£Œ';
  const statusCls=isDone?' done':' waiting';
  const statusText=isDone?'<i class="fas fa-check" style="margin-right:3px"></i>ì±„íƒ ì™„ë£Œ':'ëŒ€ê¸°ì¤‘';
  const killerBadge=q.difficulty==='ìµœìƒ'?'<span style="display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;color:#ff4500;background:rgba(255,69,0,.1);border:1px solid rgba(255,69,0,.25);padding:2px 8px;border-radius:3px"><i class="fas fa-fire"></i> ê³ ë‚œë„'+(q.reward_points?' <span style="color:#ffd700;font-weight:800">'+q.reward_points+'P</span>':'')+'</span>'
    :q.difficulty==='1:1ì‹¬í™”ì„¤ëª…'?'<span style="display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;color:#6c5ce7;background:rgba(108,92,231,.1);border:1px solid rgba(108,92,231,.25);padding:2px 8px;border-radius:3px"><i class="fas fa-chalkboard-teacher"></i> 1:1 íŠœí„°ë§'+(q.reward_points?' <span style="color:#ffd700;font-weight:800">'+q.reward_points+'P</span>':'')+'</span>':'';
  
  // Build AI meta section
  let aiMetaHTML='';
  if(q.ai_analyzed && q.ai_tags){
    const stars=q.ai_difficulty||'';
    const starCount=parseInt(stars.replace(/[^0-9]/g,''))||0;
    let starsHTML='';
    for(let i=1;i<=5;i++) starsHTML+='<span class="ai-meta__star'+(i<=starCount?'':' empty')+'">â˜…</span>';
    
    const tags=(q.ai_tags||'').split(/\\s+/).filter(t=>t.startsWith('#'));
    let tagsHTML='';
    for(const t of tags) tagsHTML+='<span class="ai-meta__tag">'+t+'</span>';
    
    // Question type info
    const qtLabels={'1-1':'ì§€ì‹í™•ì¸','1-2':'ì ˆì°¨í™•ì¸','2-1':'ê°œë…ì´í•´','2-2':'ì „ëµì„ íƒ','2-3':'ì˜¤ë¥˜ì§„ë‹¨','3-1':'ë¹„êµíŒë‹¨','3-2':'í™•ì¥ì°½ì¡°'};
    const qtColors={'1-1':'#9ca3af','1-2':'#60a5fa','2-1':'#34d399','2-2':'#a78bfa','2-3':'#f472b6','3-1':'#fbbf24','3-2':'#f87171'};
    const qtIcons={'1-1':'ğŸ“–','1-2':'ğŸ“','2-1':'ğŸ’¡','2-2':'ğŸ§­','2-3':'ğŸ”','3-1':'âš–ï¸','3-2':'ğŸš€'};
    let qtHTML='';
    if(q.question_type && qtLabels[q.question_type]){
      const c=qtColors[q.question_type]||'#666';
      qtHTML='<div class="ai-meta__row">'+
        '<span class="ai-meta__label">ì§ˆë¬¸ìœ í˜•</span>'+
        '<span class="ai-meta__badge" style="background:'+c+'15;color:'+c+';border:1px solid '+c+'33">'+qtIcons[q.question_type]+' '+qtLabels[q.question_type]+' ('+q.question_type+')</span>'+
      '</div>';
    }
    let sqHTML='';
    if(q.student_question_text && q.student_question_text.indexOf('(í•„ê¸° ì—†ìŒ')===-1){
      sqHTML='<div style="margin-top:10px;padding:14px 16px;background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:8px">'+
        '<div style="font-size:18px;font-weight:600;color:#fbbf24;margin-bottom:6px"><i class="fas fa-pencil-alt" style="margin-right:6px"></i>ì¸ì‹ëœ í•™ìƒ í•„ê¸°</div>'+
        '<div style="font-size:20px;color:var(--text);line-height:1.7">"'+q.student_question_text+'"</div>'+
      '</div>';
    }

    // === SECTION 1: ë¬¸ì œ ë¶„ì„ ===
    aiMetaHTML='<div class="ai-meta">'+
      '<div class="ai-meta__header"><i class="fas fa-microscope"></i> ë¬¸ì œ ë¶„ì„</div>'+
      '<div class="ai-meta__row">'+
        '<span class="ai-meta__label">ë‚œì´ë„</span>'+
        '<div class="ai-meta__stars">'+starsHTML+'</div>'+
        (q.ai_grade_level?'<span class="ai-meta__badge ai-meta__badge--level"><i class="fas fa-graduation-cap"></i> '+q.ai_grade_level+'</span>':'')+
        (q.ai_estimated_time?'<span class="ai-meta__badge ai-meta__badge--time"><i class="fas fa-clock"></i> '+q.ai_estimated_time+'ë¶„</span>':'')+
      '</div>'+
      (q.ai_topic_main?'<div class="ai-meta__row">'+
        '<span class="ai-meta__label">ë‹¨ì›</span>'+
        '<span class="ai-meta__badge ai-meta__badge--topic"><i class="fas fa-book"></i> '+q.ai_topic_main+'</span>'+
        (q.ai_topic_sub?'<span class="ai-meta__info"><i class="fas fa-chevron-right"></i> '+q.ai_topic_sub+'</span>':'')+
      '</div>':'')+
      '<div class="ai-meta__row">'+
        '<span class="ai-meta__label">íƒœê·¸</span>'+
        '<div class="ai-meta__tags">'+tagsHTML+'</div>'+
      '</div>'+
      (q.ai_description?'<div class="ai-meta__desc"><i class="fas fa-info-circle" style="margin-right:4px;color:var(--muted)"></i>'+q.ai_description+'</div>':'')+
    '</div>';

    // === SECTION 2: ì§ˆë¬¸ ë¶„ì„ ===
    aiMetaHTML+='<div class="ai-section ai-section--question">';
    aiMetaHTML+='<div class="ai-section__header"><i class="fas fa-search-plus"></i> ì§ˆë¬¸ ë¶„ì„</div>';
    aiMetaHTML+=qtHTML;
    aiMetaHTML+=sqHTML;
    if(q.ai_question_analysis){
      aiMetaHTML+='<div class="ai-section__body">'+q.ai_question_analysis+'</div>';
    } else {
      aiMetaHTML+='<div class="ai-section__body" style="color:var(--muted);font-style:italic">ì§ˆë¬¸ ë¶„ì„ ë°ì´í„°ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</div>';
    }
    aiMetaHTML+='</div>';

    // === SECTION 3: ì§ˆë¬¸ ì„±ì¥ ì½”ì¹­ (ìƒˆ ì¸í„°ë™í‹°ë¸Œ êµ¬ì¡°) ===
    aiMetaHTML+='<div class="ai-section ai-section--coaching">';
    var _modelBadge = q.ai_model === 'claude' 
      ? '<span style="display:inline-block;margin-left:8px;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;background:linear-gradient(135deg,#d97706,#f59e0b);color:#fff;vertical-align:middle">ğŸ¤– Claude</span>'
      : (q.ai_model === 'gemini' 
        ? '<span style="display:inline-block;margin-left:8px;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;background:linear-gradient(135deg,#4285f4,#34a853);color:#fff;vertical-align:middle">âœ¨ Gemini</span>'
        : '');
    aiMetaHTML+='<div class="ai-section__header"><i class="fas fa-graduation-cap"></i> ì§ˆë¬¸ ì„±ì¥ ì½”ì¹­' + _modelBadge + '</div>';

    var _typeEmoji = {'1-1':'ğŸ“–','1-2':'ğŸ“','2-1':'ğŸ’¡','2-2':'ğŸ§­','2-3':'ğŸ”','3-1':'âš–ï¸','3-2':'ğŸš€'};
    var _typeName = {'1-1':'ì§€ì‹í™•ì¸','1-2':'ì ˆì°¨í™•ì¸','2-1':'ê°œë…ì´í•´','2-2':'ì „ëµì„ íƒ','2-3':'ì˜¤ë¥˜ì§„ë‹¨','3-1':'ë¹„êµíŒë‹¨','3-2':'í™•ì¥ì°½ì¡°'};
    var _levelColors = {'1-1':'#94a3b8','1-2':'#94a3b8','2-1':'#60a5fa','2-2':'#60a5fa','2-3':'#60a5fa','3-1':'#a78bfa','3-2':'#f472b6'};
    var _allTypes = ['1-1','1-2','2-1','2-2','2-3','3-1','3-2'];
    var curType = q.question_type || '';
    var curIdx = _allTypes.indexOf(curType);

    // 7ë‹¨ê³„ ì§„í–‰ë°”
    if(curType && curIdx >= 0){
      aiMetaHTML+='<div class="q-level-bar">';
      aiMetaHTML+='<div class="q-level-label">í˜„ì¬ ì§ˆë¬¸ ë‹¨ê³„</div>';
      aiMetaHTML+='<div class="q-level-track">';
      for(var li=0; li<_allTypes.length; li++){
        var t = _allTypes[li];
        var isActive = (li === curIdx);
        var isPast = (li < curIdx);
        var stepColor = _levelColors[t] || '#666';
        var cls = isActive ? 'q-level-step--active' : isPast ? 'q-level-step--past' : 'q-level-step--future';
        aiMetaHTML+='<div class="q-level-step '+cls+'" style="'+(isActive?'border-color:'+stepColor+';background:'+stepColor+'18':'')+'">';
        aiMetaHTML+='<span class="q-level-emoji">'+(_typeEmoji[t]||'')+'</span>';
        aiMetaHTML+='<span class="q-level-code">'+t+'</span>';
        if(isActive) aiMetaHTML+='<span class="q-level-name">'+(_typeName[t]||'')+'</span>';
        aiMetaHTML+='</div>';
        if(li < _allTypes.length-1) aiMetaHTML+='<div class="q-level-arrow '+(isPast?'q-level-arrow--past':'')+'">â€º</div>';
      }
      aiMetaHTML+='</div>';
      aiMetaHTML+='</div>';
    }

    // coaching comment
    if(q.ai_coaching_comment){
      aiMetaHTML+='<div class="ai-section__body ai-section__coaching-text">'+q.ai_coaching_comment+'</div>';
    } else {
      aiMetaHTML+='<div class="ai-section__body" style="color:var(--muted);font-style:italic">ì½”ì¹­ ì½”ë©˜íŠ¸ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</div>';
    }

    // === New coaching data (coaching_questions + growth_interactions) ===
    var cd = null;
    try { if(q.ai_coaching_data) cd = JSON.parse(q.ai_coaching_data); } catch(e){}

    if(cd && cd.coaching_questions && cd.coaching_questions.length > 0){
      aiMetaHTML+='<div class="gc-wrap" id="gcWrap" data-qid="'+q.id+'">';

      // REVIEW PANEL (hidden by default, shown when coaching logs exist)
      aiMetaHTML+='<div class="gc-step" id="gcReviewPanel" style="display:none">';
      aiMetaHTML+='<div class="gc-card" style="border:1px solid rgba(251,191,36,.3);background:linear-gradient(135deg,rgba(251,191,36,.08),rgba(99,102,241,.08))">';
      aiMetaHTML+='<div class="gc-card__title" style="color:#fbbf24">ğŸ“‹ ì½”ì¹­ ì§„í–‰ ê¸°ë¡</div>';
      aiMetaHTML+='<div id="gcReviewTimeline" class="gc-review-timeline"></div>';
      aiMetaHTML+='</div>';
      aiMetaHTML+='<div class="gc-btns" style="flex-direction:column;gap:8px;margin-top:8px">';
      aiMetaHTML+='<button class="gc-btn gc-btn--yes" onclick="gcReplayCoaching()" style="flex:1"><i class="fas fa-play-circle" style="margin-right:6px"></i>ì²˜ìŒë¶€í„° ë‹¤ì‹œ ë³´ê¸°</button>';
      aiMetaHTML+='<button class="gc-btn gc-btn--choice" onclick="gcRestartCoaching()" style="flex:1;font-size:14px"><i class="fas fa-redo" style="margin-right:6px"></i>ë‹¤ì‹œ ì²˜ìŒë¶€í„° í•˜ê¸° (ê¸°ë¡ ì´ˆê¸°í™”)</button>';
      aiMetaHTML+='</div>';
      aiMetaHTML+='</div>';

      // SCREEN 1: ì½”ì¹­ì§ˆë¬¸ ì„ íƒ
      aiMetaHTML+='<div class="gc-step active" id="gcScreen1">';
      aiMetaHTML+='<div class="gc-card">';
      aiMetaHTML+='<div class="gc-card__title">ğŸ¯ '+(cd.selection_prompt || 'ì•„ë˜ ì¤‘ ë” ê¶ê¸ˆí•œ ê±¸ ê³¨ë¼ë³´ì„¸ìš”!')+'</div>';
      aiMetaHTML+='</div>';
      aiMetaHTML+='<div class="gc-btns" style="flex-direction:column;gap:8px">';
      cd.growth_interactions.forEach(function(gi, idx){
        aiMetaHTML+='<button class="gc-btn gc-btn--choice" style="text-align:left;padding:14px 18px;font-size:16px;border-radius:12px" onclick="gcSelectCoaching('+idx+')">';
        aiMetaHTML+=gi.selection_button;
        aiMetaHTML+='</button>';
      });
      aiMetaHTML+='</div>';
      aiMetaHTML+='</div>';

      // For each growth_interaction: generate screens 2~4
      cd.growth_interactions.forEach(function(gi, idx){
        var prefix = 'gc'+idx;
        var cq = cd.coaching_questions[gi.target_coaching_index] || cd.coaching_questions[idx] || {};
        var tColor = _levelColors[gi.target_type] || '#60a5fa';
        var tEmoji = _typeEmoji[gi.target_type] || 'ğŸ’¬';
        var tName = gi.target_label || _typeName[gi.target_type] || '';

        // SCREEN 2: Wrong attempt
        aiMetaHTML+='<div class="gc-step" id="'+prefix+'Step1">';
        aiMetaHTML+='<div class="gc-card">';
        aiMetaHTML+='<div class="gc-card__title">ğŸ¤” í•œë²ˆ í™•ì¸í•´ë³¼ê¹Œìš”?</div>';
        aiMetaHTML+='<div class="gc-card__body">'+gi.wrong_attempt.setup+'</div>';
        aiMetaHTML+='<div class="gc-card__q">'+gi.wrong_attempt.question+'</div>';
        aiMetaHTML+='</div>';
        aiMetaHTML+='<div class="gc-btns">';
        var waChoices = gi.wrong_attempt.choices || ['âœ… ê´œì°®ì€ ê²ƒ ê°™ì•„ìš”', 'âŒ ë­”ê°€ ì´ìƒí•´ìš”'];
        aiMetaHTML+='<button class="gc-btn gc-btn--yes" onclick="gcInteract('+idx+',&apos;wa&apos;,&apos;ok&apos;)">'+waChoices[0]+'</button>';
        aiMetaHTML+='<button class="gc-btn gc-btn--no" onclick="gcInteract('+idx+',&apos;wa&apos;,&apos;wrong&apos;)">'+waChoices[1]+'</button>';
        aiMetaHTML+='</div>';
        aiMetaHTML+='</div>';

        // SCREEN 2a: Student said OK (missed the error) â†’ hint
        aiMetaHTML+='<div class="gc-step" id="'+prefix+'Hint">';
        aiMetaHTML+='<div class="gc-card">';
        aiMetaHTML+='<div class="gc-card__title">ğŸ§ ì •ë§ìš”?</div>';
        aiMetaHTML+='<div class="gc-hint"><i class="fas fa-search" style="margin-right:6px"></i>'+gi.discovery_hint.on_wrong+'</div>';
        aiMetaHTML+='</div>';
        aiMetaHTML+='<div class="gc-btns">';
        aiMetaHTML+='<button class="gc-btn gc-btn--next" onclick="gcInteract('+idx+',&apos;hint&apos;,&apos;retry&apos;)" style="flex:1">'+gi.discovery_hint.on_wrong_retry+'</button>';
        aiMetaHTML+='</div>';
        aiMetaHTML+='</div>';

        // SCREEN 2b: Student found error â†’ choices
        aiMetaHTML+='<div class="gc-step" id="'+prefix+'Choices">';
        aiMetaHTML+='<div class="gc-card">';
        aiMetaHTML+='<div class="gc-card__title">ğŸ‘€ '+gi.discovery_hint.on_correct+'</div>';
        aiMetaHTML+='</div>';
        aiMetaHTML+='<div class="gc-btns" style="flex-direction:column">';
        var occ = gi.discovery_hint.on_correct_choices || [];
        for(var ci=0; ci<occ.length; ci++){
          var isLast = (ci === occ.length-1);
          aiMetaHTML+='<button class="gc-btn gc-btn--choice" style="'+(isLast?'opacity:.6':'')+'" onclick="gcInteract('+idx+',&apos;choice&apos;,&apos;c'+ci+'&apos;)">'+occ[ci]+'</button>';
        }
        aiMetaHTML+='</div>';
        aiMetaHTML+='</div>';

        // SCREEN 2c: Stuck hint
        aiMetaHTML+='<div class="gc-step" id="'+prefix+'Stuck">';
        aiMetaHTML+='<div class="gc-card">';
        aiMetaHTML+='<div class="gc-card__title">ğŸ’¡ íŒíŠ¸</div>';
        aiMetaHTML+='<div class="gc-hint"><i class="fas fa-lightbulb" style="margin-right:6px;color:#fbbf24"></i>'+gi.discovery_hint.on_stuck+'</div>';
        aiMetaHTML+='</div>';
        aiMetaHTML+='<div class="gc-btns">';
        aiMetaHTML+='<button class="gc-btn gc-btn--next" onclick="gcInteract('+idx+',&apos;stuck&apos;,&apos;next&apos;)" style="flex:1">ì´í•´í–ˆì–´ìš”, ë‹¤ìŒìœ¼ë¡œ!</button>';
        aiMetaHTML+='</div>';
        aiMetaHTML+='</div>';

        // SCREEN 3: Thinking bridge
        aiMetaHTML+='<div class="gc-step" id="'+prefix+'Bridge">';
        aiMetaHTML+='<div class="gc-card">';
        aiMetaHTML+='<div class="gc-card__title">ğŸŒ‰ ì§€ê¸ˆ ì—¬ëŸ¬ë¶„ì´ í•œ ê²ƒì€</div>';
        aiMetaHTML+='<div class="gc-bridge">';
        var steps = gi.thinking_bridge.steps || [];
        for(var si=0; si<steps.length; si++){
          aiMetaHTML+='<div class="gc-bridge__step">'+(si===0?'â‘ ':si===1?'â‘¡':'â‘¢')+' '+steps[si]+'</div>';
        }
        aiMetaHTML+='<div class="gc-bridge__conn" style="color:'+tColor+'">'+gi.thinking_bridge.connection+'</div>';
        aiMetaHTML+='</div>';
        aiMetaHTML+='</div>';
        aiMetaHTML+='<div class="gc-btns">';
        aiMetaHTML+='<button class="gc-btn gc-btn--yes" onclick="gcInteract('+idx+',&apos;bridge&apos;,&apos;understood&apos;)">ğŸ’¡ ì•„í•˜! ì´í•´í–ˆì–´ìš”</button>';
        aiMetaHTML+='<button class="gc-btn gc-btn--no" onclick="gcInteract('+idx+',&apos;bridge&apos;,&apos;confused&apos;)" style="flex:.6">ğŸ¤” ì•„ì§ ì˜ ëª¨ë¥´ê² ì–´ìš”</button>';
        aiMetaHTML+='</div>';
        aiMetaHTML+='</div>';

        // SCREEN 4: Coaching question result
        aiMetaHTML+='<div class="gc-step" id="'+prefix+'Result">';
        aiMetaHTML+='<div class="next-q-wrap">';
        aiMetaHTML+='<div class="next-q-title"><i class="fas fa-arrow-up" style="color:#fbbf24"></i> '+tEmoji+' '+cq.growth_path+' ì„±ì¥ ì§ˆë¬¸</div>';
        aiMetaHTML+='<div class="next-q-card" style="border-left:3px solid '+tColor+'">';
        aiMetaHTML+='<div class="next-q-badge" style="background:'+tColor+'20;color:'+tColor+'">'+tEmoji+' '+tName+' ('+gi.target_type+')</div>';
        aiMetaHTML+='<div class="next-q-text">"'+cq.question+'"</div>';
        aiMetaHTML+='<div class="next-q-why"><i class="fas fa-lightbulb" style="color:#fbbf24;margin-right:4px"></i>'+cq.why_important+'</div>';
        aiMetaHTML+='</div>';
        // Show other coaching questions
        if(cd.coaching_questions.length > 1){
          aiMetaHTML+='<div style="margin-top:12px;padding-top:12px;border-top:1px dashed rgba(255,255,255,.1)">';
          aiMetaHTML+='<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ë‹¤ë¥¸ ì„±ì¥ ì§ˆë¬¸ë„ ìˆì–´ìš”:</div>';
          cd.coaching_questions.forEach(function(ocq, oi){
            if(oi === (gi.target_coaching_index || idx)) return;
            var oc = _levelColors[ocq.type] || '#60a5fa';
            var oe = _typeEmoji[ocq.type] || 'ğŸ’¬';
            aiMetaHTML+='<div class="next-q-card" style="border-left:3px solid '+oc+';opacity:.8">';
            aiMetaHTML+='<div class="next-q-badge" style="background:'+oc+'20;color:'+oc+'">'+oe+' '+(ocq.type_label||'')+' ('+ocq.type+')</div>';
            aiMetaHTML+='<div class="next-q-text">"'+ocq.question+'"</div>';
            aiMetaHTML+='</div>';
          });
          aiMetaHTML+='</div>';
        }
        // Add review/restart buttons at end of result
        aiMetaHTML+='<div class="gc-btns" style="margin-top:12px;flex-direction:column;gap:6px">';
        aiMetaHTML+='<button class="gc-btn gc-btn--yes" onclick="gcReplayCoaching()" style="flex:1;font-size:14px"><i class="fas fa-play-circle" style="margin-right:4px"></i>ì²˜ìŒë¶€í„° ë‹¤ì‹œ ë³´ê¸°</button>';
        aiMetaHTML+='<button class="gc-btn gc-btn--choice" onclick="gcRestartCoaching()" style="flex:1;font-size:13px;opacity:.7"><i class="fas fa-redo" style="margin-right:4px"></i>ë‹¤ì‹œ ì²˜ìŒë¶€í„° í•˜ê¸°</button>';
        aiMetaHTML+='</div>';

        aiMetaHTML+='</div>';
        aiMetaHTML+='</div>';
      });

      aiMetaHTML+='</div>'; // gc-wrap
    }
    aiMetaHTML+='</div>';

  } else if(q.ai_analyzed===0 && q.has_image){
    aiMetaHTML='<div class="ai-meta"><div class="ai-meta__analyzing"><i class="fas fa-spinner"></i> AIê°€ ë¬¸ì œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... <span style="font-size:12px;opacity:.6">(ë³´í†µ 10~20ì´ˆ)</span></div></div>';
    // Auto-poll until analysis completes
    if(!window._aiPollTimer){
      window._aiPollCount=0;
      window._aiPollTimer=setInterval(async()=>{
        try{
          window._aiPollCount++;
          const r=await fetch('/api/questions/'+qId);
          const d=await r.json();
          if(d && d.ai_analyzed!==0){
            clearInterval(window._aiPollTimer);
            window._aiPollTimer=null;
            cachedQData=d;
            renderQ(d);
          } else if(window._aiPollCount===5){
            // After 15s still pending â†’ trigger manual analysis as fallback
            fetch('/api/questions/'+qId+'/analyze',{method:'POST',headers:authHeaders()}).catch(()=>{});
          }
        }catch(e){}
      },3000);
      // Auto-stop after 90s and show retry button
      setTimeout(()=>{
        if(window._aiPollTimer){
          clearInterval(window._aiPollTimer);
          window._aiPollTimer=null;
          // Force show retry UI
          const el=document.querySelector('.ai-meta__analyzing');
          if(el) el.innerHTML='<i class="fas fa-exclamation-triangle" style="color:#ff6b6b"></i> ë¶„ì„ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. <button onclick="retryAnalysis()" style="background:#ff6b6b;color:#fff;border:none;padding:4px 12px;border-radius:6px;cursor:pointer;font-size:13px;margin-left:8px"><i class="fas fa-redo"></i> ë‹¤ì‹œ ë¶„ì„</button>';
        }
      },90000);
    }
  } else if(q.ai_analyzed===-1 && q.has_image){
    aiMetaHTML='<div class="ai-meta"><div class="ai-meta__analyzing" style="color:#ff6b6b"><i class="fas fa-exclamation-triangle"></i> AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. <button onclick="retryAnalysis()" style="background:#ff6b6b;color:#fff;border:none;padding:4px 12px;border-radius:6px;cursor:pointer;font-size:13px;margin-left:8px"><i class="fas fa-redo"></i> ë‹¤ì‹œ ë¶„ì„</button></div></div>';
  }

  document.getElementById('questionSection').innerHTML=
    '<div class="q-head">'+
      '<div class="q-avatar"><i class="fas fa-user"></i></div>'+
      '<div class="q-meta">'+
        '<div class="q-name"><a href="/coaching/'+q.user_id+'" style="color:inherit;text-decoration:none;border-bottom:1px dashed rgba(255,255,255,.2)" title="ì§ˆë¬¸ ë¶„ì„ ë³´ê¸°">'+q.author_name+'</a>'+(q.author_grade?' <span class="grade-tag">'+q.author_grade+'</span>':'')+'<a href="/coaching/'+q.user_id+'" style="margin-left:6px;font-size:10px;color:#fbbf24;text-decoration:none;opacity:.7" title="ì§ˆë¬¸ ë¶„ì„ ë³´ê¸°"><i class="fas fa-chart-line"></i></a></div>'+
        '<div class="q-sub">'+timeAgo(q.created_at)+'</div>'+
      '</div>'+
      '<div class="q-status'+statusCls+'">'+statusText+'</div>'+
    '</div>'+
    (q.content?'<div class="q-content">'+q.content+'</div>':'')+
    (q.has_image?'<div class="q-image-wrap"><div class="q-img-btns"><button class="q-img-btn" id="copyBtn" onclick="event.stopPropagation();copyQuestionImage()" title="í´ë¦½ë³´ë“œì— ë³µì‚¬ (êµ¿ë…¸íŠ¸ ë“±ì— ë¶™ì—¬ë„£ê¸°)"><i class="fas fa-copy"></i> ë³µì‚¬</button><button class="q-img-btn" id="downloadBtn" onclick="event.stopPropagation();downloadQuestionImage()" title="ì´ë¯¸ì§€ íŒŒì¼ ì €ì¥ (í´ë˜ìŠ¤ì¸ ì—…ë¡œë“œìš©)"><i class="fas fa-download"></i> ì €ì¥</button></div><img class="q-image" id="qImage" alt=""'+(q.image_key?' src="/api/images/'+q.image_key+'"':'')+' style="min-height:100px;background:var(--bg3)" onclick="showModal(this.src)"></div>':'')+
    '<div class="q-footer"><span class="tag"><i class="fas fa-tag"></i>'+q.subject+'</span>'+killerBadge+'<span style="margin-left:auto">ë‹µë³€ '+(q.comment_count||0)+'</span></div>'+
    aiMetaHTML+
    (q.difficulty==='1:1ì‹¬í™”ì„¤ëª…'?'<div id="tutoringPanel" style="margin-top:16px"></div>':'');
  // Load tutoring data if applicable
  if(q.difficulty==='1:1ì‹¬í™”ì„¤ëª…') loadTutoring(q);
}
// === Copy question image to clipboard ===
async function copyQuestionImage(){
  const btn=document.getElementById('copyBtn');
  const img=document.getElementById('qImage');
  if(!img||!img.src) return;
  btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';

  // Helper: convert image src to PNG blob via canvas
  function imgToPngBlob(){
    return fetch(img.src)
      .then(r=>r.blob())
      .then(blob=>{
        return new Promise((resolve,reject)=>{
          const c=document.createElement('canvas');
          const t=new Image();
          t.crossOrigin='anonymous';
          t.onload=()=>{
            c.width=t.naturalWidth;c.height=t.naturalHeight;
            const ctx=c.getContext('2d');
            ctx.drawImage(t,0,0);
            URL.revokeObjectURL(t.src);
            c.toBlob(b=>{b?resolve(b):reject(new Error('toBlob failed'))},'image/png');
          };
          t.onerror=reject;
          t.src=URL.createObjectURL(blob);
        });
      });
  }

  function showSuccess(){
    btn.innerHTML='<i class="fas fa-check"></i> ì™„ë£Œ!';
    btn.classList.add('copied');
    setTimeout(()=>{btn.innerHTML='<i class="fas fa-copy"></i> ë³µì‚¬';btn.classList.remove('copied')},2000);
  }
  function showFail(msg){
    btn.innerHTML='<i class="fas fa-times"></i> '+(msg||'ì‹¤íŒ¨');
    setTimeout(()=>{btn.innerHTML='<i class="fas fa-copy"></i> ë³µì‚¬'},2000);
  }

  try{
    // Safari requires ClipboardItem to accept a Promise<Blob> directly
    // This preserves the user gesture context (no awaits before clipboard.write)
    if(typeof ClipboardItem!=='undefined' && navigator.clipboard && navigator.clipboard.write){
      const pngPromise=imgToPngBlob();
      // Safari-compatible: pass Promise<Blob> inside ClipboardItem
      try{
        await navigator.clipboard.write([new ClipboardItem({'image/png':pngPromise})]);
        showSuccess();
        return;
      }catch(safariErr){
        // Some browsers don't accept Promise<Blob>, try with resolved blob
        try{
          const pngBlob=await pngPromise;
          await navigator.clipboard.write([new ClipboardItem({'image/png':pngBlob})]);
          showSuccess();
          return;
        }catch(fallbackErr){
          console.warn('clipboard.write fallback failed',fallbackErr);
        }
      }
    }
    // Fallback for browsers without ClipboardItem/clipboard.write
    // Try execCommand approach
    try{
      const pngBlob=await imgToPngBlob();
      const urlObj=URL.createObjectURL(pngBlob);
      const tempImg2=document.createElement('img');
      tempImg2.src=urlObj;
      tempImg2.style.position='fixed';tempImg2.style.opacity='0';tempImg2.style.left='-9999px';
      document.body.appendChild(tempImg2);
      const range=document.createRange();
      range.selectNode(tempImg2);
      const sel=window.getSelection();
      sel.removeAllRanges();sel.addRange(range);
      const ok=document.execCommand('copy');
      sel.removeAllRanges();
      document.body.removeChild(tempImg2);
      URL.revokeObjectURL(urlObj);
      if(ok){showSuccess();return;}
    }catch(execErr){console.warn('execCommand copy failed',execErr)}
    // Final fallback: show a message instead of downloading
    showFail('ë³µì‚¬ ë¶ˆê°€');
  }catch(e){
    console.error('copy error',e);
    showFail('ë³µì‚¬ ì‹¤íŒ¨');
  }
}
window.copyQuestionImage=copyQuestionImage;

// === Download question image as file ===
async function downloadQuestionImage(){
  const btn=document.getElementById('downloadBtn');
  const img=document.getElementById('qImage');
  if(!img||!img.src) return;
  btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';
  try{
    const res=await fetch(img.src);
    const blob=await res.blob();
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='question_'+qId+'.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    btn.innerHTML='<i class="fas fa-check"></i> ì €ì¥ë¨!';
    btn.classList.add('downloaded');
    setTimeout(()=>{btn.innerHTML='<i class="fas fa-download"></i> ì €ì¥';btn.classList.remove('downloaded')},2000);
  }catch(e){
    console.error('download error',e);
    btn.innerHTML='<i class="fas fa-times"></i> ì‹¤íŒ¨';
    setTimeout(()=>{btn.innerHTML='<i class="fas fa-download"></i> ì €ì¥'},2000);
  }
}
window.downloadQuestionImage=downloadQuestionImage;

let tutoringPollTimer=null;
async function loadTutoring(q){
  try{
    const res=await fetch('/api/questions/'+qId+'/tutoring');
    const data=await res.json();
    renderTutoring(q,data.slots||[],data.matches||[]);
    // Start polling for matching updates (every 10 seconds)
    startTutoringPoll(q,data.matches||[]);
  }catch(e){console.error('tutoring load error',e)}
}
function startTutoringPoll(q,prevMatches){
  if(tutoringPollTimer) clearInterval(tutoringPollTimer);
  // Only poll if not yet confirmed
  const isConfirmed=prevMatches.some(m=>m.status==='confirmed');
  if(isConfirmed) return;
  tutoringPollTimer=setInterval(async()=>{
    try{
      const res=await fetch('/api/questions/'+qId+'/tutoring');
      const data=await res.json();
      const newMatches=data.matches||[];
      const oldPending=prevMatches.filter(m=>m.status==='pending').length;
      const newPending=newMatches.filter(m=>m.status==='pending').length;
      const newConfirmed=newMatches.some(m=>m.status==='confirmed');
      // Only re-render if matches actually changed
      const matchChanged=JSON.stringify(newMatches)!==JSON.stringify(prevMatches);
      // If new pending match appeared, show notification to question owner
      if(newPending>oldPending&&currentUser&&cachedQData&&currentUser.id===cachedQData.user_id){
        showTutoringNotification(newMatches.find(m=>m.status==='pending'));
      }
      // Re-render panel only if data changed
      if(matchChanged) renderTutoring(q,data.slots||[],newMatches);
      prevMatches=newMatches;
      // Stop polling if confirmed
      if(newConfirmed){clearInterval(tutoringPollTimer);tutoringPollTimer=null;}
    }catch(e){}
  },10000);
}
function showTutoringNotification(match){
  if(!match)return;
  // Remove existing notification
  const old=document.getElementById('tutoringNotif');
  if(old)old.remove();
  const notif=document.createElement('div');
  notif.id='tutoringNotif';
  notif.style.cssText='position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9999;background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff;padding:14px 20px;border-radius:12px;box-shadow:0 4px 20px rgba(108,92,231,.5);display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;animation:slideDown .4s ease;max-width:90vw';
  notif.innerHTML='<i class="fas fa-bell" style="font-size:18px;animation:ring 1s ease infinite"></i><div><div style="margin-bottom:2px">1:1 íŠœí„°ë§ ì‹ ì²­ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤!</div><div style="font-size:11px;font-weight:400;opacity:.8">'+match.tutor_name+'ë‹˜ì´ ì‹ ì²­í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ í™•ì •í•´ì£¼ì„¸ìš”.</div></div><button onclick="this.parentElement.remove();document.getElementById(&quot;tutoringPanel&quot;).scrollIntoView({behavior:&quot;smooth&quot;})" style="background:rgba(255,255,255,.2);border:none;color:#fff;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;white-space:nowrap">í™•ì¸</button>';
  document.body.appendChild(notif);
  // Auto-remove after 15s
  setTimeout(()=>{if(notif.parentElement)notif.remove()},15000);
}
function renderTutoring(q,slots,matches){
  const panel=document.getElementById('tutoringPanel');
  if(!panel)return;
  const isOwner=currentUser&&currentUser.id==q.user_id;
  const confirmedMatch=matches.find(m=>m.status==='confirmed');
  const completedMatch=matches.find(m=>m.status==='completed');
  const acceptedMatch=matches.find(m=>m.status==='accepted');
  const pendingMatch=matches.find(m=>m.status==='pending');
  const myMatch=currentUser?matches.find(m=>m.tutor_id===currentUser.id&&m.status==='pending'):null;

  let html='<div style="background:linear-gradient(135deg,rgba(108,92,231,.1),rgba(108,92,231,.05));border:1px solid rgba(108,92,231,.25);border-radius:8px;padding:16px;margin-top:4px">';
  html+='<div style="font-size:22px;font-weight:700;color:#a29bfe;margin-bottom:16px;display:flex;align-items:center;gap:10px"><i class="fas fa-chalkboard-teacher" style="font-size:22px"></i> 1:1 íŠœí„°ë§ ë§¤ì¹­</div>';

  if(acceptedMatch){
    // Already accepted - show tags/review
    const slotInfo=slots.find(s=>s.id===acceptedMatch.slot_id);
    let aTags=[];
    try{if(acceptedMatch.acceptance_tags)aTags=JSON.parse(acceptedMatch.acceptance_tags)}catch(e){}
    const tagMap={kind:{e:'ğŸ’›',t:'ì¹œì ˆí•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì•Œë ¤ì£¼ì…¨ì–´ìš”!'},detail:{e:'ğŸ“–',t:'ê¼¼ê¼¼í•˜ê²Œ ì„¤ëª…í•´ì¤˜ì„œ í™•ì‹¤íˆ ì´í•´ëì–´ìš”.'},patience:{e:'ğŸ˜Š',t:'ëª¨ë¥´ëŠ” ë¶€ë¶„ë„ ì¸ë‚´ì‹¬ ìˆê²Œ ê¸°ë‹¤ë ¤ì£¼ì…¨ì–´ìš”.'},pinpoint:{e:'ğŸ¯',t:'í—·ê°ˆë ¸ë˜ í•µì‹¬ì„ ì •í™•íˆ ì§šì–´ì£¼ì…¨ì–´ìš”!'},relief:{e:'ğŸš€',t:'ë‹µë‹µí–ˆë˜ ì†ì´ ë»¥ ëš«ë¦¬ëŠ” ê¸°ë¶„ì´ì—ìš”.'},motivated:{e:'ğŸ”¥',t:'ê°€ë¥´ì³ì¤€ ëŒ€ë¡œ í•˜ë‹ˆ ê³µë¶€ ì˜ìš•ì´ ìƒê²¨ìš”!'},again:{e:'ğŸ™Œ',t:'ë‹¤ìŒì—ë„ ë˜ ì„¤ëª… ë¶€íƒë“œë¦¬ê³  ì‹¶ì–´ìš”!'}};
    html+='<div style="text-align:center;padding:16px">';
    html+='<div style="font-size:24px;margin-bottom:8px">â­</div>';
    html+='<div style="font-size:14px;font-weight:700;color:#00c853;margin-bottom:4px">ì±„íƒ ì™„ë£Œ!</div>';
    html+='<div style="font-size:12px;color:var(--muted);margin-bottom:12px">'+acceptedMatch.tutor_name+(acceptedMatch.tutor_grade?' ('+acceptedMatch.tutor_grade+')':'')+'ë‹˜ì˜ 1:1 íŠœí„°ë§ì´ ì±„íƒë˜ì—ˆìŠµë‹ˆë‹¤</div>';
    if(aTags.length>0){
      html+='<div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:8px">';
      aTags.forEach(tid=>{const t=tagMap[tid];if(t)html+='<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;font-size:11px;background:rgba(0,200,83,.08);border:1px solid rgba(0,200,83,.2);border-radius:20px;color:#00c853">'+t.e+' '+t.t+'</span>'});
      html+='</div>';
    }
    if(acceptedMatch.acceptance_review){
      html+='<div style="margin-top:8px;padding:10px 14px;background:rgba(255,255,255,.04);border-radius:8px;border:1px solid rgba(255,255,255,.06);font-size:12px;color:var(--dim);text-align:left;line-height:1.5">"'+acceptedMatch.acceptance_review+'"</div>';
    }
    html+='</div>';
  } else if(confirmedMatch || completedMatch){
    const activeMatch = completedMatch || confirmedMatch;
    const slotInfo=slots.find(s=>s.id===activeMatch.slot_id);
    const slotDate=slotInfo?parseSlotTimeForTutoring(slotInfo.slot_time):null;
    const isPast=slotDate&&slotDate.getTime()<Date.now();

    html+='<div style="text-align:center;padding:16px">';
    html+='<div style="font-size:24px;margin-bottom:8px">'+(isPast?'âœ…':'ğŸ‰')+'</div>';
    html+='<div style="font-size:14px;font-weight:700;color:var(--green);margin-bottom:4px">'+(isPast?'ìˆ˜ì—… ì‹œê°„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤':'ë§¤ì¹­ í™•ì •!')+'</div>';
    html+='<div style="font-size:13px;color:var(--white);margin-bottom:4px"><i class="fas fa-clock" style="color:#6c5ce7"></i> '+(slotInfo?slotInfo.slot_time:'')+'</div>';
    html+='<div style="font-size:12px;color:var(--muted)">ë‹µë³€ì: '+activeMatch.tutor_name+(activeMatch.tutor_grade?' ('+activeMatch.tutor_grade+')':'')+'</div>';

    // Show accept button if: owner + session time has passed
    if(isOwner && isPast){
      html+='<div style="margin-top:16px;padding-top:12px;border-top:1px solid rgba(108,92,231,.15)">';
      html+='<div style="font-size:12px;color:var(--muted);margin-bottom:8px">1:1 íŠœí„°ë§ì´ ë§Œì¡±ìŠ¤ëŸ¬ì› ë‚˜ìš”?</div>';
      html+='<button onclick="acceptTutor()" style="padding:12px 24px;border-radius:8px;background:linear-gradient(135deg,#ffd700,#ffaa00);color:#111;border:none;font-size:14px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:6px"><i class="fas fa-star"></i> ì±„íƒí•˜ê¸° ('+(q.reward_points||0)+'P ì§€ê¸‰)</button>';
      html+='</div>';
    } else if(!isOwner && isPast){
      html+='<div style="font-size:11px;color:var(--muted);margin-top:8px"><i class="fas fa-hourglass-half"></i> ì§ˆë¬¸ìì˜ ì±„íƒì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤</div>';
    } else {
      html+='<div style="font-size:11px;color:var(--muted);margin-top:8px"><i class="fas fa-info-circle"></i> ì •ìœ¨í†¡ ì—°ë™ í›„ ìë™ìœ¼ë¡œ í†¡ë°©ì´ ìƒì„±ë©ë‹ˆë‹¤</div>';
    }
    html+='</div>';
  } else if(isOwner){
    // Question owner view - show slots and pending match
    html+='<div style="font-size:11px;color:var(--muted);margin-bottom:10px">ë‚´ê°€ ì„ íƒí•œ ì‹œê°„</div>';
    html+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">';
    slots.forEach(s=>{html+='<span style="display:inline-flex;align-items:center;gap:4px;padding:6px 12px;font-size:12px;font-weight:600;background:rgba(108,92,231,.15);border:1px solid rgba(108,92,231,.3);border-radius:20px;color:#a29bfe"><i class="fas fa-clock"></i> '+s.slot_time+'</span>'});
    html+='</div>';

    if(pendingMatch){
      // Check if hold expired
      const heldMs=Date.now()-new Date(pendingMatch.held_at+'Z').getTime();
      const leftMin=Math.max(0,Math.ceil((15*60*1000-heldMs)/60000));
      const slotInfo=slots.find(s=>s.id===pendingMatch.slot_id);
      html+='<div style="background:rgba(255,215,0,.08);border:1px solid rgba(255,215,0,.2);border-radius:6px;padding:12px;margin-top:8px">';
      html+='<div style="font-size:12px;font-weight:700;color:#ffd700;margin-bottom:6px"><i class="fas fa-bell"></i> ì‹ ì²­ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤!</div>';
      html+='<div style="font-size:12px;color:var(--white);margin-bottom:4px">'+pendingMatch.tutor_name+(pendingMatch.tutor_grade?' ('+pendingMatch.tutor_grade+')':'')+'</div>';
      html+='<div style="font-size:11px;color:var(--muted);margin-bottom:8px">í¬ë§ ì‹œê°„: '+(slotInfo?slotInfo.slot_time:'')+(leftMin>0?' Â· ìš°ì„ ê¶Œ '+leftMin+'ë¶„ ë‚¨ìŒ':'')+'</div>';
      html+='<div style="display:flex;gap:8px">';
      html+='<button onclick="confirmMatch('+pendingMatch.id+')" style="flex:1;padding:10px;border-radius:6px;background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff;border:none;font-size:13px;font-weight:700;cursor:pointer"><i class="fas fa-check"></i> í™•ì •í•˜ê¸°</button>';
      html+='</div></div>';
    } else {
      html+='<div style="text-align:center;padding:8px;color:var(--muted);font-size:12px"><i class="fas fa-hourglass-half"></i> ë‹µë³€ì ëª¨ì§‘ ì¤‘...</div>';
      // Edit slots button (only when no pending or confirmed match)
      html+='<div style="text-align:center;margin-top:8px"><button onclick="showEditSlotsModal()" style="padding:8px 16px;border-radius:6px;background:rgba(108,92,231,.1);border:1px solid rgba(108,92,231,.2);color:#a29bfe;font-size:12px;font-weight:600;cursor:pointer"><i class="fas fa-edit"></i> ì‹œê°„ ìˆ˜ì •</button></div>';
    }
  } else {
    // Other users (potential tutors)
    html+='<div style="font-size:11px;color:var(--muted);margin-bottom:10px">ğŸ•’ ê°€ëŠ¥í•œ ì‹œê°„</div>';
    html+='<div id="slotBtnWrap" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">';
    slots.forEach(s=>{
      const isChecked=myMatch&&myMatch.slot_id===s.id;
      html+='<button class="tutor-slot-btn'+(isChecked?' checked':'')+'" data-sid="'+s.id+'" onclick="selectSlot(this,'+s.id+')" style="padding:10px 16px;font-size:13px;font-weight:700;border-radius:24px;cursor:pointer;transition:all .25s;border:2px solid '+(isChecked?'#6c5ce7':'var(--border)')+';background:'+(isChecked?'linear-gradient(135deg,rgba(108,92,231,.3),rgba(162,155,254,.2))':'#1e1e1e')+';color:'+(isChecked?'#a29bfe':'var(--muted)')+'">'+(isChecked?'<i class="fas fa-check-circle" style="margin-right:4px"></i>':'<i class="fas fa-clock" style="margin-right:4px"></i>')+s.slot_time+'</button>'
    });
    html+='</div>';

    if(myMatch){
      html+='<div style="text-align:center;padding:10px;font-size:13px;color:#a29bfe;background:rgba(108,92,231,.08);border-radius:10px;border:1px solid rgba(108,92,231,.2)"><i class="fas fa-check-circle" style="margin-right:4px"></i> ì‹ ì²­ ì™„ë£Œ! ì§ˆë¬¸ì í™•ì •ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>';
    } else if(pendingMatch){
      html+='<div style="text-align:center;padding:8px;font-size:12px;color:var(--muted)"><i class="fas fa-lock"></i> í˜„ì¬ ë‹¤ë¥¸ ë‹µë³€ìê°€ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.</div>';
    } else if(currentUser) {
      html+='<div id="slotGuide" style="text-align:center;padding:10px;font-size:13px;color:var(--muted);transition:all .3s"><i class="fas fa-hand-pointer" style="margin-right:4px"></i> ì›í•˜ëŠ” ì‹œê°„ì„ íƒ­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>';
      html+='<div id="slotConfirmWrap" style="display:none;text-align:center;margin-top:8px;animation:fadeSlideUp .3s ease">';
      html+='<div style="font-size:12px;color:#a29bfe;margin-bottom:8px"><i class="fas fa-check"></i> <span id="selectedSlotTime"></span> ì„ íƒë¨</div>';
      html+='<button id="slotConfirmBtn" onclick="confirmSlotSelection()" style="padding:12px 32px;border-radius:24px;background:linear-gradient(135deg,#6c5ce7,#a29bfe);border:none;color:#fff;font-size:14px;font-weight:800;cursor:pointer;box-shadow:0 4px 15px rgba(108,92,231,.4);transition:all .2s"><i class="fas fa-paper-plane" style="margin-right:6px"></i>ì‹ ì²­ ì™„ë£Œí•˜ê¸°</button>';
      html+='</div>';
    } else {
      html+='<div style="text-align:center;padding:8px;font-size:12px;color:var(--muted)"><a href="/login" style="color:#a29bfe">ë¡œê·¸ì¸</a> í›„ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>';
    }
  }
  html+='</div>';
  panel.innerHTML=html;
}

// Helper: parse slot time for tutoring panel
function parseSlotTimeForTutoring(slotTime){
  if(!slotTime)return null;
  const parts=slotTime.trim().split(' ');
  if(parts.length<3)return null;
  const dp=parts[1].split('/'),tp=parts[2].split(':');
  const now=new Date(),yr=now.getFullYear();
  const d=new Date(yr,parseInt(dp[0])-1,parseInt(dp[1]),parseInt(tp[0]),parseInt(tp[1]||'0'));
  if(d.getTime()<now.getTime()-180*86400000)d.setFullYear(yr+1);
  return d;
}

// Edit slots modal - same picker UI as new question page
let editPickedSlots=[];
let editCurDay=null;
const EDIT_TIMES=[];
for(let h=15;h<=22;h++){EDIT_TIMES.push(h+':00');if(h<22)EDIT_TIMES.push(h+':30')}

function showEditSlotsModal(){
  editPickedSlots=[];
  editCurDay=null;
  const overlay=document.createElement('div');
  overlay.id='editSlotsOverlay';
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px';
  overlay.innerHTML=\`
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;max-width:420px;width:100%;padding:24px;animation:slideUp .3s ease;max-height:90vh;overflow-y:auto">
    <div style="font-size:16px;font-weight:700;color:var(--white);margin-bottom:4px"><i class="fas fa-clock" style="color:#a29bfe"></i> ì‹œê°„ ìˆ˜ì •</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:16px">ê¸°ì¡´ ì‹œê°„ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ìƒˆ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš” (ìµœëŒ€ 3ê°œ)</div>
    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;overflow-x:auto" id="editDayTabs"></div>
    <div id="editTimeGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;max-height:200px;overflow-y:auto"></div>
    <div id="editSelectedSlots" style="margin-top:12px;min-height:28px"></div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button onclick="document.getElementById('editSlotsOverlay').remove()" style="flex:1;padding:12px;border-radius:8px;background:var(--bg);color:var(--dim);border:1px solid var(--border);font-size:13px;font-weight:600;cursor:pointer">ì·¨ì†Œ</button>
      <button onclick="saveEditSlots()" style="flex:1;padding:12px;border-radius:8px;background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff;border:none;font-size:13px;font-weight:700;cursor:pointer"><i class="fas fa-save"></i> ì €ì¥</button>
    </div>
  </div>\`;
  document.body.appendChild(overlay);
  overlay.addEventListener('click',(e)=>{if(e.target===overlay)overlay.remove()});
  initEditSlotPicker();
}
function initEditSlotPicker(){
  const today=new Date();
  const dayList=[];
  for(let i=0;i<7;i++){
    const d=new Date(today);d.setDate(today.getDate()+i);
    const dayIdx=d.getDay();const dayName=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][dayIdx];
    const mm=(d.getMonth()+1);const dd=d.getDate();
    dayList.push({label:dayName+' '+mm+'/'+dd, value:dayName+' '+(mm<10?'0'+mm:mm)+'/'+(dd<10?'0'+dd:dd)});
  }
  const tabs=document.getElementById('editDayTabs');
  tabs.innerHTML=dayList.map((d,i)=>'<div style="padding:6px 12px;border-radius:16px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .2s;border:1px solid '+(i===0?'#6c5ce7':'var(--border)')+';background:'+(i===0?'rgba(108,92,231,.2)':'var(--bg)')+';color:'+(i===0?'#a29bfe':'var(--dim)')+'" data-day="'+d.label+'" onclick="editPickDay(this)">'+d.label+'</div>').join('');
  editCurDay=dayList[0].label;
  renderEditTimeGrid();
  renderEditSelectedSlots();
}
function editPickDay(el){
  document.querySelectorAll('#editDayTabs > div').forEach(t=>{t.style.border='1px solid var(--border)';t.style.background='var(--bg)';t.style.color='var(--dim)'});
  el.style.border='1px solid #6c5ce7';el.style.background='rgba(108,92,231,.2)';el.style.color='#a29bfe';
  editCurDay=el.dataset.day;renderEditTimeGrid();
}
function renderEditTimeGrid(){
  const grid=document.getElementById('editTimeGrid');
  grid.innerHTML=EDIT_TIMES.map(t=>{
    const key=editCurDay+' '+t;
    const picked=editPickedSlots.includes(key);
    const full=editPickedSlots.length>=3&&!picked;
    return'<div style="padding:8px 4px;text-align:center;font-size:12px;font-weight:600;border-radius:8px;cursor:'+(full?'not-allowed':'pointer')+';transition:all .2s;border:1px solid '+(picked?'#6c5ce7':'var(--border)')+';background:'+(picked?'rgba(108,92,231,.2)':'var(--bg)')+';color:'+(picked?'#a29bfe':full?'var(--border)':'var(--dim)')+'" data-slot="'+key+'" onclick="editToggleSlot(this)">'+t+'</div>';
  }).join('');
}
function editToggleSlot(el){
  const key=el.dataset.slot;
  if(editPickedSlots.includes(key)){editPickedSlots=editPickedSlots.filter(s=>s!==key)}
  else{if(editPickedSlots.length>=3)return;editPickedSlots.push(key)}
  renderEditTimeGrid();renderEditSelectedSlots();
}
function editRemoveSlot(key){editPickedSlots=editPickedSlots.filter(s=>s!==key);renderEditTimeGrid();renderEditSelectedSlots()}
function renderEditSelectedSlots(){
  const el=document.getElementById('editSelectedSlots');
  if(!editPickedSlots.length){el.innerHTML='<div style="font-size:11px;color:var(--muted)"><i class="fas fa-info-circle"></i> ìš”ì¼ì„ ì„ íƒí•˜ê³  ì‹œê°„ì„ íƒ­í•˜ì„¸ìš” (ìµœëŒ€ 3ê°œ)</div>';return}
  el.innerHTML='<div style="font-size:10px;color:var(--muted);margin-bottom:6px">ì„ íƒëœ ì‹œê°„ ('+editPickedSlots.length+'/3)</div>'+
    editPickedSlots.map(s=>'<span style="display:inline-flex;align-items:center;gap:4px;padding:5px 10px;font-size:11px;font-weight:600;background:rgba(108,92,231,.15);border:1px solid rgba(108,92,231,.3);border-radius:16px;color:#a29bfe;margin:0 4px 4px 0"><i class="fas fa-clock"></i> '+s+' <span style="cursor:pointer;margin-left:2px;color:#ff4136;font-weight:800" onclick="editRemoveSlot(&quot;'+s+'&quot;)">&times;</span></span>').join('');
}
async function saveEditSlots(){
  if(editPickedSlots.length===0){alert('ìµœì†Œ 1ê°œì˜ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');return}
  try{
    const res=await fetch('/api/questions/'+qId+'/tutoring/slots',{
      method:'PUT',
      headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({slots:editPickedSlots})
    });
    const d=await res.json();
    if(!res.ok){alert(d.error);return}
    alert('âœ… '+d.message);
    document.getElementById('editSlotsOverlay')?.remove();
    loadTutoring(cachedQData);
  }catch(e){alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')}
}
function acceptTutor(){
  const tags=[
    {id:'kind',emoji:'ğŸ’›',text:'ì¹œì ˆí•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì•Œë ¤ì£¼ì…¨ì–´ìš”!'},
    {id:'detail',emoji:'ğŸ“–',text:'ê¼¼ê¼¼í•˜ê²Œ ì„¤ëª…í•´ì¤˜ì„œ í™•ì‹¤íˆ ì´í•´ëì–´ìš”.'},
    {id:'patience',emoji:'ğŸ˜Š',text:'ëª¨ë¥´ëŠ” ë¶€ë¶„ë„ ì¸ë‚´ì‹¬ ìˆê²Œ ê¸°ë‹¤ë ¤ì£¼ì…¨ì–´ìš”.'},
    {id:'pinpoint',emoji:'ğŸ¯',text:'í—·ê°ˆë ¸ë˜ í•µì‹¬ì„ ì •í™•íˆ ì§šì–´ì£¼ì…¨ì–´ìš”!'},
    {id:'relief',emoji:'ğŸš€',text:'ë‹µë‹µí–ˆë˜ ì†ì´ ë»¥ ëš«ë¦¬ëŠ” ê¸°ë¶„ì´ì—ìš”.'},
    {id:'motivated',emoji:'ğŸ”¥',text:'ê°€ë¥´ì³ì¤€ ëŒ€ë¡œ í•˜ë‹ˆ ê³µë¶€ ì˜ìš•ì´ ìƒê²¨ìš”!'},
    {id:'again',emoji:'ğŸ™Œ',text:'ë‹¤ìŒì—ë„ ë˜ ì„¤ëª… ë¶€íƒë“œë¦¬ê³  ì‹¶ì–´ìš”!'}
  ];
  const pts=cachedQData?cachedQData.reward_points||0:0;
  const overlay=document.createElement('div');
  overlay.className='accept-modal-overlay';
  overlay.id='tutoringAcceptOverlay';
  overlay.innerHTML=
    '<div class="accept-modal">'+
      '<div class="accept-modal-header">'+
        '<h3><i class="fas fa-star" style="color:#ffd700;margin-right:6px"></i>1:1 íŠœí„°ë§ ì±„íƒ</h3>'+
        '<p>íŠœí„°ë§ì´ ë§Œì¡±ìŠ¤ëŸ¬ìš°ì…¨ë‚˜ìš”? ê°ì‚¬ì˜ ë§ˆìŒì„ ì „í•´ë³´ì„¸ìš”</p>'+
      '</div>'+
      '<div class="accept-modal-body">'+
        '<div style="font-size:12px;font-weight:600;color:var(--dim);margin-bottom:10px">ê°ì‚¬ ë¬¸êµ¬ ì„ íƒ <span style="color:var(--muted);font-weight:400">(ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</span></div>'+
        '<div class="accept-tag-list" id="tutoringTagList">'+
          tags.map(t=>
            '<div class="accept-tag-item" data-tag="'+t.id+'">'+
              '<span class="tag-emoji">'+t.emoji+'</span>'+
              '<span class="tag-text">'+t.text+'</span>'+
              '<span class="tag-check"><i class="fas fa-check"></i></span>'+
            '</div>'
          ).join('')+
        '</div>'+
        '<div style="font-size:12px;font-weight:600;color:var(--dim);margin-bottom:8px">ì±„íƒ í›„ê¸° <span style="color:var(--muted);font-weight:400">(ì„ íƒì‚¬í•­)</span></div>'+
        '<textarea class="accept-review-input" id="tutoringReviewInput" placeholder="1:1 íŠœí„°ë§ì€ ì–´ë– ì…¨ë‚˜ìš”? ê°ì‚¬ì˜ ë§ì„ ë‚¨ê²¨ë³´ì„¸ìš”..." maxlength="200"></textarea>'+
      '</div>'+
      '<div class="accept-modal-footer">'+
        '<button class="accept-cancel-btn" id="tutoringAcceptCancel">ì·¨ì†Œ</button>'+
        '<button class="accept-confirm-btn" id="tutoringAcceptConfirm"><i class="fas fa-star" style="margin-right:4px"></i>ì±„íƒí•˜ê¸° ('+pts+'P ì§€ê¸‰)</button>'+
      '</div>'+
    '</div>';
  document.body.appendChild(overlay);
  overlay.querySelectorAll('.accept-tag-item').forEach(el=>{
    el.addEventListener('click',()=>el.classList.toggle('selected'));
  });
  overlay.querySelector('#tutoringAcceptCancel').addEventListener('click',()=>overlay.remove());
  overlay.addEventListener('click',e=>{if(e.target===overlay)overlay.remove()});
  overlay.querySelector('#tutoringAcceptConfirm').addEventListener('click',async()=>{
    const selectedTags=Array.from(overlay.querySelectorAll('.accept-tag-item.selected')).map(el=>el.getAttribute('data-tag'));
    const review=overlay.querySelector('#tutoringReviewInput').value.trim();
    const btn=overlay.querySelector('#tutoringAcceptConfirm');
    btn.disabled=true;btn.textContent='ì±„íƒ ì¤‘...';
    try{
      const res=await fetch('/api/questions/'+qId+'/tutoring/accept',{
        method:'POST',
        headers:{...authHeaders(),'Content-Type':'application/json'},
        body:JSON.stringify({tags:selectedTags,review:review||null})
      });
      const d=await res.json();
      if(!res.ok){alert(d.error);btn.disabled=false;btn.innerHTML='<i class="fas fa-star" style="margin-right:4px"></i>ì±„íƒí•˜ê¸° ('+pts+'P ì§€ê¸‰)';return}
      overlay.remove();
      alert('â­ '+d.message);
      loadTutoring(cachedQData);loadQ();
    }catch(e){alert('ì±„íƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');btn.disabled=false;btn.innerHTML='<i class="fas fa-star" style="margin-right:4px"></i>ì±„íƒí•˜ê¸° ('+pts+'P ì§€ê¸‰)'}
  });
}
let _selectedSlotId=null;
function selectSlot(btn,slotId){
  if(!currentUser){alert('ì •ìœ¨í†¡ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”.');return}
  _selectedSlotId=slotId;
  // Visual feedback: highlight selected, dim others
  document.querySelectorAll('#slotBtnWrap .tutor-slot-btn').forEach(b=>{
    if(parseInt(b.dataset.sid)===slotId){
      b.style.border='2px solid #6c5ce7';
      b.style.background='linear-gradient(135deg,rgba(108,92,231,.3),rgba(162,155,254,.2))';
      b.style.color='#a29bfe';
      b.style.transform='scale(1.05)';
      b.style.boxShadow='0 0 12px rgba(108,92,231,.4)';
      b.innerHTML='<i class="fas fa-check-circle" style="margin-right:4px"></i>'+b.textContent.trim();
    } else {
      b.style.border='2px solid var(--border)';
      b.style.background='#1e1e1e';
      b.style.color='var(--muted)';
      b.style.transform='scale(1)';
      b.style.boxShadow='none';
      b.style.opacity='0.5';
    }
  });
  // Show confirm area
  const guide=document.getElementById('slotGuide');
  const cw=document.getElementById('slotConfirmWrap');
  const st=document.getElementById('selectedSlotTime');
  if(guide)guide.style.display='none';
  if(st)st.textContent=btn.textContent.trim();
  if(cw)cw.style.display='block';
}
async function confirmSlotSelection(){
  if(!_selectedSlotId)return;
  const btn=document.getElementById('slotConfirmBtn');
  if(btn){btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> ì‹ ì²­ ì¤‘...';}
  try{
    const res=await fetch('/api/questions/'+qId+'/tutoring/check',{method:'POST',headers:authHeaders(),body:JSON.stringify({slot_id:_selectedSlotId})});
    const d=await res.json();
    if(!res.ok){alert(d.error||'ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');if(btn){btn.disabled=false;btn.innerHTML='<i class="fas fa-paper-plane" style="margin-right:6px"></i>ì‹ ì²­ ì™„ë£Œí•˜ê¸°';}return}
    loadTutoring(cachedQData);
  }catch(e){alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');if(btn){btn.disabled=false;btn.innerHTML='<i class="fas fa-paper-plane" style="margin-right:6px"></i>ì‹ ì²­ ì™„ë£Œí•˜ê¸°';}}
}
async function checkSlot(slotId){
  if(!currentUser){alert('ì •ìœ¨í†¡ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”.');return}
  try{
    const res=await fetch('/api/questions/'+qId+'/tutoring/check',{method:'POST',headers:authHeaders(),body:JSON.stringify({slot_id:slotId})});
    const d=await res.json();
    if(!res.ok){alert(d.error||'ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');return}
    alert('âœ… '+d.message);
    loadTutoring(cachedQData);
  }catch(e){alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.')}
}
async function confirmMatch(matchId){
  if(!currentUser){alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');alert('ì •ìœ¨í†¡ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”.');return}
  try{
    const h=authHeaders();
    console.log('confirmMatch called, matchId='+matchId+', qId='+qId);
    const res=await fetch('/api/questions/'+qId+'/tutoring/confirm',{method:'POST',headers:h,body:JSON.stringify({match_id:matchId})});
    const d=await res.json();
    console.log('confirmMatch response:',res.status,JSON.stringify(d));
    if(!res.ok){alert(d.error||'í™•ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');return}
    alert('âœ… '+d.message);
    loadTutoring(cachedQData);loadQ();
  }catch(e){console.error('confirmMatch error:',e);alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.')}
}
async function loadQ(){
  try{
    const res=await fetch('/api/questions/'+qId);
    const q=await res.json();
    if(q&&!q.error){cachedQData=q;renderQ(q)}
  }catch(e){}
}

function renderA(list, qData){
    if(!Array.isArray(list))list=[];
    qData=qData||cachedQData||{};
    const isQOwner=currentUser&&currentUser.id===qData.user_id;
    const alreadyAccepted=list.some(a=>a.is_accepted);
    document.getElementById('answerCount').textContent=list.length;
    if(!list.length){
      document.getElementById('answersContainer').innerHTML='<div class="ans-empty"><i class="fas fa-comment-dots"></i><p>ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤<br><span style="font-size:12px;color:#555">ì²« ë²ˆì§¸ ë‹µë³€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</span></p></div>';
      return;
    }
    document.getElementById('answersContainer').innerHTML=list.map(a=>{
      const badge=a.is_accepted?'<span class="ans-badge"><i class="fas fa-check"></i> ì±„íƒëœ ë‹µë³€</span>':'';
      const hasDrawing=!!a.has_drawing;
      const hasImage=!!a.has_image;
      const hasContent=!!a.content;
      
      let bodyHTML='';
      if(hasContent){
        bodyHTML+='<div class="ans-section">'+(hasDrawing||hasImage?'<div class="ans-section-title"><i class="fas fa-lightbulb"></i> ì„¤ëª…</div>':'')+
          '<div class="ans-content">'+a.content+'</div></div>';
      }
      if(hasDrawing){
        bodyHTML+='<div class="ans-section"><div class="ans-section-title"><i class="fas fa-pen-fancy"></i> í’€ì´ ê³¼ì •</div>'+
          '<div class="ans-img-wrap"><img class="ans-img" id="drawing'+a.id+'"'+(a.drawing_key?' src="/api/answers/'+a.id+'/drawing"':' data-src="/api/answers/'+a.id+'/drawing"')+' alt="í’€ì´ ë¡œë”©ì¤‘..." style="min-height:80px;background:var(--bg3)" onclick="showModal(this.src)"></div></div>';
      }
      if(hasImage){
        bodyHTML+='<div class="ans-section">'+(hasDrawing?'<div class="ans-section-title"><i class="fas fa-image"></i> ì²¨ë¶€ ì´ë¯¸ì§€</div>':'')+
          '<div class="ans-img-wrap"><img class="ans-img" id="image'+a.id+'" data-src="/api/answers/'+a.id+'/image" alt="ì´ë¯¸ì§€ ë¡œë”©ì¤‘..." style="min-height:80px;background:var(--bg3)" onclick="showModal(this.src)"></div></div>';
      }
      // Voice recording - ClassIn-style custom player
      if(a.voice_key){
        bodyHTML+='<div class="ans-voice" data-voice-key="'+a.voice_key+'">'+
          '<div class="ans-voice__header">'+
            '<div class="ans-voice__icon"><i class="fas fa-microphone"></i></div>'+
            '<div class="ans-voice__label">ìŒì„± ë‹µë³€</div>'+
            '<div class="ans-voice__duration" id="voiceDur'+a.id+'">--:--</div>'+
          '</div>'+
          '<div class="ans-voice-player">'+
            '<button class="ans-voice-play" id="voicePlay'+a.id+'" onclick="toggleAnswerVoice('+a.id+')"><i class="fas fa-play"></i></button>'+
            '<div style="flex:1">'+
              '<div class="ans-voice-progress" onclick="seekAnswerVoice(event,'+a.id+')">'+
                '<div class="ans-voice-progress__fill" id="voiceFill'+a.id+'"></div>'+
              '</div>'+
              '<div class="ans-voice-times">'+
                '<span id="voiceCur'+a.id+'">00:00</span>'+
                '<span id="voiceTot'+a.id+'">--:--</span>'+
              '</div>'+
            '</div>'+
          '</div>'+
          '<audio id="voiceEl'+a.id+'" src="/api/voice/'+a.voice_key+'" preload="metadata" style="display:none"></audio>'+
        '</div>';
      }

      // Acceptance review section (shown on accepted answers)
      let reviewHTML='';
      if(a.is_accepted){
        let tags=[];
        try{if(a.acceptance_tags)tags=JSON.parse(a.acceptance_tags)}catch(e){}
        const tagEmojis={'aha':'ğŸ’¡','touched':'ğŸ¥¹','pinpoint':'ğŸ¯','relief':'ğŸš€','motivated':'ğŸ”¥','kind':'ğŸ˜Š','fast':'âš¡','accurate':'ğŸ‘','helpful':'ğŸ’¡','moved':'â¤ï¸'};
        const tagTexts={'aha':"ë•ë¶„ì— 'ì•„í•˜!' í•˜ê³  ë°”ë¡œ ì´í•´ëì–´ìš”!",'touched':'ì •ì„±ì´ ê°€ë“í•œ ì„¤ëª…ì— ì •ë§ ê°ë™í–ˆì–´ìš”.','pinpoint':'í—·ê°ˆë ¸ë˜ í•µì‹¬ì„ ì •í™•íˆ ì§šì–´ì£¼ì…¨ì–´ìš”!','relief':'ë‹µë‹µí–ˆë˜ ì†ì´ ë»¥ ëš«ë¦¬ëŠ” ê¸°ë¶„ì´ì—ìš”.','motivated':'ê°€ë¥´ì³ì¤€ ëŒ€ë¡œ í•˜ë‹ˆ ê³µë¶€ ì˜ìš•ì´ ìƒê²¨ìš”!','kind':'ì¹œì ˆí•˜ê²Œ ì•Œë ¤ì¤¬ì–´ìš”','fast':'ë¹ ë¥´ê²Œ ì•Œë ¤ì¤¬ì–´ìš”','accurate':'ë‹µë³€ì´ ì •í™•í•´ìš”','helpful':'ì´í•´í•˜ëŠ”ë° ë„ì›€ì´ ë˜ì—ˆì–´ìš”','moved':'ì •ë§ ê°ë™ì´ì—ìš”'};
        let tagsHTML='';
        if(tags.length>0){
          tagsHTML='<div class="accept-review-tags">'+tags.map(t=>
            '<span class="accept-review-tag">'+(tagEmojis[t]||'âœ¨')+' '+(tagTexts[t]||t)+'</span>'
          ).join('')+'</div>';
        }
        const reviewText=a.acceptance_review?'<div class="accept-review-text">'+a.acceptance_review+'</div>':'';
        if(tags.length>0||a.acceptance_review){
          reviewHTML='<div class="accept-review">'+
            '<div class="accept-review-title"><i class="fas fa-star"></i> ì§ˆë¬¸ì ì±„íƒ í›„ê¸°</div>'+
            tagsHTML+reviewText+
          '</div>';
        }
      }

      // Accept button for question owner (only if not already accepted)
      const acceptBtn=(isQOwner&&!alreadyAccepted&&!a.is_accepted)?
        '<button class="ans-accept-btn" onclick="showAcceptModal('+a.id+')"><i class="fas fa-check-circle"></i> ì±„íƒí•˜ê¸°</button>':'';

      return'<div class="ans-card'+(a.is_accepted?' accepted':'')+'" data-aid="'+a.id+'">'+
        '<div class="ans-card-head">'+
          '<div class="ans-avatar"><i class="fas fa-user-graduate"></i></div>'+
          '<div class="ans-meta">'+
            '<div class="ans-name">'+a.author_name+(a.author_grade?' <span class="ans-grade">'+a.author_grade+'</span>':'')+'</div>'+
            '<div class="ans-time">'+timeAgo(a.created_at)+'</div>'+
          '</div>'+
          badge+
        '</div>'+
        '<div class="ans-card-body">'+bodyHTML+'</div>'+
        reviewHTML+
        '<div class="ans-actions">'+
          '<button class="ans-act-btn" onclick="toggleReplySection('+a.id+')"><i class="far fa-comment"></i> ëŒ“ê¸€ <span class="reply-count" id="replyCnt'+a.id+'"></span></button>'+
          (currentUser&&currentUser.id===a.user_id?'<button class="ans-act-btn ans-del-btn" onclick="deleteAnswer('+a.id+')"><i class="far fa-trash-alt"></i> ì‚­ì œ</button>':'')+
          acceptBtn+
        '</div>'+
        '<div class="reply-section" id="replySection'+a.id+'" style="display:none">'+
          '<div class="reply-list" id="replyList'+a.id+'"></div>'+
          (currentUser?
            '<div class="reply-input-row">'+
              '<input class="reply-input" id="replyInput'+a.id+'" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500" data-aid="'+a.id+'">'+
              '<button class="reply-send" onclick="submitReply('+a.id+')"><i class="fas fa-arrow-up"></i></button>'+
            '</div>':'<div style="font-size:11px;color:var(--muted);padding:4px 0"><a href="/login?redirect=/question/'+qId+'" style="color:var(--green)">ë¡œê·¸ì¸</a> í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>')+
        '</div>'+
      '</div>'
    }).join('');

    // Wire Enter key for reply inputs via event delegation
    document.getElementById('answersContainer').addEventListener('keydown',function(e){
      if(e.key==='Enter'&&e.target.classList.contains('reply-input')){
        const aid=e.target.getAttribute('data-aid');
        if(aid)submitReply(parseInt(aid));
      }
    });

    // Lazy-load drawing/image data for each answer (non-blocking)
    list.forEach(a=>{
      if(a.has_drawing){
        const img=document.getElementById('drawing'+a.id);
        if(img){
          if(a.drawing_key){
            img.src='/api/answers/'+a.id+'/drawing';
          } else {
            fetch('/api/answers/'+a.id+'/drawing').then(r=>{
              const ct=r.headers.get('content-type')||'';
              if(ct.includes('image')){return r.blob().then(b=>{img.src=URL.createObjectURL(b)})};
              return r.json().then(d=>{if(d.data)img.src=d.data});
            }).catch(()=>{});
          }
        }
      }
      if(a.has_image){
        const img=document.getElementById('image'+a.id);
        if(img){
          if(a.image_key){img.src='/api/images/'+a.image_key}
          else{fetch('/api/answers/'+a.id+'/image').then(r=>r.json()).then(d=>{if(d.data)img.src=d.data}).catch(()=>{})}
        }
      }
    });

    // Load reply counts for all answers
    list.forEach(a=>loadReplies(a.id,false));
}
async function loadA(){
  try{
    const ansRes=await fetch('/api/questions/'+qId+'/answers');
    const list=await ansRes.json();
    renderA(Array.isArray(list)?list:[], cachedQData);
  }catch(e){console.error('loadA error',e)}
}

// ===== Reply (ëŒ€ëŒ“ê¸€) Functions =====

function toggleReplySection(answerId){
  const section=document.getElementById('replySection'+answerId);
  const btn=document.querySelector('.ans-card[data-aid="'+answerId+'"] .ans-act-btn');
  if(section.style.display==='none'){
    section.style.display='block';
    if(btn)btn.classList.add('active-reply');
    loadReplies(answerId,true);
  }else{
    section.style.display='none';
    if(btn)btn.classList.remove('active-reply');
  }
}
window.toggleReplySection=toggleReplySection;

async function loadReplies(answerId,showList){
  try{
    const replies=await(await fetch('/api/answers/'+answerId+'/replies')).json();
    const cntEl=document.getElementById('replyCnt'+answerId);
    if(cntEl)cntEl.textContent=replies.length>0?replies.length:'';
    if(!showList)return;
    const listEl=document.getElementById('replyList'+answerId);
    if(!listEl)return;
    if(!replies.length){
      listEl.innerHTML='<div style="font-size:11px;color:var(--muted);padding:6px 0">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    listEl.innerHTML=replies.map(r=>{
      const canDel=currentUser&&currentUser.id===r.user_id;
      return'<div class="reply-item">'+
        '<div class="reply-avatar"><i class="fas fa-user"></i></div>'+
        '<div class="reply-body">'+
          '<div class="reply-head">'+
            '<span class="reply-name">'+r.author_name+'</span>'+
            (r.author_grade?'<span class="reply-grade">'+r.author_grade+'</span>':'')+
            '<span class="reply-time">'+timeAgo(r.created_at)+'</span>'+
            (canDel?'<button class="reply-del" onclick="deleteReply('+r.id+','+answerId+')" title="ì‚­ì œ"><i class="fas fa-times"></i></button>':'')+
          '</div>'+
          '<div class="reply-text">'+escapeHtml(r.content)+'</div>'+
        '</div>'+
      '</div>'
    }).join('');
  }catch(e){console.error('loadReplies error',e)}
}

function escapeHtml(str){
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')
}
window.escapeHtml=escapeHtml;

async function submitReply(answerId){
  if(!currentUser){alert('ì •ìœ¨í†¡ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”.');return}
  const input=document.getElementById('replyInput'+answerId);
  const content=input.value.trim();
  if(!content){input.focus();return}
  try{
    await fetch('/api/answers/'+answerId+'/replies',{method:'POST',headers:authHeaders(),body:JSON.stringify({content})});
    input.value='';
    loadReplies(answerId,true);
  }catch(e){alert('ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')}
}
window.submitReply=submitReply;

async function deleteReply(replyId,answerId){
  if(!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  try{
    await fetch('/api/replies/'+replyId,{method:'DELETE',headers:authHeaders()});
    loadReplies(answerId,true);
  }catch(e){alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')}
}
window.deleteReply=deleteReply;

// === ClassIn Bottom-Bar Voice Recording Functions ===
let isPaused=false;
let previewAnimFrame=null;
let voiceDurationSec=0;

function showRecBar(){
  const bar=document.getElementById('voiceRecBar');
  bar.style.display='flex';
  bar.classList.remove('paused');
  document.getElementById('voiceRecStrip').style.display='flex';
  document.getElementById('voicePreviewBar').style.display='none';
  // Hide the normal bottom bar
  document.getElementById('bottomBar').style.display='none';
  // Extend split container to above recording bar
  document.querySelector('.split-container').style.bottom='48px';
}
function showPreviewBar(){
  document.getElementById('voiceRecStrip').style.display='none';
  document.getElementById('voicePreviewBar').style.display='flex';
  document.getElementById('voiceRecBar').classList.remove('paused');
}
function hideRecBar(){
  document.getElementById('voiceRecBar').style.display='none';
  // Restore normal bottom bar
  document.getElementById('bottomBar').style.display='flex';
  document.querySelector('.split-container').style.bottom='52px';
}

function stopRecordingCleanup(){
  if(mediaRecorder&&(mediaRecorder.state==='recording'||mediaRecorder.state==='paused')) mediaRecorder.stop();
  if(voiceTimerInterval) clearInterval(voiceTimerInterval);
  if(micStream) micStream.getTracks().forEach(t=>t.stop());
  micStream=null;mediaRecorder=null;
  if(audioCtx){try{audioCtx.close()}catch(e){}}
  audioCtx=null;analyser=null;
}

async function startRecording(){
  if(!getToken()){alert('ë¡œê·¸ì¸ í›„ ìŒì„± ë…¹ìŒì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');return}
  try{
    micStream=await navigator.mediaDevices.getUserMedia({audio:true});
    audioChunks=[];
    const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
      : MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm'
      : MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';
    mediaRecorder = mimeType ? new MediaRecorder(micStream,{mimeType}) : new MediaRecorder(micStream);
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data)};
    mediaRecorder.onstop=()=>{
      voiceBlob=new Blob(audioChunks,{type:mediaRecorder.mimeType||'audio/webm'});
      voiceDurationSec=voiceSeconds;
      const url=URL.createObjectURL(voiceBlob);
      document.getElementById('voiceAudio').src=url;
      // Switch to preview bar
      showPreviewBar();
      const m=String(Math.floor(voiceDurationSec/60)).padStart(2,'0');
      const s=String(voiceDurationSec%60).padStart(2,'0');
      document.getElementById('voicePreviewTotal').textContent=m+':'+s;
      document.getElementById('voicePreviewCurrent').textContent='00:00';
      document.getElementById('voicePreviewFill').style.width='0%';
      document.getElementById('voicePreviewPlay').innerHTML='<i class="fas fa-play"></i>';
      document.getElementById('voicePreviewPlay').classList.remove('playing');
    };
    mediaRecorder.start(200);
    voiceSeconds=0;isPaused=false;
    document.getElementById('voiceTimer').textContent='00:00';
    voiceTimerInterval=setInterval(()=>{
      if(!isPaused){
        voiceSeconds++;
        const m=String(Math.floor(voiceSeconds/60)).padStart(2,'0');
        const s=String(voiceSeconds%60).padStart(2,'0');
        document.getElementById('voiceTimer').textContent=m+':'+s;
      }
    },1000);
    
    showRecBar();
    document.getElementById('bbMicBtn').classList.add('recording');
    // Pause button initial state
    const pauseBtn=document.getElementById('voicePauseBtn');
    pauseBtn.className='voice-rec-strip__btn voice-rec-strip__btn--pause';
    pauseBtn.innerHTML='<i class="fas fa-pause"></i>';
    
    // Waveform visualizer
    try{
      audioCtx=new(window.AudioContext||window.webkitAudioContext)();
      analyser=audioCtx.createAnalyser();
      analyser.fftSize=256;
      const src=audioCtx.createMediaStreamSource(micStream);
      src.connect(analyser);
      drawWave();
    }catch(e){}
  }catch(e){
    alert('ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ë¥¼ í—ˆìš©í•´ì£¼ì„¸ìš”.');
  }
}

function drawWave(){
  if(!analyser)return;
  const cv=document.getElementById('voiceWaveCanvas');
  if(!cv)return;
  // Resize canvas to match container
  const parent=cv.parentElement;
  if(parent){cv.width=parent.clientWidth;cv.height=parent.clientHeight}
  const ctx2=cv.getContext('2d');
  const bufLen=analyser.frequencyBinCount;
  const data=new Uint8Array(bufLen);
  function draw(){
    if(!mediaRecorder||mediaRecorder.state==='inactive')return;
    requestAnimationFrame(draw);
    analyser.getByteFrequencyData(data);
    ctx2.clearRect(0,0,cv.width,cv.height);
    const totalBars=Math.min(50,Math.floor(cv.width/5));
    const barW=cv.width/totalBars;
    const gap=1;
    for(let i=0;i<totalBars;i++){
      const idx=Math.floor(i*(bufLen/totalBars));
      const val=isPaused?0:data[idx]/255;
      const h=Math.max(2,val*cv.height*0.9);
      const x=i*barW;
      const y=(cv.height-h)/2;
      ctx2.fillStyle='rgba(255,255,255,'+(0.3+val*0.7)+')';
      const bx=x+gap/2,bw=barW-gap;
      ctx2.beginPath();
      if(ctx2.roundRect){ctx2.roundRect(bx,y,bw,h,1)}else{ctx2.rect(bx,y,bw,h)}
      ctx2.fill();
    }
  }
  draw();
}

function togglePauseRecording(){
  if(!mediaRecorder)return;
  const pauseBtn=document.getElementById('voicePauseBtn');
  const bar=document.getElementById('voiceRecBar');
  if(mediaRecorder.state==='recording'){
    mediaRecorder.pause();
    isPaused=true;
    bar.classList.add('paused');
    pauseBtn.className='voice-rec-strip__btn voice-rec-strip__btn--resume';
    pauseBtn.innerHTML='<i class="fas fa-play"></i>';
    pauseBtn.title='ê³„ì† ë…¹ìŒ';
  }else if(mediaRecorder.state==='paused'){
    mediaRecorder.resume();
    isPaused=false;
    bar.classList.remove('paused');
    pauseBtn.className='voice-rec-strip__btn voice-rec-strip__btn--pause';
    pauseBtn.innerHTML='<i class="fas fa-pause"></i>';
    pauseBtn.title='ì¼ì‹œì •ì§€';
  }
}

function stopRecording(){
  if(voiceTimerInterval)clearInterval(voiceTimerInterval);
  if(mediaRecorder&&(mediaRecorder.state==='recording'||mediaRecorder.state==='paused'))mediaRecorder.stop();
  if(micStream)micStream.getTracks().forEach(t=>t.stop());
  micStream=null;isPaused=false;
  if(audioCtx){try{audioCtx.close()}catch(e){}}
  audioCtx=null;analyser=null;
  document.getElementById('bbMicBtn').classList.remove('recording');
}

function cancelRecording(){
  stopRecordingCleanup();
  voiceBlob=null;isPaused=false;
  document.getElementById('bbMicBtn').classList.remove('recording');
  hideRecBar();
}

function cancelFromPreview(){
  stopPreviewPlayback();
  voiceBlob=null;isPaused=false;
  document.getElementById('voiceAudio').src='';
  document.getElementById('bbMicBtn').classList.remove('recording');
  hideRecBar();
}

function rerecordVoice(){
  stopPreviewPlayback();
  voiceBlob=null;
  document.getElementById('voiceAudio').src='';
  hideRecBar();
  // Immediately start new recording
  setTimeout(()=>startRecording(),100);
}

// === Preview playback controls ===
function togglePreviewPlay(){
  const audio=document.getElementById('voiceAudio');
  const btn=document.getElementById('voicePreviewPlay');
  if(!audio.src)return;
  if(audio.paused){
    audio.play();
    btn.innerHTML='<i class="fas fa-pause"></i>';
    btn.classList.add('playing');
    startPreviewProgress();
  }else{
    audio.pause();
    btn.innerHTML='<i class="fas fa-play"></i>';
    btn.classList.remove('playing');
    cancelAnimationFrame(previewAnimFrame);
  }
}
function startPreviewProgress(){
  const audio=document.getElementById('voiceAudio');
  function update(){
    if(audio.paused||audio.ended){
      if(audio.ended){
        document.getElementById('voicePreviewFill').style.width='100%';
        document.getElementById('voicePreviewPlay').innerHTML='<i class="fas fa-play"></i>';
        document.getElementById('voicePreviewPlay').classList.remove('playing');
        const m=String(Math.floor(voiceDurationSec/60)).padStart(2,'0');
        const s=String(voiceDurationSec%60).padStart(2,'0');
        document.getElementById('voicePreviewCurrent').textContent=m+':'+s;
      }
      return;
    }
    const pct=audio.duration?(audio.currentTime/audio.duration)*100:0;
    document.getElementById('voicePreviewFill').style.width=pct+'%';
    const cm=String(Math.floor(audio.currentTime/60)).padStart(2,'0');
    const cs=String(Math.floor(audio.currentTime%60)).padStart(2,'0');
    document.getElementById('voicePreviewCurrent').textContent=cm+':'+cs;
    previewAnimFrame=requestAnimationFrame(update);
  }
  update();
}
function seekPreview(e){
  const audio=document.getElementById('voiceAudio');
  if(!audio.duration)return;
  const rect=e.currentTarget.getBoundingClientRect();
  const pct=(e.clientX-rect.left)/rect.width;
  audio.currentTime=pct*audio.duration;
  document.getElementById('voicePreviewFill').style.width=(pct*100)+'%';
}
function stopPreviewPlayback(){
  const audio=document.getElementById('voiceAudio');
  if(audio&&!audio.paused)audio.pause();
  cancelAnimationFrame(previewAnimFrame);
}

function deleteRecording(){
  voiceBlob=null;voiceKey=null;voiceDurationSec=0;
  document.getElementById('bbMicBtn').classList.remove('has-voice');
  const prev=document.getElementById('voicePreviewArea');
  if(prev)prev.style.display='none';
}

async function confirmVoice(){
  if(!voiceBlob){alert('ë…¹ìŒëœ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.');return}
  const tk=getToken();
  if(!tk){alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');return}
  const confirmBtn=document.getElementById('voiceConfirmBtn');
  confirmBtn.disabled=true;
  confirmBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> ì—…ë¡œë“œ';
  try{
    const fd=new FormData();
    const ext=voiceBlob.type&&voiceBlob.type.includes('mp4')?'mp4':voiceBlob.type&&voiceBlob.type.includes('ogg')?'ogg':'webm';
    fd.append('voice',voiceBlob,'recording.'+ext);
    const res=await fetch('/api/voice/upload',{method:'POST',headers:{'Authorization':'Bearer '+tk},body:fd});
    if(!res.ok){
      const errData=await res.json().catch(()=>null);
      alert('ì—…ë¡œë“œ ì‹¤íŒ¨ ('+res.status+'): '+(errData?.error||res.statusText));
      return;
    }
    const data=await res.json();
    if(data.voice_key){
      voiceKey=data.voice_key;
      document.getElementById('bbMicBtn').classList.add('has-voice');
      // Show preview below input
      let prev=document.getElementById('voicePreviewArea');
      if(!prev){
        prev=document.createElement('div');
        prev.id='voicePreviewArea';prev.className='voice-preview';
        document.getElementById('splitRight').insertBefore(prev,document.getElementById('answerFormArea'));
      }
      prev.style.display='flex';
      const dm=String(Math.floor(voiceDurationSec/60)).padStart(2,'0');
      const ds=String(voiceDurationSec%60).padStart(2,'0');
      const audioSrc=document.getElementById('voiceAudio').src;
      prev.innerHTML='<div class="voice-preview__icon"><i class="fas fa-microphone"></i></div>'+
        '<div class="voice-preview__info"><div class="voice-preview__label">ìŒì„± ë…¹ìŒ ì²¨ë¶€ë¨</div><div class="voice-preview__duration">'+dm+':'+ds+'</div></div>'+
        '<button class="voice-preview__play" onclick="playPreviewInline(this)" data-src="'+audioSrc+'"><i class="fas fa-play"></i></button>'+
        '<button class="voice-preview__remove" onclick="removeVoice()"><i class="fas fa-times"></i></button>';
      stopPreviewPlayback();
      hideRecBar();
    }else{
      alert('ì—…ë¡œë“œ ì‹¤íŒ¨: '+(data.error||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  }catch(e){alert('ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: '+(e.message||e))}
  finally{confirmBtn.disabled=false;confirmBtn.innerHTML='<i class="fas fa-check"></i> ì²¨ë¶€'}
}

function playPreviewInline(btn){
  const src=btn.getAttribute('data-src');
  if(!src)return;
  if(btn._audio&&!btn._audio.paused){
    btn._audio.pause();
    btn.innerHTML='<i class="fas fa-play"></i>';
    btn._audio=null;
    return;
  }
  const a=new Audio(src);
  btn._audio=a;
  btn.innerHTML='<i class="fas fa-pause"></i>';
  a.play();
  a.onended=()=>{btn.innerHTML='<i class="fas fa-play"></i>';btn._audio=null;};
}
window.playPreviewInline=playPreviewInline;

function removeVoice(){
  voiceBlob=null;voiceKey=null;voiceDurationSec=0;
  document.getElementById('bbMicBtn').classList.remove('has-voice');
  const prev=document.getElementById('voicePreviewArea');
  if(prev)prev.style.display='none';
}
window.removeVoice=removeVoice;

// === Answer card voice player functions ===
const _ansVoicePlayers={};
function toggleAnswerVoice(aid){
  const audio=document.getElementById('voiceEl'+aid);
  const btn=document.getElementById('voicePlay'+aid);
  if(!audio)return;
  // Stop all other voice players
  Object.keys(_ansVoicePlayers).forEach(k=>{
    if(parseInt(k)!==aid){
      const other=document.getElementById('voiceEl'+k);
      const otherBtn=document.getElementById('voicePlay'+k);
      if(other&&!other.paused){other.pause();other.currentTime=0}
      if(otherBtn){otherBtn.innerHTML='<i class="fas fa-play"></i>';otherBtn.classList.remove('playing')}
      if(_ansVoicePlayers[k])cancelAnimationFrame(_ansVoicePlayers[k]);
    }
  });
  if(audio.paused){
    audio.play();
    btn.innerHTML='<i class="fas fa-pause"></i>';
    btn.classList.add('playing');
    _ansVoicePlayers[aid]=requestAnimationFrame(function upd(){
      if(audio.paused||audio.ended){
        if(audio.ended){
          document.getElementById('voiceFill'+aid).style.width='0%';
          document.getElementById('voiceCur'+aid).textContent='00:00';
          btn.innerHTML='<i class="fas fa-play"></i>';btn.classList.remove('playing');
        }
        return;
      }
      const pct=audio.duration?(audio.currentTime/audio.duration)*100:0;
      document.getElementById('voiceFill'+aid).style.width=pct+'%';
      const cm=String(Math.floor(audio.currentTime/60)).padStart(2,'0');
      const cs=String(Math.floor(audio.currentTime%60)).padStart(2,'0');
      document.getElementById('voiceCur'+aid).textContent=cm+':'+cs;
      _ansVoicePlayers[aid]=requestAnimationFrame(upd);
    });
    // Set total time once loaded
    audio.addEventListener('loadedmetadata',function(){
      const tm=String(Math.floor(audio.duration/60)).padStart(2,'0');
      const ts=String(Math.floor(audio.duration%60)).padStart(2,'0');
      document.getElementById('voiceTot'+aid).textContent=tm+':'+ts;
      document.getElementById('voiceDur'+aid).textContent=tm+':'+ts;
    },{once:true});
    if(audio.duration){
      const tm=String(Math.floor(audio.duration/60)).padStart(2,'0');
      const ts=String(Math.floor(audio.duration%60)).padStart(2,'0');
      document.getElementById('voiceTot'+aid).textContent=tm+':'+ts;
      document.getElementById('voiceDur'+aid).textContent=tm+':'+ts;
    }
  }else{
    audio.pause();
    btn.innerHTML='<i class="fas fa-play"></i>';
    btn.classList.remove('playing');
    if(_ansVoicePlayers[aid])cancelAnimationFrame(_ansVoicePlayers[aid]);
  }
}
window.toggleAnswerVoice=toggleAnswerVoice;
function seekAnswerVoice(e,aid){
  const audio=document.getElementById('voiceEl'+aid);
  if(!audio||!audio.duration)return;
  const rect=e.currentTarget.getBoundingClientRect();
  const pct=(e.clientX-rect.left)/rect.width;
  audio.currentTime=pct*audio.duration;
  document.getElementById('voiceFill'+aid).style.width=(pct*100)+'%';
}
window.seekAnswerVoice=seekAnswerVoice;

async function submitAnswer(){
  if(!currentUser){alert('ì •ìœ¨í†¡ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”.');return}
  const content=document.getElementById('answerContent').value.trim();
  let dd=null;
  if(drawOn&&drawHistory.length>0){
    const pc=document.getElementById('drawPreviewCanvas');
    if(pc&&pc.width>0)dd=pc.toDataURL('image/png',0.85);
  }
  if(!content&&!dd&&!ansImgData&&!voiceKey){alert('ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return}
  const btn=document.getElementById('submitAnswer');btn.disabled=true;
  try{
    await fetch('/api/questions/'+qId+'/answers',{method:'POST',headers:authHeaders(),body:JSON.stringify({content,image_data:ansImgData,drawing_data:dd,voice_key:voiceKey})});
    document.getElementById('answerContent').value='';
    drawHistory=[];drawOn=false;
    document.getElementById('drawingPreview').style.display='none';
    document.getElementById('toggleDrawing').classList.remove('active');
    removeAnsImg();
    removeVoice();
    loadQ();loadA();
    // Scroll right panel to bottom to show new answer
    setTimeout(()=>{const sr=document.getElementById('splitRight');if(sr)sr.scrollTop=sr.scrollHeight},300);
  }
  catch(e){alert('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')}
  finally{btn.disabled=false}
}

function showModal(src){const m=document.createElement('div');m.className='img-modal';m.onclick=()=>m.remove();m.innerHTML='<img src="'+src+'">';document.body.appendChild(m)}
// ===== Accept Modal Functions =====

function showAcceptModal(answerId){
  const tags=[
    {id:'aha',emoji:'ğŸ’¡',text:"ë•ë¶„ì— 'ì•„í•˜!' í•˜ê³  ë°”ë¡œ ì´í•´ëì–´ìš”!"},
    {id:'touched',emoji:'ğŸ¥¹',text:'ì •ì„±ì´ ê°€ë“í•œ ì„¤ëª…ì— ì •ë§ ê°ë™í–ˆì–´ìš”.'},
    {id:'pinpoint',emoji:'ğŸ¯',text:'í—·ê°ˆë ¸ë˜ í•µì‹¬ì„ ì •í™•íˆ ì§šì–´ì£¼ì…¨ì–´ìš”!'},
    {id:'relief',emoji:'ğŸš€',text:'ë‹µë‹µí–ˆë˜ ì†ì´ ë»¥ ëš«ë¦¬ëŠ” ê¸°ë¶„ì´ì—ìš”.'},
    {id:'motivated',emoji:'ğŸ”¥',text:'ê°€ë¥´ì³ì¤€ ëŒ€ë¡œ í•˜ë‹ˆ ê³µë¶€ ì˜ìš•ì´ ìƒê²¨ìš”!'}
  ];
  const overlay=document.createElement('div');
  overlay.className='accept-modal-overlay';
  overlay.id='acceptModalOverlay';
  overlay.innerHTML=
    '<div class="accept-modal">'+
      '<div class="accept-modal-header">'+
        '<h3><i class="fas fa-check-circle" style="color:var(--green);margin-right:6px"></i>ë‹µë³€ ì±„íƒí•˜ê¸°</h3>'+
        '<p>ì´ ë‹µë³€ì„ ì±„íƒí•˜ê³  ê°ì‚¬ì˜ ë§ˆìŒì„ ì „í•´ë³´ì„¸ìš”</p>'+
      '</div>'+
      '<div class="accept-modal-body">'+
        '<div style="font-size:12px;font-weight:600;color:var(--dim);margin-bottom:10px">ê°ì‚¬ ë¬¸êµ¬ ì„ íƒ <span style="color:var(--muted);font-weight:400">(ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</span></div>'+
        '<div class="accept-tag-list" id="acceptTagList">'+
          tags.map(t=>
            '<div class="accept-tag-item" data-tag="'+t.id+'">'+
              '<span class="tag-emoji">'+t.emoji+'</span>'+
              '<span class="tag-text">'+t.text+'</span>'+
              '<span class="tag-check"><i class="fas fa-check"></i></span>'+
            '</div>'
          ).join('')+
        '</div>'+
        '<div style="font-size:12px;font-weight:600;color:var(--dim);margin-bottom:8px">ì±„íƒ í›„ê¸° <span style="color:var(--muted);font-weight:400">(ì„ íƒì‚¬í•­)</span></div>'+
        '<textarea class="accept-review-input" id="acceptReviewInput" placeholder="ê°ì‚¬ì˜ ë§ì„ ì§ì ‘ ì‘ì„±í•´ë³´ì„¸ìš”..." maxlength="200"></textarea>'+
      '</div>'+
      '<div class="accept-modal-footer">'+
        '<button class="accept-cancel-btn" id="acceptCancelBtn">ì·¨ì†Œ</button>'+
        '<button class="accept-confirm-btn" id="acceptConfirmBtn"><i class="fas fa-check" style="margin-right:4px"></i>ì±„íƒ ì™„ë£Œ</button>'+
      '</div>'+
    '</div>';
  document.body.appendChild(overlay);
  // Wire tag toggle
  overlay.querySelectorAll('.accept-tag-item').forEach(el=>{
    el.addEventListener('click',()=>el.classList.toggle('selected'));
  });
  overlay.querySelector('#acceptCancelBtn').addEventListener('click',()=>overlay.remove());
  overlay.addEventListener('click',e=>{if(e.target===overlay)overlay.remove()});
  overlay.querySelector('#acceptConfirmBtn').addEventListener('click',()=>acceptAnswer(answerId));
}

async function acceptAnswer(answerId){
  const overlay=document.getElementById('acceptModalOverlay');
  const selectedTags=Array.from(overlay.querySelectorAll('.accept-tag-item.selected')).map(el=>el.getAttribute('data-tag'));
  const review=overlay.querySelector('#acceptReviewInput').value.trim();
  const btn=overlay.querySelector('#acceptConfirmBtn');
  btn.disabled=true;btn.textContent='ì±„íƒ ì¤‘...';
  try{
    const res=await fetch('/api/answers/'+answerId+'/accept',{
      method:'PATCH',
      headers:authHeaders(),
      body:JSON.stringify({tags:selectedTags,review:review||null})
    });
    const data=await res.json();
    if(!res.ok){alert(data.error||'ì±„íƒ ì‹¤íŒ¨');btn.disabled=false;btn.innerHTML='<i class="fas fa-check" style="margin-right:4px"></i>ì±„íƒ ì™„ë£Œ';return}
    overlay.remove();
    loadQ();loadA();
  }catch(e){alert('ì±„íƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');btn.disabled=false;btn.innerHTML='<i class="fas fa-check" style="margin-right:4px"></i>ì±„íƒ ì™„ë£Œ'}
}
window.showAcceptModal=showAcceptModal;

async function deleteAnswer(id){
  if(!confirm('ì´ ë‹µë³€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  try{
    const res=await fetch('/api/answers/'+id,{method:'DELETE',headers:authHeaders()});
    const data=await res.json();
    if(!res.ok){alert(data.error||'ì‚­ì œ ì‹¤íŒ¨');return}
    loadQ();loadA();
  }catch(e){alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')}
}
window.deleteAnswer=deleteAnswer;
window.showModal=showModal;

async function retryAnalysis(){
  try{
    const btn=event.target.closest('button');
    if(btn){btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> ë¶„ì„ ì¤‘...';}
    const res=await fetch('/api/questions/'+qId+'/analyze',{method:'POST',headers:authHeaders()});
    const d=await res.json();
    if(d.success){
      loadQ();
    }else{
      alert('ë¶„ì„ ì‹¤íŒ¨: '+(d.error||d.debug?.geminiError||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      if(btn){btn.disabled=false;btn.innerHTML='<i class="fas fa-redo"></i> ë‹¤ì‹œ ë¶„ì„';}
    }
  }catch(e){alert('ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨');loadQ();}
}
window.retryAnalysis=retryAnalysis;

// === Growth Coaching Interactive Logic (New: per-coaching-question screens) ===
var _gcStepStart = 0;
var _gcSelectedIdx = -1;

// Helper: hide all gc-step, show specific one by ID with animation
function showGcScreen(screenId) {
  var wrap = document.getElementById('gcWrap');
  if (!wrap) return;
  var steps = wrap.querySelectorAll('.gc-step');
  for (var i = 0; i < steps.length; i++) steps[i].classList.remove('active');
  var target = document.getElementById(screenId);
  if (target) {
    target.classList.add('active');
    // Scroll into view smoothly
    setTimeout(function(){ target.scrollIntoView({ behavior:'smooth', block:'nearest' }); }, 50);
  }
}

// Helper: log coaching interaction
function gcLog(step, choice) {
  var elapsed = Date.now() - (_gcStepStart || Date.now());
  _gcStepStart = Date.now();
  var wrap = document.getElementById('gcWrap');
  var qid = wrap ? wrap.getAttribute('data-qid') : '';
  try {
    fetch('/api/coaching/log', {
      method: 'POST', headers: authHeaders(),
      body: JSON.stringify({ questionId: Number(qid), step: String(step), choice: String(choice), timeSpentMs: elapsed })
    }).catch(function(){});
  } catch(e){}
}

// SCREEN 1: Student selects a coaching question
function gcSelectCoaching(idx) {
  _gcSelectedIdx = idx;
  _gcStepStart = Date.now();
  gcLog('select', 'coaching_' + idx);
  // Show wrong_attempt screen for this coaching question
  showGcScreen('gc' + idx + 'Step1');
}

// SCREEN 2+: Handle interactions within a coaching question flow
function gcInteract(idx, step, choice) {
  gcLog(step + '_' + idx, choice);
  var prefix = 'gc' + idx;

  if (step === 'wa') {
    // Wrong attempt response
    if (choice === 'ok') {
      // Student said OK (missed the error) â†’ show hint that something is wrong
      showGcScreen(prefix + 'Hint');
    } else if (choice === 'wrong') {
      // Student spotted the error (correct!) â†’ show discovery choices
      showGcScreen(prefix + 'Choices');
    }
  } else if (step === 'hint') {
    // After seeing "are you sure?" hint â†’ retry: show choices
    if (choice === 'retry') {
      showGcScreen(prefix + 'Choices');
    }
  } else if (step === 'choice') {
    // Student picked a choice from on_correct_choices
    var choiceNum = parseInt(choice.replace('c',''));
    var numChoices = document.querySelectorAll('#' + prefix + 'Choices .gc-btn--choice').length;
    // Last choice = "ì˜ ëª¨ë¥´ê² ì–´ìš”" â†’ show stuck hint
    if (choiceNum === numChoices - 1) {
      showGcScreen(prefix + 'Stuck');
    } else {
      // Any other choice â†’ proceed to thinking bridge
      showGcScreen(prefix + 'Bridge');
    }
  } else if (step === 'stuck') {
    // After seeing stuck hint â†’ proceed to thinking bridge
    showGcScreen(prefix + 'Bridge');
  } else if (step === 'bridge') {
    // Thinking bridge response
    if (choice === 'understood' || choice === 'confused') {
      // Both paths â†’ show final result (coaching question + others)
      showGcScreen(prefix + 'Result');
    }
  }
}

// === COACHING REVIEW SYSTEM ===

var _gcReviewLogs = [];
var _gcReviewMode = false;

// Step label mapping for review
var _stepLabels = {
  'select': 'ğŸ¯ ì½”ì¹­ ì§ˆë¬¸ ì„ íƒ',
  'wa': 'ğŸ¤” í™•ì¸ ì§ˆë¬¸',
  'hint': 'ğŸ§ íŒíŠ¸ í™•ì¸',
  'choice': 'ğŸ‘€ ë°œê²¬ ì„ íƒ',
  'stuck': 'ğŸ’¡ ì¶”ê°€ íŒíŠ¸',
  'bridge': 'ğŸŒ‰ ì‚¬ê³ ì˜ ë‹¤ë¦¬'
};

var _choiceLabels = {
  'ok': 'âœ… ê´œì°®ì€ ê²ƒ ê°™ì•„ìš”',
  'wrong': 'âŒ ë­”ê°€ ì´ìƒí•´ìš”',
  'retry': 'ë‹¤ì‹œ ì‚´í´ë³¼ê²Œìš”',
  'understood': 'ğŸ’¡ ì•„í•˜! ì´í•´í–ˆì–´ìš”',
  'confused': 'ğŸ¤” ì•„ì§ ì˜ ëª¨ë¥´ê² ì–´ìš”',
  'next': 'ì´í•´í–ˆì–´ìš”, ë‹¤ìŒìœ¼ë¡œ!'
};

// Load coaching logs on page init
function gcLoadReviewLogs() {
  var wrap = document.getElementById('gcWrap');
  if (!wrap) return;
  var qid = wrap.getAttribute('data-qid');
  if (!qid) return;

  fetch('/api/coaching/logs/' + qid, { headers: authHeaders() })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (data.success && data.logs && data.logs.length > 0) {
        _gcReviewLogs = data.logs;
        // Has completed coaching â†’ show review panel
        var hasResult = data.logs.some(function(l){ return l.step.indexOf('bridge') >= 0; });
        if (hasResult) {
          gcShowReviewMode();
        }
      }
    })
    .catch(function(){});
}

function gcShowReviewMode() {
  _gcReviewMode = true;
  // Hide Screen1, show Review Panel
  var screen1 = document.getElementById('gcScreen1');
  if (screen1) screen1.classList.remove('active');

  var reviewPanel = document.getElementById('gcReviewPanel');
  if (reviewPanel) {
    reviewPanel.style.display = 'block';
    reviewPanel.classList.add('active');
  }

  // Build review timeline
  gcBuildTimeline();
}

function gcBuildTimeline() {
  var container = document.getElementById('gcReviewTimeline');
  if (!container || !_gcReviewLogs.length) return;

  var html = '';
  _gcReviewLogs.forEach(function(log, i){
    // Extract step type: "select" from "select", "wa_0" from "wa", etc.
    var parts = log.step.split('_');
    var stepType = parts[0];
    if (stepType === 'wa' || stepType === 'hint' || stepType === 'choice' || stepType === 'stuck' || stepType === 'bridge') {
      // keep stepType
    } else if (parts.length > 1 && (parts[1] === 'wa' || parts[1] === 'hint' || parts[1] === 'choice' || parts[1] === 'stuck' || parts[1] === 'bridge')) {
      stepType = parts[1];
    }

    var dotClass = 'gc-review-dot--' + stepType;
    var label = _stepLabels[stepType] || ('ğŸ“Œ ' + log.step);
    var choiceText = _choiceLabels[log.choice] || log.choice;

    // If it's a coaching selection
    if (log.step === 'select' && log.choice.indexOf('coaching_') >= 0) {
      var cIdx = parseInt(log.choice.replace('coaching_', ''));
      var selBtns = document.querySelectorAll('#gcScreen1 .gc-btn--choice');
      if (selBtns[cIdx]) {
        choiceText = 'â¡ï¸ ' + selBtns[cIdx].textContent.trim();
      } else {
        choiceText = 'ì½”ì¹­ ì§ˆë¬¸ #' + (cIdx + 1) + ' ì„ íƒ';
      }
    }

    // Choice with c prefix (discovery choices)
    if (log.choice && log.choice.match && log.choice.match(/^c\\d+$/)) {
      choiceText = 'ë³´ê¸° #' + (parseInt(log.choice.replace('c','')) + 1) + ' ì„ íƒ';
    }

    var timeText = '';
    if (log.time_spent_ms > 0) {
      var sec = Math.round(log.time_spent_ms / 1000);
      timeText = sec > 0 ? (sec + 'ì´ˆ ì†Œìš”') : '';
    }

    html += '<div class="gc-review-step">';
    html += '<div class="gc-review-dot ' + dotClass + '">' + (i+1) + '</div>';
    html += '<div class="gc-review-content">';
    html += '<div class="gc-review-label">' + label + '</div>';
    html += '<div class="gc-review-choice">' + choiceText + '</div>';
    if (timeText) html += '<div class="gc-review-time"><i class="far fa-clock" style="margin-right:3px"></i>' + timeText + '</div>';
    html += '</div>';
    html += '</div>';
  });

  container.innerHTML = html;
}

// Replay: reset UI to step 1, then auto-advance through steps with animation
function gcReplayCoaching() {
  _gcReviewMode = false;
  // Hide review panel
  var reviewPanel = document.getElementById('gcReviewPanel');
  if (reviewPanel) {
    reviewPanel.classList.remove('active');
    reviewPanel.style.display = 'none';
  }

  // Reset all steps
  var allSteps = document.querySelectorAll('.gc-step');
  for (var i = 0; i < allSteps.length; i++) {
    allSteps[i].classList.remove('active');
  }

  // Show screen 1 first
  showGcScreen('gcScreen1');

  // If we have logs, auto-replay them with delay
  if (_gcReviewLogs.length > 0) {
    var replayIdx = 0;
    var _replayTimer = setInterval(function(){
      if (replayIdx >= _gcReviewLogs.length) {
        clearInterval(_replayTimer);
        return;
      }
      var log = _gcReviewLogs[replayIdx];
      // Simulate the step transition
      var parts = log.step.split('_');
      var stepType = parts[0];
      var idxNum = 0;
      
      // Parse step and idx from log
      if (parts.length >= 2 && !isNaN(parseInt(parts[parts.length-1]))) {
        idxNum = parseInt(parts[parts.length-1]);
      }
      if (parts.length >= 2 && (parts[0] === 'wa' || parts[0] === 'hint' || parts[0] === 'choice' || parts[0] === 'stuck' || parts[0] === 'bridge')) {
        stepType = parts[0];
        idxNum = parseInt(parts[1]) || 0;
      }

      var prefix = 'gc' + idxNum;

      if (stepType === 'select') {
        showGcScreen(prefix + 'Step1');
      } else if (stepType === 'wa') {
        if (log.choice === 'ok') showGcScreen(prefix + 'Hint');
        else showGcScreen(prefix + 'Choices');
      } else if (stepType === 'hint') {
        showGcScreen(prefix + 'Choices');
      } else if (stepType === 'choice') {
        var cn = parseInt((log.choice || '').replace('c',''));
        var numC = document.querySelectorAll('#' + prefix + 'Choices .gc-btn--choice').length;
        if (cn === numC - 1) showGcScreen(prefix + 'Stuck');
        else showGcScreen(prefix + 'Bridge');
      } else if (stepType === 'stuck') {
        showGcScreen(prefix + 'Bridge');
      } else if (stepType === 'bridge') {
        showGcScreen(prefix + 'Result');
      }

      replayIdx++;
    }, 1500);
  }
}

// Restart: clear logs and reset UI completely
function gcRestartCoaching() {
  if (!confirm('ì½”ì¹­ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ í•˜ì‹œê² ì–´ìš”?')) return;

  var wrap = document.getElementById('gcWrap');
  if (!wrap) return;
  var qid = wrap.getAttribute('data-qid');

  // Reset logs on server
  fetch('/api/coaching/logs/' + qid + '/reset', {
    method: 'POST',
    headers: authHeaders()
  }).catch(function(){});

  // Clear local state
  _gcReviewLogs = [];
  _gcReviewMode = false;
  _gcSelectedIdx = -1;

  // Hide review panel
  var reviewPanel = document.getElementById('gcReviewPanel');
  if (reviewPanel) {
    reviewPanel.classList.remove('active');
    reviewPanel.style.display = 'none';
  }

  // Reset all steps
  var allSteps = document.querySelectorAll('.gc-step');
  for (var i = 0; i < allSteps.length; i++) {
    allSteps[i].classList.remove('active');
  }

  // Show screen 1
  showGcScreen('gcScreen1');
}

// Trigger review log loading after render
setTimeout(gcLoadReviewLogs, 500);

window.gcSelectCoaching = gcSelectCoaching;
window.gcInteract = gcInteract;
window.gcReplayCoaching = gcReplayCoaching;
window.gcRestartCoaching = gcRestartCoaching;
</script>
</body>
</html>`
}

// ===== New Question Page =====

function newQuestionHTML() {
  return `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì§ˆë¬¸í•˜ê¸°</title>
${pwaHead()}
<style>
${sharedCSS()}

.detail-nav{height:56px;display:flex;align-items:center;padding:0 4%;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;background:rgba(20,20,20,.95);backdrop-filter:blur(6px)}
.detail-nav__back{font-size:14px;font-weight:500;color:var(--dim);background:none;border:none;padding:0;display:flex;align-items:center;gap:8px;transition:color .15s}
.detail-nav__back:hover{color:var(--white)}

.new-q{max-width:600px;margin:0 auto;padding:32px 4% 80px}
.new-q__user{text-align:center;margin-bottom:24px;padding:16px;background:var(--bg2);border-radius:6px;border:1px solid var(--border)}
.new-q__user-name{font-size:15px;font-weight:600;color:var(--white)}
.new-q__user-sub{font-size:12px;color:var(--muted);margin-top:2px}
.new-q__section{margin-bottom:24px}
.new-q__label{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;display:block}
.new-q__label em{color:var(--red);font-style:normal}
.f-input{width:100%;padding:10px 12px;font-size:13px;border:1px solid var(--border);border-radius:4px;background:#1e1e1e;color:var(--white);outline:none;transition:border-color .15s}
.f-input:focus{border-color:var(--muted)}
.f-input::placeholder{color:var(--muted)}
textarea.f-input{resize:none;min-height:100px;line-height:1.6}
select.f-input{appearance:auto}

.upload-zone{border:1px dashed var(--border);border-radius:6px;padding:40px 20px;text-align:center;cursor:pointer;transition:all .15s}
.upload-zone:hover{border-color:var(--muted);background:#1e1e1e}
.upload-zone.drag-over{border-color:var(--green);background:rgba(70,211,105,.05)}
.upload-zone__icon{font-size:24px;color:var(--muted);margin-bottom:8px}
.upload-zone__text{font-size:13px;color:var(--dim)}
.upload-zone__sub{font-size:12px;color:var(--muted);margin-top:4px}
.upload-methods{display:flex;gap:8px;margin-top:10px}
.upload-method{flex:1;text-align:center;padding:8px;font-size:12px;color:var(--muted);border:1px solid var(--border);border-radius:4px;background:none;cursor:pointer;transition:all .15s}
.upload-method:hover{border-color:var(--dim)}
.preview-wrap{position:relative;margin-top:12px}
.preview-wrap img{max-width:100%;border-radius:6px}
.preview-remove{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:50%;background:rgba(0,0,0,.7);color:var(--white);border:none;font-size:11px;display:flex;align-items:center;justify-content:center}
.info-box{padding:12px 14px;background:#1e1e1e;border-radius:4px;border-left:3px solid var(--muted);font-size:12px;color:var(--muted);line-height:1.5;margin-bottom:24px}
.btn-submit{width:100%;padding:12px;border-radius:4px;background:var(--red);color:var(--white);border:none;font-size:14px;font-weight:700;transition:opacity .15s}
.btn-submit:hover{opacity:.85}
.btn-submit:disabled{opacity:.4;cursor:not-allowed}

.killer-check{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;padding:8px 14px;border:1px solid var(--border);border-radius:4px;background:#1e1e1e;transition:all .2s}
.killer-check:hover{border-color:var(--muted)}
.killer-check input{display:none}
.killer-check__box{width:22px;height:22px;border-radius:4px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);transition:all .2s}
.killer-check input:checked~.killer-check__box{background:linear-gradient(135deg,#ff4500,#e50914);color:#fff}
.killer-check__text{font-size:13px;font-weight:600;color:var(--dim);transition:color .2s}
.killer-check input:checked~.killer-check__text{color:#ff4500}
.killer-check.glow{border-color:#ff4500;background:rgba(255,69,0,.08)}

.q-type-group{display:flex;gap:8px;margin-bottom:12px}
.q-type-btn{flex:1;padding:10px 8px;text-align:center;font-size:12px;font-weight:600;color:var(--muted);border:1px solid var(--border);border-radius:6px;background:#1e1e1e;cursor:pointer;transition:all .2s;position:relative}
.q-type-btn:hover{border-color:var(--dim);color:var(--dim)}
.q-type-btn.active-normal{border-color:var(--green);color:var(--green);background:rgba(70,211,105,.06)}
.q-type-btn.active-killer{border-color:#ff4500;color:#ff4500;background:rgba(255,69,0,.06);animation:killerPulse 2s infinite}
.q-type-btn.active-tutor{border-color:#6c5ce7;color:#6c5ce7;background:rgba(108,92,231,.06);animation:tutorPulse 2s infinite}
@keyframes tutorPulse{0%,100%{box-shadow:0 0 4px rgba(108,92,231,.2)}50%{box-shadow:0 0 12px rgba(108,92,231,.5)}}
.q-type-btn i{display:block;font-size:18px;margin-bottom:4px}

.points-select{display:none;margin-top:8px;padding:12px;border:1px solid var(--border);border-radius:6px;background:#1a1a2e}
.points-select.show{display:block;animation:fadeSlideIn .25s ease}
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeSlideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.points-select__title{font-size:11px;font-weight:600;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.points-chips{display:flex;gap:8px}
.points-chip{flex:1;padding:10px 6px;text-align:center;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all .2s;background:#1e1e1e}
.points-chip:hover{border-color:var(--dim)}
.points-chip.selected{border-color:#ffd700;background:rgba(255,215,0,.08)}
.points-chip__val{font-size:18px;font-weight:800;color:var(--white)}
.points-chip__won{font-size:10px;color:var(--muted);margin-top:2px}
.points-chip.selected .points-chip__val{color:#ffd700}
.points-chip.selected .points-chip__won{color:#ffd700}

.day-tab{padding:6px 12px;font-size:11px;font-weight:600;border:1px solid var(--border);border-radius:4px;background:#1e1e1e;color:var(--muted);cursor:pointer;transition:all .15s}
.day-tab:hover{border-color:var(--dim);color:var(--dim)}
.day-tab.active{border-color:#6c5ce7;color:#6c5ce7;background:rgba(108,92,231,.1)}
.time-slot{padding:8px 4px;text-align:center;font-size:11px;font-weight:500;border:1px solid var(--border);border-radius:4px;background:#1e1e1e;color:var(--muted);cursor:pointer;transition:all .15s}
.time-slot:hover{border-color:var(--dim);color:var(--white)}
.time-slot.picked{border-color:#6c5ce7;color:#fff;background:rgba(108,92,231,.3)}
.time-slot.disabled{opacity:.3;cursor:not-allowed}
.slot-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;font-size:11px;font-weight:600;background:rgba(108,92,231,.15);border:1px solid rgba(108,92,231,.3);border-radius:20px;color:#a29bfe;margin:3px 3px 3px 0}
.slot-tag__x{cursor:pointer;opacity:.6;transition:opacity .15s}
.slot-tag__x:hover{opacity:1}
</style>
</head>
<body>
<div class="detail-nav">
  <a href="/" class="detail-nav__back"><i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ</a>
</div>

<div class="new-q">
  <div class="new-q__user" id="userInfo">
    <div class="new-q__user-name" id="userName">-</div>
    <div class="new-q__user-sub" id="userSub">ë¡œê·¸ì¸ í™•ì¸ ì¤‘...</div>
  </div>

  <div class="new-q__section">
    <label class="new-q__label">ê³¼ëª© <em>*</em></label>
    <select id="questionSubject" class="f-input" required>
      <option value="">ê³¼ëª© ì„ íƒ</option>
      <option value="ì˜ì–´">ì˜ì–´</option>
      <option value="ìˆ˜í•™">ìˆ˜í•™</option>
      <option value="êµ­ì–´">êµ­ì–´</option>
      <option value="ê³¼í•™">ê³¼í•™</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
  </div>

  <div class="new-q__section">
    <label class="new-q__label">ì§ˆë¬¸ ìœ í˜•</label>
    <div class="q-type-group">
      <div class="q-type-btn active-normal" id="typeNormal" onclick="selectQType('normal')">
        <i class="fas fa-comment-dots"></i>ì¼ë°˜ ì§ˆë¬¸
      </div>
      <div class="q-type-btn" id="typeKiller" onclick="selectQType('killer')">
        <i class="fas fa-fire"></i>ê³ ë‚œë„
      </div>
      <div class="q-type-btn" id="typeTutor" onclick="selectQType('tutor')">
        <i class="fas fa-chalkboard-teacher"></i>1:1 íŠœí„°ë§
      </div>
    </div>

    <div class="points-select" id="killerPoints">
      <div class="points-select__title"><i class="fas fa-coins" style="color:#ffd700"></i> ìƒê¸ˆ í¬ì¸íŠ¸ ì„¤ì • (1P = 100ì›)</div>
      <div class="points-chips">
        <div class="points-chip" onclick="selectPoints(10)"><div class="points-chip__val">10P</div><div class="points-chip__won">â‚©1,000</div></div>
        <div class="points-chip" onclick="selectPoints(20)"><div class="points-chip__val">20P</div><div class="points-chip__won">â‚©2,000</div></div>
        <div class="points-chip" onclick="selectPoints(30)"><div class="points-chip__val">30P</div><div class="points-chip__won">â‚©3,000</div></div>
      </div>
    </div>

    <div class="points-select" id="tutorPoints">
      <div class="points-select__title"><i class="fas fa-coins" style="color:#ffd700"></i> 1:1 ì„¤ëª… í¬ì¸íŠ¸ ì„¤ì • (1P = 100ì›)</div>
      <div class="points-chips">
        <div class="points-chip" onclick="selectPoints(50)"><div class="points-chip__val">50P</div><div class="points-chip__won">â‚©5,000</div></div>
        <div class="points-chip" onclick="selectPoints(80)"><div class="points-chip__val">80P</div><div class="points-chip__won">â‚©8,000</div></div>
        <div class="points-chip" onclick="selectPoints(100)"><div class="points-chip__val">100P</div><div class="points-chip__won">â‚©10,000</div></div>
      </div>
      <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px">
        <div class="points-select__title"><i class="fas fa-clock" style="color:#6c5ce7"></i> ê°€ëŠ¥í•œ ì‹œê°„ 3ê°œ ì„ íƒ <span style="color:var(--muted);font-weight:400">(30ë¶„ ë‹¨ìœ„)</span></div>
        <div id="slotPicker" style="margin-top:8px">
          <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap" id="dayTabs"></div>
          <div id="timeGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;max-height:180px;overflow-y:auto"></div>
        </div>
        <div id="selectedSlots" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <div class="new-q__section">
    <label class="new-q__label">ì§ˆë¬¸ ë‚´ìš© <em>*</em></label>
    <textarea id="questionContent" class="f-input" rows="5" placeholder="ì–´ë–¤ ë¶€ë¶„ì´ ì´í•´ê°€ ì•ˆ ë˜ëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš” (ìµœì†Œ 10ì)" oninput="checkContentLength()"></textarea>
    <div id="contentCounter" style="text-align:right;font-size:11px;color:var(--muted);margin-top:4px">0 / 10ì ì´ìƒ</div>
  </div>

  <div class="new-q__section">
    <label class="new-q__label">ë¬¸ì œ ì´ë¯¸ì§€</label>
    <div id="uploadLock" style="padding:32px 20px;text-align:center;border:1px solid var(--border);border-radius:6px;background:#1a1a1a">
      <div style="font-size:20px;color:var(--muted);margin-bottom:6px"><i class="fas fa-lock"></i></div>
      <div style="font-size:13px;color:var(--muted)">ì§ˆë¬¸ ë‚´ìš©ì„ 10ì ì´ìƒ ì‘ì„±í•˜ë©´ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
      <div id="lockProgress" style="margin-top:10px;height:3px;background:#333;border-radius:2px;overflow:hidden"><div id="lockBar" style="height:100%;width:0%;background:var(--red);transition:width .2s;border-radius:2px"></div></div>
    </div>
    <div id="uploadAreaWrap" style="display:none">
      <div id="uploadArea" class="upload-zone">
        <div class="upload-zone__icon"><i class="fas fa-arrow-up-from-bracket"></i></div>
        <div class="upload-zone__text">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</div>
        <div class="upload-zone__sub">ìº¡ì²˜í•œ ë¬¸ì œ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”</div>
        <input id="imageInput" type="file" accept="image/*" style="display:none">
      </div>
      <div class="upload-methods">
        <label class="upload-method"><i class="fas fa-camera" style="margin-right:4px"></i>ì¹´ë©”ë¼
          <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none">
        </label>
        <button id="pasteBtn" class="upload-method"><i class="fas fa-paste" style="margin-right:4px"></i>ë¶™ì—¬ë„£ê¸°</button>
      </div>
    </div>
    <div id="imagePreview" style="display:none">
      <div class="preview-wrap">
        <img id="previewImg" src="">
        <button id="removeImage" class="preview-remove"><i class="fas fa-times"></i></button>
      </div>
    </div>
  </div>

  <div class="info-box">êµ¬ì²´ì ìœ¼ë¡œ ì§ˆë¬¸í• ìˆ˜ë¡ ì¢‹ì€ ë‹µë³€ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
  <button id="submitQuestion" class="btn-submit">ì§ˆë¬¸ ë“±ë¡</button>
</div>

<script>
${sharedAuthJS()}

let imageData=null,thumbnailData=null,imageUnlocked=false,currentUser=null;
let qType='normal',selectedPoints=0,pickedSlots=[];

const DAYS=['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];
const TIMES=[];
for(let h=15;h<=22;h++){TIMES.push(h+':00');if(h<22)TIMES.push(h+':30')}

function selectQType(type){
  qType=type;selectedPoints=0;pickedSlots=[];
  document.querySelectorAll('.q-type-btn').forEach(b=>b.className='q-type-btn');
  document.querySelectorAll('.points-chip').forEach(c=>c.classList.remove('selected'));
  if(type==='normal'){document.getElementById('typeNormal').className='q-type-btn active-normal';document.getElementById('killerPoints').classList.remove('show');document.getElementById('tutorPoints').classList.remove('show')}
  else if(type==='killer'){document.getElementById('typeKiller').className='q-type-btn active-killer';document.getElementById('killerPoints').classList.add('show');document.getElementById('tutorPoints').classList.remove('show')}
  else if(type==='tutor'){document.getElementById('typeTutor').className='q-type-btn active-tutor';document.getElementById('tutorPoints').classList.add('show');document.getElementById('killerPoints').classList.remove('show');initSlotPicker()}
}
function selectPoints(p){
  selectedPoints=p;
  const container=qType==='killer'?document.getElementById('killerPoints'):document.getElementById('tutorPoints');
  container.querySelectorAll('.points-chip').forEach(c=>{c.classList.toggle('selected',c.querySelector('.points-chip__val').textContent===p+'P')});
}

let curDay=null;
function initSlotPicker(){
  // ì˜¤ëŠ˜ë¶€í„° 7ì¼ ê³„ì‚°
  const today=new Date();
  const dayList=[];
  for(let i=0;i<7;i++){
    const d=new Date(today);d.setDate(today.getDate()+i);
    const dayIdx=d.getDay();const dayName=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][dayIdx];
    const mm=(d.getMonth()+1);const dd=d.getDate();
    dayList.push({label:dayName+' '+mm+'/'+dd,value:dayName+' '+(mm<10?'0'+mm:mm)+'/'+(dd<10?'0'+dd:dd),dateStr:(d.getMonth()+1)+'/'+d.getDate()});
  }
  const tabs=document.getElementById('dayTabs');
  tabs.innerHTML=dayList.map((d,i)=>'<div class="day-tab'+(i===0?' active':'')+'" data-day="'+d.label+'" onclick="pickDay(this)">'+d.label+'</div>').join('');
  curDay=dayList[0].label;
  renderTimeGrid();
  renderSelectedSlots();
}
function pickDay(el){
  document.querySelectorAll('.day-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');curDay=el.dataset.day;renderTimeGrid();
}
function renderTimeGrid(){
  const grid=document.getElementById('timeGrid');
  grid.innerHTML=TIMES.map(t=>{
    const key=curDay+' '+t;
    const picked=pickedSlots.includes(key);
    const full=pickedSlots.length>=3&&!picked;
    return'<div class="time-slot'+(picked?' picked':'')+(full?' disabled':'')+'" data-slot="'+key+'" onclick="toggleSlot(this)">'+t+'</div>';
  }).join('');
}
function toggleSlot(el){
  if(el.classList.contains('disabled'))return;
  const key=el.dataset.slot;
  if(pickedSlots.includes(key)){pickedSlots=pickedSlots.filter(s=>s!==key)}
  else{if(pickedSlots.length>=3)return;pickedSlots.push(key)}
  renderTimeGrid();renderSelectedSlots();
}
function removeSlot(key){pickedSlots=pickedSlots.filter(s=>s!==key);renderTimeGrid();renderSelectedSlots()}
function renderSelectedSlots(){
  const el=document.getElementById('selectedSlots');
  if(!pickedSlots.length){el.innerHTML='<div style="font-size:11px;color:var(--muted)"><i class="fas fa-info-circle"></i> ìš”ì¼ì„ ì„ íƒí•˜ê³  ì‹œê°„ì„ íƒ­í•˜ì„¸ìš” (ìµœëŒ€ 3ê°œ)</div>';return}
  el.innerHTML='<div style="font-size:10px;color:var(--muted);margin-bottom:4px">ì„ íƒëœ ì‹œê°„ ('+pickedSlots.length+'/3)</div>'+
    pickedSlots.map(s=>'<span class="slot-tag"><i class="fas fa-clock"></i> '+s+' <span class="slot-tag__x" onclick="removeSlot(&quot;'+s+'&quot;)">&times;</span></span>').join('');
}
const uploadArea=document.getElementById('uploadArea'),imageInput=document.getElementById('imageInput');

// Auth check
(async()=>{
  currentUser=await checkAuth();
  if(!currentUser){alert('ì •ìœ¨í†¡ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”.');return}
  document.getElementById('userName').textContent=currentUser.nickname;
  document.getElementById('userSub').textContent=(currentUser.grade||'í•™ë…„ ë¯¸ì„¤ì •')+' Â· @'+currentUser.username;
})();

function checkContentLength(){
  const len=document.getElementById('questionContent').value.trim().length;
  const counter=document.getElementById('contentCounter');
  const lockBar=document.getElementById('lockBar');
  const pct=Math.min(len/10*100,100);
  counter.textContent=len+' / 10ì ì´ìƒ';
  counter.style.color=len>=10?'#46d369':'var(--muted)';
  lockBar.style.width=pct+'%';
  if(len>=10)lockBar.style.background='#46d369';
  else lockBar.style.background='var(--red)';
  if(len>=10&&!imageUnlocked){imageUnlocked=true;document.getElementById('uploadLock').style.display='none';document.getElementById('uploadAreaWrap').style.display='block'}
  else if(len<10&&imageUnlocked&&!imageData){imageUnlocked=false;document.getElementById('uploadLock').style.display='';document.getElementById('uploadAreaWrap').style.display='none'}
}

uploadArea.addEventListener('click',()=>imageInput.click());
uploadArea.addEventListener('dragover',e=>{e.preventDefault();uploadArea.classList.add('drag-over')});
uploadArea.addEventListener('dragleave',()=>uploadArea.classList.remove('drag-over'));
uploadArea.addEventListener('drop',e=>{e.preventDefault();uploadArea.classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))processFile(f)});
imageInput.addEventListener('change',e=>{if(e.target.files[0])processFile(e.target.files[0])});
document.getElementById('cameraInput').addEventListener('change',e=>{if(e.target.files[0])processFile(e.target.files[0])});

document.getElementById('pasteBtn').addEventListener('click',async()=>{
  try{const items=await navigator.clipboard.read();for(const item of items)for(const type of item.types)if(type.startsWith('image/')){processFile(await item.getType(type));return}alert('í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.')}
  catch(e){alert('í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')}
});

document.addEventListener('paste',e=>{const items=e.clipboardData?.items;if(!items)return;for(const item of items)if(item.type.startsWith('image/')){const f=item.getAsFile();if(f)processFile(f);return}});

function processFile(file){
  const reader=new FileReader();
  reader.onload=ev=>{const img=new Image();img.onload=()=>{
    // Original (1200px, quality 0.82)
    const max=1200;let w=img.width,h=img.height;
    if(w>max||h>max){const s=max/Math.max(w,h);w=Math.round(w*s);h=Math.round(h*s)}
    const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
    imageData=c.toDataURL('image/jpeg',0.82);
    // Thumbnail (480px, quality 0.7)
    const tmax=480;let tw=img.width,th=img.height;
    if(tw>tmax||th>tmax){const ts=tmax/Math.max(tw,th);tw=Math.round(tw*ts);th=Math.round(th*ts)}
    const tc=document.createElement('canvas');tc.width=tw;tc.height=th;tc.getContext('2d').drawImage(img,0,0,tw,th);
    thumbnailData=tc.toDataURL('image/jpeg',0.7);
    document.getElementById('previewImg').src=imageData;document.getElementById('imagePreview').style.display='block';uploadArea.style.display='none'};img.src=ev.target.result};
  reader.readAsDataURL(file);
}

document.getElementById('removeImage').addEventListener('click',()=>{imageData=null;thumbnailData=null;document.getElementById('imagePreview').style.display='none';uploadArea.style.display='';imageInput.value=''});

document.getElementById('submitQuestion').addEventListener('click',async()=>{
  const contentVal=document.getElementById('questionContent').value.trim();
  if(contentVal.length<10){alert('ì§ˆë¬¸ ë‚´ìš©ì„ 10ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');return}
  const subjectVal=document.getElementById('questionSubject').value;
  if(!subjectVal){alert('ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');return}
  if((qType==='killer'||qType==='tutor')&&selectedPoints===0){alert('í¬ì¸íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');return}
  if(qType==='tutor'&&pickedSlots.length===0){alert('ê°€ëŠ¥í•œ ì‹œê°„ì„ ìµœì†Œ 1ê°œ ì„ íƒí•´ì£¼ì„¸ìš”.');return}
  const btn=document.getElementById('submitQuestion');btn.disabled=true;btn.textContent='ë“±ë¡ ì¤‘...';
  try{
    let imgKey=null,thumbKey=null;
    // Upload image to R2 first if exists
    if(imageData){
      btn.textContent='ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...';
      const upRes=await fetch('/api/images/upload',{method:'POST',headers:authHeaders(),body:JSON.stringify({image_data:imageData,thumbnail_data:thumbnailData,type:'question'})});
      const upData=await upRes.json();
      if(upRes.ok&&upData.key){imgKey=upData.key;thumbKey=upData.thumbnailKey}
      else{alert(upData.error||'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');btn.disabled=false;btn.textContent='ì§ˆë¬¸ ë“±ë¡';return}
    }
    btn.textContent='ì§ˆë¬¸ ë“±ë¡ ì¤‘...';
    const body={content:contentVal,image_key:imgKey,thumbnail_key:thumbKey,subject:subjectVal,is_killer:qType==='killer',is_tutoring:qType==='tutor',reward_points:selectedPoints,tutoring_slots:qType==='tutor'?pickedSlots:undefined};
    const res=await fetch('/api/questions',{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});
    const data=await res.json();
    if(!res.ok){alert(data.error||'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');btn.disabled=false;btn.textContent='ì§ˆë¬¸ ë“±ë¡';return}
    location.href='/question/'+data.id;
  }catch(e){alert('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');btn.disabled=false;btn.textContent='ì§ˆë¬¸ ë“±ë¡'}
});
</script>
</body>
</html>`
}
